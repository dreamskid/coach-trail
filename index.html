<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f1117">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <title>Coach Trail — Yohann Tschudi — OCC 2026</title>
    <style>
        :root {
            --bg: #0f1117;
            --bg-card: #1a1d27;
            --bg-card-alt: #21242f;
            --border: #2a2d3a;
            --text: #e4e4e7;
            --text-muted: #8b8fa3;
            --accent: #3b82f6;
            --accent-light: #60a5fa;
            --green: #22c55e;
            --green-dark: #15803d;
            --yellow: #eab308;
            --orange: #f97316;
            --red: #ef4444;
            --red-dark: #991b1b;
            --purple: #a855f7;
            --cyan: #06b6d4;
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Inter, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 0;
        }

        /* ===== HEADER ===== */
        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px 24px 0;
            max-width: 1400px;
            margin: 0 auto;
        }

        header h1 { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; }
        header h1 span { color: var(--accent); }
        .header-meta { text-align: right; color: var(--text-muted); font-size: 12px; }
        .header-meta .update { color: var(--accent-light); font-weight: 600; }

        /* ===== TABS ===== */
        .tab-bar {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border);
            padding: 0 24px;
            max-width: 1400px;
            margin: 16px auto 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            white-space: nowrap;
            transition: all 0.2s;
            font-family: inherit;
        }

        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--accent-light); border-bottom-color: var(--accent-light); }

        .tab-content {
            display: none;
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
            animation: fadeIn 0.2s;
        }

        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ===== GRID ===== */
        .grid { display: grid; gap: 20px; margin-bottom: 24px; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        .grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
        .grid-1-2 { grid-template-columns: 1fr 2fr; }
        .grid-2-1 { grid-template-columns: 2fr 1fr; }

        /* ===== CARDS ===== */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }

        .card h2 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .card h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 16px 0 8px;
            color: var(--accent-light);
        }

        /* ===== STATS ===== */
        .stat-big { font-size: 36px; font-weight: 700; line-height: 1.1; }
        .stat-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .stat-row:last-child { border-bottom: none; }
        .stat-row .label { color: var(--text-muted); font-size: 13px; }
        .stat-row .value { font-weight: 600; font-size: 14px; }

        /* ===== BADGES ===== */
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-green { background: var(--green-dark); color: var(--green); }
        .badge-yellow { background: #854d0e; color: var(--yellow); }
        .badge-red { background: var(--red-dark); color: #fca5a5; }
        .badge-blue { background: #1e3a5f; color: var(--accent-light); }
        .badge-purple { background: #581c87; color: #d8b4fe; }
        .badge-orange { background: #9a3412; color: #fdba74; }

        /* ===== TABLE ===== */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        table th {
            text-align: left; padding: 8px 10px; font-size: 11px;
            text-transform: uppercase; letter-spacing: 0.5px;
            color: var(--text-muted); border-bottom: 2px solid var(--border);
        }
        table td { padding: 8px 10px; border-bottom: 1px solid var(--border); vertical-align: top; }
        table tr:last-child td { border-bottom: none; }
        table tr:hover { background: var(--bg-card-alt); }

        /* ===== COLORS ===== */
        .text-green { color: var(--green); }
        .text-yellow { color: var(--yellow); }
        .text-red { color: var(--red); }
        .text-orange { color: var(--orange); }
        .text-blue { color: var(--accent-light); }
        .text-purple { color: var(--purple); }
        .text-cyan { color: var(--cyan); }
        .text-muted { color: var(--text-muted); }
        .text-bold { font-weight: 700; }

        /* ===== ZONE BAR ===== */
        .zone-bar { display: flex; height: 32px; border-radius: 6px; overflow: hidden; margin: 8px 0; }
        .zone-bar div { display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #fff; }
        .zone-1 { background: #3b82f6; }
        .zone-2 { background: #22c55e; }
        .zone-3 { background: #eab308; }
        .zone-4 { background: #f97316; }
        .zone-5 { background: #ef4444; }

        /* ===== PROGRESS BAR ===== */
        .progress-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin: 6px 0; }
        .progress-bar .fill { height: 100%; border-radius: 4px; transition: width 0.3s; }

        /* ===== RECOMMENDATIONS ===== */
        .reco-item { padding: 14px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid; }
        .reco-critical { background: #1c1012; border-color: var(--red); }
        .reco-important { background: #1a1608; border-color: var(--orange); }
        .reco-positive { background: #0a1a0f; border-color: var(--green); }
        .reco-item .reco-title { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
        .reco-item .reco-text { font-size: 13px; color: var(--text-muted); }

        /* ===== RACE TIMELINE ===== */
        .race-timeline { position: relative; padding-left: 24px; }
        .race-timeline::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: var(--border); }
        .race-item { position: relative; padding: 12px 0; }
        .race-item::before { content: ''; position: absolute; left: -20px; top: 18px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid; }
        .race-a::before { border-color: var(--red); background: var(--red-dark); }
        .race-b::before { border-color: var(--orange); background: #9a3412; }
        .race-c::before { border-color: var(--yellow); background: #854d0e; }
        .race-done::before { border-color: var(--green); background: var(--green-dark); }
        .race-item .race-date { font-size: 12px; color: var(--text-muted); }
        .race-item .race-name { font-weight: 700; font-size: 15px; }
        .race-item .race-details { font-size: 13px; color: var(--text-muted); }

        /* ===== INJURY ===== */
        .injury-status { padding: 16px; border-radius: 8px; border: 1px solid; }
        .injury-active { background: #1c1012; border-color: var(--red); }
        .injury-healing { background: #1a1608; border-color: var(--yellow); }
        .injury-resolved { background: #0a1a0f; border-color: var(--green); }

        /* ===== WEEK DAY ===== */
        .week-day { padding: 12px; border-radius: 8px; background: var(--bg-card-alt); margin-bottom: 8px; }
        .week-day .day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .week-day .day-name { font-weight: 700; font-size: 14px; }
        .week-day .day-details { font-size: 13px; color: var(--text-muted); line-height: 1.5; }

        /* ===== NOTE BOX ===== */
        .note-box {
            background: var(--bg-card-alt);
            border-left: 3px solid var(--accent);
            padding: 12px 16px;
            border-radius: 0 8px 8px 0;
            font-size: 13px;
            margin: 12px 0;
            color: var(--text-muted);
        }

        /* ===== SECTION TITLE ===== */
        .section-title {
            font-size: 20px; font-weight: 700;
            margin: 32px 0 16px; padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            letter-spacing: -0.3px;
        }
        .section-title span { color: var(--accent-light); }

        /* ===== ACTIVITY CARD (Strava) ===== */
        .activity-card {
            background: var(--bg-card-alt);
            border-radius: 10px;
            padding: 0;
            margin-bottom: 10px;
            display: flex;
            overflow: hidden;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .activity-card:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
        .act-icon {
            width: 56px;
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .act-icon svg { width: 26px; height: 26px; }
        .act-icon.run { background: linear-gradient(135deg, #15803d, #22c55e); }
        .act-icon.trail { background: linear-gradient(135deg, #b45309, #f97316); }
        .act-icon.swim { background: linear-gradient(135deg, #0e7490, #06b6d4); }
        .act-icon.elliptical { background: linear-gradient(135deg, #7e22ce, #a855f7); }
        .act-icon.walk { background: linear-gradient(135deg, #a16207, #eab308); }
        .act-icon.workout { background: linear-gradient(135deg, #9a3412, #f97316); }
        .act-icon.default { background: linear-gradient(135deg, #1e3a5f, #3b82f6); }
        .act-body { flex: 1; padding: 14px 16px; }
        .act-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .act-name { font-weight: 700; font-size: 14px; letter-spacing: -0.2px; }
        .act-meta { font-size: 11px; color: var(--text-muted); text-align: right; line-height: 1.4; }
        .act-type-label { font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .act-stats { display: flex; gap: 6px; flex-wrap: wrap; }
        .act-stat {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 6px 12px;
            text-align: center;
            min-width: 72px;
        }
        .act-stat-value { font-weight: 800; font-size: 14px; letter-spacing: -0.3px; }
        .act-stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 1px; }
        .act-zone {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 8px;
        }

        /* ===== HEALTH TAB ===== */
        .sleep-phases-bar { display: flex; height: 28px; border-radius: 6px; overflow: hidden; margin: 8px 0; }
        .sleep-phases-bar div { display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: #fff; }
        .sleep-deep { background: #1e3a8a; }
        .sleep-light { background: #3b82f6; }
        .sleep-rem { background: #8b5cf6; }
        .sleep-awake { background: #f97316; }

        .mini-chart { display: flex; align-items: flex-end; gap: 3px; height: 80px; padding: 0 2px; }
        .mini-chart .bar {
            flex: 1;
            border-radius: 3px 3px 0 0;
            min-width: 8px;
            position: relative;
            transition: opacity 0.15s;
            cursor: default;
        }
        .mini-chart .bar:hover { opacity: 0.8; }
        .mini-chart-labels { display: flex; justify-content: space-between; font-size: 9px; color: var(--text-muted); padding: 4px 2px 0; }

        .health-metric {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        .health-metric:last-child { border-bottom: none; }
        .health-metric-icon {
            width: 40px; height: 40px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .health-metric-value { font-size: 20px; font-weight: 700; }
        .health-metric-label { font-size: 12px; color: var(--text-muted); }

        .hrv-status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ===== SYNC BUTTON ===== */
        .sync-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            margin-top: 6px;
        }
        .sync-btn:hover { background: var(--bg-card-alt); color: var(--text); border-color: var(--accent); }
        .sync-btn.syncing { color: var(--accent-light); border-color: var(--accent); cursor: wait; }
        .sync-btn.syncing svg { animation: spin 1s linear infinite; }
        .sync-btn.stale { border-color: var(--orange); color: var(--orange); }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .sync-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); display: flex; align-items: center;
            justify-content: center; z-index: 1000;
        }
        .sync-modal-box {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 24px; max-width: 480px; width: 90%;
        }
        .sync-modal-box h3 { font-size: 16px; margin-bottom: 12px; }
        .sync-modal-box input {
            width: 100%; padding: 10px 12px; border-radius: 8px;
            border: 1px solid var(--border); background: var(--bg-card-alt);
            color: var(--text); font-size: 13px; font-family: monospace;
            margin: 8px 0 16px;
        }
        .sync-modal-box input:focus { outline: none; border-color: var(--accent); }
        .sync-modal-btn {
            padding: 8px 20px; border-radius: 8px; border: none;
            background: var(--accent); color: #fff; font-weight: 600;
            font-size: 13px; cursor: pointer; font-family: inherit;
        }
        .sync-modal-btn:hover { background: var(--accent-light); }
        .sync-modal-cancel {
            padding: 8px 20px; border-radius: 8px; border: 1px solid var(--border);
            background: none; color: var(--text-muted); font-weight: 600;
            font-size: 13px; cursor: pointer; margin-left: 8px; font-family: inherit;
        }

        /* ===== FOOTER ===== */
        footer {
            text-align: center; padding: 30px 0 20px; color: var(--text-muted);
            font-size: 12px; border-top: 1px solid var(--border);
            margin: 40px 24px 0; max-width: 1400px;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 900px) {
            .grid-2, .grid-3, .grid-4, .grid-1-2, .grid-2-1 { grid-template-columns: 1fr; }
            header { flex-direction: column; gap: 8px; }
            .header-meta { text-align: left; }
            .tab-btn { padding: 10px 14px; font-size: 12px; }
        }
    </style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header>
    <div>
        <h1>Coach Trail — <span>Yohann Tschudi</span></h1>
        <p style="color: var(--text-muted); margin-top: 2px; font-size: 13px;">Objectif : OCC (UTMB Week) — 27 aout 2026 — 57 km / 3500 D+</p>
    </div>
    <div class="header-meta">
        <div class="update" id="header-update">Mise a jour : 7 fevrier 2026</div>
        <div>J-201 avant l'OCC</div>
        <div>Bloc 0 — Reprise & Soin</div>
        <button class="sync-btn" id="sync-btn" onclick="handleSync(event)" title="Sync Strava + Garmin (Shift+click = reconfigurer le token)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
            <span id="sync-label">Sync</span>
        </button>
    </div>
</header>

<!-- ===== TAB BAR ===== -->
<nav class="tab-bar">
    <button class="tab-btn active" data-tab="overview">Vue d'ensemble</button>
    <button class="tab-btn" data-tab="week">Semaine</button>
    <button class="tab-btn" data-tab="injury">Blessure</button>
    <button class="tab-btn" data-tab="health">Sante</button>
    <button class="tab-btn" data-tab="calendar">Calendrier</button>
    <button class="tab-btn" data-tab="progress">Progression</button>
    <button class="tab-btn" data-tab="activities">Activites</button>
</nav>

<!-- ======================================================================== -->
<!-- TAB 1 : VUE D'ENSEMBLE                                                  -->
<!-- ======================================================================== -->
<div id="overview" class="tab-content active">

    <!-- KPI cards -->
    <div class="grid grid-4" style="margin-bottom: 24px;">
        <div class="card" style="text-align: center;">
            <div class="stat-big text-blue">451</div>
            <div class="stat-label">UTMB Index Pic</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;">20K: 446 · 50K: 437</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big text-green" id="kpi-vo2max">45</div>
            <div class="stat-label">VO2max (ml/kg/min)</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="kpi-vo2max-sub">Garmin · 07/02/2026</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big text-red" id="kpi-sleep">6h03</div>
            <div class="stat-label">Sommeil moyen /nuit</div>
            <div style="font-size:12px; color: var(--red); margin-top:4px;" id="kpi-sleep-sub">Objectif : 7h30</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big text-orange">82<span style="font-size:18px; color: var(--text-muted);">kg</span></div>
            <div class="stat-label">Poids</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;">184 cm · IMC 24.2</div>
        </div>
    </div>

    <!-- Profil + Evaluation -->
    <div class="grid grid-2-1">
        <div class="card">
            <h2>Profil athlete</h2>
            <div class="stat-row"><span class="label">Age</span><span class="value">42 ans</span></div>
            <div class="stat-row"><span class="label">FC repos</span><span class="value">46 bpm</span></div>
            <div class="stat-row"><span class="label">FC max</span><span class="value">178 bpm</span></div>
            <div class="stat-row"><span class="label">Reserve cardiaque</span><span class="value">132 bpm</span></div>
            <div class="stat-row"><span class="label">VO2max (Garmin)</span><span class="value">45 ml/kg/min</span></div>
            <div class="stat-row"><span class="label">VMA estimee</span><span class="value">~15.0 km/h <span class="badge badge-yellow">a tester</span></span></div>
            <div class="stat-row"><span class="label">Running Stones</span><span class="value">4</span></div>
            <div class="stat-row"><span class="label">Courses depuis 2022</span><span class="value">27</span></div>
            <div class="stat-row"><span class="label">Plus longue course</span><span class="value">65.8 km (Astragale)</span></div>
            <div class="stat-row"><span class="label">Montre</span><span class="value">Garmin Fenix 7 Pro</span></div>
            <div class="stat-row"><span class="label">Batons</span><span class="value">Oui, fluide en montee</span></div>
            <div class="stat-row"><span class="label">Tapis</span><span class="value">+40% / -5%</span></div>
        </div>

        <div class="card">
            <h2>Evaluation /10</h2>
            <div class="stat-row"><span class="label">Progression</span><span class="value text-green">9/10</span></div>
            <div class="stat-row"><span class="label">Mental</span><span class="value text-green">7/10</span></div>
            <div class="stat-row"><span class="label">Gestion d'effort</span><span class="value text-green">7/10</span></div>
            <div class="stat-row"><span class="label">Socle aerobie</span><span class="value text-yellow">6/10</span></div>
            <div class="stat-row"><span class="label">Endurance ultra</span><span class="value text-yellow">6/10</span></div>
            <div class="stat-row"><span class="label">Technique descente</span><span class="value text-yellow">5/10</span></div>
            <div class="stat-row"><span class="label">Regularite entrainement</span><span class="value text-orange">5/10</span></div>
            <div class="stat-row"><span class="label">Puissance montee</span><span class="value text-red">4/10</span></div>
            <div class="stat-row"><span class="label">Resistance musculaire</span><span class="value text-red">4/10</span></div>
            <div class="stat-row"><span class="label">Recuperation</span><span class="value text-red">4/10</span></div>
            <div style="margin-top: 16px; padding-top: 12px; border-top: 2px solid var(--border); text-align: center;">
                <div class="stat-big" style="color: var(--yellow);">5.7<span style="font-size: 16px; color: var(--text-muted);">/10</span></div>
                <div class="stat-label">Note globale</div>
            </div>
        </div>
    </div>

    <!-- Zones FC -->
    <div class="card" style="margin-top: 4px;">
        <h2>Zones de frequence cardiaque</h2>
        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">Methode Karvonen · FC repos 46 · FC max 178 · RFC 132 bpm</p>
        <div class="zone-bar">
            <div class="zone-1" style="width:20%;">Z1 112-125</div>
            <div class="zone-2" style="width:20%;">Z2 125-138</div>
            <div class="zone-3" style="width:20%;">Z3 138-152</div>
            <div class="zone-4" style="width:20%;">Z4 152-165</div>
            <div class="zone-5" style="width:20%;">Z5 165-178</div>
        </div>
    </div>

    <!-- Recommandations -->
    <div class="section-title">Recommandations <span>prioritaires</span></div>

    <div class="note-box">
        <strong>Effet cumule estime des facteurs limitants hors entrainement : -12 a -20% de performance, risque blessure x2-3.</strong><br>
        Corriger ces facteurs = gain equivalent a 1h-2h sur l'OCC, sans aucune seance supplementaire.
    </div>

    <div class="grid grid-3">
        <div class="card">
            <div class="reco-item reco-critical">
                <div class="reco-title">Sommeil : objectif 7h30</div>
                <div class="reco-text">
                    Actuellement <strong>6h03/nuit</strong>. Facteur limitant n1.<br>
                    Risque blessure x1.7. Synthese collagene tronquee. VO2max -3 a -5%.<br><br>
                    <strong>Actions :</strong><br>
                    · Coucher a heure fixe (22h30 max)<br>
                    · Pas d'ecran 30 min avant<br>
                    · Sieste 20 min si dette<br>
                    · Suivi quotidien Fenix 7 Pro
                </div>
            </div>
            <div style="margin-top: 12px;">
                <div class="stat-row"><span class="label">Actuel</span><span class="value text-red">6h03</span></div>
                <div class="stat-row"><span class="label">Objectif S1</span><span class="value text-orange">7h00</span></div>
                <div class="stat-row"><span class="label">Objectif S2+</span><span class="value text-green">7h30</span></div>
                <div class="progress-bar"><div class="fill" style="width: 40%; background: var(--red);"></div></div>
            </div>
        </div>

        <div class="card">
            <div class="reco-item reco-important">
                <div class="reco-title">Alimentation : manger le soir</div>
                <div class="reco-text">
                    Saute diner + souvent petit-dej. Deficit proteique chronique.<br>
                    Besoin : 2800-3500 kcal/j. Proteines : 115-148 g/j.<br><br>
                    <strong>Actions :</strong><br>
                    · Diner CHAQUE soir (30-40g proteines min.)<br>
                    · Petit-dej jours d'entrainement<br>
                    · Post-entrainement : proteines dans les 30 min<br>
                    · Hydratation 2-2.5L/jour
                </div>
            </div>
            <div style="margin-top: 12px;">
                <div class="stat-row"><span class="label">Diner</span><span class="value text-red">Irregulier</span></div>
                <div class="stat-row"><span class="label">Petit-dej</span><span class="value text-orange">Parfois</span></div>
                <div class="stat-row"><span class="label">Objectif</span><span class="value text-green">3 repas/j</span></div>
            </div>
        </div>

        <div class="card">
            <div class="reco-item reco-positive">
                <div class="reco-title">Nicotine : arret le 7 fevrier</div>
                <div class="reco-text">
                    <strong>Passage a 0 mg ce jour.</strong><br>
                    Gain attendu : FC repos -3-5 bpm, VO2max +2-5 ml/kg/min, recuperation amelioree.<br><br>
                    <strong>Calendrier :</strong><br>
                    · 48-72h : vasoconstriction disparait<br>
                    · 2-4 semaines : effet complet VO2max<br>
                    · E-cigarette sans nicotine : OK
                </div>
            </div>
            <div style="margin-top: 12px;">
                <div class="stat-row"><span class="label">Nicotine</span><span class="value text-green">0 mg depuis 07/02</span></div>
                <div class="stat-row"><span class="label">Gain FC repos</span><span class="value text-cyan">42-44 bpm</span></div>
                <div class="stat-row"><span class="label">Gain VO2max</span><span class="value text-cyan">48-50 ml/kg/min</span></div>
            </div>
        </div>
    </div>
</div>

<!-- ======================================================================== -->
<!-- TAB 2 : SEMAINE                                                          -->
<!-- ======================================================================== -->
<div id="week" class="tab-content">

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2 style="margin: 0;">Semaine W07 — 10 au 16 fevrier 2026</h2>
            <span class="badge badge-blue">BLOC 0 — REPRISE & SOIN</span>
        </div>

        <div class="note-box">
            <strong>Objectif :</strong> Soleaire : avancer dans le protocole (phase 1 vers 2). Maintenir le cardio. Installer les nouvelles habitudes (sommeil, alimentation, 0 nicotine).<br>
            <strong>Course a pied :</strong> ZERO. Pas de footing cette semaine.<br>
            <strong>Volume cible :</strong> 5-6h cross-training.
        </div>

        <!-- Habitudes -->
        <div style="margin-bottom: 16px;">
            <h3>Nouvelles habitudes a installer</h3>
            <div class="grid grid-4" style="gap: 10px; margin-top: 8px;">
                <div style="background: var(--bg-card-alt); border-radius: 8px; padding: 10px; text-align: center;">
                    <div style="font-size: 18px;">SOMMEIL</div>
                    <div style="font-size: 12px; font-weight: 600;">Coucher 22h30 max</div>
                    <div style="font-size: 11px; color: var(--text-muted);">Objectif : 7h00/nuit</div>
                </div>
                <div style="background: var(--bg-card-alt); border-radius: 8px; padding: 10px; text-align: center;">
                    <div style="font-size: 18px;">REPAS</div>
                    <div style="font-size: 12px; font-weight: 600;">Diner chaque soir</div>
                    <div style="font-size: 11px; color: var(--text-muted);">30-40g proteines min.</div>
                </div>
                <div style="background: var(--bg-card-alt); border-radius: 8px; padding: 10px; text-align: center;">
                    <div style="font-size: 18px;">NICOTINE</div>
                    <div style="font-size: 12px; font-weight: 600;">0 mg</div>
                    <div style="font-size: 11px; color: var(--red);">Jours 3-9 : les + durs</div>
                </div>
                <div style="background: var(--bg-card-alt); border-radius: 8px; padding: 10px; text-align: center;">
                    <div style="font-size: 18px;">EAU</div>
                    <div style="font-size: 12px; font-weight: 600;">Hydratation 2L+</div>
                    <div style="font-size: 11px; color: var(--text-muted);">Eau + infusions</div>
                </div>
            </div>
        </div>

        <!-- Planning jour par jour -->
        <div class="week-day">
            <div class="day-header">
                <span class="day-name">Lundi 10</span>
                <span class="badge badge-green">Marche active</span>
            </div>
            <div class="day-details">
                <strong>Marche active</strong> — Parcours Champagne court (7-8 km, 150-200 D+)<br>
                <span class="text-blue">Z1 (112-125 bpm)</span> · 1h00 · Creneau midi<br>
                Protocole iso mollets en fin de seance. Pas de trot.
            </div>
        </div>

        <div class="week-day">
            <div class="day-header">
                <span class="day-name">Mardi 11</span>
                <span class="badge badge-blue">Elliptique + PPG</span>
            </div>
            <div class="day-details">
                <strong>Elliptique</strong> 50 min <span class="text-blue">Z1-Z2 (112-138 bpm)</span> + <strong>PPG haut du corps</strong> 30 min<br>
                Pompes 3x12, tractions 3x10, gainage frontal 3x45s, lateral 2x30s, superman 3x12<br>
                Protocole iso mollets apres.
            </div>
        </div>

        <div class="week-day">
            <div class="day-header">
                <span class="day-name">Mercredi 12</span>
                <span class="badge badge-purple">Natation</span>
            </div>
            <div class="day-details">
                <strong>Natation</strong> 45-60 min (~1500-2000 m) <span class="text-blue">Z1-Z2</span><br>
                Crawl principal. Battements moderes — pullbuoy si gene mollet.<br>
                Protocole iso mollets le soir.
            </div>
        </div>

        <div class="week-day">
            <div class="day-header">
                <span class="day-name">Jeudi 13</span>
                <span class="badge badge-blue">Elliptique + Test phase 2</span>
            </div>
            <div class="day-details">
                <strong>Elliptique</strong> 50-60 min <span class="text-green">Z2 (125-138 bpm)</span> — un cran au-dessus<br>
                <strong style="color: var(--yellow);">Test passage phase 2 :</strong> mollet unipodal G x 15 reps lentes.<br>
                Si 0 gene : <span class="text-green">excentrique Stanish</span> (3x10 reps, descente 5s). Sinon : rester phase 1.
            </div>
        </div>

        <div class="week-day">
            <div class="day-header">
                <span class="day-name">Vendredi 14</span>
                <span class="badge badge-green">Marche active</span>
            </div>
            <div class="day-details">
                <strong>Marche active</strong> — Parcours Champagne 45-60 min<br>
                <span class="text-blue">Z1 (112-125 bpm)</span> · Creneau midi<br>
                Tester sensations mollet en montee marchee. Protocole iso ou excentriques selon jeudi.
            </div>
        </div>

        <div class="week-day" style="border-left: 3px solid var(--red);">
            <div class="day-header">
                <span class="day-name">Samedi 15</span>
                <span class="badge badge-red">RETEST + Double seance</span>
            </div>
            <div class="day-details">
                <strong>PPG complete</strong> 40 min (haut + bas du corps doux) + <strong>Natation ou Elliptique</strong> 45-60 min <span class="text-blue">Z1-Z2</span><br>
                <strong style="color: var(--red);">RETEST SAUT UNIPODAL G : 10 sauts, noter /10</strong><br>
                <span class="text-muted">Resultat 7 fev : 4-5/10. Si 2/10 ou moins : footing envisageable W08. Si 3+ : on continue phase 1-2.</span><br>
                <strong style="color: var(--orange);">Point de decision Cabornis (8 mars)</strong>
            </div>
        </div>

        <div class="week-day">
            <div class="day-header">
                <span class="day-name">Dimanche 16</span>
                <span class="badge" style="background: #333; color: #999;">Repos / Souple</span>
            </div>
            <div class="day-details">
                <strong>Repos complet</strong> OU elliptique souple 30 min <span class="text-blue">Z1</span> si Body Battery > 50<br>
                Protocole iso/excentriques. Bilan de la semaine.
            </div>
        </div>

        <!-- Volume resume -->
        <div style="margin-top: 16px; padding: 12px; background: var(--bg-card-alt); border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; font-size: 13px;">
                <span class="text-muted">Volume total cible</span>
                <span class="text-bold">5h30 — 6h30 cross-training</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 13px; margin-top: 4px;">
                <span class="text-muted">Course a pied</span>
                <span class="text-bold text-red">ZERO</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 13px; margin-top: 4px;">
                <span class="text-muted">Seances</span>
                <span class="text-bold">6-7 (2 marche, 2-3 elliptique, 1-2 natation, 2 PPG)</span>
            </div>
        </div>
    </div>

    <!-- Semaine type -->
    <div class="card" style="margin-top: 20px;">
        <h2>Semaine type — Creneaux disponibles</h2>
        <table>
            <tr><th>Jour</th><th>Lieu</th><th>Creneaux</th><th>Contraintes</th></tr>
            <tr><td class="text-bold">Lundi</td><td>Bureau Champagne</td><td>Midi uniquement</td><td class="text-muted">7-8 km / 150-200 D+ ou 12-13 km / 350-400 D+</td></tr>
            <tr><td class="text-bold">Mardi</td><td>Teletravail</td><td>Matin + Midi</td><td class="text-muted">Flexible</td></tr>
            <tr><td class="text-bold">Mercredi</td><td>Teletravail</td><td>Matin + Midi</td><td class="text-muted">Flexible</td></tr>
            <tr><td class="text-bold">Jeudi</td><td>Teletravail</td><td>Matin + Midi</td><td class="text-muted">Flexible</td></tr>
            <tr><td class="text-bold">Vendredi</td><td>Bureau Champagne</td><td>Midi uniquement</td><td class="text-muted">7-8 km / 150-200 D+ ou 12-13 km / 350-400 D+</td></tr>
            <tr><td class="text-bold">Samedi</td><td>Libre</td><td>Toute la journee</td><td class="text-muted">Sortie longue possible</td></tr>
            <tr><td class="text-bold">Dimanche</td><td>Libre</td><td>Matin</td><td class="text-muted">2 enfants — adapter</td></tr>
        </table>
    </div>
</div>

<!-- ======================================================================== -->
<!-- TAB 3 : BLESSURE                                                         -->
<!-- ======================================================================== -->
<div id="injury" class="tab-content">

    <div class="grid grid-2">
        <div class="card">
            <div class="injury-status injury-active">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 700; font-size: 16px;">Soleaire gauche — Episode 4</div>
                        <div style="font-size: 13px; color: var(--text-muted);">Jonction myo-tendineuse · Grade leger</div>
                    </div>
                    <span class="badge badge-red">ACTIF</span>
                </div>
            </div>

            <h3>Bilan du 7 fevrier</h3>
            <div class="stat-row"><span class="label">Palpation</span><span class="value text-green">0/10</span></div>
            <div class="stat-row"><span class="label">Mollets bilateral</span><span class="value text-green">0/10</span></div>
            <div class="stat-row"><span class="label">Mollet unipodal G</span><span class="value text-yellow">~1/10 (gene en haut)</span></div>
            <div class="stat-row"><span class="label">Saut unipodal G</span><span class="value text-red">4-5/10</span></div>
            <div class="stat-row"><span class="label">Marche rapide</span><span class="value text-green">0/10</span></div>

            <h3>Contexte</h3>
            <div class="stat-row"><span class="label">Declencheur</span><span class="value">Raidlight WT (31/01) puis sortie fatiguee (06/02)</span></div>
            <div class="stat-row"><span class="label">Historique</span><span class="value">4 episodes (3x G, 1x D) — fragilite bilaterale chronique</span></div>

            <h3>Observation chronique</h3>
            <div class="note-box">
                Raideur bilaterale systematique a la jonction mollet/soleaire en debut de chaque seance. Pattern chronique = fragilite structurelle permanente. Protocole de prevention a vie, pas uniquement en phase de blessure.
            </div>
        </div>

        <div class="card">
            <h2>Protocole de retour a la course</h2>
            <table>
                <tr><th>Phase</th><th>Critere d'entree</th><th>Contenu</th><th>Statut</th></tr>
                <tr>
                    <td class="text-bold">1 — Isometrique</td>
                    <td>Maintenant</td>
                    <td class="text-muted">Iso mollet 30sx4, bilateral puis unipodal</td>
                    <td><span class="badge badge-blue">EN COURS</span></td>
                </tr>
                <tr>
                    <td class="text-bold">2 — Excentrique</td>
                    <td>Unipodal 15 reps 0 gene</td>
                    <td class="text-muted">Stanish lent + marche pente tapis</td>
                    <td><span class="badge badge-yellow">A VENIR</span></td>
                </tr>
                <tr>
                    <td class="text-bold">3 — Footing</td>
                    <td>Saut unipodal &le; 1/10</td>
                    <td class="text-muted">Tapis plat, 7-8 km/h, 15-20 min</td>
                    <td><span class="badge badge-yellow">A VENIR</span></td>
                </tr>
                <tr>
                    <td class="text-bold">4 — Progression</td>
                    <td>30 min tapis indolore</td>
                    <td class="text-muted">Duree augmentee, intro inclinaison</td>
                    <td><span class="badge badge-yellow">A VENIR</span></td>
                </tr>
                <tr>
                    <td class="text-bold">5 — Validation</td>
                    <td>10 sauts unipodaux 0/10</td>
                    <td class="text-muted">Course normale, reintro D+</td>
                    <td><span class="badge badge-yellow">A VENIR</span></td>
                </tr>
            </table>

            <div class="note-box" style="margin-top: 16px;">
                <strong>Point de decision Cabornis (8 mars) :</strong> retest saut unipodal le 15 fevrier.<br>
                Si phase 3 non atteinte au 20 fevrier : Cabornis annulee.
            </div>

            <h3>Prevention permanente</h3>
            <table>
                <tr><th>Action</th><th>Frequence</th></tr>
                <tr><td>Echauffement obligatoire : 10 min marche + montees mollets progressives</td><td>Avant CHAQUE course</td></tr>
                <tr><td>Isometrique mollet unipodal 4x30s</td><td>Quotidien</td></tr>
                <tr><td>Excentrique Stanish 3x15 reps</td><td>3x / semaine</td></tr>
                <tr><td>Ne JAMAIS courir en fatigue accumulee</td><td>Regle absolue</td></tr>
                <tr><td>Auto-test : 10 sauts unipodaux</td><td>Chaque lundi matin</td></tr>
            </table>

            <h3>Journal de suivi</h3>
            <table>
                <tr><th>Date</th><th>Saut /10</th><th>Unipodal</th><th>Action</th><th>Notes</th></tr>
                <tr><td>7 fev.</td><td class="text-red text-bold">4-5/10</td><td>Gene legere</td><td>Bilan initial, repos course</td><td>Palpation 0, marche OK</td></tr>
                <tr><td class="text-muted">15 fev.</td><td class="text-muted">—</td><td class="text-muted">—</td><td class="text-muted">RETEST prevu</td><td class="text-muted">Point de decision Cabornis</td></tr>
            </table>
        </div>
    </div>

    <!-- Historique blessures -->
    <div class="card" style="margin-top: 20px;">
        <h2>Historique des blessures</h2>
        <table>
            <tr><th>#</th><th>Localisation</th><th>Cote</th><th>Gravite</th><th>Resolution</th></tr>
            <tr><td>1</td><td>Jonction mollet/soleaire</td><td>Gauche</td><td>Modere</td><td class="text-green">Resolu</td></tr>
            <tr><td>2</td><td>Jonction mollet/soleaire</td><td>Gauche</td><td>Modere</td><td class="text-green">Resolu</td></tr>
            <tr><td>3</td><td>Jonction mollet/soleaire</td><td>Droit</td><td>Leger</td><td class="text-green">Resolu</td></tr>
            <tr><td class="text-bold">4</td><td class="text-bold">Jonction mollet/soleaire</td><td class="text-bold">Gauche</td><td class="text-bold">Leger</td><td class="text-red text-bold">En cours</td></tr>
        </table>
    </div>
</div>

<!-- ======================================================================== -->
<!-- TAB : SANTE (Garmin Connect)                                             -->
<!-- ======================================================================== -->
<div id="health" class="tab-content">

    <!-- Garmin header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
            <span style="font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Donnees Garmin Connect</span>
        </div>
        <span class="badge badge-blue" id="garmin-status">Synchro...</span>
    </div>

    <!-- KPI Sante -->
    <div class="grid grid-4" style="margin-bottom: 24px;" id="health-kpi">
        <div class="card" style="text-align: center;">
            <div class="stat-big" id="health-sleep-score" style="color: var(--text-muted);">--</div>
            <div class="stat-label">Score sommeil</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="health-sleep-duration">--</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big" id="health-body-battery" style="color: var(--text-muted);">--</div>
            <div class="stat-label">Body Battery</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="health-bb-detail">--</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big" id="health-vo2max" style="color: var(--text-muted);">--</div>
            <div class="stat-label">VO2max</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;">ml/kg/min</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big" id="health-rhr" style="color: var(--text-muted);">--</div>
            <div class="stat-label">FC repos</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="health-rhr-avg">--</div>
        </div>
    </div>

    <!-- Sommeil detail + VFC/Stress -->
    <div class="grid grid-2">
        <!-- Sommeil -->
        <div class="card">
            <h2>Sommeil</h2>
            <div id="health-sleep-detail">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">Chargement...</div>
            </div>
        </div>

        <!-- VFC + Stress -->
        <div class="card">
            <h2>Variabilite cardiaque & Stress</h2>
            <div id="health-hrv-stress">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">Chargement...</div>
            </div>
        </div>
    </div>

    <!-- Charts 14 jours -->
    <div class="section-title">Tendances <span>14 jours</span></div>

    <div class="grid grid-3">
        <div class="card">
            <h2>FC repos (bpm)</h2>
            <div class="mini-chart" id="chart-rhr"></div>
            <div class="mini-chart-labels" id="chart-rhr-labels"></div>
        </div>
        <div class="card">
            <h2>VFC — Moyenne nocturne (ms)</h2>
            <div class="mini-chart" id="chart-hrv"></div>
            <div class="mini-chart-labels" id="chart-hrv-labels"></div>
        </div>
        <div class="card">
            <h2>Pas quotidiens</h2>
            <div class="mini-chart" id="chart-steps"></div>
            <div class="mini-chart-labels" id="chart-steps-labels"></div>
        </div>
    </div>

    <!-- Body Battery 14j + Sommeil 14j -->
    <div class="grid grid-2">
        <div class="card">
            <h2>Body Battery — 14 jours</h2>
            <div class="mini-chart" id="chart-bb"></div>
            <div class="mini-chart-labels" id="chart-bb-labels"></div>
            <div id="chart-bb-summary" style="margin-top: 12px;"></div>
        </div>
        <div class="card">
            <h2>Sommeil — 14 jours</h2>
            <div class="mini-chart" id="chart-sleep"></div>
            <div class="mini-chart-labels" id="chart-sleep-labels"></div>
            <div id="chart-sleep-summary" style="margin-top: 12px;"></div>
        </div>
    </div>
</div>

<!-- ======================================================================== -->
<!-- TAB 4 : CALENDRIER                                                       -->
<!-- ======================================================================== -->
<div id="calendar" class="tab-content">

    <div class="grid grid-1-2">
        <div class="card">
            <h2>Courses 2026</h2>
            <div class="race-timeline">
                <div class="race-item race-done">
                    <div class="race-date">31 janvier — <span class="badge badge-green">TERMINE</span></div>
                    <div class="race-name">Raidlight Winter Trail</div>
                    <div class="race-details">19 km · 1000 D+ · 3:10:59 · 99e/116</div>
                </div>
                <div class="race-item race-c">
                    <div class="race-date">8 mars — <span class="badge badge-yellow">OBJECTIF C</span></div>
                    <div class="race-name">Cabornis</div>
                    <div class="race-details">25 km · 1000 D+ · Reprise / evaluation</div>
                    <div style="font-size: 12px; color: var(--red); margin-top: 2px;">Conditionne a la guerison soleaire</div>
                </div>
                <div class="race-item race-b">
                    <div class="race-date">26 avril — <span class="badge badge-orange">OBJECTIF B</span></div>
                    <div class="race-name">MMT (Marathon Mistral Trail)</div>
                    <div class="race-details">51 km · 2500 D+ · Test ultra + gestion effort long</div>
                </div>
                <div class="race-item race-b">
                    <div class="race-date">31 mai — <span class="badge badge-orange">OBJECTIF B</span></div>
                    <div class="race-name">Marathon-eXperience</div>
                    <div class="race-details">42 km · 1800 D+ · Allure + nutrition</div>
                </div>
                <div class="race-item race-b">
                    <div class="race-date">14 juin — <span class="badge badge-orange">OBJECTIF B</span></div>
                    <div class="race-name">Monistrail (Saint-Jacques UTMB)</div>
                    <div class="race-details">~53 km · ~1810 D+ · Meme course 2025 (UTMB 451) — etalon</div>
                </div>
                <div class="race-item race-a">
                    <div class="race-date">27 aout — <span class="badge badge-red">OBJECTIF A</span></div>
                    <div class="race-name" style="font-size: 18px;">OCC (UTMB Week)</div>
                    <div class="race-details">57 km · 3500 D+ · 61 m D+/km</div>
                    <div style="font-size: 12px; color: var(--accent-light); margin-top: 2px;">Projection : 10h30 — 12h30 · Cutoff : 14h30</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Periodisation macro</h2>
            <table>
                <tr><th>Bloc</th><th>Periode</th><th>Focus</th><th>Courses</th></tr>
                <tr>
                    <td><span class="badge badge-blue">BLOC 0</span></td>
                    <td>Fev. (actuel)</td>
                    <td>Reprise & soin soleaire. Cross-training. Zero course.<br><span class="text-green text-bold">+ Arret nicotine + sommeil + alimentation</span></td>
                    <td class="text-muted">—</td>
                </tr>
                <tr>
                    <td><span class="badge badge-green">BLOC 1</span></td>
                    <td>Mars</td>
                    <td>Reconstruction volume. Reprise D+ progressive. PPG bas du corps.</td>
                    <td>Cabornis (C)</td>
                </tr>
                <tr>
                    <td><span class="badge badge-yellow">BLOC 2</span></td>
                    <td>Avril</td>
                    <td>Build volume + D+. Sorties longues 3-5h. Seuil en cote.</td>
                    <td>MMT (B)</td>
                </tr>
                <tr>
                    <td><span class="badge badge-orange">BLOC 3</span></td>
                    <td>Mai</td>
                    <td>Build 2. Sorties longues avec fort D+. Nutrition longue duree.</td>
                    <td>MaraXP (B)</td>
                </tr>
                <tr>
                    <td><span class="badge badge-red">BLOC 4</span></td>
                    <td>Juin</td>
                    <td>Specifique OCC. Profil D+/km eleve. Descente technique.</td>
                    <td>Monistrail (B)</td>
                </tr>
                <tr>
                    <td><span class="badge badge-purple">BLOC 5</span></td>
                    <td>Juillet</td>
                    <td>Volume pic. Sorties montagne. Altitude si possible.</td>
                    <td>—</td>
                </tr>
                <tr>
                    <td><span class="badge" style="background:#333; color:#fff;">AFFUT</span></td>
                    <td>Aout</td>
                    <td>Tapering 10-14j. Maintien intensite, volume reduit. Logistique OCC.</td>
                    <td><strong>OCC (A)</strong></td>
                </tr>
            </table>

            <h3>Gap OCC — Le defi cle</h3>
            <table>
                <tr><th>Indicateur</th><th>Tes ultras</th><th>OCC</th><th>Gap</th></tr>
                <tr><td>D+/km</td><td>34 m/km</td><td class="text-red text-bold">61 m/km</td><td class="text-red">x 1.8</td></tr>
                <tr><td>D+ total</td><td>2247 m max</td><td class="text-red text-bold">3500 m</td><td class="text-red">+1253 m</td></tr>
                <tr><td>Altitude</td><td>~1500 m max</td><td class="text-orange text-bold">~2600 m</td><td class="text-orange">a travailler</td></tr>
                <tr><td>Duree effort</td><td>10h53 max</td><td class="text-yellow text-bold">10h30-12h30</td><td class="text-yellow">dans la zone</td></tr>
            </table>
        </div>
    </div>

    <!-- Projection OCC -->
    <div class="section-title">Projection <span>OCC</span></div>

    <div class="grid grid-3">
        <div class="card" style="text-align: center; border-color: var(--green-dark);">
            <div class="stat-label" style="margin-bottom: 8px;">AMBITIEUX</div>
            <div class="stat-big text-green">&lt; 11h</div>
            <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Tout se passe bien, bonne gestion, forme optimale</div>
        </div>
        <div class="card" style="text-align: center; border-color: var(--accent);">
            <div class="stat-label" style="margin-bottom: 8px;">REALISTE</div>
            <div class="stat-big text-blue">11h — 12h</div>
            <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Gestion prudente, forme correcte</div>
        </div>
        <div class="card" style="text-align: center; border-color: var(--orange);">
            <div class="stat-label" style="margin-bottom: 8px;">SECURITE</div>
            <div class="stat-big text-orange">12h — 13h</div>
            <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Conditions difficiles ou forme sous-optimale</div>
        </div>
    </div>

    <!-- Axes de travail -->
    <div class="card" style="margin-top: 20px;">
        <h2>Axes de travail — Par ordre d'impact sur l'OCC</h2>
        <table>
            <tr><th>#</th><th>Axe</th><th>Impact</th><th>Outil principal</th><th>Indicateur de succes</th></tr>
            <tr><td class="text-bold">1</td><td class="text-bold">Specifique montee (D+/km)</td><td><span class="badge badge-red">TRES ELEVE</span></td><td>Tapis 20-40%, cotes terrain</td><td>Confort en Z3 a 25%+ d'inclinaison</td></tr>
            <tr><td class="text-bold">2</td><td class="text-bold">Sommeil &ge; 7h30</td><td><span class="badge badge-red">TRES ELEVE</span></td><td>Discipline + suivi Fenix</td><td>Moyenne Garmin &ge; 7h30</td></tr>
            <tr><td class="text-bold">3</td><td class="text-bold">Alimentation complete</td><td><span class="badge badge-red">TRES ELEVE</span></td><td>Diner systematique</td><td>3 repas/j, 120g+ proteines</td></tr>
            <tr><td class="text-bold">4</td><td class="text-bold">Endurance &gt; 8h</td><td><span class="badge badge-orange">ELEVE</span></td><td>Sorties longues + courses prepa</td><td>MMT et Monistrail boucles</td></tr>
            <tr><td class="text-bold">5</td><td class="text-bold">Prevention soleaire</td><td><span class="badge badge-orange">ELEVE</span></td><td>Protocole quotidien iso + excentriques</td><td>0 episode d'ici l'OCC</td></tr>
            <tr><td class="text-bold">6</td><td class="text-bold">PPG / Renforcement</td><td><span class="badge badge-yellow">MODERE</span></td><td>Musculation 2x/sem</td><td>Excentrique quadri + chaine post.</td></tr>
            <tr><td class="text-bold">7</td><td class="text-bold">Nutrition course &gt; 10h</td><td><span class="badge badge-yellow">MODERE</span></td><td>Tests en sortie longue + courses</td><td>Plan valide a 250-300 kcal/h</td></tr>
            <tr><td class="text-bold">8</td><td class="text-bold">Technique descente</td><td><span class="badge badge-yellow">MODERE</span></td><td>Seances specifiques + tapis -5%</td><td>Aisance en descente technique</td></tr>
        </table>
    </div>
</div>

<!-- ======================================================================== -->
<!-- TAB 5 : PROGRESSION                                                      -->
<!-- ======================================================================== -->
<div id="progress" class="tab-content">

    <div class="card">
        <h2>Progression UTMB Index</h2>
        <div style="display: flex; gap: 40px; align-items: center; margin-bottom: 16px; flex-wrap: wrap;">
            <div style="text-align: center;">
                <div class="stat-big text-red">305</div>
                <div class="stat-label">Nov. 2023</div>
            </div>
            <div style="font-size: 32px; color: var(--text-muted);">&rarr;</div>
            <div style="text-align: center;">
                <div class="stat-big text-green">451</div>
                <div class="stat-label">Juin 2025</div>
            </div>
            <div style="font-size: 14px; color: var(--green); font-weight: 700;">+146 points en 18 mois</div>
        </div>

        <!-- Graphique simplifie en CSS -->
        <div style="display: flex; align-items: flex-end; gap: 4px; height: 120px; margin: 20px 0; padding: 0 4px;">
            <div style="flex:1; background: var(--red); border-radius: 4px 4px 0 0; height: 36%;" title="358 - SainteLyon 2021"></div>
            <div style="flex:1; background: var(--red); border-radius: 4px 4px 0 0; height: 23%;" title="339 - Coursieres 2023"></div>
            <div style="flex:1; background: var(--red); border-radius: 4px 4px 0 0; height: 35%;" title="356 - StJacques 20K 2023"></div>
            <div style="flex:1; background: var(--red); border-radius: 4px 4px 0 0; height: 0%;" title="305 - Veni Vici 2023"></div>
            <div style="flex:1; background: var(--yellow); border-radius: 4px 4px 0 0; height: 78%;" title="419 - Sanglier 2024"></div>
            <div style="flex:1; background: var(--green); border-radius: 4px 4px 0 0; height: 100%;" title="451 - BelMontaise 2024"></div>
            <div style="flex:1; background: var(--orange); border-radius: 4px 4px 0 0; height: 51%;" title="380 - ETC UTMB 2024"></div>
            <div style="flex:1; background: var(--yellow); border-radius: 4px 4px 0 0; height: 88%;" title="433 - Veni Vici 2024"></div>
            <div style="flex:1; background: var(--yellow); border-radius: 4px 4px 0 0; height: 83%;" title="426 - Beaujoltrail 2025"></div>
            <div style="flex:1; background: var(--green); border-radius: 4px 4px 0 0; height: 100%;" title="451 - StJacques 50K 2025"></div>
            <div style="flex:1; background: var(--green); border-radius: 4px 4px 0 0; height: 97%;" title="447 - Nice CdA 2025"></div>
            <div style="flex:1; background: var(--green); border-radius: 4px 4px 0 0; height: 96%;" title="446 - SainteSprint 2025"></div>
            <div style="flex:1; background: var(--yellow); border-radius: 4px 4px 0 0; height: 80%;" title="422 - Astragale 2025"></div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); padding: 0 4px;">
            <span>Nov 21</span><span>Mai 23</span><span>Jun 23</span><span>Nov 23</span><span>Mar 24</span><span>Jul 24</span><span>Aou 24</span><span>Nov 24</span><span>Mai 25</span><span>Jun 25</span><span>Sep 25</span><span>Nov 25</span><span>Dec 25</span>
        </div>

        <table style="margin-top: 20px;">
            <tr><th>Course</th><th>Date</th><th>Distance</th><th>D+</th><th>Temps</th><th>Class.</th><th>UTMB Index</th></tr>
            <tr><td>SainteLyon SaintExpress</td><td>11/2021</td><td>45.9 km</td><td>1000 m</td><td>7:29:00</td><td>2131/2405</td><td><span class="text-red">358</span></td></tr>
            <tr><td>Coursieres 25</td><td>05/2023</td><td>25 km</td><td>990 m</td><td>4:28:57</td><td>331/343</td><td><span class="text-red">339</span></td></tr>
            <tr><td>Saint-Jacques 20K</td><td>06/2023</td><td>18 km</td><td>600 m</td><td>2:36:21</td><td>634/772</td><td><span class="text-red">356</span></td></tr>
            <tr><td>Veni Vici</td><td>11/2023</td><td>27.8 km</td><td>640 m</td><td>4:33:24</td><td>1880/1917</td><td><span class="text-red text-bold">305</span></td></tr>
            <tr><td>Sanglier 15</td><td>03/2024</td><td>15 km</td><td>700 m</td><td>1:55:57</td><td>143/240</td><td><span class="text-yellow">419</span></td></tr>
            <tr><td>Bel'Montaise 15</td><td>07/2024</td><td>15 km</td><td>600 m</td><td>1:34:00</td><td>81/138</td><td><span class="text-green text-bold">451</span></td></tr>
            <tr><td>ETC UTMB (Chamonix)</td><td>08/2024</td><td>15 km</td><td>1200 m</td><td>3:09:30</td><td>636/1182</td><td><span class="text-orange">380</span></td></tr>
            <tr><td>Veni Vici</td><td>11/2024</td><td>27.9 km</td><td>700 m</td><td>3:14:07</td><td>918/2054</td><td><span class="text-yellow">433</span></td></tr>
            <tr><td>Beaujol'trail 32</td><td>05/2025</td><td>32 km</td><td>1410 m</td><td>4:20:05</td><td>162/211</td><td><span class="text-yellow">426</span></td></tr>
            <tr><td class="text-bold">Saint-Jacques 50K</td><td>06/2025</td><td>52.8 km</td><td>1810 m</td><td>7:48:40</td><td>946/1665</td><td><span class="text-green text-bold">451</span></td></tr>
            <tr><td>Nice CdA UTMB</td><td>09/2025</td><td>23 km</td><td>680 m</td><td>2:54:58</td><td>364/1209</td><td><span class="text-green">447</span></td></tr>
            <tr><td>SainteSprint</td><td>11/2025</td><td>25 km</td><td>347 m</td><td>2:30:20</td><td>551/2561</td><td><span class="text-green">446</span></td></tr>
            <tr><td>Astragale (Templiers)</td><td>12/2025</td><td>65.8 km</td><td>2247 m</td><td>10:53:27</td><td>480/677</td><td><span class="text-yellow">422</span></td></tr>
        </table>
    </div>
</div>

<!-- ======================================================================== -->
<!-- TAB 6 : ACTIVITES (Strava)                                               -->
<!-- ======================================================================== -->
<div id="activities" class="tab-content">

    <!-- Summary bar -->
    <div id="activities-summary" style="display: none; margin-bottom: 20px;">
        <div class="grid grid-4" style="gap: 12px;">
            <div class="card" style="text-align: center; padding: 16px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 6px;"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                <div class="stat-big text-green" id="sum-runs" style="font-size: 28px;">0</div>
                <div class="stat-label">Courses</div>
            </div>
            <div class="card" style="text-align: center; padding: 16px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--accent-light)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 6px;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                <div class="stat-big text-blue" id="sum-distance" style="font-size: 28px;">0</div>
                <div class="stat-label">km total</div>
            </div>
            <div class="card" style="text-align: center; padding: 16px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 6px;"><path d="M8 3l4 8 5-5 5 15H2L8 3z"/></svg>
                <div class="stat-big text-orange" id="sum-elevation" style="font-size: 28px;">0</div>
                <div class="stat-label">D+ total</div>
            </div>
            <div class="card" style="text-align: center; padding: 16px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--purple)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 6px;"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
                <div class="stat-big text-purple" id="sum-time" style="font-size: 28px;">0h</div>
                <div class="stat-label">Temps total</div>
            </div>
        </div>
    </div>

    <!-- Strava header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            <span style="font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Activites Strava + Garmin</span>
        </div>
        <span class="badge badge-orange" id="strava-status">Synchro...</span>
    </div>

    <div id="activities-list">
        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <div style="font-size: 14px;">Chargement des activites...</div>
        </div>
    </div>
</div>

<!-- ===== FOOTER ===== -->
<footer>
    Coach Trail — Yohann Tschudi — Preparation OCC 2026<br>
    Donnees : Garmin Connect · UTMB World · BeTrail · Strava<br>
    Suivi versionne avec Git · Derniere mise a jour : 7 fevrier 2026
</footer>

<!-- ===== JAVASCRIPT ===== -->
<script>
// ===== TAB NAVIGATION =====
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
        history.replaceState(null, null, '#' + btn.dataset.tab);
    });
});

// Handle URL hash on load
const hash = location.hash.slice(1);
if (hash) {
    const btn = document.querySelector('[data-tab="' + hash + '"]');
    if (btn) btn.click();
}

// ===== SVG ICONS =====
const SVG = {
    run: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="2"/><path d="M7 21l3-7 2.5 2 4.5-6"/><path d="M10 14l-2 3"/><path d="M17 8l-4.5 6"/></svg>',
    trail: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3l4 8 5-5 5 15H2L8 3z"/><circle cx="17" cy="5" r="2"/></svg>',
    swim: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18c2-1 4 1 6 0s4-1 6 0 4 1 6 0"/><path d="M2 14c2-1 4 1 6 0s4-1 6 0 4 1 6 0"/><circle cx="8" cy="6" r="2"/><path d="M10 6l4 4-3 3"/></svg>',
    elliptical: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="12" rx="8" ry="5"/><circle cx="12" cy="12" r="2"/><line x1="12" y1="2" x2="12" y2="7"/><line x1="12" y1="17" x2="12" y2="22"/></svg>',
    walk: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="2"/><path d="M10 21l1-7 3 3 3-8"/><path d="M11 14l-3 7"/></svg>',
    workout: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 5v14"/><path d="M18 5v14"/><path d="M6 12h12"/><rect x="3" y="7" width="2" height="10" rx="1"/><rect x="19" y="7" width="2" height="10" rx="1"/></svg>',
    default: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
    distance: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6l-6 6-6-6"/><path d="M18 18l-6-6-6 6"/></svg>',
    elevation: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3l4 8 5-5 5 15H2L8 3z"/></svg>',
    clock: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
    heart: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>',
    pace: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
};

const TYPES = {
    'TrailRun':       { icon: 'trail',   iconClass: 'trail',      label: 'TRAIL',        color: 'var(--orange)' },
    'Run':            { icon: 'run',     iconClass: 'run',        label: 'COURSE',       color: 'var(--green)' },
    'Treadmill':      { icon: 'run',     iconClass: 'elliptical', label: 'TAPIS',        color: 'var(--purple)' },
    'Walk':           { icon: 'walk',    iconClass: 'walk',       label: 'MARCHE',       color: 'var(--yellow)' },
    'Hike':           { icon: 'walk',    iconClass: 'walk',       label: 'RANDO',        color: 'var(--yellow)' },
    'Swim':           { icon: 'swim',    iconClass: 'swim',       label: 'NATATION',     color: 'var(--cyan)' },
    'Elliptical':     { icon: 'elliptical', iconClass: 'elliptical', label: 'ELLIPTIQUE', color: 'var(--purple)' },
    'WeightTraining': { icon: 'workout', iconClass: 'workout',    label: 'MUSCU',        color: 'var(--orange)' },
    'Workout':        { icon: 'workout', iconClass: 'workout',    label: 'PPG',          color: 'var(--orange)' },
};

// Garmin typeKey → unified type
const GARMIN_TYPE_MAP = {
    'running':            'Run',
    'trail_running':      'TrailRun',
    'treadmill_running':  'Treadmill',
    'walking':            'Walk',
    'hiking':             'Hike',
    'swimming':           'Swim',
    'lap_swimming':       'Swim',
    'open_water_swimming':'Swim',
    'elliptical':         'Elliptical',
    'strength_training':  'WeightTraining',
    'cardio':             'Workout',
    'yoga':               'Workout',
    'other':              'Workout',
};

function detectType(act) {
    const st = act.sport_type || act.type;
    // Treadmill detection: Run with D+=0, or named "My Workout"/"Manual Workout"
    if (st === 'Run') {
        const name = (act.name || '').toLowerCase();
        const isTreadmill = act.total_elevation_gain === 0
            || name.includes('workout')
            || name.includes('tapis')
            || name.includes('treadmill');
        if (isTreadmill) return 'Treadmill';
    }
    return st;
}

function fmtSwimPace(distance, movingTime) {
    if (!distance || distance === 0) return '-';
    const secPer100 = movingTime / (distance / 100);
    const min = Math.floor(secPer100 / 60);
    const sec = Math.round(secPer100 % 60);
    return min + ':' + String(sec).padStart(2, '0') + '/100m';
}

// FC zones for coloring
const FC_ZONES = [
    { max: 112, label: 'Repos',  bg: '#1e3a5f', color: '#60a5fa' },
    { max: 125, label: 'Z1',     bg: '#1e3a5f', color: '#3b82f6' },
    { max: 138, label: 'Z2',     bg: '#0a2e1a', color: '#22c55e' },
    { max: 152, label: 'Z3',     bg: '#2d2206', color: '#eab308' },
    { max: 165, label: 'Z4',     bg: '#3d1c08', color: '#f97316' },
    { max: 999, label: 'Z5',     bg: '#3d0a0a', color: '#ef4444' },
];

function getZone(hr) {
    if (!hr) return null;
    return FC_ZONES.find(z => hr <= z.max);
}

function fmt(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    return h > 0 ? h + 'h' + String(m).padStart(2, '0') : m + 'min';
}

function fmtPace(mps) {
    if (!mps || mps === 0) return '-';
    const spk = 1000 / mps;
    return Math.floor(spk / 60) + ':' + String(Math.round(spk % 60)).padStart(2, '0') + '/km';
}

function fmtDate(s) {
    const d = new Date(s);
    return d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
}

function fmtDateShort(s) {
    const d = new Date(s);
    return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
}

function loadActivities() {
    const stravaP = fetch('data/strava-activities.json').then(r => r.ok ? r.json() : []).catch(() => []);
    const garminP = fetch('data/garmin-activities.json').then(r => r.ok ? r.json() : []).catch(() => []);

    Promise.all([stravaP, garminP]).then(([stravaActs, garminActs]) => {
        // Normalize Garmin activities to match Strava format
        const garminNorm = (garminActs || []).map(ga => {
            const unified = GARMIN_TYPE_MAP[ga.type] || 'Workout';
            return {
                name: ga.name,
                type: unified,
                sport_type: unified,
                start_date_local: ga.start_date_local,
                distance: ga.distance || 0,
                moving_time: ga.moving_time || 0,
                elapsed_time: ga.elapsed_time || 0,
                total_elevation_gain: ga.total_elevation_gain || 0,
                average_speed: ga.average_speed || 0,
                average_heartrate: ga.average_heartrate,
                max_heartrate: ga.max_heartrate,
                source: 'garmin',
                _garmin_type: ga.type,
            };
        });

        // Deduplicate: if Strava has an activity within 2h of a Garmin activity of similar type, skip the Garmin one
        const stravaKeys = new Set();
        (stravaActs || []).forEach(sa => {
            const d = new Date(sa.start_date_local).getTime();
            stravaKeys.add(Math.round(d / 7200000)); // 2h buckets
        });

        const garminOnly = garminNorm.filter(ga => {
            const d = new Date(ga.start_date_local).getTime();
            const bucket = Math.round(d / 7200000);
            return !stravaKeys.has(bucket);
        });

        // Merge and sort by date (newest first)
        const all = [...(stravaActs || []).map(a => ({...a, source: 'strava'})), ...garminOnly];
        all.sort((a, b) => new Date(b.start_date_local) - new Date(a.start_date_local));

        if (all.length === 0) {
            document.getElementById('activities-list').innerHTML =
                '<div style="text-align:center;padding:40px;color:var(--text-muted);">' +
                '<div style="font-size:14px;">Pas encore de donnees.</div></div>';
            return;
        }

        const list = document.getElementById('activities-list');
        const summary = document.getElementById('activities-summary');
        list.innerHTML = '';

        let totalRuns = 0, totalDist = 0, totalElev = 0, totalTime = 0;
        let currentDate = '';

        all.forEach(act => {
            const st = detectType(act);
            const t = TYPES[st] || { icon: 'default', iconClass: 'default', label: st.toUpperCase(), color: 'var(--accent-light)' };
            const dist = (act.distance / 1000).toFixed(1);
            const elev = Math.round(act.total_elevation_gain || 0);
            const isRun = st === 'Run' || st === 'TrailRun' || st === 'Treadmill';
            const isSwim = st === 'Swim';
            const zone = getZone(act.average_heartrate);
            const dateKey = fmtDate(act.start_date_local);

            if (isRun) totalRuns++;
            totalDist += act.distance / 1000;
            totalElev += act.total_elevation_gain || 0;
            totalTime += act.moving_time || 0;

            // Date separator
            if (dateKey !== currentDate) {
                currentDate = dateKey;
                list.innerHTML += '<div style="font-size:12px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; padding:16px 0 6px; border-bottom:1px solid var(--border); margin-bottom:8px;">' + dateKey + '</div>';
            }

            // Source badge
            const srcBadge = act.source === 'garmin' ? ' <span style="font-size:9px;color:var(--text-muted);font-weight:400;">GARMIN</span>' : '';

            let stats = '';
            if (act.distance > 0) stats += '<div class="act-stat"><div class="act-stat-value">' + dist + '<span style="font-size:11px;font-weight:400;color:var(--text-muted);"> km</span></div><div class="act-stat-label">Distance</div></div>';
            if (elev > 0) stats += '<div class="act-stat"><div class="act-stat-value text-orange">' + elev + '<span style="font-size:11px;font-weight:400;color:var(--text-muted);"> m</span></div><div class="act-stat-label">D+</div></div>';
            stats += '<div class="act-stat"><div class="act-stat-value">' + fmt(act.moving_time) + '</div><div class="act-stat-label">Duree</div></div>';
            if (act.average_heartrate) {
                const zHtml = zone ? '<span class="act-zone" style="background:' + zone.bg + ';color:' + zone.color + ';">' + zone.label + '</span>' : '';
                stats += '<div class="act-stat"><div class="act-stat-value" style="color:' + (zone ? zone.color : 'var(--text)') + ';">' + Math.round(act.average_heartrate) + '<span style="font-size:11px;font-weight:400;"> bpm</span>' + zHtml + '</div><div class="act-stat-label">FC moy</div></div>';
            }
            if (isRun && act.average_speed) stats += '<div class="act-stat"><div class="act-stat-value">' + fmtPace(act.average_speed) + '</div><div class="act-stat-label">Allure</div></div>';
            if (isSwim && act.distance > 0) stats += '<div class="act-stat"><div class="act-stat-value text-cyan">' + fmtSwimPace(act.distance, act.moving_time) + '</div><div class="act-stat-label">Allure /100m</div></div>';

            list.innerHTML +=
                '<div class="activity-card">' +
                    '<div class="act-icon ' + t.iconClass + '">' + SVG[t.icon] + '</div>' +
                    '<div class="act-body">' +
                        '<div class="act-header">' +
                            '<div><span class="act-name">' + act.name + '</span></div>' +
                            '<div class="act-meta"><span class="act-type-label" style="color:' + t.color + ';">' + t.label + '</span>' + srcBadge + '</div>' +
                        '</div>' +
                        '<div class="act-stats">' + stats + '</div>' +
                    '</div>' +
                '</div>';
        });

        document.getElementById('sum-runs').textContent = totalRuns;
        document.getElementById('sum-distance').textContent = Math.round(totalDist);
        document.getElementById('sum-elevation').textContent = Math.round(totalElev);
        document.getElementById('sum-time').textContent = Math.round(totalTime / 3600) + 'h';
        summary.style.display = 'block';

        document.getElementById('strava-status').className = 'badge badge-green';
        document.getElementById('strava-status').textContent = 'Strava + Garmin OK';
    });
}

loadActivities();

// ===== GARMIN WELLNESS DATA =====
function fmtSeconds(s) {
    if (!s || s <= 0) return '--';
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    return h + 'h' + String(m).padStart(2, '0');
}

function fmtDateLabel(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }).replace('.', '');
}

function fmtDateDay(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return String(d.getDate());
}

function sleepScoreColor(score) {
    if (!score) return 'var(--text-muted)';
    if (score >= 80) return 'var(--green)';
    if (score >= 60) return 'var(--yellow)';
    if (score >= 40) return 'var(--orange)';
    return 'var(--red)';
}

function bbColor(val) {
    if (!val) return 'var(--text-muted)';
    if (val >= 70) return 'var(--green)';
    if (val >= 40) return 'var(--yellow)';
    if (val >= 20) return 'var(--orange)';
    return 'var(--red)';
}

function rhrColor(val) {
    if (!val) return 'var(--text-muted)';
    if (val <= 48) return 'var(--green)';
    if (val <= 55) return 'var(--yellow)';
    return 'var(--orange)';
}

function stressColor(val) {
    if (!val) return 'var(--text-muted)';
    if (val <= 25) return 'var(--green)';
    if (val <= 50) return 'var(--yellow)';
    if (val <= 75) return 'var(--orange)';
    return 'var(--red)';
}

function hrvStatusBadge(status) {
    if (!status || status === 'UNKNOWN') return '<span class="hrv-status-badge" style="background:#333;color:#999;">INCONNU</span>';
    const map = {
        'BALANCED': { bg: 'var(--green-dark)', color: 'var(--green)', label: 'EQUILIBRE' },
        'UNBALANCED': { bg: '#854d0e', color: 'var(--yellow)', label: 'DESEQUILIBRE' },
        'LOW': { bg: 'var(--red-dark)', color: '#fca5a5', label: 'BAS' },
        'POOR': { bg: 'var(--red-dark)', color: '#fca5a5', label: 'FAIBLE' },
    };
    const s = map[status] || { bg: '#333', color: '#999', label: status };
    return '<span class="hrv-status-badge" style="background:' + s.bg + ';color:' + s.color + ';">' + s.label + '</span>';
}

function renderMiniChart(containerId, labelsId, values, colorFn, unit) {
    const container = document.getElementById(containerId);
    const labelsEl = document.getElementById(labelsId);
    if (!container) return;

    const validValues = values.filter(v => v.value != null && v.value > 0);
    if (validValues.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:12px;width:100%;">Pas de donnees</div>';
        return;
    }

    const nums = validValues.map(v => v.value);
    const maxVal = Math.max(...nums);
    const minVal = Math.min(...nums);
    const range = maxVal - minVal || 1;

    let html = '';
    values.forEach(v => {
        if (v.value != null && v.value > 0) {
            const pct = 15 + ((v.value - minVal) / range) * 85;
            const color = colorFn ? colorFn(v.value) : 'var(--accent)';
            html += '<div class="bar" style="height:' + pct + '%;background:' + color + ';" title="' + v.label + ': ' + v.value + (unit || '') + '"></div>';
        } else {
            html += '<div class="bar" style="height:5%;background:var(--border);opacity:0.3;" title="' + v.label + ': --"></div>';
        }
    });
    container.innerHTML = html;

    if (labelsEl && values.length > 0) {
        labelsEl.innerHTML = '<span>' + values[0].shortLabel + '</span><span>' + values[values.length - 1].shortLabel + '</span>';
    }
}

function sleepColor(seconds) {
    if (!seconds) return 'var(--text-muted)';
    const h = seconds / 3600;
    if (h >= 7.5) return 'var(--green)';
    if (h >= 7) return 'var(--yellow)';
    if (h >= 6) return 'var(--orange)';
    return 'var(--red)';
}

function stepsColor(steps) {
    if (!steps) return 'var(--text-muted)';
    if (steps >= 10000) return 'var(--green)';
    if (steps >= 7000) return 'var(--yellow)';
    if (steps >= 5000) return 'var(--orange)';
    return 'var(--red)';
}

function loadGarminData() {
    fetch('data/garmin-wellness.json')
        .then(r => { if (!r.ok) throw new Error('No data'); return r.json(); })
        .then(data => {
            const sum = data.summary;
            const days = data.days || [];

            // ===== KPI SANTE =====
            // Sleep score
            const scoreEl = document.getElementById('health-sleep-score');
            if (sum.sleep_score) {
                scoreEl.textContent = sum.sleep_score;
                scoreEl.style.color = sleepScoreColor(sum.sleep_score);
            }
            const sleepDurEl = document.getElementById('health-sleep-duration');
            if (sum.sleep_avg_seconds) {
                sleepDurEl.textContent = 'Moy. ' + fmtSeconds(sum.sleep_avg_seconds) + ' / nuit';
            }

            // Body Battery
            const bbEl = document.getElementById('health-body-battery');
            if (sum.body_battery_current) {
                bbEl.textContent = sum.body_battery_current;
                bbEl.style.color = bbColor(sum.body_battery_current);
            }
            const bbDetail = document.getElementById('health-bb-detail');
            if (sum.body_battery_current) bbDetail.textContent = 'Pic du jour';

            // VO2max
            const vo2El = document.getElementById('health-vo2max');
            if (sum.vo2max) {
                vo2El.textContent = sum.vo2max;
                vo2El.style.color = 'var(--green)';
            }

            // RHR
            const rhrEl = document.getElementById('health-rhr');
            if (sum.resting_hr) {
                rhrEl.textContent = sum.resting_hr;
                rhrEl.style.color = rhrColor(sum.resting_hr);
            }
            const rhrAvgEl = document.getElementById('health-rhr-avg');
            if (sum.resting_hr_avg) rhrAvgEl.textContent = 'Moy. 14j : ' + sum.resting_hr_avg + ' bpm';

            // ===== UPDATE OVERVIEW KPIs =====
            if (sum.vo2max) {
                const ov = document.getElementById('kpi-vo2max');
                if (ov) ov.textContent = sum.vo2max;
                const ovSub = document.getElementById('kpi-vo2max-sub');
                if (ovSub) ovSub.textContent = 'Garmin · ' + sum.last_sync.split(' ')[0];
            }
            if (sum.sleep_avg_seconds) {
                const slEl = document.getElementById('kpi-sleep');
                if (slEl) {
                    slEl.textContent = fmtSeconds(sum.sleep_avg_seconds);
                    const h = sum.sleep_avg_seconds / 3600;
                    slEl.style.color = h >= 7.5 ? 'var(--green)' : h >= 7 ? 'var(--yellow)' : h >= 6 ? 'var(--orange)' : 'var(--red)';
                }
                const slSub = document.getElementById('kpi-sleep-sub');
                if (slSub) {
                    const h = sum.sleep_avg_seconds / 3600;
                    slSub.textContent = 'Objectif : 7h30';
                    slSub.style.color = h >= 7.5 ? 'var(--green)' : 'var(--red)';
                }
            }

            // ===== SOMMEIL DETAIL =====
            const sleepDetail = document.getElementById('health-sleep-detail');
            const latestSleep = findLatest(days, 'sleep');
            if (latestSleep && latestSleep.sleep) {
                const sl = latestSleep.sleep;
                const total = sl.duration_seconds || 1;
                const deepPct = Math.round(sl.deep_seconds / total * 100);
                const lightPct = Math.round(sl.light_seconds / total * 100);
                const remPct = Math.round(sl.rem_seconds / total * 100);
                const awakePct = Math.max(0, 100 - deepPct - lightPct - remPct);

                let html = '<div style="margin-bottom:12px;"><span style="font-size:11px;color:var(--text-muted);">Derniere nuit (' + fmtDateLabel(latestSleep.date) + ')</span></div>';
                html += '<div style="text-align:center;margin-bottom:12px;"><span style="font-size:28px;font-weight:700;color:' + sleepColor(total) + ';">' + fmtSeconds(total) + '</span>';
                if (sl.score) html += ' <span style="font-size:14px;color:' + sleepScoreColor(sl.score) + ';font-weight:600;">Score ' + sl.score + '</span>';
                html += '</div>';

                // Phases bar
                html += '<div class="sleep-phases-bar">';
                if (deepPct > 0) html += '<div class="sleep-deep" style="width:' + deepPct + '%;">' + (deepPct >= 10 ? deepPct + '%' : '') + '</div>';
                if (lightPct > 0) html += '<div class="sleep-light" style="width:' + lightPct + '%;">' + (lightPct >= 10 ? lightPct + '%' : '') + '</div>';
                if (remPct > 0) html += '<div class="sleep-rem" style="width:' + remPct + '%;">' + (remPct >= 10 ? remPct + '%' : '') + '</div>';
                if (awakePct > 0) html += '<div class="sleep-awake" style="width:' + awakePct + '%;">' + (awakePct >= 10 ? awakePct + '%' : '') + '</div>';
                html += '</div>';

                // Legend
                html += '<div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:8px;font-size:12px;">';
                html += '<span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#1e3a8a;margin-right:4px;"></span>Profond ' + fmtSeconds(sl.deep_seconds) + '</span>';
                html += '<span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#3b82f6;margin-right:4px;"></span>Leger ' + fmtSeconds(sl.light_seconds) + '</span>';
                html += '<span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#8b5cf6;margin-right:4px;"></span>REM ' + fmtSeconds(sl.rem_seconds) + '</span>';
                html += '<span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#f97316;margin-right:4px;"></span>Eveil ' + fmtSeconds(sl.awake_seconds) + '</span>';
                html += '</div>';

                // 7-day trend
                const last7 = days.slice(-7);
                const sleepDurs = last7.filter(d => d.sleep && d.sleep.duration_seconds > 0).map(d => d.sleep.duration_seconds);
                if (sleepDurs.length > 0) {
                    const avg = Math.round(sleepDurs.reduce((a, b) => a + b, 0) / sleepDurs.length);
                    html += '<div style="margin-top:16px;padding:10px;background:var(--bg-card-alt);border-radius:8px;">';
                    html += '<div style="display:flex;justify-content:space-between;font-size:13px;">';
                    html += '<span class="text-muted">Moyenne 7 jours</span>';
                    html += '<span style="font-weight:700;color:' + sleepColor(avg) + ';">' + fmtSeconds(avg) + '</span>';
                    html += '</div>';
                    html += '<div style="display:flex;justify-content:space-between;font-size:13px;margin-top:4px;">';
                    html += '<span class="text-muted">Objectif</span>';
                    html += '<span style="font-weight:700;color:var(--green);">7h30</span>';
                    html += '</div></div>';
                }

                sleepDetail.innerHTML = html;
            } else {
                sleepDetail.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Pas de donnees sommeil</div>';
            }

            // ===== VFC + STRESS =====
            const hrvStress = document.getElementById('health-hrv-stress');
            const latestHrv = findLatest(days, 'hrv');
            const latestStress = findLatest(days, 'stress');
            let hrvHtml = '';

            if (latestHrv && latestHrv.hrv) {
                const h = latestHrv.hrv;
                hrvHtml += '<div style="margin-bottom:16px;">';
                hrvHtml += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">';
                hrvHtml += '<span style="font-size:13px;color:var(--text-muted);">Statut VFC</span>';
                hrvHtml += hrvStatusBadge(h.status);
                hrvHtml += '</div>';

                hrvHtml += '<div class="health-metric">';
                hrvHtml += '<div class="health-metric-icon" style="background:linear-gradient(135deg,#581c87,#a855f7);">';
                hrvHtml += '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>';
                hrvHtml += '</div>';
                hrvHtml += '<div><div class="health-metric-value text-purple">' + (h.weekly_avg || '--') + ' <span style="font-size:12px;font-weight:400;color:var(--text-muted);">ms</span></div>';
                hrvHtml += '<div class="health-metric-label">Moyenne hebdo</div></div>';
                hrvHtml += '</div>';

                hrvHtml += '<div class="health-metric">';
                hrvHtml += '<div class="health-metric-icon" style="background:linear-gradient(135deg,#4338ca,#818cf8);">';
                hrvHtml += '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M12 2a5 5 0 015 5c0 6-5 8-5 13-2-3-5-7-5-13a5 5 0 015-5z"/></svg>';
                hrvHtml += '</div>';
                hrvHtml += '<div><div class="health-metric-value" style="color:#818cf8;">' + (h.last_night_avg || '--') + ' <span style="font-size:12px;font-weight:400;color:var(--text-muted);">ms</span></div>';
                hrvHtml += '<div class="health-metric-label">Derniere nuit</div></div>';
                hrvHtml += '</div>';

                if (h.baseline_balanced_low && h.baseline_balanced_upper) {
                    hrvHtml += '<div style="font-size:12px;color:var(--text-muted);margin-top:8px;">Baseline : ' + h.baseline_balanced_low + ' — ' + h.baseline_balanced_upper + ' ms</div>';
                }
            }

            if (latestStress && latestStress.stress) {
                const st = latestStress.stress;
                hrvHtml += '<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">';
                hrvHtml += '<div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:12px;">Stress (' + fmtDateLabel(latestStress.date) + ')</div>';

                hrvHtml += '<div class="health-metric">';
                hrvHtml += '<div class="health-metric-icon" style="background:linear-gradient(135deg,#9a3412,#f97316);">';
                hrvHtml += '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M12 2v6M12 18v4M4.93 4.93l4.24 4.24M14.83 14.83l4.24 4.24M2 12h6M18 12h4M4.93 19.07l4.24-4.24M14.83 9.17l4.24-4.24"/></svg>';
                hrvHtml += '</div>';
                hrvHtml += '<div><div class="health-metric-value" style="color:' + stressColor(st.avg) + ';">' + (st.avg || '--') + '</div>';
                hrvHtml += '<div class="health-metric-label">Niveau moyen</div></div>';
                hrvHtml += '</div>';

                // Stress durations
                const restH = st.rest_stress_duration ? Math.round(st.rest_stress_duration / 60) : 0;
                const lowH = st.low_stress_duration ? Math.round(st.low_stress_duration / 60) : 0;
                const medH = st.medium_stress_duration ? Math.round(st.medium_stress_duration / 60) : 0;
                const highH = st.high_stress_duration ? Math.round(st.high_stress_duration / 60) : 0;
                const totalStressMin = restH + lowH + medH + highH || 1;

                hrvHtml += '<div style="display:flex;height:20px;border-radius:4px;overflow:hidden;margin-top:8px;">';
                if (restH > 0) hrvHtml += '<div style="width:' + (restH / totalStressMin * 100) + '%;background:var(--green);" title="Repos ' + restH + ' min"></div>';
                if (lowH > 0) hrvHtml += '<div style="width:' + (lowH / totalStressMin * 100) + '%;background:var(--yellow);" title="Bas ' + lowH + ' min"></div>';
                if (medH > 0) hrvHtml += '<div style="width:' + (medH / totalStressMin * 100) + '%;background:var(--orange);" title="Moyen ' + medH + ' min"></div>';
                if (highH > 0) hrvHtml += '<div style="width:' + (highH / totalStressMin * 100) + '%;background:var(--red);" title="Eleve ' + highH + ' min"></div>';
                hrvHtml += '</div>';

                hrvHtml += '<div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:6px;font-size:11px;">';
                hrvHtml += '<span><span style="color:var(--green);">●</span> Repos ' + restH + 'm</span>';
                hrvHtml += '<span><span style="color:var(--yellow);">●</span> Bas ' + lowH + 'm</span>';
                hrvHtml += '<span><span style="color:var(--orange);">●</span> Moyen ' + medH + 'm</span>';
                hrvHtml += '<span><span style="color:var(--red);">●</span> Eleve ' + highH + 'm</span>';
                hrvHtml += '</div>';
                hrvHtml += '</div>';
            }

            if (!hrvHtml) hrvHtml = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Pas de donnees VFC/stress</div>';
            hrvStress.innerHTML = hrvHtml;

            // ===== CHARTS 14 JOURS =====
            // FC repos
            renderMiniChart('chart-rhr', 'chart-rhr-labels',
                days.map(d => ({ value: d.resting_hr, label: fmtDateLabel(d.date), shortLabel: fmtDateDay(d.date) })),
                rhrColor, ' bpm'
            );

            // VFC
            renderMiniChart('chart-hrv', 'chart-hrv-labels',
                days.map(d => ({ value: d.hrv ? d.hrv.last_night_avg : null, label: fmtDateLabel(d.date), shortLabel: fmtDateDay(d.date) })),
                function(v) { return v >= 50 ? 'var(--green)' : v >= 30 ? 'var(--yellow)' : 'var(--orange)'; }, ' ms'
            );

            // Pas
            renderMiniChart('chart-steps', 'chart-steps-labels',
                days.map(d => ({ value: d.steps, label: fmtDateLabel(d.date), shortLabel: fmtDateDay(d.date) })),
                stepsColor, ''
            );

            // Body Battery
            renderMiniChart('chart-bb', 'chart-bb-labels',
                days.map(d => ({ value: d.body_battery ? d.body_battery.highest : null, label: fmtDateLabel(d.date), shortLabel: fmtDateDay(d.date) })),
                bbColor, ''
            );
            // BB summary
            const bbSummaryEl = document.getElementById('chart-bb-summary');
            const bbDays = days.filter(d => d.body_battery);
            if (bbDays.length > 0 && bbSummaryEl) {
                const avgHigh = Math.round(bbDays.reduce((a, d) => a + d.body_battery.highest, 0) / bbDays.length);
                const avgLow = Math.round(bbDays.reduce((a, d) => a + d.body_battery.lowest, 0) / bbDays.length);
                bbSummaryEl.innerHTML = '<div style="display:flex;justify-content:space-around;font-size:12px;">' +
                    '<div style="text-align:center;"><div style="font-weight:700;color:' + bbColor(avgHigh) + ';">' + avgHigh + '</div><div class="text-muted">Pic moy.</div></div>' +
                    '<div style="text-align:center;"><div style="font-weight:700;color:' + bbColor(avgLow) + ';">' + avgLow + '</div><div class="text-muted">Min moy.</div></div>' +
                    '</div>';
            }

            // Sleep 14j
            renderMiniChart('chart-sleep', 'chart-sleep-labels',
                days.map(d => ({ value: d.sleep ? Math.round(d.sleep.duration_seconds / 60) : null, label: fmtDateLabel(d.date), shortLabel: fmtDateDay(d.date) })),
                function(mins) { return sleepColor(mins * 60); }, ' min'
            );
            // Sleep summary
            const sleepSummaryEl = document.getElementById('chart-sleep-summary');
            const sleepDays = days.filter(d => d.sleep && d.sleep.duration_seconds > 0);
            if (sleepDays.length > 0 && sleepSummaryEl) {
                const avgSec = Math.round(sleepDays.reduce((a, d) => a + d.sleep.duration_seconds, 0) / sleepDays.length);
                const scores = sleepDays.filter(d => d.sleep.score > 0).map(d => d.sleep.score);
                const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : null;
                sleepSummaryEl.innerHTML = '<div style="display:flex;justify-content:space-around;font-size:12px;">' +
                    '<div style="text-align:center;"><div style="font-weight:700;color:' + sleepColor(avgSec) + ';">' + fmtSeconds(avgSec) + '</div><div class="text-muted">Duree moy.</div></div>' +
                    (avgScore ? '<div style="text-align:center;"><div style="font-weight:700;color:' + sleepScoreColor(avgScore) + ';">' + avgScore + '</div><div class="text-muted">Score moy.</div></div>' : '') +
                    '</div>';
            }

            // Status badge
            document.getElementById('garmin-status').className = 'badge badge-green';
            document.getElementById('garmin-status').textContent = 'Synchro OK · ' + sum.last_sync;
        })
        .catch(() => {
            document.getElementById('garmin-status').className = 'badge badge-yellow';
            document.getElementById('garmin-status').textContent = 'Pas de donnees';
            document.getElementById('health-sleep-detail').innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Pas encore de donnees Garmin.<br><span style="font-size:12px;">Configure les secrets GARMIN_EMAIL / GARMIN_PASSWORD<br>et lance le workflow GitHub Actions.</span></div>';
            document.getElementById('health-hrv-stress').innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Pas encore de donnees Garmin.</div>';
        });
}

function findLatest(days, key) {
    for (let i = days.length - 1; i >= 0; i--) {
        if (days[i][key]) return days[i];
    }
    return null;
}

loadGarminData();

// ===== SYNC BUTTON =====
const SYNC_REPO = 'dreamskid/coach-trail';
const SYNC_WORKFLOW = 'sync-strava.yml';
const SYNC_STALE_HOURS = 6;

function getSyncToken() { return localStorage.getItem('gh_sync_token'); }
function setSyncToken(t) { localStorage.setItem('gh_sync_token', t); }

function handleSync(e) {
    if (e && e.shiftKey) { localStorage.removeItem('gh_sync_token'); }
    const token = getSyncToken();
    if (!token) {
        showTokenModal();
    } else {
        triggerSync(token);
    }
}

function showTokenModal() {
    const modal = document.createElement('div');
    modal.className = 'sync-modal';
    modal.id = 'sync-modal';
    modal.innerHTML =
        '<div class="sync-modal-box">' +
            '<h3>Configuration Sync (une seule fois)</h3>' +
            '<p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">' +
                'Pour synchroniser depuis le navigateur, il faut un <strong>GitHub Personal Access Token (classic)</strong>.' +
            '</p>' +
            '<p style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">' +
                '1. <a href="https://github.com/settings/tokens/new?scopes=repo&description=Coach+Trail+Sync" target="_blank" style="color:var(--accent);">Clique ici pour creer le token</a><br>' +
                '2. Laisse la coche <strong>repo</strong> activee, clique <strong>Generate token</strong><br>' +
                '3. Copie le token et colle-le ci-dessous' +
            '</p>' +
            '<input type="password" id="sync-token-input" placeholder="ghp_xxxxxxxxxxxx...">' +
            '<div>' +
                '<button class="sync-modal-btn" onclick="saveTokenAndSync()">Enregistrer et Sync</button>' +
                '<button class="sync-modal-cancel" onclick="closeTokenModal()">Annuler</button>' +
            '</div>' +
            '<p style="font-size:11px;color:var(--text-muted);margin-top:12px;">Le token reste dans ton navigateur (localStorage). Jamais envoye ailleurs que github.com.</p>' +
        '</div>';
    document.body.appendChild(modal);
    document.getElementById('sync-token-input').focus();
}

function closeTokenModal() {
    const m = document.getElementById('sync-modal');
    if (m) m.remove();
}

function saveTokenAndSync() {
    const input = document.getElementById('sync-token-input');
    const token = input.value.trim();
    if (!token) return;
    setSyncToken(token);
    closeTokenModal();
    triggerSync(token);
}

function triggerSync(token) {
    const btn = document.getElementById('sync-btn');
    const label = document.getElementById('sync-label');
    btn.classList.add('syncing');
    btn.classList.remove('stale');
    label.textContent = 'Sync...';

    fetch('https://api.github.com/repos/' + SYNC_REPO + '/actions/workflows/' + SYNC_WORKFLOW + '/dispatches', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + token,
            'Accept': 'application/vnd.github.v3+json',
        },
        body: JSON.stringify({ ref: 'main' }),
    })
    .then(r => {
        if (r.status === 204) {
            label.textContent = 'Lance !';
            startSyncCountdown(40);
        } else if (r.status === 401) {
            label.textContent = 'Token expire';
            btn.classList.remove('syncing');
            localStorage.removeItem('gh_sync_token');
            setTimeout(() => { label.textContent = 'Sync'; }, 3000);
        } else if (r.status === 403) {
            label.textContent = 'Droits insuffisants';
            btn.classList.remove('syncing');
            setTimeout(() => { label.textContent = 'Sync'; }, 4000);
        } else {
            r.text().then(t => console.error('Sync error:', r.status, t));
            label.textContent = 'Erreur ' + r.status;
            btn.classList.remove('syncing');
            setTimeout(() => { label.textContent = 'Sync'; }, 3000);
        }
    })
    .catch(e => {
        console.error('Sync fetch error:', e);
        label.textContent = 'Erreur reseau';
        btn.classList.remove('syncing');
        setTimeout(() => { label.textContent = 'Sync'; }, 3000);
    });
}

function startSyncCountdown(seconds) {
    const label = document.getElementById('sync-label');
    const btn = document.getElementById('sync-btn');
    let remaining = seconds;

    const interval = setInterval(() => {
        remaining--;
        label.textContent = remaining + 's...';
        if (remaining <= 0) {
            clearInterval(interval);
            label.textContent = 'Reload...';
            // Reload data without full page refresh
            loadActivities();
            loadGarminData();
            setTimeout(() => {
                btn.classList.remove('syncing');
                label.textContent = 'Sync';
                updateSyncStatus();
            }, 2000);
        }
    }, 1000);
}

function updateSyncStatus() {
    fetch('data/garmin-wellness.json')
        .then(r => r.ok ? r.json() : null)
        .then(data => {
            if (!data || !data.summary || !data.summary.last_sync) return;
            const lastSync = new Date(data.summary.last_sync.replace(' ', 'T'));
            const now = new Date();
            const diffH = (now - lastSync) / (1000 * 60 * 60);
            const btn = document.getElementById('sync-btn');
            const label = document.getElementById('sync-label');
            const headerUpdate = document.getElementById('header-update');

            if (headerUpdate) {
                const syncDate = lastSync.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                const syncTime = lastSync.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                headerUpdate.textContent = 'Mise a jour : ' + syncDate + ' a ' + syncTime;
            }

            if (diffH > SYNC_STALE_HOURS && !btn.classList.contains('syncing')) {
                btn.classList.add('stale');
                label.textContent = 'Sync (' + Math.round(diffH) + 'h)';
            }
        })
        .catch(() => {});
}

updateSyncStatus();
</script>

</body>
</html>
