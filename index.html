<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f1117">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Coach Trail — Dashboard</title>
    <style>
        :root {
            --bg: #0f1117;
            --bg-card: #1a1d27;
            --bg-card-alt: #21242f;
            --border: #2a2d3a;
            --text: #e4e4e7;
            --text-muted: #8b8fa3;
            --accent: #3b82f6;
            --accent-light: #60a5fa;
            --green: #22c55e;
            --green-dark: #15803d;
            --yellow: #eab308;
            --orange: #f97316;
            --red: #ef4444;
            --red-dark: #991b1b;
            --purple: #a855f7;
            --cyan: #06b6d4;
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Inter, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 0;
            overflow-x: hidden;
        }

        /* ===== HEADER ===== */
        .header-bar {
            background: linear-gradient(135deg, #141720 0%, #1a1d27 100%);
            border-bottom: 1px solid var(--border);
            padding: 0;
        }
        header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 24px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .header-brand {
            display: flex; align-items: center; gap: 10px; flex-shrink: 0;
        }
        .header-logo-icon {
            width: 34px; height: 34px; border-radius: 8px;
            background: linear-gradient(135deg, var(--accent) 0%, #2563eb 100%);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        .header-logo-icon svg { width: 18px; height: 18px; }
        .header-title {
            font-size: 16px; font-weight: 800; letter-spacing: -0.5px;
            color: var(--text); line-height: 1.1;
        }
        .header-title span { color: var(--accent-light); }
        .header-athletes {
            display: flex; gap: 8px; flex: 1; justify-content: center;
        }
        .athlete-btn {
            display: flex; align-items: center; gap: 10px; padding: 8px 16px; border-radius: 10px;
            border: 1px solid transparent; background: transparent; color: var(--text-muted);
            cursor: pointer; font-family: inherit; font-size: 13px; font-weight: 600; transition: all 0.2s;
        }
        .athlete-btn:hover { background: var(--bg-card-alt); color: var(--text); }
        .athlete-btn.active {
            background: var(--bg-card); color: var(--text);
            border-color: var(--border);
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        .athlete-avatar {
            width: 32px; height: 32px; border-radius: 50%; color: #fff;
            display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700;
            flex-shrink: 0;
        }
        .avatar-yohann { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .avatar-juliette { background: linear-gradient(135deg, #a855f7, #7c3aed); }
        .athlete-info { display: flex; flex-direction: column; gap: 1px; min-width: 0; }
        .athlete-name { font-weight: 700; font-size: 13px; white-space: nowrap; }
        .athlete-detail { font-size: 11px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .athlete-btn.active .athlete-name { color: var(--text); }
        .athlete-btn.active .athlete-detail { color: var(--accent-light); }

        /* ===== TABS ===== */
        .tab-bar {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border);
            padding: 0 24px;
            max-width: 1400px;
            margin: 8px auto 0;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            white-space: nowrap;
            transition: all 0.2s;
            font-family: inherit;
        }

        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--accent-light); border-bottom-color: var(--accent-light); }

        .tab-content {
            display: none;
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
            animation: fadeIn 0.2s;
        }

        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ===== GRID ===== */
        .grid { display: grid; gap: 20px; margin-bottom: 24px; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        .grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
        .grid-1-2 { grid-template-columns: 1fr 2fr; }
        .grid-2-1 { grid-template-columns: 2fr 1fr; }

        /* ===== CARDS ===== */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }

        .card h2 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .card h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 16px 0 8px;
            color: var(--accent-light);
        }

        /* ===== STATS ===== */
        .stat-big { font-size: 36px; font-weight: 700; line-height: 1.1; }
        .stat-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .stat-row:last-child { border-bottom: none; }
        .stat-row .label { color: var(--text-muted); font-size: 13px; }
        .stat-row .value { font-weight: 600; font-size: 14px; }

        /* ===== BADGES ===== */
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-green { background: var(--green-dark); color: var(--green); }
        .badge-yellow { background: #854d0e; color: var(--yellow); }
        .badge-red { background: var(--red-dark); color: #fca5a5; }
        .badge-blue { background: #1e3a5f; color: var(--accent-light); }
        .badge-purple { background: #581c87; color: #d8b4fe; }
        .badge-orange { background: #9a3412; color: #fdba74; }

        /* ===== TABLE ===== */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        table th {
            text-align: left; padding: 8px 10px; font-size: 11px;
            text-transform: uppercase; letter-spacing: 0.5px;
            color: var(--text-muted); border-bottom: 2px solid var(--border);
        }
        table td { padding: 8px 10px; border-bottom: 1px solid var(--border); vertical-align: top; }
        table tr:last-child td { border-bottom: none; }
        table tr:hover { background: var(--bg-card-alt); }

        /* ===== COLORS ===== */
        .text-green { color: var(--green); }
        .text-yellow { color: var(--yellow); }
        .text-red { color: var(--red); }
        .text-orange { color: var(--orange); }
        .text-blue { color: var(--accent-light); }
        .text-purple { color: var(--purple); }
        .text-cyan { color: var(--cyan); }
        .text-muted { color: var(--text-muted); }
        .text-bold { font-weight: 700; }

        /* ===== ZONE BAR ===== */
        .zone-bar { display: flex; height: 32px; border-radius: 6px; overflow: hidden; margin: 8px 0; }
        .zone-bar div { display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #fff; }
        .zone-1 { background: #3b82f6; }
        .zone-2 { background: #22c55e; }
        .zone-3 { background: #eab308; }
        .zone-4 { background: #f97316; }
        .zone-5 { background: #ef4444; }

        /* ===== PROGRESS BAR ===== */
        .progress-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin: 6px 0; }
        .progress-bar .fill { height: 100%; border-radius: 4px; transition: width 0.3s; }

        /* ===== RECOMMENDATIONS ===== */
        .reco-item { padding: 14px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid; }
        .reco-critical { background: #1c1012; border-color: var(--red); }
        .reco-important { background: #1a1608; border-color: var(--orange); }
        .reco-positive { background: #0a1a0f; border-color: var(--green); }
        .reco-item .reco-title { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
        .reco-item .reco-text { font-size: 13px; color: var(--text-muted); }

        /* ===== RACE TIMELINE ===== */
        .race-timeline { position: relative; padding-left: 24px; }
        .race-timeline::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: var(--border); }
        .race-item { position: relative; padding: 12px 0; }
        .race-item::before { content: ''; position: absolute; left: -20px; top: 18px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid; }
        .race-a::before { border-color: var(--red); background: var(--red-dark); }
        .race-b::before { border-color: var(--orange); background: #9a3412; }
        .race-c::before { border-color: var(--yellow); background: #854d0e; }
        .race-done::before { border-color: var(--green); background: var(--green-dark); }
        .race-item .race-date { font-size: 12px; color: var(--text-muted); }
        .race-item .race-name { font-weight: 700; font-size: 15px; }
        .race-item .race-details { font-size: 13px; color: var(--text-muted); }

        /* ===== INJURY ===== */
        .injury-status { padding: 16px; border-radius: 8px; border: 1px solid; }
        .injury-active { background: #1c1012; border-color: var(--red); }
        .injury-healing { background: #1a1608; border-color: var(--yellow); }
        .injury-resolved { background: #0a1a0f; border-color: var(--green); }

        /* ===== WEEK DAY ===== */
        .week-day { padding: 12px; border-radius: 8px; background: var(--bg-card-alt); margin-bottom: 8px; }
        .week-day .day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .week-day .day-name { font-weight: 700; font-size: 14px; }
        .week-day .day-details { font-size: 13px; color: var(--text-muted); line-height: 1.5; }

        /* ===== NOTE BOX ===== */
        .note-box {
            background: var(--bg-card-alt);
            border-left: 3px solid var(--accent);
            padding: 12px 16px;
            border-radius: 0 8px 8px 0;
            font-size: 13px;
            margin: 12px 0;
            color: var(--text-muted);
        }

        /* ===== SECTION TITLE ===== */
        .section-title {
            font-size: 20px; font-weight: 700;
            margin: 32px 0 16px; padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            letter-spacing: -0.3px;
        }
        .section-title span { color: var(--accent-light); }

        /* ===== ACTIVITY CARD (Strava) ===== */
        .activity-card {
            background: var(--bg-card-alt);
            border-radius: 10px;
            padding: 0;
            margin-bottom: 10px;
            display: flex;
            overflow: hidden;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .activity-card:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
        .act-icon {
            width: 56px;
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .act-icon svg { width: 26px; height: 26px; }
        .act-icon.run { background: linear-gradient(135deg, #15803d, #22c55e); }
        .act-icon.trail { background: linear-gradient(135deg, #b45309, #f97316); }
        .act-icon.swim { background: linear-gradient(135deg, #0e7490, #06b6d4); }
        .act-icon.elliptical { background: linear-gradient(135deg, #7e22ce, #a855f7); }
        .act-icon.walk { background: linear-gradient(135deg, #a16207, #eab308); }
        .act-icon.workout { background: linear-gradient(135deg, #9a3412, #f97316); }
        .act-icon.default { background: linear-gradient(135deg, #1e3a5f, #3b82f6); }
        .act-body { flex: 1; padding: 14px 16px; }
        .act-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .act-name { font-weight: 700; font-size: 14px; letter-spacing: -0.2px; }
        .act-meta { font-size: 11px; color: var(--text-muted); text-align: right; line-height: 1.4; }
        .act-type-label { font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .act-stats { display: flex; gap: 6px; flex-wrap: wrap; }
        .act-stat {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 6px 12px;
            text-align: center;
            min-width: 72px;
        }
        .act-stat-value { font-weight: 800; font-size: 14px; letter-spacing: -0.3px; }
        .act-stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 1px; }
        .act-zone {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 8px;
        }

        /* ===== HEALTH TAB ===== */
        .sleep-phases-bar { display: flex; height: 28px; border-radius: 6px; overflow: hidden; margin: 8px 0; }
        .sleep-phases-bar div { display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: #fff; }
        .sleep-deep { background: #1e3a8a; }
        .sleep-light { background: #3b82f6; }
        .sleep-rem { background: #8b5cf6; }
        .sleep-awake { background: #f97316; }

        .mini-chart { display: flex; align-items: flex-end; gap: 3px; height: 100px; padding: 18px 2px 0; }
        .mini-chart .bar {
            flex: 1;
            border-radius: 3px 3px 0 0;
            min-width: 8px;
            position: relative;
            transition: opacity 0.15s;
            cursor: default;
        }
        .mini-chart .bar::after {
            content: attr(data-val);
            position: absolute;
            top: -16px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            font-weight: 600;
            color: var(--text-muted);
            white-space: nowrap;
        }
        .mini-chart .bar:hover { opacity: 0.8; }
        .mini-chart-labels { display: flex; justify-content: space-between; font-size: 9px; color: var(--text-muted); padding: 4px 2px 0; }

        .health-metric {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        .health-metric:last-child { border-bottom: none; }
        .health-metric-icon {
            width: 40px; height: 40px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .health-metric-value { font-size: 20px; font-weight: 700; }
        .health-metric-label { font-size: 12px; color: var(--text-muted); }

        .hrv-status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ===== SYNC BUTTON ===== */
        .sync-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            margin-top: 6px;
        }
        .sync-btn:hover { background: var(--bg-card-alt); color: var(--text); border-color: var(--accent); }
        .sync-btn.syncing { color: var(--accent-light); border-color: var(--accent); cursor: wait; }
        .sync-btn.syncing svg { animation: spin 1s linear infinite; }
        .sync-btn.stale { border-color: var(--orange); color: var(--orange); }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .sync-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); display: flex; align-items: center;
            justify-content: center; z-index: 1000;
        }
        .sync-modal-box {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 24px; max-width: 480px; width: 90%;
        }
        .sync-modal-box h3 { font-size: 16px; margin-bottom: 12px; }
        .sync-modal-box input {
            width: 100%; padding: 10px 12px; border-radius: 8px;
            border: 1px solid var(--border); background: var(--bg-card-alt);
            color: var(--text); font-size: 13px; font-family: monospace;
            margin: 8px 0 16px;
        }
        .sync-modal-box input:focus { outline: none; border-color: var(--accent); }
        .sync-modal-btn {
            padding: 8px 20px; border-radius: 8px; border: none;
            background: var(--accent); color: #fff; font-weight: 600;
            font-size: 13px; cursor: pointer; font-family: inherit;
        }
        .sync-modal-btn:hover { background: var(--accent-light); }
        .sync-modal-cancel {
            padding: 8px 20px; border-radius: 8px; border: 1px solid var(--border);
            background: none; color: var(--text-muted); font-weight: 600;
            font-size: 13px; cursor: pointer; margin-left: 8px; font-family: inherit;
        }

        /* ===== FOOTER ===== */
        footer {
            text-align: center; padding: 30px 0 20px; color: var(--text-muted);
            font-size: 12px; border-top: 1px solid var(--border);
            margin: 40px 24px 0; max-width: 1400px;
        }

        /* ===== WEEK MATCH ===== */
        .day-match {
            margin-top: 8px;
            font-size: 12px;
        }
        .day-match-done {
            background: #0a1a0f;
            border: 1px solid var(--green-dark);
            border-radius: 6px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .day-match-miss {
            background: #1c1012;
            border: 1px solid var(--red-dark);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--red);
        }
        .day-match-future {
            color: var(--text-muted);
            font-style: italic;
            padding: 4px 0;
        }

        .day-checks { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
        .day-check {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-muted);
            transition: all 0.15s;
        }
        .day-check:hover { border-color: var(--accent); }
        .day-check.checked {
            background: #0a1a0f;
            border-color: var(--green-dark);
            color: var(--green);
        }
        .day-check .check-icon { font-size: 14px; }

        /* ===== DAY METRICS (Soléaire + RPE dots) ===== */
        .day-metrics { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px; }
        .metric-row {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .metric-label { color: var(--text-muted); min-width: 28px; }
        .metric-dots { display: flex; gap: 2px; }
        .metric-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 1.5px solid var(--border);
            background: transparent;
            cursor: pointer;
            transition: all 0.12s;
            padding: 0;
            box-sizing: border-box;
        }
        .metric-dot:hover { border-color: var(--text-muted); transform: scale(1.15); }
        .metric-dot.filled { border-color: transparent; }
        .metric-value {
            min-width: 16px;
            text-align: center;
            font-variant-numeric: tabular-nums;
            margin-left: 2px;
        }

        /* ===== SAVE CHECKS BUTTON ===== */
        .save-checks-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 24px;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
            transition: all 0.3s;
            transform: translateY(80px);
            opacity: 0;
            z-index: 100;
        }
        .save-checks-btn.visible { transform: translateY(0); opacity: 1; }
        .save-checks-btn:hover { opacity: 0.9; }
        .save-checks-btn:disabled { opacity: 0.5; cursor: wait; }

        /* ===== CHAT (TAB INTEGRATED) ===== */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 160px);
            min-height: 400px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .chat-header-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            background: linear-gradient(135deg, #0a1a0f 0%, #122218 100%);
            border-bottom: 1px solid rgba(34, 197, 94, 0.2);
            flex-shrink: 0;
        }
        .chat-header-icon {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            background: linear-gradient(135deg, #22c55e 0%, #15803d 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
        }
        .chat-header-icon svg { width: 22px; height: 22px; }
        .chat-header-info {
            display: flex;
            flex-direction: column;
            gap: 1px;
            flex: 1;
        }
        .chat-header-title {
            font-size: 14px;
            font-weight: 800;
            color: var(--text);
            letter-spacing: -0.3px;
        }
        .chat-header-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .chat-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #22c55e;
            display: inline-block;
            flex-shrink: 0;
            animation: chat-pulse 2s infinite;
        }
        @keyframes chat-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .chat-new-btn {
            padding: 7px 14px;
            background: var(--bg-card-alt);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s;
            flex-shrink: 0;
        }
        .chat-new-btn:hover { border-color: var(--accent); color: var(--text); }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            scroll-behavior: smooth;
        }
        .chat-messages::-webkit-scrollbar { width: 4px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .chat-date-sep {
            text-align: center;
            padding: 8px 0;
        }
        .chat-date-sep span {
            font-size: 11px;
            color: var(--text-muted);
            background: var(--bg-card-alt);
            padding: 3px 12px;
            border-radius: 10px;
        }

        .chat-msg {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 14px;
            font-size: 13.5px;
            line-height: 1.55;
            word-break: break-word;
            animation: chat-msg-in 0.2s ease-out;
        }

        @keyframes chat-msg-in {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-msg.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-msg.assistant {
            align-self: flex-start;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
            border-bottom-left-radius: 4px;
        }
        .chat-msg.assistant strong { color: var(--accent-light); }
        .chat-msg.assistant em { color: var(--text-muted); font-style: italic; }
        .chat-msg.assistant ul, .chat-msg.assistant ol {
            padding-left: 18px;
            margin: 4px 0;
        }
        .chat-msg.assistant li { margin: 2px 0; }
        .chat-msg.assistant code {
            background: var(--bg-card-alt);
            padding: 1px 5px;
            border-radius: 4px;
            font-size: 12.5px;
        }
        .chat-msg.assistant p { margin: 4px 0; }
        .chat-msg.assistant p:first-child { margin-top: 0; }
        .chat-msg.assistant p:last-child { margin-bottom: 0; }

        .chat-msg-time {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 3px;
            opacity: 0.7;
        }
        .chat-msg.user .chat-msg-time { text-align: right; color: rgba(255,255,255,0.6); }

        .chat-notification {
            align-self: center;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--green);
            background: rgba(34, 197, 94, 0.08);
            border: 1px solid rgba(34, 197, 94, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            margin: 4px 0;
        }
        .chat-notification svg { width: 12px; height: 12px; flex-shrink: 0; }

        .chat-typing {
            display: none;
            align-items: center;
            gap: 6px;
            padding: 8px 18px;
            flex-shrink: 0;
            font-size: 12px;
            color: var(--text-muted);
        }
        .chat-typing.visible { display: flex; }
        .chat-typing-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--accent);
            animation: chat-bounce 1.2s infinite;
        }
        .chat-typing-dot:nth-child(2) { animation-delay: 0.15s; }
        .chat-typing-dot:nth-child(3) { animation-delay: 0.3s; }

        @keyframes chat-bounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-3px); opacity: 1; }
        }
        .chat-typing-text {
            font-style: italic;
            margin-left: 2px;
        }

        .chat-input-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding: 12px 14px;
            border-top: 1px solid var(--border);
            background: var(--bg-card);
            flex-shrink: 0;
        }
        .chat-input-row textarea {
            flex: 1;
            background: var(--bg-card-alt);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-family: inherit;
            font-size: 16px;
            padding: 10px 14px;
            resize: none;
            outline: none;
            max-height: 72px;
            line-height: 1.4;
            transition: border-color 0.2s;
        }
        .chat-input-row textarea:focus { border-color: var(--accent); }
        .chat-input-row textarea::placeholder { color: var(--text-muted); }
        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .chat-send-btn:hover { transform: scale(1.05); }
        .chat-send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        .chat-send-btn svg { width: 18px; height: 18px; }

        /* ===== CHAT RESPONSIVE ===== */
        @media (max-width: 768px) {
            .chat-container {
                height: calc(100dvh - 130px);
                border-radius: 0;
                border: none;
            }
            .chat-input-row {
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 900px) {
            body { overflow-x: hidden; }
            .grid-2, .grid-3, .grid-4, .grid-1-2, .grid-2-1 { grid-template-columns: 1fr; }
            header { flex-wrap: wrap; padding: 10px 16px; gap: 8px; }
            .header-brand { flex: 0 0 auto; }
            .header-athletes { flex: 1 1 100%; order: 3; gap: 6px; }
            .athlete-btn { flex: 1; padding: 8px 12px; }
            .header-sync { order: 2; margin-left: auto; }
            .tab-btn { padding: 10px 14px; font-size: 12px; }
            table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        }
        @media (max-width: 480px) {
            header { padding: 8px 12px; gap: 6px; }
            .header-logo-icon { width: 28px; height: 28px; border-radius: 6px; }
            .header-logo-icon svg { width: 15px; height: 15px; }
            .header-title { font-size: 13px; }
            .header-athletes { gap: 6px; }
            .athlete-btn { padding: 6px 8px; gap: 6px; }
            .athlete-avatar { width: 28px; height: 28px; font-size: 10px; }
            .athlete-name { font-size: 12px; }
            .athlete-detail { font-size: 10px; }
            .tab-btn { padding: 8px 10px; font-size: 11px; }
        }

        /* ===== TODAY CARD ===== */
        .today-card { border: 1px solid var(--accent); position: relative; }
        .today-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px; }
        .today-header h2 { margin: 0; }
        .today-exercises { display: flex; flex-direction: column; gap: 12px; }
        .exercise-card {
            display: flex; gap: 16px; align-items: flex-start;
            padding: 12px; border-radius: 8px; background: var(--bg-card-alt);
        }
        .exercise-svg { flex-shrink: 0; width: 64px; height: 64px; }
        .exercise-svg svg { width: 100%; height: 100%; }
        .exercise-info { flex: 1; }
        .exercise-name { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
        .exercise-detail { font-size: 13px; color: var(--text-muted); line-height: 1.5; }

        /* Today icon strip */
        .today-icons { display: flex; gap: 16px; margin-bottom: 4px; }
        .today-icon-item { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .today-icon-item .exercise-svg { width: 48px; height: 48px; }
        .today-icon-label { font-size: 11px; color: var(--text-muted); font-weight: 600; }

        /* Past days: compact + greyed out, expandable on hover/tap */
        .day-past { opacity: 0.5; }
        .day-past .day-details { max-height: 0; overflow: hidden; margin: 0; padding: 0; transition: max-height 0.3s ease, opacity 0.3s ease; }
        .day-past .day-header { margin-bottom: 0; flex-wrap: wrap; }
        .day-past:hover { opacity: 0.8; }
        .day-past:hover .day-details { max-height: 200px; }
        /* Validated day card */
        .day-validated { border-left-color: var(--green) !important; background: rgba(76, 175, 80, 0.08) !important; }
        .day-past.day-validated { opacity: 0.6; }
        .day-metrics-summary { display: flex; gap: 6px; margin-left: auto; }
        .metric-badge { font-size: 11px; font-weight: 700; padding: 2px 6px; border-radius: 4px; border: 1px solid; background: rgba(0,0,0,0.3); white-space: nowrap; }
        .week-day-placeholder { padding: 8px 12px; font-size: 12px; color: var(--text-muted); border-left: 2px solid var(--border); margin: 4px 0; }
        .day-hidden { display: none; }

        /* Sub-tabs (Programme: A venir / Passés) */
        .sub-tabs { display: flex; gap: 0; margin-bottom: 20px; border-bottom: 2px solid var(--border); background: var(--bg-card); border-radius: 8px 8px 0 0; padding: 4px 4px 0; }
        .sub-tab { padding: 10px 20px; background: none; border: none; color: var(--text-muted); font-size: 14px; font-weight: 700; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; font-family: inherit; transition: all 0.2s; letter-spacing: 0.3px; }
        .sub-tab:hover { color: var(--text); }
        .sub-tab.active { color: var(--accent-light); border-bottom-color: var(--accent-light); border-bottom-width: 3px; }
        .sub-content { display: none; }
        .sub-content.active { display: block; animation: fadeIn 0.2s; }

        .athlete-content { display: none; }
        .athlete-content.active { display: block; }
    </style>
</head>
<body>

<!-- ===== HEADER ===== -->
<div class="header-bar">
<header>
    <div class="header-brand">
        <div class="header-logo-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 19l4-8 3 4 4-10 7 14"/>
                <circle cx="18" cy="5" r="2" fill="white" stroke="none"/>
            </svg>
        </div>
        <div class="header-title">Coach<span>Trail</span></div>
    </div>
    <div class="header-athletes">
        <button class="athlete-btn active" data-athlete="yohann">
            <span class="athlete-avatar avatar-yohann">YT</span>
            <div class="athlete-info">
                <span class="athlete-name">Yohann</span>
                <span class="athlete-detail" id="header-detail-yohann">OCC 57km — J-200</span>
            </div>
        </button>
        <button class="athlete-btn" data-athlete="juliette">
            <span class="athlete-avatar avatar-juliette">JS</span>
            <div class="athlete-info">
                <span class="athlete-name">Juliette</span>
                <span class="athlete-detail" id="header-detail-juliette">G2G 275km — J-224</span>
            </div>
        </button>
    </div>
    <div class="header-sync" style="display: flex; align-items: center; gap: 8px;">
        <button class="sync-btn" id="sync-btn" onclick="handleSync(event)" title="Sync Strava + Garmin (Shift+click = reconfigurer le token)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
            <span id="sync-label">Sync</span>
        </button>
        <span id="garmin-status" style="font-size: 10px; color: var(--text-muted);"></span>
    </div>
</header>
</div>

<!-- ===== TAB BAR ===== -->
<nav class="tab-bar">
    <button class="tab-btn active" data-tab="overview">Vue d'ensemble</button>
    <button class="tab-btn" data-tab="health">Santé</button>
    <button class="tab-btn" data-tab="activities">Activités</button>
    <button class="tab-btn" data-tab="week">Programme</button>
    <button class="tab-btn" data-tab="injury">Blessure</button>
    <button class="tab-btn" data-tab="calendar">Calendrier</button>
    <button class="tab-btn" data-tab="progress">Progression</button>
    <button class="tab-btn" data-tab="coach">Coach IA</button>
</nav>

<!-- ===== ATHLETE: YOHANN ===== -->
<div id="athlete-yohann" class="athlete-content active">

<!-- ======================================================================== -->
<!-- TAB 1 : VUE D'ENSEMBLE                                                  -->
<!-- ======================================================================== -->
<div id="overview" class="tab-content active">
    <div id="overview-kpi" class="grid grid-4" style="margin-bottom: 24px;"></div>
    <div class="grid grid-2-1">
        <div class="card" id="profile-card"></div>
        <div class="card">
            <h2>Evaluation /10</h2>
            <div id="eval-scores">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">Chargement...</div>
            </div>
            <div id="eval-global" style="margin-top: 16px; padding-top: 12px; border-top: 2px solid var(--border); text-align: center;">
                <div class="stat-big" id="eval-global-value" style="color: var(--text-muted);">&mdash;<span style="font-size: 16px; color: var(--text-muted);">/10</span></div>
                <div class="stat-label">Note globale</div>
            </div>
            <div id="eval-comment" style="margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--border); text-align: left;"></div>
        </div>
    </div>
    <div class="card" id="zones-card" style="margin-top: 4px;"></div>
</div>

<!-- ======================================================================== -->
<!-- TAB 2 : SEMAINE                                                          -->
<!-- ======================================================================== -->
<div id="week" class="tab-content">

    <!-- Sous-onglets -->
    <div class="sub-tabs">
        <button class="sub-tab active" data-subtab="upcoming">A venir</button>
        <button class="sub-tab" data-subtab="past">Pass&#233;s</button>
    </div>

    <!-- SUB-TAB : A venir -->
    <div id="week-upcoming" class="sub-content active">

    <!-- AUJOURD'HUI (dynamique) -->
    <div id="today-container"></div>

    <!-- Plan de semaine (chargé dynamiquement via API) -->
    <div id="week-plan-container"></div>

    <!-- Semaine type -->
    <div class="card" style="margin-top: 20px;">
        <h2>Semaine type — Creneaux disponibles</h2>
        <table>
            <tr><th>Jour</th><th>Lieu</th><th>Creneaux</th><th>Contraintes</th></tr>
            <tr><td class="text-bold">Lundi</td><td>Bureau Champagne</td><td>Midi uniquement</td><td class="text-muted">7-8 km / 150-200 D+ ou 12-13 km / 350-400 D+</td></tr>
            <tr><td class="text-bold">Mardi</td><td>Teletravail</td><td>Matin + Midi</td><td class="text-muted">Flexible</td></tr>
            <tr><td class="text-bold">Mercredi</td><td>Teletravail</td><td>Matin + Midi</td><td class="text-muted">Flexible</td></tr>
            <tr><td class="text-bold">Jeudi</td><td>Teletravail</td><td>Matin + Midi</td><td class="text-muted">Flexible</td></tr>
            <tr><td class="text-bold">Vendredi</td><td>Bureau Champagne</td><td>Midi uniquement</td><td class="text-muted">7-8 km / 150-200 D+ ou 12-13 km / 350-400 D+</td></tr>
            <tr><td class="text-bold">Samedi</td><td>Libre</td><td>Toute la journee</td><td class="text-muted">Sortie longue possible</td></tr>
            <tr><td class="text-bold">Dimanche</td><td>Libre</td><td>Matin</td><td class="text-muted">2 enfants — adapter</td></tr>
        </table>
    </div>

    </div><!-- /week-upcoming -->

    <!-- SUB-TAB : Passés (populated dynamically by populatePastDays + movePastDaysToHistory) -->
    <div id="week-past" class="sub-content">
    </div><!-- /week-past -->

</div>

<!-- ======================================================================== -->
<!-- TAB 3 : BLESSURE                                                         -->
<!-- ======================================================================== -->
<div id="injury" class="tab-content">
    <div id="injury-content"></div>
</div>

<!-- ======================================================================== -->
<!-- TAB : SANTE (Garmin Connect)                                             -->
<!-- ======================================================================== -->
<div id="health" class="tab-content">

    <!-- KPI Sante -->
    <div class="grid grid-4" style="margin-bottom: 24px;" id="health-kpi">
        <div class="card" style="text-align: center;">
            <div class="stat-big" id="health-last-night" style="color: var(--text-muted);">--</div>
            <div class="stat-label">Dernière nuit</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="health-last-night-score">--</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big" id="health-body-battery" style="color: var(--text-muted);">--</div>
            <div class="stat-label">Body Battery</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="health-bb-detail">--</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big text-red" id="health-sleep-avg">--</div>
            <div class="stat-label">Sommeil moyen /nuit</div>
            <div style="font-size:12px; color: var(--red); margin-top:4px;" id="health-sleep-avg-sub">Objectif : 7h30</div>
        </div>
        <div class="card" style="text-align: center;" id="health-weight-card"></div>
    </div>

    <!-- Sommeil detail + VFC/Stress -->
    <div class="grid grid-2">
        <div class="card">
            <h2>Sommeil</h2>
            <div id="health-sleep-detail">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">Chargement...</div>
            </div>
        </div>
        <div class="card">
            <h2>Variabilite cardiaque & Stress</h2>
            <div id="health-hrv-stress">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">Chargement...</div>
            </div>
        </div>
    </div>

    <div id="health-factors-card"></div>

    <!-- Charts 14 jours -->
    <div class="section-title">Tendances <span>14 jours</span></div>

    <div class="grid grid-3">
        <div class="card">
            <h2>FC repos (bpm)</h2>
            <div class="mini-chart" id="chart-rhr"></div>
            <div class="mini-chart-labels" id="chart-rhr-labels"></div>
        </div>
        <div class="card">
            <h2>VFC — Moyenne nocturne (ms)</h2>
            <div class="mini-chart" id="chart-hrv"></div>
            <div class="mini-chart-labels" id="chart-hrv-labels"></div>
        </div>
        <div class="card">
            <h2>Pas quotidiens</h2>
            <div class="mini-chart" id="chart-steps"></div>
            <div class="mini-chart-labels" id="chart-steps-labels"></div>
        </div>
    </div>

    <!-- Body Battery 14j + Sommeil 14j -->
    <div class="grid grid-2">
        <div class="card">
            <h2>Body Battery — 14 jours</h2>
            <div class="mini-chart" id="chart-bb"></div>
            <div class="mini-chart-labels" id="chart-bb-labels"></div>
            <div id="chart-bb-summary" style="margin-top: 12px;"></div>
        </div>
        <div class="card">
            <h2>Sommeil — 14 jours</h2>
            <div class="mini-chart" id="chart-sleep"></div>
            <div class="mini-chart-labels" id="chart-sleep-labels"></div>
            <div id="chart-sleep-summary" style="margin-top: 12px;"></div>
        </div>
    </div>
</div>

<!-- ======================================================================== -->
<!-- TAB 4 : CALENDRIER                                                       -->
<!-- ======================================================================== -->
<div id="calendar" class="tab-content">
    <div id="calendar-content"></div>
    <div id="predictions-content" style="margin-top: 20px;"></div>
    <div id="projection-content"></div>
    <div id="work-axes-content" style="margin-top: 20px;"></div>
</div>

<!-- ======================================================================== -->
<!-- TAB 5 : PROGRESSION                                                      -->
<!-- ======================================================================== -->
<div id="progress" class="tab-content">
    <div id="progression-content"></div>
    <div class="card" style="margin-top: 20px;">
        <h2>Evolution Evaluation /10</h2>
        <div id="eval-history">
            <div style="text-align: center; padding: 20px; color: var(--text-muted);">Chargement...</div>
        </div>
    </div>
</div>

<!-- ======================================================================== -->
<!-- TAB 6 : ACTIVITES (Strava)                                               -->
<!-- ======================================================================== -->
<div id="activities" class="tab-content">

    <!-- Summary bar -->
    <div id="activities-summary" style="display: none; margin-bottom: 20px;">
        <div class="grid grid-4" style="gap: 12px;">
            <div class="card" style="text-align: center; padding: 16px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 6px;"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                <div class="stat-big text-green" id="sum-runs" style="font-size: 28px;">0</div>
                <div class="stat-label">Courses</div>
            </div>
            <div class="card" style="text-align: center; padding: 16px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--accent-light)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 6px;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                <div class="stat-big text-blue" id="sum-distance" style="font-size: 28px;">0</div>
                <div class="stat-label">km total</div>
            </div>
            <div class="card" style="text-align: center; padding: 16px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 6px;"><path d="M8 3l4 8 5-5 5 15H2L8 3z"/></svg>
                <div class="stat-big text-orange" id="sum-elevation" style="font-size: 28px;">0</div>
                <div class="stat-label">D+ total</div>
            </div>
            <div class="card" style="text-align: center; padding: 16px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--purple)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 6px;"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
                <div class="stat-big text-purple" id="sum-time" style="font-size: 28px;">0h</div>
                <div class="stat-label">Temps total</div>
            </div>
        </div>
    </div>

    <div id="activities-list">
        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <div style="font-size: 14px;">Chargement des activites...</div>
        </div>
    </div>
</div>

<!-- ======================================================================== -->
<!-- TAB 8 : COACH IA                                                       -->
<!-- ======================================================================== -->
<div id="coach" class="tab-content">
    <div class="chat-container">
        <div class="chat-header-bar">
            <div class="chat-header-icon">
                <svg viewBox="0 0 64 64" fill="none"><path d="M8 48 L24 20 L32 32 L40 22 L56 48 Z" fill="rgba(255,255,255,0.15)" stroke="white" stroke-width="2.5" stroke-linejoin="round"/><circle cx="38" cy="14" r="3.5" fill="white"/><path d="M35 19 L38 25 L42 22 M38 25 L36 32 L32 36 M38 25 L40 32 L44 35" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div class="chat-header-info">
                <span class="chat-header-title">Coach Trail IA</span>
                <span class="chat-header-subtitle"><span class="chat-status-dot"></span> En ligne — <span class="chat-athlete-label">Yohann</span></span>
            </div>
            <button class="chat-new-btn" id="chat-new" title="Nouvelle conversation">&#8635; Nouveau</button>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-typing" id="chat-typing">
            <span class="chat-typing-dot"></span>
            <span class="chat-typing-dot"></span>
            <span class="chat-typing-dot"></span>
            <span class="chat-typing-text">Ton coach analyse et recherche...</span>
        </div>
        <div class="chat-input-row">
            <textarea id="chat-input" placeholder="Parle a ton coach..." rows="1"></textarea>
            <button class="chat-send-btn" id="chat-send">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
    </div>
</div>

</div><!-- /athlete-yohann -->

<!-- ===== ATHLETE: JULIETTE ===== -->
<div id="athlete-juliette" class="athlete-content">

<!-- ======================================================================== -->
<!-- J-TAB 1 : VUE D'ENSEMBLE                                                -->
<!-- ======================================================================== -->
<div id="j-overview" class="tab-content active">
    <div id="j-overview-kpi" class="grid grid-4" style="margin-bottom: 24px;"></div>
    <div class="grid grid-2-1">
        <div class="card" id="j-profile-card"></div>
        <div class="card">
            <h2>Evaluation /10</h2>
            <div id="j-eval-scores">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">Chargement...</div>
            </div>
            <div id="j-eval-global" style="margin-top: 16px; padding-top: 12px; border-top: 2px solid var(--border); text-align: center;">
                <div class="stat-big" id="j-eval-global-value" style="color: var(--text-muted);">&mdash;<span style="font-size: 16px; color: var(--text-muted);">/10</span></div>
                <div class="stat-label">Note globale</div>
            </div>
            <div id="j-eval-comment" style="margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--border); text-align: left;"></div>
        </div>
    </div>
    <div class="card" id="j-zones-card" style="margin-top: 4px;"></div>
</div>

<!-- ======================================================================== -->
<!-- J-TAB 2 : PROGRAMME                                                      -->
<!-- ======================================================================== -->
<div id="j-week" class="tab-content">

    <!-- Sous-onglets -->
    <div class="sub-tabs">
        <button class="sub-tab active" data-subtab="upcoming">A venir</button>
        <button class="sub-tab" data-subtab="past">Pass&#233;s</button>
    </div>

    <!-- SUB-TAB : A venir -->
    <div id="j-week-upcoming" class="sub-content active">

    <!-- AUJOURD'HUI (dynamique) -->
    <div id="j-today-container"></div>

    <!-- Plan de semaine (chargé dynamiquement via API) -->
    <div id="j-week-plan-container"></div>

    </div><!-- /j-week-upcoming -->

    <!-- SUB-TAB : Passes (populated dynamically) -->
    <div id="j-week-past" class="sub-content">
    </div><!-- /j-week-past -->

</div>

<!-- ======================================================================== -->
<!-- J-TAB 3 : BLESSURE                                                       -->
<!-- ======================================================================== -->
<div id="j-injury" class="tab-content">
    <div id="j-injury-content"></div>
</div>

<!-- ======================================================================== -->
<!-- J-TAB 4 : SANTE                                                          -->
<!-- ======================================================================== -->
<div id="j-health" class="tab-content">

    <div class="grid grid-4" style="margin-bottom: 24px;" id="j-health-kpi">
        <div class="card" style="text-align: center;">
            <div class="stat-big" id="j-health-last-night" style="color: var(--text-muted);">--</div>
            <div class="stat-label">Derniere nuit</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="j-health-last-night-score">--</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big" id="j-health-body-battery" style="color: var(--text-muted);">--</div>
            <div class="stat-label">Body Battery</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="j-health-bb-detail">--</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big" id="j-health-sleep-avg" style="color: var(--text-muted);">--</div>
            <div class="stat-label">Sommeil moyen /nuit</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="j-health-sleep-avg-sub">Objectif : 7h30</div>
        </div>
        <div class="card" style="text-align: center;" id="j-health-weight-card"></div>
    </div>

    <div class="grid grid-2">
        <div class="card">
            <h2>Sommeil</h2>
            <div id="j-health-sleep-detail">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">Pas encore de donnees Garmin</div>
            </div>
        </div>
        <div class="card">
            <h2>Variabilite cardiaque & Stress</h2>
            <div id="j-health-hrv-stress">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">Pas encore de donnees Garmin</div>
            </div>
        </div>
    </div>

    <div class="section-title">Tendances <span>14 jours</span></div>
    <div class="grid grid-3">
        <div class="card">
            <h2>FC repos (bpm)</h2>
            <div class="mini-chart" id="j-chart-rhr"></div>
            <div class="mini-chart-labels" id="j-chart-rhr-labels"></div>
        </div>
        <div class="card">
            <h2>VFC — Moyenne nocturne (ms)</h2>
            <div class="mini-chart" id="j-chart-hrv"></div>
            <div class="mini-chart-labels" id="j-chart-hrv-labels"></div>
        </div>
        <div class="card">
            <h2>Pas quotidiens</h2>
            <div class="mini-chart" id="j-chart-steps"></div>
            <div class="mini-chart-labels" id="j-chart-steps-labels"></div>
        </div>
    </div>
    <div class="grid grid-2">
        <div class="card">
            <h2>Body Battery — 14 jours</h2>
            <div class="mini-chart" id="j-chart-bb"></div>
            <div class="mini-chart-labels" id="j-chart-bb-labels"></div>
            <div id="j-chart-bb-summary" style="margin-top: 12px;"></div>
        </div>
        <div class="card">
            <h2>Sommeil — 14 jours</h2>
            <div class="mini-chart" id="j-chart-sleep"></div>
            <div class="mini-chart-labels" id="j-chart-sleep-labels"></div>
            <div id="j-chart-sleep-summary" style="margin-top: 12px;"></div>
        </div>
    </div>
    <div id="j-health-factors-card"></div>
</div>

<!-- ======================================================================== -->
<!-- J-TAB 5 : CALENDRIER                                                     -->
<!-- ======================================================================== -->
<div id="j-calendar" class="tab-content">
    <div id="j-calendar-content"></div>
    <div id="j-predictions-content" style="margin-top: 20px;"></div>
    <div id="j-projection-content"></div>
    <div id="j-work-axes-content" style="margin-top: 20px;"></div>
</div>

<!-- ======================================================================== -->
<!-- J-TAB 6 : PROGRESSION                                                    -->
<!-- ======================================================================== -->
<div id="j-progress" class="tab-content">
    <div id="j-progression-content"></div>
    <div class="card" style="margin-top: 20px;">
        <h2>Evolution Evaluation /10</h2>
        <div id="j-eval-history">
            <div style="text-align: center; padding: 20px; color: var(--text-muted);">Chargement...</div>
        </div>
    </div>
</div>

<!-- ======================================================================== -->
<!-- J-TAB 7 : ACTIVITES                                                      -->
<!-- ======================================================================== -->
<div id="j-activities" class="tab-content">

    <div id="j-activities-summary" style="display: none; margin-bottom: 20px;">
        <div class="grid grid-4" style="gap: 12px;">
            <div class="card" style="text-align: center; padding: 16px;">
                <div class="stat-big text-green" id="j-sum-runs" style="font-size: 28px;">0</div>
                <div class="stat-label">Courses</div>
            </div>
            <div class="card" style="text-align: center; padding: 16px;">
                <div class="stat-big text-blue" id="j-sum-distance" style="font-size: 28px;">0</div>
                <div class="stat-label">km total</div>
            </div>
            <div class="card" style="text-align: center; padding: 16px;">
                <div class="stat-big text-orange" id="j-sum-elevation" style="font-size: 28px;">0</div>
                <div class="stat-label">D+ total</div>
            </div>
            <div class="card" style="text-align: center; padding: 16px;">
                <div class="stat-big text-purple" id="j-sum-time" style="font-size: 28px;">0h</div>
                <div class="stat-label">Temps total</div>
            </div>
        </div>
    </div>

    <div id="j-activities-list">
        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <div style="font-size: 14px;">Pas encore de donnees Strava/Garmin</div>
        </div>
    </div>
</div>

<!-- ======================================================================== -->
<!-- J-TAB 8 : COACH IA                                                     -->
<!-- ======================================================================== -->
<div id="j-coach" class="tab-content">
    <div class="chat-container">
        <div class="chat-header-bar">
            <div class="chat-header-icon">
                <svg viewBox="0 0 64 64" fill="none"><path d="M8 48 L24 20 L32 32 L40 22 L56 48 Z" fill="rgba(255,255,255,0.15)" stroke="white" stroke-width="2.5" stroke-linejoin="round"/><circle cx="38" cy="14" r="3.5" fill="white"/><path d="M35 19 L38 25 L42 22 M38 25 L36 32 L32 36 M38 25 L40 32 L44 35" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div class="chat-header-info">
                <span class="chat-header-title">Coach Trail IA</span>
                <span class="chat-header-subtitle"><span class="chat-status-dot"></span> En ligne — <span class="chat-athlete-label">Juliette</span></span>
            </div>
            <button class="chat-new-btn" id="j-chat-new" title="Nouvelle conversation">&#8635; Nouveau</button>
        </div>
        <div class="chat-messages" id="j-chat-messages"></div>
        <div class="chat-typing" id="j-chat-typing">
            <span class="chat-typing-dot"></span>
            <span class="chat-typing-dot"></span>
            <span class="chat-typing-dot"></span>
            <span class="chat-typing-text">Ton coach analyse et recherche...</span>
        </div>
        <div class="chat-input-row">
            <textarea id="j-chat-input" placeholder="Parle a ton coach..." rows="1"></textarea>
            <button class="chat-send-btn" id="j-chat-send">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
    </div>
</div>

</div><!-- /athlete-juliette -->

<!-- ===== FOOTER ===== -->
<footer id="footer-text">
    Juliette et Yohann sont amoureux !<span id="footer-sync"></span>
</footer>

<!-- ===== JAVASCRIPT ===== -->
<script>
// ===== MULTI-ATHLETE CONFIG =====
var ATHLETES = {
    yohann: {
        name: 'Yohann Tschudi',
        objective: 'Objectif : OCC (UTMB Week) — 27 aout 2026 — 57 km / 3500 D+',
        targetDate: '2026-08-27',
        targetLabel: 'OCC',
        shortLabel: 'OCC 57km',
        prefix: '',
        dataDir: 'data/',
        block: 'Bloc 0 — Reprise & Soin',
        weekSubId: 'week',
        injuryKey: 'soleaire'
    },
    juliette: {
        name: 'Juliette Sailland',
        objective: 'Objectif : Grand to Grand Ultra — 20 sept 2026 — 275 km / 6 étapes',
        targetDate: '2026-09-20',
        targetLabel: 'G2G',
        shortLabel: 'G2G 275km',
        prefix: 'j-',
        dataDir: 'data/juliette/',
        block: 'Build 1 — Construction base',
        weekSubId: 'j-week',
        injuryKey: 'genou'
    }
};
var currentAthlete = localStorage.getItem('currentAthlete') || 'yohann';

function updateHeaderDetails() {
    Object.keys(ATHLETES).forEach(function(key) {
        var c = ATHLETES[key];
        var el = document.getElementById('header-detail-' + key);
        if (!el) return;
        var daysLeft = Math.ceil((new Date(c.targetDate) - new Date()) / (1000 * 60 * 60 * 24));
        el.textContent = c.shortLabel + ' \u2014 J-' + daysLeft;
    });
}
var _coachLogByAthlete = {};
var _loadedAthletes = {};
var _activitiesByAthlete = {};
var _weekPlanByAthlete = {};
var _athleteDataByAthlete = {};
var _fcZonesByAthlete = {};

var isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
var API_BASE = isLocalhost ? 'http://localhost:3000' : 'https://unguillotined-norris-historically.ngrok-free.dev';

function getISOWeek(date) {
    var d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    var dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
}

// ===== ATHLETE SWITCHING =====
document.querySelectorAll('.athlete-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var athlete = btn.dataset.athlete;
        if (athlete === currentAthlete) return;
        currentAthlete = athlete;
        localStorage.setItem('currentAthlete', athlete);

        // Toggle active buttons
        document.querySelectorAll('.athlete-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');

        // Toggle active wrappers
        document.querySelectorAll('.athlete-content').forEach(function(c) { c.classList.remove('active'); });
        document.getElementById('athlete-' + athlete).classList.add('active');

        // Update header detail for this athlete
        var cfg = ATHLETES[athlete];
        updateHeaderDetails();

        // Activate first tab in the new wrapper
        var container = document.getElementById('athlete-' + athlete);
        container.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
        var firstTab = container.querySelector('.tab-content');
        if (firstTab) firstTab.classList.add('active');

        // Reset tab-bar to first tab
        document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
        document.querySelector('.tab-btn').classList.add('active');

        // Load data if not already done
        if (!_loadedAthletes[athlete]) {
            loadAthleteData(athlete);
            _loadedAthletes[athlete] = true;
        }
    });
});

// ===== TAB NAVIGATION (scoped to active athlete) =====
document.querySelectorAll('.tab-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');

        var prefix = ATHLETES[currentAthlete].prefix;
        var container = document.getElementById('athlete-' + currentAthlete);
        container.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
        var target = container.querySelector('#' + prefix + btn.dataset.tab);
        if (target) target.classList.add('active');
        history.replaceState(null, null, '#' + btn.dataset.tab);
    });
});

// Handle URL hash on load
var hash = location.hash.slice(1);
if (hash) {
    var hashBtn = document.querySelector('[data-tab="' + hash + '"]');
    if (hashBtn) hashBtn.click();
}

// ===== SUB-TAB NAVIGATION (scoped) =====
document.querySelectorAll('.sub-tab').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var parent = btn.closest('.tab-content');
        parent.querySelectorAll('.sub-tab').forEach(function(b) { b.classList.remove('active'); });
        parent.querySelectorAll('.sub-content').forEach(function(c) { c.classList.remove('active'); });
        btn.classList.add('active');
        // Find the sub-content by id — use parent's id to determine prefix
        var parentId = parent.id;
        var subId = parentId + '-' + btn.dataset.subtab;
        var subContent = parent.querySelector('#' + subId);
        if (subContent) subContent.classList.add('active');
    });
});

// ===== SVG ICONS =====
const SVG = {
    run: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="2"/><path d="M7 21l3-7 2.5 2 4.5-6"/><path d="M10 14l-2 3"/><path d="M17 8l-4.5 6"/></svg>',
    trail: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3l4 8 5-5 5 15H2L8 3z"/><circle cx="17" cy="5" r="2"/></svg>',
    swim: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18c2-1 4 1 6 0s4-1 6 0 4 1 6 0"/><path d="M2 14c2-1 4 1 6 0s4-1 6 0 4 1 6 0"/><circle cx="8" cy="6" r="2"/><path d="M10 6l4 4-3 3"/></svg>',
    elliptical: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="12" rx="8" ry="5"/><circle cx="12" cy="12" r="2"/><line x1="12" y1="2" x2="12" y2="7"/><line x1="12" y1="17" x2="12" y2="22"/></svg>',
    walk: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="2"/><path d="M10 21l1-7 3 3 3-8"/><path d="M11 14l-3 7"/></svg>',
    workout: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 5v14"/><path d="M18 5v14"/><path d="M6 12h12"/><rect x="3" y="7" width="2" height="10" rx="1"/><rect x="19" y="7" width="2" height="10" rx="1"/></svg>',
    default: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
    distance: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6l-6 6-6-6"/><path d="M18 18l-6-6-6 6"/></svg>',
    elevation: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3l4 8 5-5 5 15H2L8 3z"/></svg>',
    clock: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
    heart: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>',
    pace: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
};

const TYPES = {
    'TrailRun':       { icon: 'trail',   iconClass: 'trail',      label: 'TRAIL',        color: 'var(--orange)' },
    'Run':            { icon: 'run',     iconClass: 'run',        label: 'COURSE',       color: 'var(--green)' },
    'Treadmill':      { icon: 'run',     iconClass: 'elliptical', label: 'TAPIS',        color: 'var(--purple)' },
    'Walk':           { icon: 'walk',    iconClass: 'walk',       label: 'MARCHE',       color: 'var(--yellow)' },
    'Hike':           { icon: 'walk',    iconClass: 'walk',       label: 'RANDO',        color: 'var(--yellow)' },
    'Swim':           { icon: 'swim',    iconClass: 'swim',       label: 'NATATION',     color: 'var(--cyan)' },
    'Elliptical':     { icon: 'elliptical', iconClass: 'elliptical', label: 'ELLIPTIQUE', color: 'var(--purple)' },
    'WeightTraining': { icon: 'workout', iconClass: 'workout',    label: 'MUSCU',        color: 'var(--orange)' },
    'Workout':        { icon: 'workout', iconClass: 'workout',    label: 'PPG',          color: 'var(--orange)' },
    'HighIntensityIntervalTraining': { icon: 'workout', iconClass: 'workout', label: 'HIIT', color: 'var(--red)' },
};

// Garmin typeKey → unified type
const GARMIN_TYPE_MAP = {
    'running':            'Run',
    'trail_running':      'TrailRun',
    'treadmill_running':  'Treadmill',
    'walking':            'Walk',
    'hiking':             'Hike',
    'swimming':           'Swim',
    'lap_swimming':       'Swim',
    'open_water_swimming':'Swim',
    'elliptical':         'Elliptical',
    'strength_training':  'WeightTraining',
    'cardio':             'Workout',
    'yoga':               'Workout',
    'other':              'Workout',
};

function detectType(act) {
    const st = act.sport_type || act.type;
    // Treadmill detection: Run with D+=0, or named "My Workout"/"Manual Workout"
    if (st === 'Run') {
        const name = (act.name || '').toLowerCase();
        const isTreadmill = act.total_elevation_gain === 0
            || name.includes('workout')
            || name.includes('tapis')
            || name.includes('treadmill');
        if (isTreadmill) return 'Treadmill';
    }
    return st;
}

function fmtSwimPace(distance, movingTime) {
    if (!distance || distance === 0) return '-';
    const secPer100 = movingTime / (distance / 100);
    const min = Math.floor(secPer100 / 60);
    const sec = Math.round(secPer100 % 60);
    return min + ':' + String(sec).padStart(2, '0') + '/100m';
}

// FC zones for coloring
var FC_ZONES_DEFAULT = [
    { max: 112, label: 'Repos',  bg: '#1e3a5f', color: '#60a5fa' },
    { max: 125, label: 'Z1',     bg: '#1e3a5f', color: '#3b82f6' },
    { max: 138, label: 'Z2',     bg: '#0a2e1a', color: '#22c55e' },
    { max: 152, label: 'Z3',     bg: '#2d2206', color: '#eab308' },
    { max: 165, label: 'Z4',     bg: '#3d1c08', color: '#f97316' },
    { max: 999, label: 'Z5',     bg: '#3d0a0a', color: '#ef4444' },
];
// Initialize default zones for both athletes
_fcZonesByAthlete.yohann = FC_ZONES_DEFAULT.map(function(z) { return Object.assign({}, z); });
_fcZonesByAthlete.juliette = FC_ZONES_DEFAULT.map(function(z) { return Object.assign({}, z); });

function getZone(hr, athlete) {
    if (!hr) return null;
    var zones = _fcZonesByAthlete[athlete || currentAthlete] || FC_ZONES_DEFAULT;
    return zones.find(function(z) { return hr <= z.max; });
}

function fmt(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    return h > 0 ? h + 'h' + String(m).padStart(2, '0') : m + 'min';
}

function fmtPace(mps) {
    if (!mps || mps === 0) return '-';
    const spk = 1000 / mps;
    return Math.floor(spk / 60) + ':' + String(Math.round(spk % 60)).padStart(2, '0') + '/km';
}

function fmtDate(s) {
    const d = new Date(s);
    return d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
}

function fmtDateShort(s) {
    const d = new Date(s);
    return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
}

function fetchActivities(athlete) {
    athlete = athlete || 'yohann';
    var cfg = ATHLETES[athlete];
    var _nc = '?t=' + Date.now();
    var stravaP = fetch(cfg.dataDir + 'strava-activities.json' + _nc).then(function(r) { return r.ok ? r.json() : []; }).catch(function() { return []; });
    var garminP = fetch(cfg.dataDir + 'garmin-activities.json' + _nc).then(function(r) { return r.ok ? r.json() : []; }).catch(function() { return []; });

    return Promise.all([stravaP, garminP]).then(function(results) {
        var stravaActs = results[0];
        var garminActs = results[1];
        // Normalize Garmin activities to match Strava format
        var garminNorm = (garminActs || []).map(function(ga) {
            var unified = GARMIN_TYPE_MAP[ga.type] || 'Workout';
            return {
                name: ga.name,
                type: unified,
                sport_type: unified,
                start_date_local: ga.start_date_local,
                distance: ga.distance || 0,
                moving_time: ga.moving_time || 0,
                elapsed_time: ga.elapsed_time || 0,
                total_elevation_gain: ga.total_elevation_gain || 0,
                average_speed: ga.average_speed || 0,
                average_heartrate: ga.average_heartrate,
                max_heartrate: ga.max_heartrate,
                source: 'garmin',
                _garmin_type: ga.type,
            };
        });

        // Merge Strava + Garmin: when both have the same activity (within 5min), combine best data
        var parseLocal = function(s) { return new Date(s.replace('Z', '').replace(' ', 'T')); };
        var merged = [];
        var usedGarmin = new Set();

        (stravaActs || []).forEach(function(sa) {
            var sTime = parseLocal(sa.start_date_local).getTime();
            var match = garminNorm.find(function(ga, i) {
                if (usedGarmin.has(i)) return false;
                return Math.abs(parseLocal(ga.start_date_local).getTime() - sTime) < 300000;
            });
            if (match) {
                usedGarmin.add(garminNorm.indexOf(match));
                merged.push(Object.assign({}, sa, {
                    source: 'strava+garmin',
                    average_heartrate: sa.average_heartrate || match.average_heartrate,
                    max_heartrate: sa.max_heartrate || match.max_heartrate,
                    total_elevation_gain: (sa.total_elevation_gain > 0 ? sa.total_elevation_gain : match.total_elevation_gain) || 0,
                    distance: sa.distance > 0 ? sa.distance : match.distance,
                    moving_time: sa.moving_time > 0 ? sa.moving_time : match.moving_time,
                    calories: sa.calories || match.calories,
                }));
            } else {
                merged.push(Object.assign({}, sa, { source: 'strava' }));
            }
        });

        // Add Garmin-only activities
        garminNorm.forEach(function(ga, i) {
            if (!usedGarmin.has(i)) merged.push(ga);
        });

        merged.sort(function(a, b) { return new Date(b.start_date_local) - new Date(a.start_date_local); });
        return merged;
    });
}

function renderActivitiesList(activities, athlete) {
    athlete = athlete || 'yohann';
    var cfg = ATHLETES[athlete];
    var p = cfg.prefix;
    var all = activities;

    if (all.length === 0) {
        document.getElementById(p + 'activities-list').innerHTML =
            '<div style="text-align:center;padding:40px;color:var(--text-muted);">' +
            '<div style="font-size:14px;">Pas encore de donnees.</div></div>';
        return;
    }

    var list = document.getElementById(p + 'activities-list');
    var summary = document.getElementById(p + 'activities-summary');
    list.innerHTML = '';

    var totalRuns = 0, totalDist = 0, totalElev = 0, totalTime = 0;
    var currentDate = '';

    all.forEach(function(act) {
        var st = detectType(act);
        var t = TYPES[st] || { icon: 'default', iconClass: 'default', label: st.toUpperCase(), color: 'var(--accent-light)' };
        var dist = (act.distance / 1000).toFixed(1);
        var elev = Math.round(act.total_elevation_gain || 0);
        var isRun = st === 'Run' || st === 'TrailRun' || st === 'Treadmill';
        var isSwim = st === 'Swim';
        var zone = getZone(act.average_heartrate, athlete);
        var dateKey = fmtDate(act.start_date_local);

        if (isRun) totalRuns++;
        totalDist += act.distance / 1000;
        totalElev += act.total_elevation_gain || 0;
        totalTime += act.moving_time || 0;

        // Date separator
        if (dateKey !== currentDate) {
            currentDate = dateKey;
            list.innerHTML += '<div style="font-size:12px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; padding:16px 0 6px; border-bottom:1px solid var(--border); margin-bottom:8px;">' + dateKey + '</div>';
        }

        // Source badge
        var srcBadge = act.source === 'garmin' ? ' <span style="font-size:9px;color:var(--text-muted);font-weight:400;">GARMIN</span>'
            : act.source === 'strava+garmin' ? ' <span style="font-size:9px;color:var(--green);font-weight:400;">S+G</span>' : '';

        var stats = '';
        if (act.distance > 0) stats += '<div class="act-stat"><div class="act-stat-value">' + dist + '<span style="font-size:11px;font-weight:400;color:var(--text-muted);"> km</span></div><div class="act-stat-label">Distance</div></div>';
        if (elev > 0) stats += '<div class="act-stat"><div class="act-stat-value text-orange">' + elev + '<span style="font-size:11px;font-weight:400;color:var(--text-muted);"> m</span></div><div class="act-stat-label">D+</div></div>';
        stats += '<div class="act-stat"><div class="act-stat-value">' + fmt(act.moving_time) + '</div><div class="act-stat-label">Duree</div></div>';
        if (act.average_heartrate) {
            var zHtml = zone ? '<span class="act-zone" style="background:' + zone.bg + ';color:' + zone.color + ';">' + zone.label + '</span>' : '';
            stats += '<div class="act-stat"><div class="act-stat-value" style="color:' + (zone ? zone.color : 'var(--text)') + ';">' + Math.round(act.average_heartrate) + '<span style="font-size:11px;font-weight:400;"> bpm</span>' + zHtml + '</div><div class="act-stat-label">FC moy</div></div>';
        }
        if (isRun && act.average_speed) stats += '<div class="act-stat"><div class="act-stat-value">' + fmtPace(act.average_speed) + '</div><div class="act-stat-label">Allure</div></div>';
        if (isSwim && act.distance > 0) stats += '<div class="act-stat"><div class="act-stat-value text-cyan">' + fmtSwimPace(act.distance, act.moving_time) + '</div><div class="act-stat-label">Allure /100m</div></div>';

        list.innerHTML +=
            '<div class="activity-card">' +
                '<div class="act-icon ' + t.iconClass + '">' + SVG[t.icon] + '</div>' +
                '<div class="act-body">' +
                    '<div class="act-header">' +
                        '<div><span class="act-name">' + act.name + '</span></div>' +
                        '<div class="act-meta"><span class="act-type-label" style="color:' + t.color + ';">' + t.label + '</span>' + srcBadge + '</div>' +
                    '</div>' +
                    '<div class="act-stats">' + stats + '</div>' +
                '</div>' +
            '</div>';
    });

    document.getElementById(p + 'sum-runs').textContent = totalRuns;
    document.getElementById(p + 'sum-distance').textContent = Math.round(totalDist);
    document.getElementById(p + 'sum-elevation').textContent = Math.round(totalElev);
    document.getElementById(p + 'sum-time').textContent = Math.round(totalTime / 3600) + 'h';
    summary.style.display = 'block';

    if (!p) {
        var stravaEl = document.getElementById('strava-status');
        if (stravaEl) { stravaEl.style.color = 'var(--green)'; stravaEl.textContent = 'Strava OK'; }
    }

    // ===== KPI VUE D'ENSEMBLE : Km + D+ semaine =====
    updateWeekKPIs(all, athlete);
}

function updateWeekKPIs(activities, athlete) {
    athlete = athlete || 'yohann';
    var p = ATHLETES[athlete].prefix;
    const now = new Date();
    const day = now.getDay();
    const diffToMonday = (day === 0 ? 6 : day - 1);
    const monday = new Date(now);
    monday.setDate(now.getDate() - diffToMonday);
    monday.setHours(0, 0, 0, 0);

    let weekKm = 0, weekElev = 0, weekCount = 0;
    activities.forEach(act => {
        const d = new Date(act.start_date_local.replace('Z', '').replace(' ', 'T'));
        if (d >= monday) {
            weekKm += (act.distance || 0) / 1000;
            weekElev += act.total_elevation_gain || 0;
            weekCount++;
        }
    });

    const kmEl = document.getElementById(p + 'kpi-week-km');
    const kmSub = document.getElementById(p + 'kpi-week-km-sub');
    if (kmEl) {
        kmEl.textContent = weekKm >= 10 ? Math.round(weekKm) : weekKm.toFixed(1);
        kmEl.style.color = weekKm >= 40 ? 'var(--green)' : weekKm >= 20 ? 'var(--yellow)' : 'var(--text-muted)';
    }
    if (kmSub) kmSub.textContent = weekCount + ' activite' + (weekCount > 1 ? 's' : '') + ' cette semaine';

    const elevEl = document.getElementById(p + 'kpi-week-elev');
    const elevSub = document.getElementById(p + 'kpi-week-elev-sub');
    if (elevEl) {
        elevEl.innerHTML = Math.round(weekElev) + '<span style="font-size:18px; color: var(--text-muted);"> m</span>';
        elevEl.style.color = weekElev >= 500 ? 'var(--green)' : weekElev >= 200 ? 'var(--yellow)' : 'var(--text-muted)';
    }
    if (elevSub) elevSub.textContent = 'D+ semaine en cours';
}

function matchWeekActivities(activities, athlete) {
    athlete = athlete || 'yohann';
    var container = document.getElementById('athlete-' + athlete);
    const now = new Date();
    const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');

    // Index activities by date (YYYY-MM-DD) — extract date directly from local string
    const actByDate = {};
    activities.forEach(act => {
        var raw = (act.start_date_local || '').replace(' ', 'T');
        var key = raw.slice(0, 10); // YYYY-MM-DD from local time string
        if (key && /^\d{4}-\d{2}-\d{2}$/.test(key)) {
            if (!actByDate[key]) actByDate[key] = [];
            actByDate[key].push(act);
        }
    });

    const dayEls = container.querySelectorAll('.week-day[data-date]');
    let totalExpected = 0, totalDone = 0;

    dayEls.forEach(el => {
        const date = el.dataset.date;
        const matchEl = el.querySelector('.day-match');
        if (!matchEl) return;

        const isFuture = date > todayStr;
        const dayActs = actByDate[date] || [];
        const detailEl = el.querySelector('.day-details');
        const isRestDay = detailEl ? detailEl.textContent.toLowerCase().includes('repos complet') : false;

        if (isFuture) {
            matchEl.innerHTML = '<div class="day-match-future">A venir</div>';
            return;
        }

        // Check coach-log checks for this day
        var GARMIN_KEYWORDS = ['elliptique', 'course', 'trail', 'natation', 'tapis', 'vélo', 'velo', 'running'];
        var dailyEntry = (_coachLogByAthlete[athlete] || []).find(function(d) { return d.date === date; });
        var checks = dailyEntry && dailyEntry.checks ? dailyEntry.checks : {};
        var checkKeys = Object.keys(checks);

        // Count actions granularly: each check = 1 action
        var dayExpected = 0, dayDone = 0;
        var hasGarminCheck = false;
        checkKeys.forEach(function(k) {
            var lower = k.toLowerCase();
            var isGarmin = GARMIN_KEYWORDS.some(function(kw) { return lower.indexOf(kw) >= 0; });
            if (isGarmin) {
                hasGarminCheck = true;
                dayExpected++;
                if (dayActs.length > 0) dayDone++; // Garmin validates this action
            } else {
                dayExpected++;
                if (checks[k] === true) dayDone++;
            }
        });
        // Rest day counts as 1 expected, 1 done
        if (isRestDay && dayExpected === 0) { dayExpected = 1; dayDone = 1; }

        totalExpected += dayExpected;
        totalDone += dayDone;

        // Day fully validated?
        var dayFullyDone = dayExpected > 0 && dayDone === dayExpected;

        // Display: activity match
        if (dayActs.length > 0) {
            let html = '';
            dayActs.forEach(act => {
                const st = detectType(act);
                const t = TYPES[st] || { label: st, color: 'var(--accent-light)' };
                const dist = (act.distance / 1000).toFixed(1);
                const dur = fmt(act.moving_time);
                const fcStr = act.average_heartrate ? ' · ' + Math.round(act.average_heartrate) + ' bpm' : '';
                html += '<div class="day-match-done">' +
                    '<span style="color:var(--green);font-weight:700;">&#10003;</span> ' +
                    '<span style="color:' + t.color + ';font-weight:600;">' + t.label + '</span> ' +
                    '<span style="color:var(--text-muted);">' + act.name + ' — ' + dist + ' km · ' + dur + fcStr + '</span>' +
                    '</div>';
            });
            matchEl.innerHTML = html;
        } else if (isRestDay) {
            matchEl.innerHTML = '<div class="day-match-done"><span style="color:var(--green);font-weight:700;">&#10003;</span> <span style="color:var(--text-muted);">Repos respecte</span></div>';
        } else if (hasGarminCheck) {
            // Expects a Garmin activity but none found
            matchEl.innerHTML = '<div class="day-match-miss">&#10007; Pas d\'activite enregistree</div>';
        } else {
            // No Garmin activity expected — nothing to display
            matchEl.innerHTML = '';
        }

        // Green card if day is fully validated
        el.classList.toggle('day-validated', dayFullyDone);
    });

    // Regularity widget
    var p = ATHLETES[athlete].prefix;
    var regEl = document.getElementById(p + 'week-regularity');
    if (regEl && totalExpected > 0) {
        regEl.style.display = 'block';
        var pct = Math.round(totalDone / totalExpected * 100);
        var color = pct >= 80 ? 'var(--green)' : pct >= 60 ? 'var(--yellow)' : 'var(--orange)';
        var badgeCls = pct >= 80 ? 'badge-green' : pct >= 60 ? 'badge-yellow' : 'badge-orange';
        var regBadge = document.getElementById(p + 'week-regularity-badge');
        if (regBadge) { regBadge.className = 'badge ' + badgeCls; regBadge.textContent = pct + '%'; }
        var regBar = document.getElementById(p + 'week-regularity-bar');
        if (regBar) { regBar.style.width = pct + '%'; regBar.style.background = color; }
        var regDetail = document.getElementById(p + 'week-regularity-detail');
        if (regDetail) regDetail.textContent = totalDone + '/' + totalExpected + ' actions realisees';
    }
}

// fetchActivities() + renderActivitiesList() are called via loadAthleteData()

// ===== MANUAL CHECKS (renfo/iso/PPG) =====
var _checksDirty = false;

function updateDayValidation(dayEl, athlete) {
    var GARMIN_KEYWORDS = ['elliptique', 'course', 'trail', 'natation', 'tapis', 'vélo', 'velo', 'running'];
    var chips = dayEl.querySelectorAll('.day-check');
    if (chips.length === 0) return;
    var allDone = true;
    chips.forEach(function(chip) {
        var label = chip.textContent.replace(/^[\u2713\u25CB]\s*/, '').trim();
        var lower = label.toLowerCase();
        var isGarmin = GARMIN_KEYWORDS.some(function(kw) { return lower.indexOf(kw) >= 0; });
        if (isGarmin) {
            // Garmin checks are validated by activity match, not by checkbox
            var matchEl = dayEl.querySelector('.day-match');
            var hasActivity = matchEl && matchEl.querySelector('.day-match-done');
            if (!hasActivity) allDone = false;
        } else {
            if (!chip.classList.contains('checked')) allDone = false;
        }
    });
    dayEl.classList.toggle('day-validated', allDone);
}

function initManualChecks(athlete) {
    athlete = athlete || 'yohann';
    var containerEl = document.getElementById('athlete-' + athlete);
    var daily = _coachLogByAthlete[athlete] || [];
    containerEl.querySelectorAll('.week-day[data-checks]').forEach(function(dayEl) {
        var date = dayEl.dataset.date;
        var items = dayEl.dataset.checks.split(',').map(function(s) { return s.trim(); }).filter(Boolean);
        var container = dayEl.querySelector('.day-checks');
        if (!container || items.length === 0) return;
        container.innerHTML = '';

        var coachEntry = daily.find(function(d) { return d.date === date; });
        var coachChecks = coachEntry && coachEntry.checks ? coachEntry.checks : null;

        items.forEach(function(item) {
            var key = 'check_' + date + '_' + item.replace(/[^a-zA-Z0-9]/g, '_');
            var isChecked = coachChecks ? !!coachChecks[item] : localStorage.getItem(key) === '1';

            var chip = document.createElement('span');
            chip.className = 'day-check' + (isChecked ? ' checked' : '');
            chip.innerHTML = '<span class="check-icon">' + (isChecked ? '\u2713' : '\u25CB') + '</span>' + item;
            chip.addEventListener('click', function() {
                var nowChecked = !this.classList.contains('checked');
                this.classList.toggle('checked', nowChecked);
                this.querySelector('.check-icon').textContent = nowChecked ? '\u2713' : '\u25CB';
                localStorage.setItem(key, nowChecked ? '1' : '0');
                _checksDirty = true;
                showSaveChecksBtn();
                // Update card validation state
                updateDayValidation(dayEl, athlete);
            });

            container.appendChild(chip);
        });
    });
}

function rpeColor(val) {
    if (val == null) return 'var(--text-muted)';
    if (val <= 4) return 'var(--green)';
    if (val <= 6) return 'var(--yellow)';
    if (val <= 8) return 'var(--orange)';
    return 'var(--red)';
}

function initDayMetrics(athlete) {
    athlete = athlete || 'yohann';
    var containerEl = document.getElementById('athlete-' + athlete);
    var daily = _coachLogByAthlete[athlete] || [];
    var injuryKey = ATHLETES[athlete].injuryKey;
    containerEl.querySelectorAll('.week-day[data-date]').forEach(function(dayEl) {
        var date = dayEl.dataset.date;
        // Remove previous metrics if re-init
        var old = dayEl.querySelector('.day-metrics');
        if (old) old.remove();
        // Remove previous metric summary if re-init
        var oldSummary = dayEl.querySelector('.day-metrics-summary');
        if (oldSummary) oldSummary.remove();

        var coachEntry = daily.find(function(d) { return d.date === date; });

        var isPast = dayEl.classList.contains('day-past');

        var injuryLabel = injuryKey === 'soleaire' ? 'Sol' : injuryKey === 'genou' ? 'Gen' : injuryKey;
        var injuryLabelFull = injuryKey === 'soleaire' ? 'Soléaire' : injuryKey === 'genou' ? 'Genou' : injuryKey;
        var metrics = [
            { key: injuryKey, label: injuryLabelFull, shortLabel: injuryLabel, colorFn: soleaireColor },
            { key: 'rpe', label: 'RPE', shortLabel: 'RPE', colorFn: rpeColor }
        ];

        // For past days: add compact summary badges in header
        if (isPast) {
            var summaryEl = document.createElement('div');
            summaryEl.className = 'day-metrics-summary';
            var hasSummary = false;
            metrics.forEach(function(m) {
                var val = coachEntry && coachEntry[m.key] != null ? Math.round(coachEntry[m.key]) : null;
                if (val != null) {
                    var badge = document.createElement('span');
                    badge.className = 'metric-badge';
                    badge.style.color = m.colorFn(val);
                    badge.style.borderColor = m.colorFn(val);
                    badge.textContent = m.shortLabel + ' ' + val;
                    summaryEl.appendChild(badge);
                    hasSummary = true;
                }
            });
            if (hasSummary) {
                var header = dayEl.querySelector('.day-header');
                if (header) header.appendChild(summaryEl);
            }
        }

        // Full metric dots (interactive)
        var container = document.createElement('div');
        container.className = 'day-metrics';

        metrics.forEach(function(m) {
            var row = document.createElement('div');
            row.className = 'metric-row';
            row.dataset.metric = m.key;

            var savedVal = coachEntry && coachEntry[m.key] != null ? Math.round(coachEntry[m.key]) : null;
            row.dataset.value = savedVal != null ? savedVal : '';

            var lbl = document.createElement('span');
            lbl.className = 'metric-label';
            lbl.textContent = m.label;
            row.appendChild(lbl);

            var dots = document.createElement('span');
            dots.className = 'metric-dots';

            for (var i = 0; i <= 10; i++) {
                (function(idx) {
                    var dot = document.createElement('button');
                    dot.className = 'metric-dot';
                    dot.dataset.idx = idx;
                    dot.title = idx + '/10';
                    if (savedVal != null && idx <= savedVal) {
                        dot.classList.add('filled');
                        dot.style.background = m.colorFn(savedVal);
                    }
                    dot.addEventListener('click', function() {
                        var current = row.dataset.value !== '' ? parseInt(row.dataset.value) : null;
                        var newVal = (current === idx) ? null : idx;
                        row.dataset.value = newVal != null ? newVal : '';
                        row.dataset.dirty = '1';
                        row.querySelectorAll('.metric-dot').forEach(function(d) {
                            var di = parseInt(d.dataset.idx);
                            if (newVal != null && di <= newVal) {
                                d.classList.add('filled');
                                d.style.background = m.colorFn(newVal);
                            } else {
                                d.classList.remove('filled');
                                d.style.background = '';
                            }
                        });
                        var vs = row.querySelector('.metric-value');
                        if (vs) { vs.textContent = newVal != null ? newVal : ''; vs.style.color = m.colorFn(newVal); }
                        _checksDirty = true;
                        showSaveChecksBtn();
                    });
                    dots.appendChild(dot);
                })(i);
            }
            row.appendChild(dots);

            var valSpan = document.createElement('span');
            valSpan.className = 'metric-value';
            valSpan.textContent = savedVal != null ? savedVal : '';
            valSpan.style.color = m.colorFn(savedVal);
            row.appendChild(valSpan);

            container.appendChild(row);
        });

        dayEl.appendChild(container);
    });
}

function showSaveChecksBtn() {
    var btn = document.getElementById('save-checks-btn');
    if (!btn) {
        btn = document.createElement('button');
        btn.id = 'save-checks-btn';
        btn.className = 'save-checks-btn';
        btn.textContent = 'Sauvegarder';
        btn.onclick = saveChecksToGitHub;
        document.body.appendChild(btn);
    }
    btn.disabled = false;
    btn.textContent = 'Sauvegarder';
    btn.style.background = '';
    setTimeout(function() { btn.classList.add('visible'); }, 10);
}

function collectAllDayData(athlete) {
    athlete = athlete || currentAthlete;
    var containerEl = document.getElementById('athlete-' + athlete);
    var result = {};
    containerEl.querySelectorAll('.week-day[data-date]').forEach(function(dayEl) {
        var date = dayEl.dataset.date;
        var entry = {};
        // Checks
        var checks = {};
        dayEl.querySelectorAll('.day-check').forEach(function(chip) {
            var name = chip.textContent.replace(/^[\u2713\u25CB]\s*/, '');
            checks[name] = chip.classList.contains('checked');
        });
        if (Object.keys(checks).length > 0) entry.checks = checks;
        // Metrics (soléaire, RPE) — only send if user interacted (dirty) or has a value
        dayEl.querySelectorAll('.metric-row').forEach(function(row) {
            var key = row.dataset.metric;
            var val = row.dataset.value;
            if (row.dataset.dirty === '1' || val !== '') {
                entry[key] = val !== '' ? parseInt(val) : null;
            }
            // Skip sending null for non-dirty metrics → prevents overwriting saved values
        });
        result[date] = entry;
    });
    return result;
}

function saveChecksToGitHub() {
    var btn = document.getElementById('save-checks-btn');
    btn.disabled = true;
    btn.textContent = 'Sauvegarde...';

    var allData = collectAllDayData(currentAthlete);
    var injKey = ATHLETES[currentAthlete].injuryKey;
    var headers = isLocalhost ? { 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': '1' };

    // Build daily entries to save via backoffice
    var entries = Object.keys(allData).map(function(date) {
        var dayData = allData[date];
        var entry = { date: date };
        if (dayData.checks) entry.checks = dayData.checks;
        if (dayData[injKey] !== undefined) entry[injKey] = dayData[injKey];
        if (dayData.rpe !== undefined) entry.rpe = dayData.rpe;
        return entry;
    });

    // Save all entries in a single request via backoffice API
    fetch(API_BASE + '/api/save?athlete=' + currentAthlete, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({ dailyBatch: entries })
    })
    .then(function(r) { if (!r.ok) throw new Error('Save failed'); return r.json(); })
    .then(function() {
        btn.textContent = 'OK !';
        btn.style.background = 'var(--green-dark)';
        _checksDirty = false;
        // Update local coach-log data directly (avoid re-fetch which can return cached data)
        var daily = _coachLogByAthlete[currentAthlete] || [];
        entries.forEach(function(entry) {
            var idx = daily.findIndex(function(d) { return d.date === entry.date; });
            if (idx >= 0) {
                Object.keys(entry).forEach(function(k) { daily[idx][k] = entry[k]; });
            } else {
                daily.push(entry);
            }
        });
        _coachLogByAthlete[currentAthlete] = daily;
        setTimeout(function() { btn.classList.remove('visible'); }, 1500);
    })
    .catch(function(err) {
        btn.textContent = 'Erreur';
        btn.style.background = 'var(--red)';
        console.error('Save checks error:', err);
        setTimeout(function() {
            btn.textContent = 'Sauvegarder';
            btn.style.background = '';
            btn.disabled = false;
        }, 2000);
    });
}

// ===== DYNAMIC TODAY CARD + PAST DAYS =====
var EXERCISE_SVGS = {
    iso: '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="10" r="5" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="15" x2="32" y2="35" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="20" x2="24" y2="28" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="20" x2="40" y2="28" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="35" x2="27" y2="48" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="35" x2="37" y2="48" stroke="var(--accent)" stroke-width="2"/><line x1="24" y1="48" x2="40" y2="48" stroke="var(--text-muted)" stroke-width="1.5" stroke-dasharray="2 2"/><circle cx="27" cy="48" r="2" fill="var(--accent)"/><circle cx="37" cy="48" r="2" fill="var(--accent)"/><line x1="44" y1="46" x2="44" y2="36" stroke="var(--accent)" stroke-width="2"/><polyline points="41,39 44,36 47,39" stroke="var(--accent)" stroke-width="2" fill="none"/><ellipse cx="35" cy="42" rx="3" ry="5" stroke="var(--accent)" stroke-width="1" opacity="0.4"/></svg>',
    cardio: '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M32 52 C32 52 12 38 12 24 C12 18 17 13 23 13 C27 13 30 15 32 18 C34 15 37 13 41 13 C47 13 52 18 52 24 C52 38 32 52 32 52Z" stroke="var(--accent)" stroke-width="2" fill="none"/><path d="M20 30 L26 30 L28 24 L30 36 L32 28 L34 32 L36 30 L44 30" stroke="var(--accent)" stroke-width="1.5" fill="none"/></svg>',
    ppg: '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="22" r="5" stroke="var(--accent)" stroke-width="2"/><line x1="46" y1="24" x2="18" y2="30" stroke="var(--accent)" stroke-width="2"/><line x1="42" y1="26" x2="42" y2="40" stroke="var(--accent)" stroke-width="2"/><line x1="34" y1="28" x2="34" y2="42" stroke="var(--accent)" stroke-width="2"/><line x1="18" y1="30" x2="12" y2="42" stroke="var(--accent)" stroke-width="2"/><line x1="18" y1="30" x2="20" y2="42" stroke="var(--accent)" stroke-width="2"/><line x1="8" y1="42" x2="46" y2="42" stroke="var(--text-muted)" stroke-width="1" stroke-dasharray="3 2"/></svg>',
    marche: '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="8" r="5" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="13" x2="32" y2="33" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="20" x2="24" y2="28" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="20" x2="40" y2="26" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="33" x2="24" y2="50" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="33" x2="38" y2="46" stroke="var(--accent)" stroke-width="2"/><line x1="38" y1="46" x2="42" y2="50" stroke="var(--accent)" stroke-width="2"/><line x1="20" y1="50" x2="46" y2="50" stroke="var(--text-muted)" stroke-width="1" stroke-dasharray="3 2"/></svg>',
    running: '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="36" cy="8" r="5" stroke="var(--accent)" stroke-width="2"/><line x1="34" y1="13" x2="30" y2="32" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="18" x2="22" y2="24" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="18" x2="42" y2="22" stroke="var(--accent)" stroke-width="2"/><line x1="30" y1="32" x2="20" y2="48" stroke="var(--accent)" stroke-width="2"/><line x1="30" y1="32" x2="42" y2="44" stroke="var(--accent)" stroke-width="2"/><line x1="42" y1="44" x2="48" y2="42" stroke="var(--accent)" stroke-width="2"/><line x1="20" y1="48" x2="16" y2="52" stroke="var(--accent)" stroke-width="2"/></svg>',
    repos: '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M36 12 C36 12 28 14 24 22 C20 30 22 40 30 46 C38 52 48 50 52 42 C48 46 38 48 32 42 C26 36 26 24 36 12Z" stroke="var(--accent)" stroke-width="2" fill="none"/><text x="44" y="20" font-size="12" fill="var(--accent)" font-weight="bold">z</text><text x="50" y="14" font-size="10" fill="var(--accent)" font-weight="bold">z</text></svg>'
};

var EXERCISE_PATTERNS = [
    { key: 'iso', pattern: /iso|mollet/i, label: 'Iso mollets' },
    { key: 'running', pattern: /footing|course|trail|trot/i, label: 'Course' },
    { key: 'cardio', pattern: /elliptique|natation|nage|cardio/i, label: 'Cardio' },
    { key: 'ppg', pattern: /ppg|gainage|pompe|musculation/i, label: 'PPG' },
    { key: 'marche', pattern: /marche|rando/i, label: 'Marche' },
    { key: 'repos', pattern: /repos|off|souple/i, label: 'Repos' }
];

function detectExercises(badgeText, detailsText) {
    var combined = (badgeText || '') + ' ' + (detailsText || '');
    var found = [];
    var seen = {};
    EXERCISE_PATTERNS.forEach(function(ep) {
        if (!seen[ep.key] && ep.pattern.test(combined)) {
            found.push({ key: ep.key, label: ep.label });
            seen[ep.key] = true;
        }
    });
    return found.slice(0, 3);
}

// ===== DYNAMIC WEEK PLAN =====
function renderWeekPlan(plan, athlete) {
    athlete = athlete || 'yohann';
    var cfg = ATHLETES[athlete];
    var p = cfg.prefix;
    var container = document.getElementById(p + 'week-plan-container');
    if (!container) return;

    if (!plan || plan.notFound) {
        container.innerHTML = '<div class="card" style="margin-top:20px;text-align:center;padding:40px;color:var(--text-muted);">' +
            '<div style="font-size:14px;">Pas de programme pour cette semaine.</div>' +
            '<div style="font-size:12px;margin-top:8px;">Demande a ton coach de le creer via le chat.</div></div>';
        return;
    }

    var html = '<div class="card" style="margin-top: 20px;">';

    // Header: title + bloc badge
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">';
    html += '<h2 style="margin: 0;">' + escapeHtmlFront(plan.title || ('Semaine ' + plan.week)) + '</h2>';
    if (plan.bloc) {
        html += '<span class="badge badge-blue">' + escapeHtmlFront(plan.bloc).toUpperCase() + '</span>';
    }
    html += '</div>';

    // Note-box: objective + volume
    if (plan.objective || plan.volume) {
        html += '<div class="note-box">';
        if (plan.objective) html += '<strong>Objectif :</strong> ' + escapeHtmlFront(plan.objective) + '<br>';
        if (plan.volume) html += '<strong>Volume cible :</strong> ' + escapeHtmlFront(plan.volume);
        html += '</div>';
    }

    // Days
    plan.days.forEach(function(day) {
        var highlightStyle = day.highlight ? ' style="border-left: 3px solid var(--red);"' : '';
        var checksAttr = day.checks && day.checks.length > 0 ? ' data-checks="' + day.checks.join(',') + '"' : '';
        html += '<div class="week-day"' + highlightStyle + ' data-date="' + day.date + '"' + checksAttr + '>';
        html += '<div class="day-header">';
        html += '<span class="day-name">' + day.dayName + ' ' + day.dayNum + '</span>';
        var badgeClass = day.badgeClass || 'badge-blue';
        if (badgeClass === 'badge-grey') {
            html += '<span class="badge" style="background: #333; color: #999;">' + escapeHtmlFront(day.title) + '</span>';
        } else {
            html += '<span class="badge ' + badgeClass + '">' + escapeHtmlFront(day.title) + '</span>';
        }
        html += '</div>';
        html += '<div class="day-details">' + day.detailsHtml + '</div>';
        html += '<div class="day-match"></div>';
        html += '<div class="day-checks"></div>';
        html += '</div>';
    });

    // Regularity widget
    html += '<div id="' + p + 'week-regularity" style="margin-top: 16px; padding: 14px; background: var(--bg-card-alt); border-radius: 8px; display: none;">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">';
    html += '<span style="font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">R\u00e9gularit\u00e9</span>';
    html += '<span id="' + p + 'week-regularity-badge" class="badge badge-yellow">--</span>';
    html += '</div>';
    html += '<div class="progress-bar" style="height: 10px;"><div class="fill" id="' + p + 'week-regularity-bar" style="width: 0%; background: var(--yellow);"></div></div>';
    html += '<div id="' + p + 'week-regularity-detail" style="font-size: 12px; color: var(--text-muted); margin-top: 6px;"></div>';
    html += '</div>';

    // Volume summary
    if (plan.volume) {
        html += '<div style="margin-top: 16px; padding: 12px; background: var(--bg-card-alt); border-radius: 8px;">';
        html += '<div style="display: flex; justify-content: space-between; font-size: 13px;">';
        html += '<span class="text-muted">Volume total cible</span>';
        html += '<span class="text-bold">' + escapeHtmlFront(plan.volume) + '</span>';
        html += '</div></div>';
    }

    html += '</div>';
    container.innerHTML = html;
}

function escapeHtmlFront(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function fetchWeekPlan(athlete) {
    athlete = athlete || 'yohann';
    var now = new Date();
    var weekNum = getISOWeek(now);
    var currentWeek = now.getFullYear() + '-W' + String(weekNum).padStart(2, '0');
    var dayOfWeek = now.getDay() || 7;

    var headers = isLocalhost ? {} : { 'ngrok-skip-browser-warning': '1' };

    // Always fetch current week
    var currentFetch = fetch(API_BASE + '/api/week-plan?athlete=' + athlete + '&week=' + currentWeek, { headers: headers, cache: 'no-store' })
        .then(function(r) { return r.json(); })
        .catch(function() { return { notFound: true, week: currentWeek }; });

    // Fetch next week if Thu+
    var nextFetch = Promise.resolve(null);
    if (dayOfWeek >= 4) {
        var nextWeekDate = new Date(now);
        nextWeekDate.setDate(nextWeekDate.getDate() + (8 - dayOfWeek));
        var nextWeekNum = getISOWeek(nextWeekDate);
        var nextWeek = nextWeekDate.getFullYear() + '-W' + String(nextWeekNum).padStart(2, '0');
        nextFetch = fetch(API_BASE + '/api/week-plan?athlete=' + athlete + '&week=' + nextWeek, { headers: headers, cache: 'no-store' })
            .then(function(r) { return r.json(); })
            .catch(function() { return { notFound: true, week: nextWeek }; });
    }

    // Always fetch previous week
    var prevWeekDate = new Date(now);
    prevWeekDate.setDate(prevWeekDate.getDate() - 7);
    var prevWeekNum = getISOWeek(prevWeekDate);
    var prevWeek = prevWeekDate.getFullYear() + '-W' + String(prevWeekNum).padStart(2, '0');
    var prevFetch = fetch(API_BASE + '/api/week-plan?athlete=' + athlete + '&week=' + prevWeek, { headers: headers, cache: 'no-store' })
        .then(function(r) { return r.json(); })
        .catch(function() { return { notFound: true, week: prevWeek }; });

    return Promise.all([currentFetch, nextFetch, prevFetch]).then(function(results) {
        return { current: results[0], next: results[1], previous: results[2] };
    });
}

function applyWeekPlan(weekData, athlete) {
    athlete = athlete || 'yohann';
    var cfg = ATHLETES[athlete];
    var p = cfg.prefix;

    // Handle both old array format and new object format
    var current, next, previous;
    if (weekData && weekData.current) {
        current = weekData.current;
        next = weekData.next;
        previous = weekData.previous;
    } else if (Array.isArray(weekData)) {
        current = weekData[0];
        next = weekData[1] || null;
        previous = null;
    } else {
        current = weekData;
        next = null;
        previous = null;
    }

    var container = document.getElementById(p + 'week-plan-container');
    if (!container) return;
    container.innerHTML = '';

    var oldNext = document.getElementById(p + 'week-plan-next');
    if (oldNext) oldNext.remove();

    var todayC = document.getElementById(p + 'today-container');
    if (todayC) todayC.innerHTML = '';

    renderWeekPlan(current, athlete);

    if (next && !next.notFound) {
        var nextContainer = document.createElement('div');
        nextContainer.id = p + 'week-plan-next';
        container.parentNode.insertBefore(nextContainer, container.nextSibling);
        var nextHtml = '';
        var plan = next;
        nextHtml += '<div class="card" style="margin-top: 20px;">';
        nextHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">';
        nextHtml += '<h2 style="margin: 0;">' + escapeHtmlFront(plan.title || ('Semaine ' + plan.week)) + '</h2>';
        if (plan.bloc) nextHtml += '<span class="badge badge-blue">' + escapeHtmlFront(plan.bloc).toUpperCase() + '</span>';
        nextHtml += '</div>';
        if (plan.objective || plan.volume) {
            nextHtml += '<div class="note-box">';
            if (plan.objective) nextHtml += '<strong>Objectif :</strong> ' + escapeHtmlFront(plan.objective) + '<br>';
            if (plan.volume) nextHtml += '<strong>Volume cible :</strong> ' + escapeHtmlFront(plan.volume);
            nextHtml += '</div>';
        }
        plan.days.forEach(function(day) {
            var hl = day.highlight ? ' style="border-left: 3px solid var(--red);"' : '';
            var ca = day.checks && day.checks.length > 0 ? ' data-checks="' + day.checks.join(',') + '"' : '';
            nextHtml += '<div class="week-day"' + hl + ' data-date="' + day.date + '"' + ca + '>';
            nextHtml += '<div class="day-header"><span class="day-name">' + day.dayName + ' ' + day.dayNum + '</span>';
            var bc = day.badgeClass || 'badge-blue';
            if (bc === 'badge-grey') nextHtml += '<span class="badge" style="background: #333; color: #999;">' + escapeHtmlFront(day.title) + '</span>';
            else nextHtml += '<span class="badge ' + bc + '">' + escapeHtmlFront(day.title) + '</span>';
            nextHtml += '</div>';
            nextHtml += '<div class="day-details">' + day.detailsHtml + '</div>';
            nextHtml += '<div class="day-match"></div><div class="day-checks"></div></div>';
        });
        nextHtml += '</div>';
        nextContainer.innerHTML = nextHtml;
    }

    // Populate past days tab with previous week
    populatePastDays(previous, athlete);
}

function populatePastDays(previousPlan, athlete) {
    athlete = athlete || 'yohann';
    var p = ATHLETES[athlete].prefix;
    var pastContainer = document.getElementById(p + 'week-past');
    if (!pastContainer) return;

    // Clear existing content
    pastContainer.innerHTML = '';

    // Header
    var headerEl = document.createElement('h3');
    headerEl.style.cssText = 'font-size: 15px; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;';
    headerEl.textContent = 'Historique recent';
    pastContainer.appendChild(headerEl);

    // Placeholder for current week past days (will be populated by movePastDaysToHistory)
    var currentWeekSlot = document.createElement('div');
    currentWeekSlot.id = p + 'past-current-week';
    pastContainer.appendChild(currentWeekSlot);

    // Previous week section
    if (!previousPlan || previousPlan.notFound || !previousPlan.days || previousPlan.days.length === 0) {
        // Show summary if plan exists but has no structured days
        if (previousPlan && !previousPlan.notFound && previousPlan.title) {
            var summaryHtml = '<div class="card" style="margin-top: 8px; padding: 14px; opacity: 0.7;">';
            summaryHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">';
            summaryHtml += '<span style="font-size: 14px; font-weight: 600;">' + escapeHtmlFront(previousPlan.title) + '</span>';
            if (previousPlan.bloc) summaryHtml += '<span class="badge badge-blue" style="font-size: 11px;">' + escapeHtmlFront(previousPlan.bloc).toUpperCase() + '</span>';
            summaryHtml += '</div>';
            if (previousPlan.objective) summaryHtml += '<div style="font-size: 12px; color: var(--text-muted);">' + escapeHtmlFront(previousPlan.objective) + '</div>';
            summaryHtml += '<div style="font-size: 11px; color: var(--text-muted); margin-top: 6px; font-style: italic;">Programme non detaille jour par jour</div>';
            summaryHtml += '</div>';
            pastContainer.insertAdjacentHTML('beforeend', summaryHtml);
        }
        return;
    }

    // Previous week title
    var prevTitle = document.createElement('div');
    prevTitle.style.cssText = 'font-size: 13px; color: var(--text-muted); margin: 16px 0 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;';
    prevTitle.textContent = previousPlan.title || ('Semaine ' + previousPlan.week);
    if (previousPlan.bloc) {
        prevTitle.innerHTML += ' <span class="badge badge-blue" style="font-size: 10px; vertical-align: middle;">' + escapeHtmlFront(previousPlan.bloc).toUpperCase() + '</span>';
    }
    pastContainer.appendChild(prevTitle);

    // Render previous week days (reverse chronological — most recent first)
    var days = previousPlan.days.slice().reverse();
    days.forEach(function(day) {
        var checksAttr = day.checks && day.checks.length > 0 ? ' data-checks="' + day.checks.join(',') + '"' : '';
        var html = '<div class="week-day day-past" data-date="' + day.date + '"' + checksAttr + '>';
        html += '<div class="day-header"><span class="day-name">' + day.dayName + ' ' + day.dayNum + '</span>';
        var bc = day.badgeClass || 'badge-blue';
        if (bc === 'badge-grey') html += '<span class="badge" style="background: #333; color: #999;">' + escapeHtmlFront(day.title) + '</span>';
        else html += '<span class="badge ' + bc + '">' + escapeHtmlFront(day.title) + '</span>';
        html += '</div>';
        html += '<div class="day-details">' + day.detailsHtml + '</div>';
        html += '<div class="day-match"></div>';
        html += '<div class="day-checks"></div>';
        html += '</div>';
        pastContainer.insertAdjacentHTML('beforeend', html);
    });
}

function movePastDaysToHistory(athlete) {
    athlete = athlete || 'yohann';
    var p = ATHLETES[athlete].prefix;
    var planContainer = document.getElementById(p + 'week-plan-container');
    var currentWeekSlot = document.getElementById(p + 'past-current-week');
    if (!planContainer || !currentWeekSlot) return;

    var pastDays = planContainer.querySelectorAll('.week-day.day-past');
    if (pastDays.length === 0) return;

    // Add "Cette semaine" label
    var label = document.createElement('div');
    label.style.cssText = 'font-size: 13px; color: var(--text-muted); margin: 0 0 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;';
    label.textContent = 'Cette semaine';
    currentWeekSlot.appendChild(label);

    // Move past days from plan to past container (keep chronological order reversed — most recent first)
    var daysArray = Array.prototype.slice.call(pastDays);
    daysArray.reverse().forEach(function(el) {
        // Insert placeholder in the plan
        var placeholder = document.createElement('div');
        placeholder.className = 'week-day-placeholder';
        placeholder.dataset.date = el.dataset.date;
        placeholder.innerHTML = '<span style="opacity:0.4">\u2192 Voir dans Passes</span>';
        el.parentNode.insertBefore(placeholder, el);

        // Move element to past container
        currentWeekSlot.appendChild(el);
    });
}

function buildTodayCard(athlete) {
    athlete = athlete || 'yohann';
    var cfg = ATHLETES[athlete];
    var p = cfg.prefix;
    var todayContainer = document.getElementById(p + 'today-container');
    if (!todayContainer) return;

    var now = new Date();
    var todayISO = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');

    var JOURS = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
    var MOIS = ['janvier','fevrier','mars','avril','mai','juin','juillet','aout','septembre','octobre','novembre','decembre'];
    var jourNom = JOURS[now.getDay()];
    var moisNom = MOIS[now.getMonth()];
    var jourNum = now.getDate();

    // Find matching day-card in the week plan
    var athleteContainer = document.getElementById('athlete-' + athlete);
    var sourceEl = athleteContainer.querySelector('#' + p + 'week-plan-container .week-day[data-date="' + todayISO + '"]');
    // Also check next-week container
    if (!sourceEl) {
        var nextC = document.getElementById(p + 'week-plan-next');
        if (nextC) sourceEl = nextC.querySelector('.week-day[data-date="' + todayISO + '"]');
    }

    var badgeHTML = '';
    var detailsHTML = '';
    var exercises = [];

    if (sourceEl) {
        var badgeEl = sourceEl.querySelector('.day-header .badge');
        if (badgeEl) badgeHTML = badgeEl.outerHTML;
        var detailEl = sourceEl.querySelector('.day-details');
        if (detailEl) detailsHTML = detailEl.innerHTML;
        exercises = detectExercises(badgeEl ? badgeEl.textContent : '', detailsHTML);

        // Insert a placeholder where the source element was
        var placeholder = document.createElement('div');
        placeholder.className = 'week-day-placeholder';
        placeholder.dataset.date = todayISO;
        placeholder.innerHTML = '<span style="opacity:0.4">\u25B2 Voir ci-dessus</span>';
        sourceEl.parentNode.insertBefore(placeholder, sourceEl);

        // MOVE (not clone) the source element into the today-card wrapper
        sourceEl.classList.add('today-card');

        var iconsHTML = '';
        if (exercises.length === 0) exercises = [{ key: 'repos', label: 'Repos' }];
        iconsHTML = '<div class="today-icons">';
        exercises.forEach(function(ex) {
            iconsHTML += '<div class="today-icon-item">' +
                '<div class="exercise-svg">' + (EXERCISE_SVGS[ex.key] || '') + '</div>' +
                '<span class="today-icon-label">' + ex.label + '</span>' +
                '</div>';
        });
        iconsHTML += '</div>';

        var wrapper = document.createElement('div');
        wrapper.className = 'card today-card-wrapper';
        wrapper.innerHTML = '<div class="today-header">' +
            '<h2>Aujourd\'hui \u2014 ' + jourNom + ' ' + jourNum + ' ' + moisNom + '</h2>' +
            badgeHTML +
            '</div>' + iconsHTML;

        wrapper.appendChild(sourceEl);
        todayContainer.innerHTML = '';
        todayContainer.appendChild(wrapper);
    } else {
        // No plan for today — show repos card
        exercises = [{ key: 'repos', label: 'Repos' }];
        badgeHTML = '<span class="badge" style="background: #333; color: #999;">Repos</span>';
        detailsHTML = 'Pas de seance programmee';

        var iconsHTML2 = '<div class="today-icons">';
        exercises.forEach(function(ex) {
            iconsHTML2 += '<div class="today-icon-item">' +
                '<div class="exercise-svg">' + (EXERCISE_SVGS[ex.key] || '') + '</div>' +
                '<span class="today-icon-label">' + ex.label + '</span>' +
                '</div>';
        });
        iconsHTML2 += '</div>';

        todayContainer.innerHTML = '<div class="card today-card week-day" data-date="' + todayISO + '">' +
            '<div class="today-header">' +
            '<h2>Aujourd\'hui \u2014 ' + jourNom + ' ' + jourNum + ' ' + moisNom + '</h2>' +
            badgeHTML +
            '</div>' +
            iconsHTML2 +
            '<div class="day-details" style="margin-top: 12px; line-height: 1.7;">' + detailsHTML + '</div>' +
            '<div class="day-match"></div>' +
            '<div class="day-checks"></div>' +
            '</div>';
    }
}

function markPastDays(athlete) {
    athlete = athlete || 'yohann';
    var p = ATHLETES[athlete].prefix;
    var containerEl = document.getElementById('athlete-' + athlete);
    var now = new Date();
    var todayISO = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');

    containerEl.querySelectorAll('.week-day[data-date]').forEach(function(el) {
        // Skip elements inside today-container or week-past (already styled)
        if (el.closest('#' + p + 'today-container')) return;
        if (el.closest('#' + p + 'week-past')) return;
        var date = el.dataset.date;
        if (date < todayISO) {
            el.classList.add('day-past');
        }
        // Today's element has been MOVED to today-container by buildTodayCard,
        // so no need to hide it here.
    });
}

// buildTodayCard, markPastDays, initManualChecks, initDayMetrics
// are now called ONCE by loadAthleteData() after all data is fetched

// ===== GARMIN WELLNESS DATA =====
function fmtSeconds(s) {
    if (!s || s <= 0) return '--';
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    return h + 'h' + String(m).padStart(2, '0');
}

function fmtDateLabel(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }).replace('.', '');
}

function fmtDateDay(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return String(d.getDate());
}

function sleepScoreColor(score) {
    if (!score) return 'var(--text-muted)';
    if (score >= 80) return 'var(--green)';
    if (score >= 60) return 'var(--yellow)';
    if (score >= 40) return 'var(--orange)';
    return 'var(--red)';
}

function bbColor(val) {
    if (!val) return 'var(--text-muted)';
    if (val >= 70) return 'var(--green)';
    if (val >= 40) return 'var(--yellow)';
    if (val >= 20) return 'var(--orange)';
    return 'var(--red)';
}

function rhrColor(val) {
    if (!val) return 'var(--text-muted)';
    if (val <= 48) return 'var(--green)';
    if (val <= 55) return 'var(--yellow)';
    return 'var(--orange)';
}

function stressColor(val) {
    if (!val) return 'var(--text-muted)';
    if (val <= 25) return 'var(--green)';
    if (val <= 50) return 'var(--yellow)';
    if (val <= 75) return 'var(--orange)';
    return 'var(--red)';
}

function hrvStatusBadge(status) {
    if (!status || status === 'UNKNOWN') return '<span class="hrv-status-badge" style="background:#333;color:#999;">INCONNU</span>';
    const map = {
        'BALANCED': { bg: 'var(--green-dark)', color: 'var(--green)', label: 'EQUILIBRE' },
        'UNBALANCED': { bg: '#854d0e', color: 'var(--yellow)', label: 'DESEQUILIBRE' },
        'LOW': { bg: 'var(--red-dark)', color: '#fca5a5', label: 'BAS' },
        'POOR': { bg: 'var(--red-dark)', color: '#fca5a5', label: 'FAIBLE' },
    };
    const s = map[status] || { bg: '#333', color: '#999', label: status };
    return '<span class="hrv-status-badge" style="background:' + s.bg + ';color:' + s.color + ';">' + s.label + '</span>';
}

function renderMiniChart(containerId, labelsId, values, colorFn, unit, formatLabel) {
    const container = document.getElementById(containerId);
    const labelsEl = document.getElementById(labelsId);
    if (!container) return;

    const validValues = values.filter(v => v.value != null && v.value > 0);
    if (validValues.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:12px;width:100%;">Pas de donnees</div>';
        return;
    }

    const nums = validValues.map(v => v.value);
    const maxVal = Math.max(...nums);
    const minVal = Math.min(...nums);
    const range = maxVal - minVal || 1;

    let html = '';
    values.forEach(v => {
        if (v.value != null && v.value > 0) {
            const pct = 15 + ((v.value - minVal) / range) * 85;
            const color = colorFn ? colorFn(v.value) : 'var(--accent)';
            const label = formatLabel ? formatLabel(v.value) : v.value;
            html += '<div class="bar" data-val="' + label + '" style="height:' + pct + '%;background:' + color + ';" title="' + v.label + ': ' + v.value + (unit || '') + '"></div>';
        } else {
            html += '<div class="bar" style="height:5%;background:var(--border);opacity:0.3;" title="' + v.label + ': --"></div>';
        }
    });
    container.innerHTML = html;

    if (labelsEl && values.length > 0) {
        labelsEl.innerHTML = '<span>' + values[0].shortLabel + '</span><span>' + values[values.length - 1].shortLabel + '</span>';
    }
}

function sleepColor(seconds) {
    if (!seconds) return 'var(--text-muted)';
    const h = seconds / 3600;
    if (h >= 7.5) return 'var(--green)';
    if (h >= 7) return 'var(--yellow)';
    if (h >= 6) return 'var(--orange)';
    return 'var(--red)';
}

function stepsColor(steps) {
    if (!steps) return 'var(--text-muted)';
    if (steps >= 10000) return 'var(--green)';
    if (steps >= 7000) return 'var(--yellow)';
    if (steps >= 5000) return 'var(--orange)';
    return 'var(--red)';
}

function fetchGarminData(athlete) {
    athlete = athlete || 'yohann';
    var cfg = ATHLETES[athlete];
    return fetch(cfg.dataDir + 'garmin-wellness.json?t=' + Date.now())
        .then(function(r) { if (!r.ok) throw new Error('No data'); return r.json(); })
        .catch(function() { return null; });
}

function renderGarminWellness(data, athlete) {
    athlete = athlete || 'yohann';
    var cfg = ATHLETES[athlete];
    var p = cfg.prefix;

    if (!data) {
        if (!p) {
            var gs = document.getElementById('garmin-status');
            if (gs) { gs.style.color = 'var(--yellow)'; gs.textContent = 'Pas de donnees'; }
        }
        var sleepEl = document.getElementById(p + 'health-sleep-detail');
        if (sleepEl) sleepEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Pas encore de donnees Garmin.</div>';
        var hrvEl = document.getElementById(p + 'health-hrv-stress');
        if (hrvEl) hrvEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Pas encore de donnees Garmin.</div>';
        return;
    }

    (function() {
            const sum = data.summary;
            const days = data.days || [];

            // ===== KPI SANTE =====
            // Last night sleep (duration + score)
            const lastNightEl = document.getElementById(p + 'health-last-night');
            const lastNightScoreEl = document.getElementById(p + 'health-last-night-score');
            const latestSleepDay = findLatest(days, 'sleep');
            if (latestSleepDay && latestSleepDay.sleep) {
                const dur = latestSleepDay.sleep.duration_seconds;
                lastNightEl.textContent = fmtSeconds(dur);
                lastNightEl.style.color = sleepColor(dur);
                if (latestSleepDay.sleep.score) {
                    lastNightScoreEl.textContent = 'Score ' + latestSleepDay.sleep.score;
                    lastNightScoreEl.style.color = sleepScoreColor(latestSleepDay.sleep.score);
                }
            }

            // Body Battery
            const bbEl = document.getElementById(p + 'health-body-battery');
            if (bbEl && sum.body_battery_current) {
                bbEl.textContent = sum.body_battery_current;
                bbEl.style.color = bbColor(sum.body_battery_current);
            }
            const bbDetail = document.getElementById(p + 'health-bb-detail');
            if (bbDetail && sum.body_battery_current) bbDetail.textContent = 'Pic du jour';

            // Sommeil moyen (Sante KPI)
            if (sum.sleep_avg_seconds) {
                const slAvgEl = document.getElementById(p + 'health-sleep-avg');
                if (slAvgEl) {
                    slAvgEl.textContent = fmtSeconds(sum.sleep_avg_seconds);
                    const h = sum.sleep_avg_seconds / 3600;
                    slAvgEl.style.color = h >= 7.5 ? 'var(--green)' : h >= 7 ? 'var(--yellow)' : h >= 6 ? 'var(--orange)' : 'var(--red)';
                }
                const slAvgSub = document.getElementById(p + 'health-sleep-avg-sub');
                if (slAvgSub) {
                    const h = sum.sleep_avg_seconds / 3600;
                    slAvgSub.textContent = 'Objectif : 7h30';
                    slAvgSub.style.color = h >= 7.5 ? 'var(--green)' : 'var(--red)';
                }
            }

            // ===== UPDATE OVERVIEW KPIs =====
            if (sum.vo2max) {
                const ov = document.getElementById(p + 'kpi-vo2max');
                if (ov) ov.textContent = sum.vo2max;
                const ovSub = document.getElementById(p + 'kpi-vo2max-sub');
                if (ovSub) ovSub.textContent = 'Garmin · ' + sum.last_sync.split(' ')[0];
            }
            // ===== SOMMEIL DETAIL =====
            const sleepDetail = document.getElementById(p + 'health-sleep-detail');
            const latestSleep = findLatest(days, 'sleep');
            if (latestSleep && latestSleep.sleep) {
                const sl = latestSleep.sleep;
                const total = sl.duration_seconds || 1;
                const deepPct = Math.round(sl.deep_seconds / total * 100);
                const lightPct = Math.round(sl.light_seconds / total * 100);
                const remPct = Math.round(sl.rem_seconds / total * 100);
                const awakePct = Math.max(0, 100 - deepPct - lightPct - remPct);

                let html = '<div style="margin-bottom:12px;"><span style="font-size:11px;color:var(--text-muted);">Derniere nuit (' + fmtDateLabel(latestSleep.date) + ')</span></div>';
                html += '<div style="text-align:center;margin-bottom:12px;"><span style="font-size:28px;font-weight:700;color:' + sleepColor(total) + ';">' + fmtSeconds(total) + '</span>';
                if (sl.score) html += ' <span style="font-size:14px;color:' + sleepScoreColor(sl.score) + ';font-weight:600;">Score ' + sl.score + '</span>';
                html += '</div>';

                // Phases bar
                html += '<div class="sleep-phases-bar">';
                if (deepPct > 0) html += '<div class="sleep-deep" style="width:' + deepPct + '%;">' + (deepPct >= 10 ? deepPct + '%' : '') + '</div>';
                if (lightPct > 0) html += '<div class="sleep-light" style="width:' + lightPct + '%;">' + (lightPct >= 10 ? lightPct + '%' : '') + '</div>';
                if (remPct > 0) html += '<div class="sleep-rem" style="width:' + remPct + '%;">' + (remPct >= 10 ? remPct + '%' : '') + '</div>';
                if (awakePct > 0) html += '<div class="sleep-awake" style="width:' + awakePct + '%;">' + (awakePct >= 10 ? awakePct + '%' : '') + '</div>';
                html += '</div>';

                // Legend
                html += '<div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:8px;font-size:12px;">';
                html += '<span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#1e3a8a;margin-right:4px;"></span>Profond ' + fmtSeconds(sl.deep_seconds) + '</span>';
                html += '<span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#3b82f6;margin-right:4px;"></span>Leger ' + fmtSeconds(sl.light_seconds) + '</span>';
                html += '<span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#8b5cf6;margin-right:4px;"></span>REM ' + fmtSeconds(sl.rem_seconds) + '</span>';
                html += '<span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#f97316;margin-right:4px;"></span>Eveil ' + fmtSeconds(sl.awake_seconds) + '</span>';
                html += '</div>';

                // 7-day trend
                const last7 = days.slice(-7);
                const sleepDurs = last7.filter(d => d.sleep && d.sleep.duration_seconds > 0).map(d => d.sleep.duration_seconds);
                if (sleepDurs.length > 0) {
                    const avg = Math.round(sleepDurs.reduce((a, b) => a + b, 0) / sleepDurs.length);
                    html += '<div style="margin-top:16px;padding:10px;background:var(--bg-card-alt);border-radius:8px;">';
                    html += '<div style="display:flex;justify-content:space-between;font-size:13px;">';
                    html += '<span class="text-muted">Moyenne 7 jours</span>';
                    html += '<span style="font-weight:700;color:' + sleepColor(avg) + ';">' + fmtSeconds(avg) + '</span>';
                    html += '</div>';
                    html += '<div style="display:flex;justify-content:space-between;font-size:13px;margin-top:4px;">';
                    html += '<span class="text-muted">Objectif</span>';
                    html += '<span style="font-weight:700;color:var(--green);">7h30</span>';
                    html += '</div></div>';
                }

                sleepDetail.innerHTML = html;
            } else {
                sleepDetail.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Pas de donnees sommeil</div>';
            }

            // ===== VFC + STRESS =====
            const hrvStress = document.getElementById(p + 'health-hrv-stress');
            const latestHrv = findLatest(days, 'hrv');
            const latestStress = findLatest(days, 'stress');
            let hrvHtml = '';

            if (latestHrv && latestHrv.hrv) {
                const h = latestHrv.hrv;
                hrvHtml += '<div style="margin-bottom:16px;">';
                hrvHtml += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">';
                hrvHtml += '<span style="font-size:13px;color:var(--text-muted);">Statut VFC</span>';
                hrvHtml += hrvStatusBadge(h.status);
                hrvHtml += '</div>';

                hrvHtml += '<div class="health-metric">';
                hrvHtml += '<div class="health-metric-icon" style="background:linear-gradient(135deg,#581c87,#a855f7);">';
                hrvHtml += '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>';
                hrvHtml += '</div>';
                hrvHtml += '<div><div class="health-metric-value text-purple">' + (h.weekly_avg || '--') + ' <span style="font-size:12px;font-weight:400;color:var(--text-muted);">ms</span></div>';
                hrvHtml += '<div class="health-metric-label">Moyenne hebdo</div></div>';
                hrvHtml += '</div>';

                hrvHtml += '<div class="health-metric">';
                hrvHtml += '<div class="health-metric-icon" style="background:linear-gradient(135deg,#4338ca,#818cf8);">';
                hrvHtml += '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M12 2a5 5 0 015 5c0 6-5 8-5 13-2-3-5-7-5-13a5 5 0 015-5z"/></svg>';
                hrvHtml += '</div>';
                hrvHtml += '<div><div class="health-metric-value" style="color:#818cf8;">' + (h.last_night_avg || '--') + ' <span style="font-size:12px;font-weight:400;color:var(--text-muted);">ms</span></div>';
                hrvHtml += '<div class="health-metric-label">Derniere nuit</div></div>';
                hrvHtml += '</div>';

                if (h.baseline_balanced_low && h.baseline_balanced_upper) {
                    hrvHtml += '<div style="font-size:12px;color:var(--text-muted);margin-top:8px;">Baseline : ' + h.baseline_balanced_low + ' — ' + h.baseline_balanced_upper + ' ms</div>';
                }
            }

            if (latestStress && latestStress.stress) {
                const st = latestStress.stress;
                hrvHtml += '<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">';
                hrvHtml += '<div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:12px;">Stress (' + fmtDateLabel(latestStress.date) + ')</div>';

                hrvHtml += '<div class="health-metric">';
                hrvHtml += '<div class="health-metric-icon" style="background:linear-gradient(135deg,#9a3412,#f97316);">';
                hrvHtml += '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M12 2v6M12 18v4M4.93 4.93l4.24 4.24M14.83 14.83l4.24 4.24M2 12h6M18 12h4M4.93 19.07l4.24-4.24M14.83 9.17l4.24-4.24"/></svg>';
                hrvHtml += '</div>';
                hrvHtml += '<div><div class="health-metric-value" style="color:' + stressColor(st.avg) + ';">' + (st.avg || '--') + '</div>';
                hrvHtml += '<div class="health-metric-label">Niveau moyen</div></div>';
                hrvHtml += '</div>';

                // Stress durations
                const restH = st.rest_stress_duration ? Math.round(st.rest_stress_duration / 60) : 0;
                const lowH = st.low_stress_duration ? Math.round(st.low_stress_duration / 60) : 0;
                const medH = st.medium_stress_duration ? Math.round(st.medium_stress_duration / 60) : 0;
                const highH = st.high_stress_duration ? Math.round(st.high_stress_duration / 60) : 0;
                const totalStressMin = restH + lowH + medH + highH || 1;

                hrvHtml += '<div style="display:flex;height:20px;border-radius:4px;overflow:hidden;margin-top:8px;">';
                if (restH > 0) hrvHtml += '<div style="width:' + (restH / totalStressMin * 100) + '%;background:var(--green);" title="Repos ' + restH + ' min"></div>';
                if (lowH > 0) hrvHtml += '<div style="width:' + (lowH / totalStressMin * 100) + '%;background:var(--yellow);" title="Bas ' + lowH + ' min"></div>';
                if (medH > 0) hrvHtml += '<div style="width:' + (medH / totalStressMin * 100) + '%;background:var(--orange);" title="Moyen ' + medH + ' min"></div>';
                if (highH > 0) hrvHtml += '<div style="width:' + (highH / totalStressMin * 100) + '%;background:var(--red);" title="Eleve ' + highH + ' min"></div>';
                hrvHtml += '</div>';

                hrvHtml += '<div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:6px;font-size:11px;">';
                hrvHtml += '<span><span style="color:var(--green);">●</span> Repos ' + restH + 'm</span>';
                hrvHtml += '<span><span style="color:var(--yellow);">●</span> Bas ' + lowH + 'm</span>';
                hrvHtml += '<span><span style="color:var(--orange);">●</span> Moyen ' + medH + 'm</span>';
                hrvHtml += '<span><span style="color:var(--red);">●</span> Eleve ' + highH + 'm</span>';
                hrvHtml += '</div>';
                hrvHtml += '</div>';
            }

            if (!hrvHtml) hrvHtml = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Pas de donnees VFC/stress</div>';
            hrvStress.innerHTML = hrvHtml;

            // ===== CHARTS 14 JOURS =====
            // FC repos
            renderMiniChart(p + 'chart-rhr', p + 'chart-rhr-labels',
                days.map(d => ({ value: d.resting_hr, label: fmtDateLabel(d.date), shortLabel: fmtDateDay(d.date) })),
                rhrColor, ' bpm'
            );

            // VFC
            renderMiniChart(p + 'chart-hrv', p + 'chart-hrv-labels',
                days.map(d => ({ value: d.hrv ? d.hrv.last_night_avg : null, label: fmtDateLabel(d.date), shortLabel: fmtDateDay(d.date) })),
                function(v) { return v >= 50 ? 'var(--green)' : v >= 30 ? 'var(--yellow)' : 'var(--orange)'; }, ' ms'
            );

            // Pas
            renderMiniChart(p + 'chart-steps', p + 'chart-steps-labels',
                days.map(d => ({ value: d.steps, label: fmtDateLabel(d.date), shortLabel: fmtDateDay(d.date) })),
                stepsColor, '',
                function(v) { return v >= 1000 ? (v / 1000).toFixed(1).replace('.0', '') + 'k' : v; }
            );

            // Body Battery
            renderMiniChart(p + 'chart-bb', p + 'chart-bb-labels',
                days.map(d => ({ value: d.body_battery ? d.body_battery.highest : null, label: fmtDateLabel(d.date), shortLabel: fmtDateDay(d.date) })),
                bbColor, ''
            );
            // BB summary
            const bbSummaryEl = document.getElementById(p + 'chart-bb-summary');
            const bbDays = days.filter(d => d.body_battery);
            if (bbDays.length > 0 && bbSummaryEl) {
                const avgHigh = Math.round(bbDays.reduce((a, d) => a + d.body_battery.highest, 0) / bbDays.length);
                const avgLow = Math.round(bbDays.reduce((a, d) => a + d.body_battery.lowest, 0) / bbDays.length);
                bbSummaryEl.innerHTML = '<div style="display:flex;justify-content:space-around;font-size:12px;">' +
                    '<div style="text-align:center;"><div style="font-weight:700;color:' + bbColor(avgHigh) + ';">' + avgHigh + '</div><div class="text-muted">Pic moy.</div></div>' +
                    '<div style="text-align:center;"><div style="font-weight:700;color:' + bbColor(avgLow) + ';">' + avgLow + '</div><div class="text-muted">Min moy.</div></div>' +
                    '</div>';
            }

            // Sleep 14j
            renderMiniChart(p + 'chart-sleep', p + 'chart-sleep-labels',
                days.map(d => ({ value: d.sleep ? Math.round(d.sleep.duration_seconds / 60) : null, label: fmtDateLabel(d.date), shortLabel: fmtDateDay(d.date) })),
                function(mins) { return sleepColor(mins * 60); }, ' min',
                function(mins) { var h = Math.floor(mins / 60); var m = mins % 60; return h + 'h' + String(m).padStart(2, '0'); }
            );
            // Sleep summary
            const sleepSummaryEl = document.getElementById(p + 'chart-sleep-summary');
            const sleepDays = days.filter(d => d.sleep && d.sleep.duration_seconds > 0);
            if (sleepDays.length > 0 && sleepSummaryEl) {
                const avgSec = Math.round(sleepDays.reduce((a, d) => a + d.sleep.duration_seconds, 0) / sleepDays.length);
                const scores = sleepDays.filter(d => d.sleep.score > 0).map(d => d.sleep.score);
                const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : null;
                sleepSummaryEl.innerHTML = '<div style="display:flex;justify-content:space-around;font-size:12px;">' +
                    '<div style="text-align:center;"><div style="font-weight:700;color:' + sleepColor(avgSec) + ';">' + fmtSeconds(avgSec) + '</div><div class="text-muted">Duree moy.</div></div>' +
                    (avgScore ? '<div style="text-align:center;"><div style="font-weight:700;color:' + sleepScoreColor(avgScore) + ';">' + avgScore + '</div><div class="text-muted">Score moy.</div></div>' : '') +
                    '</div>';
            }

            // Status badge (Yohann only)
            if (!p) {
                document.getElementById('garmin-status').style.color = 'var(--green)';
                document.getElementById('garmin-status').textContent = 'OK';
            }
    })();
}

function findLatest(days, key) {
    for (var i = days.length - 1; i >= 0; i--) {
        if (days[i][key]) return days[i];
    }
    return null;
}

// ===== SYNC BUTTON =====
const SYNC_REPO = 'dreamskid/coach-trail';
const SYNC_WORKFLOW = 'sync-strava.yml';
const SYNC_STALE_HOURS = 6;

function getSyncToken() { return localStorage.getItem('gh_sync_token'); }
function setSyncToken(t) { localStorage.setItem('gh_sync_token', t); }

function handleSync(e) {
    if (e && e.shiftKey) { localStorage.removeItem('gh_sync_token'); }
    const token = getSyncToken();
    if (!token) {
        showTokenModal();
    } else {
        triggerSync(token);
    }
}

var _tokenCallback = null;

function showTokenModal(callback) {
    _tokenCallback = callback || null;
    const modal = document.createElement('div');
    modal.className = 'sync-modal';
    modal.id = 'sync-modal';
    modal.innerHTML =
        '<div class="sync-modal-box">' +
            '<h3>Configuration (une seule fois)</h3>' +
            '<p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">' +
                'Il faut un <strong>GitHub Personal Access Token (classic)</strong> pour sauvegarder et synchroniser.' +
            '</p>' +
            '<p style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">' +
                '1. <a href="https://github.com/settings/tokens/new?scopes=repo&description=Coach+Trail+Sync" target="_blank" style="color:var(--accent);">Clique ici pour creer le token</a><br>' +
                '2. Laisse la coche <strong>repo</strong> activee, clique <strong>Generate token</strong><br>' +
                '3. Copie le token et colle-le ci-dessous' +
            '</p>' +
            '<input type="password" id="sync-token-input" placeholder="ghp_xxxxxxxxxxxx...">' +
            '<div>' +
                '<button class="sync-modal-btn" onclick="saveTokenAndGo()">Enregistrer</button>' +
                '<button class="sync-modal-cancel" onclick="closeTokenModal()">Annuler</button>' +
            '</div>' +
            '<p style="font-size:11px;color:var(--text-muted);margin-top:12px;">Le token est sauvegarde sur tous tes appareils via GitHub.</p>' +
        '</div>';
    document.body.appendChild(modal);
    document.getElementById('sync-token-input').focus();
}

function closeTokenModal() {
    const m = document.getElementById('sync-modal');
    if (m) m.remove();
}

function saveTokenAndGo() {
    const input = document.getElementById('sync-token-input');
    const token = input.value.trim();
    if (!token) return;
    setSyncToken(token);
    closeTokenModal();
    if (_tokenCallback) { _tokenCallback(); _tokenCallback = null; }
    else { triggerSync(token); }
}

function saveTokenAndSync() { saveTokenAndGo(); }

function triggerSync(token) {
    const btn = document.getElementById('sync-btn');
    const label = document.getElementById('sync-label');
    btn.classList.add('syncing');
    btn.classList.remove('stale');
    label.textContent = 'Sync...';

    fetch('https://api.github.com/repos/' + SYNC_REPO + '/actions/workflows/' + SYNC_WORKFLOW + '/dispatches', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + token,
            'Accept': 'application/vnd.github.v3+json',
        },
        body: JSON.stringify({ ref: 'main' }),
    })
    .then(r => {
        if (r.status === 204) {
            label.textContent = 'Lance !';
            setTimeout(() => pollSyncWorkflow(), 3000);
        } else if (r.status === 401) {
            label.textContent = 'Token expire';
            btn.classList.remove('syncing');
            localStorage.removeItem('gh_sync_token');
            setTimeout(() => { label.textContent = 'Sync'; }, 3000);
        } else if (r.status === 403) {
            label.textContent = 'Droits insuffisants';
            btn.classList.remove('syncing');
            setTimeout(() => { label.textContent = 'Sync'; }, 4000);
        } else {
            r.text().then(t => console.error('Sync error:', r.status, t));
            label.textContent = 'Erreur ' + r.status;
            btn.classList.remove('syncing');
            setTimeout(() => { label.textContent = 'Sync'; }, 3000);
        }
    })
    .catch(e => {
        console.error('Sync fetch error:', e);
        label.textContent = 'Erreur reseau';
        btn.classList.remove('syncing');
        setTimeout(() => { label.textContent = 'Sync'; }, 3000);
    });
}

function pollSyncWorkflow() {
    const label = document.getElementById('sync-label');
    const btn = document.getElementById('sync-btn');
    const token = getSyncToken();
    let elapsed = 0;

    const poll = setInterval(() => {
        elapsed += 5;
        label.textContent = elapsed + 's...';

        if (elapsed > 120) {
            clearInterval(poll);
            label.textContent = 'Timeout';
            btn.classList.remove('syncing');
            setTimeout(() => { label.textContent = 'Sync'; }, 3000);
            return;
        }

        fetch('https://api.github.com/repos/' + SYNC_REPO + '/actions/runs?per_page=1', {
            headers: { 'Authorization': 'Bearer ' + token, 'Accept': 'application/vnd.github.v3+json' }
        })
        .then(r => r.json())
        .then(data => {
            const run = data.workflow_runs && data.workflow_runs[0];
            if (!run) return;
            if (run.status === 'completed') {
                clearInterval(poll);
                const ok = run.conclusion === 'success';
                label.textContent = ok ? 'OK !' : 'Echec';
                if (ok) {
                    Object.keys(ATHLETES).forEach(function(a) {
                        if (_loadedAthletes[a]) {
                            Promise.all([fetchActivities(a), fetchGarminData(a)]).then(function(res) {
                                _activitiesByAthlete[a] = res[0];
                                renderActivitiesList(res[0], a);
                                matchWeekActivities(res[0], a);
                                renderGarminWellness(res[1], a);
                            });
                        }
                    });
                }
                setTimeout(() => {
                    btn.classList.remove('syncing');
                    label.textContent = 'Sync';
                    updateSyncStatus();
                }, 2000);
            }
        })
        .catch(() => {});
    }, 5000);
}

function updateSyncStatus() {
    fetch('data/garmin-wellness.json?t=' + Date.now())
        .then(r => r.ok ? r.json() : null)
        .then(data => {
            if (!data || !data.summary || !data.summary.last_sync) return;
            const lastSync = new Date(data.summary.last_sync.replace(' ', 'T'));
            const now = new Date();
            const diffH = (now - lastSync) / (1000 * 60 * 60);
            const btn = document.getElementById('sync-btn');
            const label = document.getElementById('sync-label');
            const headerUpdate = document.getElementById('header-update');

            const syncDate = lastSync.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
            const syncTime = lastSync.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            if (headerUpdate) {
                headerUpdate.textContent = 'Mise a jour : ' + syncDate + ' a ' + syncTime;
            }
            var footerSync = document.getElementById('footer-sync');
            if (footerSync) {
                footerSync.textContent = ' Derniere mise a jour : ' + syncDate;
            }

            if (diffH > SYNC_STALE_HOURS && !btn.classList.contains('syncing')) {
                btn.classList.add('stale');
                label.textContent = 'Sync (' + Math.round(diffH) + 'h)';
            }
        })
        .catch(() => {});
}

updateSyncStatus();

// ===== COACH LOG =====
function soleaireColor(val) {
    if (val == null) return 'var(--text-muted)';
    if (val <= 1) return 'var(--green)';
    if (val <= 3) return 'var(--yellow)';
    if (val <= 5) return 'var(--orange)';
    return 'var(--red)';
}

function renderInjuryJournal(athlete) {
    athlete = athlete || 'yohann';
    var cfg = ATHLETES[athlete];
    var p = cfg.prefix;
    var daily = _coachLogByAthlete[athlete] || [];
    var injuryKey = cfg.injuryKey;
    var container = document.getElementById(p + 'injury-journal');
    if (!container) return;
    var entries = daily.filter(function(d) { return d[injuryKey] != null; });
    if (entries.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Aucune donnee enregistree</div>';
        return;
    }
    entries.sort(function(a, b) { return b.date.localeCompare(a.date); });
    var injuryLabel = injuryKey === 'soleaire' ? 'Soleaire' : injuryKey === 'genou' ? 'Genou' : injuryKey;
    var html = '<table><tr><th>Date</th><th>' + injuryLabel + ' /10</th><th>RPE</th><th>Checks</th><th>Verdict</th></tr>';
    entries.forEach(function(d) {
        var color = soleaireColor(d[injuryKey]);
        var dateObj = new Date(d.date + 'T00:00:00');
        var dateStr = dateObj.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        var checks = d.checks ? Object.keys(d.checks).filter(function(k) { return d.checks[k]; }).join(', ') : '—';
        var rpe = d.rpe != null ? d.rpe + '/10' : '—';
        var verdict = d.verdict || '—';
        html += '<tr>';
        html += '<td>' + dateStr + '</td>';
        html += '<td style="color:' + color + ';font-weight:bold;">' + d[injuryKey] + '/10</td>';
        html += '<td>' + rpe + '</td>';
        html += '<td class="text-muted">' + checks + '</td>';
        html += '<td>' + verdict + '</td>';
        html += '</tr>';
    });
    html += '</table>';
    container.innerHTML = html;
}

function renderInjuryChart(athlete) {
    athlete = athlete || 'yohann';
    var cfg = ATHLETES[athlete];
    var p = cfg.prefix;
    var daily = _coachLogByAthlete[athlete] || [];
    var injuryKey = cfg.injuryKey;
    var chartId = injuryKey === 'soleaire' ? 'chart-soleaire' : 'chart-' + injuryKey;
    var labelsId = chartId + '-labels';
    var last14 = daily.slice(-14);
    var values = last14.map(function(d) {
        var dateObj = new Date(d.date + 'T00:00:00');
        var short = dateObj.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        return { value: d[injuryKey], label: d.date, shortLabel: short };
    });
    renderMiniChart(p + chartId, p + labelsId, values, soleaireColor, '/10');
}

// --- Evaluation /10 ---
var EVAL_LABELS = {
    progression: 'Progression', mental: 'Mental', gestion_effort: "Gestion d'effort",
    socle_aerobie: 'Socle aérobie', endurance_ultra: 'Endurance ultra',
    technique_descente: 'Technique descente', regularite: 'Régularité entraînement',
    puissance_montee: 'Puissance montée', resistance_musculaire: 'Résistance musculaire',
    recuperation: 'Récupération'
};

function evaluationColor(val) {
    if (val == null) return 'var(--text-muted)';
    if (val >= 8) return 'var(--green)';
    if (val >= 6) return 'var(--yellow)';
    if (val >= 4) return 'var(--orange)';
    return 'var(--red)';
}

function renderEvaluation(evalData, athlete) {
    athlete = athlete || 'yohann';
    var p = ATHLETES[athlete].prefix;
    var container = document.getElementById(p + 'eval-scores');
    var globalEl = document.getElementById(p + 'eval-global-value');
    if (!container) return;

    if (!evalData || !evalData.current || !evalData.current.scores) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Pas d\'\u00e9valuation disponible</div>';
        return;
    }

    var scores = evalData.current.scores;
    var reasons = evalData.current.reasons || {};
    var keys = Object.keys(EVAL_LABELS);
    var html = '';
    var sum = 0;
    var count = 0;

    for (var i = 0; i < keys.length; i++) {
        var key = keys[i];
        var val = scores[key];
        var label = EVAL_LABELS[key];
        if (val == null) continue;
        var color = evaluationColor(val);
        var reason = reasons[key] || '';
        html += '<div class="stat-row" style="flex-wrap: wrap;"><span class="label">' + label + '</span><span class="value" style="color:' + color + ';">' + val + '/10</span>';
        if (reason) {
            html += '<span style="width: 100%; font-size: 11px; color: var(--text-muted); margin-top: -4px; padding-left: 2px;">' + reason + '</span>';
        }
        html += '</div>';
        sum += val;
        count++;
    }

    container.innerHTML = html;

    if (globalEl && count > 0) {
        var avg = (sum / count).toFixed(1);
        var avgColor = evaluationColor(parseFloat(avg));
        globalEl.innerHTML = avg + '<span style="font-size: 16px; color: var(--text-muted);">/10</span>';
        globalEl.style.color = avgColor;
    }

    /* Global comment */
    var commentEl = document.getElementById(p + 'eval-comment');
    var gc = evalData.current.global_comment;
    if (commentEl && gc) {
        commentEl.innerHTML =
            '<div style="margin-bottom:10px;"><span style="font-weight:600;color:var(--green);">&#9650; Forces</span><br><span style="font-size:12px;color:var(--text-muted);">' + gc.forces + '</span></div>' +
            '<div style="margin-bottom:10px;"><span style="font-weight:600;color:var(--orange);">&#9660; Axes d\'am\u00e9lioration</span><br><span style="font-size:12px;color:var(--text-muted);">' + gc.axes + '</span></div>' +
            '<div><span style="font-weight:600;color:var(--accent-light);">&#9673; Positionnement trail</span><br><span style="font-size:12px;color:var(--text-muted);">' + gc.positionnement + '</span></div>';
    }
}

function renderEvalHistory(evalData, athlete) {
    athlete = athlete || 'yohann';
    var p = ATHLETES[athlete].prefix;
    var container = document.getElementById(p + 'eval-history');
    if (!container) return;

    if (!evalData || !evalData.history || evalData.history.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Pas encore d\'historique</div>';
        return;
    }

    var history = evalData.history;
    var keys = Object.keys(EVAL_LABELS);
    var html = '<table><tr><th>Dimension</th>';

    for (var h = 0; h < history.length; h++) {
        var d = new Date(history[h].date + 'T00:00:00');
        var dateStr = d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        html += '<th style="text-align:center;">' + history[h].trigger + '<br><span style="font-size:11px;color:var(--text-muted);">' + dateStr + '</span></th>';
    }
    html += '</tr>';

    var sums = [];
    for (var s = 0; s < history.length; s++) sums.push({ sum: 0, count: 0 });

    for (var i = 0; i < keys.length; i++) {
        var key = keys[i];
        html += '<tr><td>' + EVAL_LABELS[key] + '</td>';
        for (var j = 0; j < history.length; j++) {
            var val = history[j].scores[key];
            var color = evaluationColor(val);
            var trend = '';
            if (j > 0 && val != null && history[j-1].scores[key] != null) {
                var prev = history[j-1].scores[key];
                if (val > prev) trend = ' <span style="color:var(--green);">&#8593;</span>';
                else if (val < prev) trend = ' <span style="color:var(--red);">&#8595;</span>';
                else trend = ' <span style="color:var(--text-muted);">=</span>';
            }
            html += '<td style="text-align:center;color:' + color + ';">' + (val != null ? val : '—') + trend + '</td>';
            if (val != null) { sums[j].sum += val; sums[j].count++; }
        }
        html += '</tr>';
    }

    // Moyenne row
    html += '<tr style="font-weight:700;border-top:2px solid var(--border);"><td>Moyenne</td>';
    for (var m = 0; m < sums.length; m++) {
        var avg = sums[m].count > 0 ? (sums[m].sum / sums[m].count).toFixed(1) : '—';
        var avgColor = sums[m].count > 0 ? evaluationColor(parseFloat(avg)) : 'var(--text-muted)';
        var mTrend = '';
        if (m > 0 && sums[m].count > 0 && sums[m-1].count > 0) {
            var prevAvg = sums[m-1].sum / sums[m-1].count;
            var curAvg = sums[m].sum / sums[m].count;
            if (curAvg > prevAvg + 0.05) mTrend = ' <span style="color:var(--green);">&#8593;</span>';
            else if (curAvg < prevAvg - 0.05) mTrend = ' <span style="color:var(--red);">&#8595;</span>';
            else mTrend = ' <span style="color:var(--text-muted);">=</span>';
        }
        html += '<td style="text-align:center;color:' + avgColor + ';">' + avg + mTrend + '</td>';
    }
    html += '</tr></table>';

    container.innerHTML = html;
}

function fetchCoachLog(athlete) {
    athlete = athlete || 'yohann';
    var headers = isLocalhost ? {} : { 'ngrok-skip-browser-warning': '1' };
    return fetch(API_BASE + '/api/data?athlete=' + athlete, { headers: headers, cache: 'no-store' })
        .then(function(r) { if (!r.ok) throw new Error('No data'); return r.json(); })
        .catch(function() { return { daily: [], longterm: {} }; });
}

function applyCoachLog(data, athlete) {
    athlete = athlete || 'yohann';
    var cfg = ATHLETES[athlete];
    var prefix = cfg.prefix;
    var lt = data.longterm || {};

    // Token is now stored in localStorage only (not in public JSON)

    // Protocol phase badges (Yohann only — has proto-phase-X IDs)
    if (!prefix) {
        var currentPhase = lt.protocol_phase || 1;
        for (var pp = 1; pp <= 5; pp++) {
            var protoEl = document.getElementById('proto-phase-' + pp);
            if (!protoEl) continue;
            if (pp < currentPhase) {
                protoEl.innerHTML = '<span class="badge badge-green">VALIDE</span>';
            } else if (pp === currentPhase) {
                protoEl.innerHTML = '<span class="badge badge-blue">EN COURS</span>';
            } else {
                protoEl.innerHTML = '<span class="badge badge-yellow">A VENIR</span>';
            }
        }
    }

    renderInjuryJournal(athlete);
    renderInjuryChart(athlete);

    var evalData = lt.evaluation || null;
    renderEvaluation(evalData, athlete);
    renderEvalHistory(evalData, athlete);
}

function fetchAthleteProfile(athlete) {
    var headers = isLocalhost ? {} : { 'ngrok-skip-browser-warning': '1' };
    return fetch(API_BASE + '/api/athlete-data?athlete=' + athlete, { headers: headers, cache: 'no-store' })
        .then(function(r) { return r.json(); })
        .catch(function(e) { console.warn('fetchAthleteProfile error:', e); return {}; });
}

function esc(s) { return (s || '').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

function renderProfile(data, athlete) {
    var p = ATHLETES[athlete].prefix;
    var prof = data.profile || {};
    // KPI cards
    var kpiEl = document.getElementById(p + 'overview-kpi');
    if (kpiEl) {
        var utmbSub = [];
        if (prof.utmb_20k) utmbSub.push('20K: ' + prof.utmb_20k);
        if (prof.utmb_50k) utmbSub.push('50K: ' + prof.utmb_50k);
        if (prof.utmb_100k) utmbSub.push('100K: ' + prof.utmb_100k);
        if (prof.utmb_100m) utmbSub.push('100M: ' + prof.utmb_100m);
        kpiEl.innerHTML =
            '<div class="card" style="text-align: center;"><div class="stat-big text-blue">' + (prof.utmb_pic || '--') + '</div><div class="stat-label">UTMB Index Pic</div><div style="font-size:12px; color: var(--text-muted); margin-top:4px;">' + utmbSub.join(' · ') + '</div></div>' +
            '<div class="card" style="text-align: center;"><div class="stat-big text-green" id="' + p + 'kpi-vo2max">' + (prof.vo2max || '--') + '</div><div class="stat-label">VO2max (ml/kg/min)</div><div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="' + p + 'kpi-vo2max-sub">Garmin</div></div>' +
            '<div class="card" style="text-align: center;"><div class="stat-big text-green" id="' + p + 'kpi-week-km">--</div><div class="stat-label">Km cette semaine</div><div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="' + p + 'kpi-week-km-sub">Chargement...</div></div>' +
            '<div class="card" style="text-align: center;"><div class="stat-big text-orange" id="' + p + 'kpi-week-elev">--</div><div class="stat-label">D+ cette semaine</div><div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="' + p + 'kpi-week-elev-sub">Chargement...</div></div>';
    }
    // Profile card
    var profEl = document.getElementById(p + 'profile-card');
    if (profEl) {
        var vmaText = prof.vma ? ('~' + prof.vma + ' km/h') : '—';
        var vmaBadge = prof.vma_tested ? '' : ' <span class="badge badge-yellow">' + (prof.vma ? 'à tester' : 'non testée') + '</span>';
        profEl.innerHTML =
            '<h2>Profil athlète</h2>' +
            '<div class="stat-row"><span class="label">Age</span><span class="value">' + prof.age + ' ans</span></div>' +
            '<div class="stat-row"><span class="label">Taille / Poids</span><span class="value">' + prof.height_cm + ' cm / ' + prof.weight_kg + ' kg</span></div>' +
            '<div class="stat-row"><span class="label">FC repos</span><span class="value">' + prof.fc_repos + ' bpm</span></div>' +
            '<div class="stat-row"><span class="label">FC max</span><span class="value">' + prof.fc_max + ' bpm</span></div>' +
            '<div class="stat-row"><span class="label">Réserve cardiaque</span><span class="value">' + prof.rfc + ' bpm</span></div>' +
            '<div class="stat-row"><span class="label">VO2max (Garmin)</span><span class="value">' + (prof.vo2max || '—') + ' ml/kg/min</span></div>' +
            '<div class="stat-row"><span class="label">VMA estimée</span><span class="value">' + vmaText + vmaBadge + '</span></div>' +
            '<div class="stat-row"><span class="label">Running Stones</span><span class="value">' + (prof.running_stones || '—') + '</span></div>' +
            '<div class="stat-row"><span class="label">Courses depuis 2022</span><span class="value">' + (prof.races_count || '—') + '</span></div>' +
            '<div class="stat-row"><span class="label">Plus longue course</span><span class="value">' + esc(prof.longest_race || '—') + '</span></div>';
    }
    // Health weight card
    var weightEl = document.getElementById(p + 'health-weight-card');
    if (weightEl) {
        weightEl.innerHTML =
            '<div class="stat-big text-orange">' + prof.weight_kg + '<span style="font-size:18px; color: var(--text-muted);">kg</span></div>' +
            '<div class="stat-label">Poids</div>' +
            '<div style="font-size:12px; color: var(--text-muted); margin-top:4px;">' + prof.height_cm + ' cm · IMC ' + (prof.imc || (prof.weight_kg / ((prof.height_cm/100) * (prof.height_cm/100))).toFixed(1)) + '</div>';
    }
}

function renderZones(data, athlete) {
    var p = ATHLETES[athlete].prefix;
    var zones = data.zones || [];
    var prof = data.profile || {};
    var el = document.getElementById(p + 'zones-card');
    if (!el || zones.length === 0) return;
    var barHtml = '<div class="zone-bar">';
    zones.forEach(function(z, i) {
        barHtml += '<div class="zone-' + (i+1) + '" style="width:' + (100/zones.length) + '%;">' + z.label + ' ' + z.min + '-' + z.max + '</div>';
    });
    barHtml += '</div>';
    el.innerHTML =
        '<h2>Zones de fréquence cardiaque</h2>' +
        '<p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">Méthode Karvonen · FC repos ' + prof.fc_repos + ' · FC max ' + prof.fc_max + ' · RFC ' + prof.rfc + ' bpm</p>' +
        barHtml;
    // Update per-athlete zones for activity matching
    if (zones.length >= 5) {
        var az = _fcZonesByAthlete[athlete];
        if (az && az.length >= 6) {
            az[0].max = zones[0].min - 1;
            az[1].max = zones[0].max;
            az[2].max = zones[1].max;
            az[3].max = zones[2].max;
            az[4].max = zones[3].max;
            az[5].max = 999;
        }
    }
}

function renderInjury(data, athlete) {
    var p = ATHLETES[athlete].prefix;
    var inj = data.injury || {};
    var cfg = ATHLETES[athlete];
    var el = document.getElementById(p + 'injury-content');
    if (!el) return;
    var statusClass = inj.status === 'active' ? 'injury-active' : 'injury-healing';
    var statusBadge = inj.status === 'active' ? '<span class="badge badge-red">ACTIF</span>' : '<span class="badge badge-yellow">GESTION</span>';
    var h = '<div class="grid grid-2"><div class="card">';
    h += '<div class="injury-status ' + statusClass + '"><div style="display: flex; justify-content: space-between; align-items: center;"><div>';
    h += '<div style="font-weight: 700; font-size: 16px;">' + esc(inj.location) + (inj.episode ? ' — Épisode ' + inj.episode : '') + '</div>';
    h += '<div style="font-size: 13px; color: var(--text-muted);">' + esc(inj.detail) + '</div>';
    h += '</div>' + statusBadge + '</div></div>';
    // Tests
    if (inj.tests && inj.tests.length > 0) {
        h += '<h3>Bilan' + (inj.assessment_date ? ' du ' + new Date(inj.assessment_date).toLocaleDateString('fr-FR', {day:'numeric',month:'long'}) : '') + '</h3>';
        inj.tests.forEach(function(t) {
            h += '<div class="stat-row"><span class="label">' + esc(t.name) + '</span><span class="value text-' + t.color + '">' + esc(t.value) + '</span></div>';
        });
    }
    // Context
    if (inj.context && inj.context.length > 0) {
        h += '<h3>Contexte</h3>';
        inj.context.forEach(function(c) {
            h += '<div class="stat-row"><span class="label">' + esc(c.label) + '</span><span class="value">' + esc(c.value) + '</span></div>';
        });
    }
    // Observation
    if (inj.observation) {
        h += '<h3>Observation chronique</h3><div class="note-box">' + esc(inj.observation) + '</div>';
    }
    h += '</div>'; // close left card

    // Right card: Protocol
    h += '<div class="card">';
    if (inj.protocol && inj.protocol.length > 0) {
        h += '<h2>Protocole de retour à la course</h2><table><tr><th>Phase</th><th>Critère d\'entrée</th><th>Contenu</th><th>Statut</th></tr>';
        inj.protocol.forEach(function(pr, i) {
            var badge = pr.status === 'en_cours' ? '<span class="badge badge-blue">EN COURS</span>' : '<span class="badge badge-yellow">A VENIR</span>';
            h += '<tr><td class="text-bold">' + esc(pr.phase) + '</td><td>' + esc(pr.entry) + '</td><td class="text-muted">' + esc(pr.content) + '</td><td id="' + p + 'proto-phase-' + (i+1) + '">' + badge + '</td></tr>';
        });
        h += '</table>';
    }
    if (inj.decision_point) {
        h += '<div class="note-box" style="margin-top: 16px;"><strong>' + esc(inj.decision_point).replace(/\n/g, '<br>') + '</strong></div>';
    }
    // Prevention
    if (inj.prevention && inj.prevention.length > 0) {
        h += '<h3>Prévention permanente</h3><table><tr><th>Action</th><th>Fréquence</th></tr>';
        inj.prevention.forEach(function(prev) {
            h += '<tr><td>' + esc(prev.action) + '</td><td>' + esc(prev.frequency) + '</td></tr>';
        });
        h += '</table>';
    }
    // Chart + Journal (dynamic from coach-log)
    h += '<h3>Évolution ' + esc(cfg.injuryKey) + ' (14 derniers jours)</h3>';
    h += '<div class="mini-chart" id="' + p + 'chart-' + cfg.injuryKey + '" style="height: 80px;"></div>';
    h += '<div class="mini-chart-labels" id="' + p + 'chart-' + cfg.injuryKey + '-labels"></div>';
    h += '<h3>Journal de suivi</h3>';
    h += '<div id="' + p + 'injury-journal"><div style="text-align: center; padding: 20px; color: var(--text-muted);">Chargement...</div></div>';
    h += '</div></div>'; // close right card + grid

    // Injury history
    if (inj.history && inj.history.length > 0) {
        h += '<div class="card" style="margin-top: 20px;"><h2>Historique des blessures</h2><table>';
        var hasside = inj.history.some(function(hi) { return hi.side; });
        h += '<tr><th>#</th><th>Localisation</th>' + (hasside ? '<th>Côté</th>' : '') + '<th>Gravité</th><th>Résolution</th></tr>';
        inj.history.forEach(function(hi) {
            var isCurrent = hi.resolution === 'En cours' || hi.resolution === 'En gestion';
            var cls = isCurrent ? ' class="text-bold"' : '';
            var resCls = isCurrent ? (hi.resolution === 'En gestion' ? 'text-yellow text-bold' : 'text-red text-bold') : 'text-green';
            h += '<tr><td' + cls + '>' + hi.num + '</td><td' + cls + '>' + esc(hi.location) + '</td>';
            if (hasside) h += '<td' + cls + '>' + esc(hi.side || '') + '</td>';
            h += '<td' + cls + '>' + esc(hi.severity) + '</td><td class="' + resCls + '">' + esc(hi.resolution) + '</td></tr>';
        });
        h += '</table></div>';
    }
    el.innerHTML = h;
}

function renderCalendar(data, athlete) {
    var p = ATHLETES[athlete].prefix;
    var cal = data.calendar || {};
    var el = document.getElementById(p + 'calendar-content');
    if (!el) return;
    var h = '<div class="grid grid-1-2"><div class="card"><h2>Courses 2026</h2><div class="race-timeline">';
    // Races
    (cal.races || []).forEach(function(r) {
        var objMap = {done:'race-done', A:'race-a', B:'race-b', C:'race-c'};
        var cls = objMap[r.objective] || 'race-c';
        var badgeMap = {done:'<span class="badge badge-green">TERMINÉ</span>', A:'<span class="badge badge-red">OBJECTIF A</span>', B:'<span class="badge badge-orange">OBJECTIF B</span>', C:'<span class="badge badge-yellow">OBJECTIF C</span>'};
        var badge = badgeMap[r.objective] || '';
        var dateStr = new Date(r.date).toLocaleDateString('fr-FR', {day:'numeric', month:'long'});
        h += '<div class="race-item ' + cls + '">';
        h += '<div class="race-date">' + dateStr + ' — ' + badge + '</div>';
        var isA = r.objective === 'A';
        h += '<div class="race-name"' + (isA ? ' style="font-size: 18px;"' : '') + '>' + esc(r.name) + '</div>';
        h += '<div class="race-details">' + esc(r.distance) + ' · ' + esc(r.dplus) + (r.result ? ' · ' + esc(r.result) : '') + '</div>';
        if (r.note) h += '<div style="font-size: 12px; color: ' + (r.objective === 'A' ? 'var(--accent-light)' : 'var(--red)') + '; margin-top: 2px;">' + esc(r.note) + '</div>';
        h += '</div>';
    });
    h += '</div></div>';
    // Periodisation
    h += '<div class="card"><h2>Périodisation macro</h2><table><tr><th>Bloc</th><th>Période</th><th>Focus</th><th>Courses</th></tr>';
    (cal.periodisation || []).forEach(function(per) {
        var badgeSt = per.badge_class === 'badge-dark' ? 'background:#333; color:#fff;' : '';
        var badgeCls = per.badge_class === 'badge-dark' ? 'badge' : 'badge ' + per.badge_class;
        h += '<tr><td><span class="' + badgeCls + '"' + (badgeSt ? ' style="' + badgeSt + '"' : '') + '>' + esc(per.bloc) + '</span></td>';
        h += '<td>' + esc(per.period) + '</td><td>' + (per.focus || '').replace(/\n/g, '<br>') + '</td>';
        h += '<td' + (per.races === '—' ? ' class="text-muted"' : '') + '>' + (per.races.indexOf('(A)') >= 0 ? '<strong>' + esc(per.races) + '</strong>' : esc(per.races)) + '</td></tr>';
    });
    h += '</table>';
    // Gap analysis
    if (cal.gap_analysis && cal.gap_analysis.length > 0) {
        h += '<h3>Gap — Le défi clé</h3><table><tr><th>Indicateur</th><th>Actuel</th><th>Cible</th><th>Gap</th></tr>';
        cal.gap_analysis.forEach(function(g) {
            h += '<tr><td>' + esc(g.indicator) + '</td><td>' + esc(g.current) + '</td><td class="text-' + g.color + ' text-bold">' + esc(g.target) + '</td><td class="text-' + g.color + '">' + esc(g.gap) + '</td></tr>';
        });
        h += '</table>';
    }
    h += '</div></div>';
    el.innerHTML = h;
}

function renderPredictions(data, athlete) {
    var p = ATHLETES[athlete].prefix;
    var preds = data.predictions || [];
    var proj = data.projection;
    var axes = data.work_axes || [];
    // Predictions
    var predEl = document.getElementById(p + 'predictions-content');
    if (predEl && preds.length > 0) {
        var h = '<div class="card"><h2>Prévisions courses 2026</h2>';
        h += '<p style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">Méthodologie : corrélation UTMB Index / temps de course, historique personnel, VO2max Garmin.</p>';
        h += '<div style="display: flex; flex-direction: column; gap: 16px;">';
        preds.forEach(function(pr) {
            var bc = pr.border_color || 'yellow';
            var colorVar = bc === 'red' ? 'var(--red)' : bc === 'orange' ? 'var(--orange)' : 'var(--yellow)';
            h += '<div style="padding: 14px; background: var(--bg-card-alt); border-radius: 8px; border-left: 3px solid ' + colorVar + ';">';
            h += '<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 4px;">';
            var isMain = pr.name && pr.name.indexOf('OCC') >= 0 || pr.name && pr.name.indexOf('Grand to Grand') >= 0;
            h += (isMain ? '<strong style="font-size: 15px;">' : '<strong>') + esc(pr.name) + '</strong>';
            h += '<span style="font-size: 12px; color: var(--text-muted);">' + esc(pr.distance) + ' · ' + esc(pr.date) + '</span></div>';
            if (pr.edition_info) h += '<div style="font-size: 11px; color: var(--text-muted); margin: 6px 0 10px; border-bottom: 1px solid var(--border); padding-bottom: 8px;">' + esc(pr.edition_info) + '</div>';
            h += '<table style="width: 100%; font-size: 12px;">';
            (pr.rows || []).forEach(function(row) {
                h += '<tr><td style="width:40%; color: var(--text-muted);">' + esc(row.label) + '</td><td' + (row.green ? ' style="color: var(--green);"' : '') + '>' + (row.bold ? '<strong>' + esc(row.value) + '</strong>' : esc(row.value)) + '</td></tr>';
            });
            h += '</table>';
            if (pr.notes) h += '<div style="font-size: 11px; color: var(--text-muted); margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);">' + esc(pr.notes) + '</div>';
            h += '</div>';
        });
        h += '</div></div>';
        predEl.innerHTML = h;
    }
    // Projection
    var projEl = document.getElementById(p + 'projection-content');
    if (projEl && proj && proj.scenarios) {
        var h2 = '<div class="section-title">Projection <span>' + esc(proj.title || '') + '</span></div><div class="grid grid-3">';
        var colorMap = {green:'var(--green-dark)', blue:'var(--accent)', orange:'var(--orange)', red:'var(--red)'};
        proj.scenarios.forEach(function(s) {
            h2 += '<div class="card" style="text-align: center; border-color: ' + (colorMap[s.color] || 'var(--border)') + ';">';
            h2 += '<div class="stat-label" style="margin-bottom: 8px;">' + esc(s.label) + '</div>';
            h2 += '<div class="stat-big text-' + s.color + '">' + esc(s.value) + '</div>';
            h2 += '<div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">' + esc(s.detail) + '</div></div>';
        });
        h2 += '</div>';
        projEl.innerHTML = h2;
    }
    // Work axes
    var axesEl = document.getElementById(p + 'work-axes-content');
    if (axesEl && axes.length > 0) {
        var h3 = '<div class="card"><h2>Axes de travail — Par ordre d\'impact</h2><table>';
        h3 += '<tr><th>#</th><th>Axe</th><th>Impact</th><th>Outil principal</th><th>Indicateur de succès</th></tr>';
        axes.forEach(function(a) {
            h3 += '<tr><td class="text-bold">' + a.rank + '</td><td class="text-bold">' + esc(a.name) + '</td>';
            h3 += '<td><span class="badge badge-' + a.impact_color + '">' + esc(a.impact) + '</span></td>';
            h3 += '<td>' + esc(a.tool) + '</td><td>' + esc(a.success) + '</td></tr>';
        });
        h3 += '</table></div>';
        axesEl.innerHTML = h3;
    }
}

function renderProgression(data, athlete) {
    var p = ATHLETES[athlete].prefix;
    var hist = data.race_history || [];
    var idx = data.index_progression || {};
    var el = document.getElementById(p + 'progression-content');
    if (!el) return;
    var h = '<div class="card"><h2>Progression UTMB Index</h2>';
    h += '<div style="display: flex; gap: 40px; align-items: center; margin-bottom: 16px; flex-wrap: wrap;">';
    h += '<div style="text-align: center;"><div class="stat-big text-red">' + (idx.start_index || '--') + '</div><div class="stat-label">' + esc(idx.start_date || '') + '</div></div>';
    h += '<div style="font-size: 32px; color: var(--text-muted);">&rarr;</div>';
    h += '<div style="text-align: center;"><div class="stat-big text-green">' + (idx.current_index || '--') + '</div><div class="stat-label">' + esc(idx.current_date || '') + '</div></div>';
    h += '<div style="font-size: 14px; color: var(--green); font-weight: 700;">' + esc(idx.gain_text || '') + '</div></div>';
    // Bar chart
    if (hist.length > 0) {
        var maxIdx = Math.max.apply(null, hist.map(function(r) { return r.utmb_index; }));
        var minIdx = Math.min.apply(null, hist.map(function(r) { return r.utmb_index; }));
        var range = maxIdx - minIdx || 1;
        h += '<div style="display: flex; align-items: flex-end; gap: ' + (hist.length > 15 ? '3' : '4') + 'px; height: 120px; margin: 20px 0; padding: 0 4px;">';
        hist.slice().reverse().forEach(function(r) {
            var pct = Math.round(((r.utmb_index - minIdx) / range) * 100);
            var color = r.utmb_index >= maxIdx - 10 ? 'var(--green)' : r.utmb_index >= maxIdx - 40 ? 'var(--yellow)' : r.utmb_index >= maxIdx - 80 ? 'var(--orange)' : 'var(--red)';
            h += '<div style="flex:1; background: ' + color + '; border-radius: ' + (hist.length > 15 ? '3' : '4') + 'px ' + (hist.length > 15 ? '3' : '4') + 'px 0 0; height: ' + pct + '%;" title="' + r.utmb_index + ' - ' + esc(r.name) + '"></div>';
        });
        h += '</div>';
    }
    // Race history table
    h += '<table style="margin-top: 20px;"><tr><th>Course</th><th>Date</th><th>Distance</th><th>D+</th><th>Temps</th>' + (hist.some(function(r) { return r.ranking; }) ? '<th>Class.</th>' : '') + '<th>UTMB Index</th></tr>';
    hist.forEach(function(r) {
        var bold = r.highlight ? ' class="text-bold"' : '';
        var idxColor = r.utmb_index >= (idx.current_index || 999) - 5 ? 'text-green' : r.utmb_index >= (idx.current_index || 999) - 30 ? 'text-yellow' : r.utmb_index >= (idx.current_index || 999) - 60 ? 'text-orange' : 'text-red';
        var idxBold = r.highlight ? ' text-bold' : '';
        h += '<tr><td' + bold + '>' + esc(r.name) + '</td><td>' + esc(r.date) + '</td><td>' + esc(r.distance) + '</td><td>' + esc(r.dplus) + '</td><td>' + esc(r.time) + '</td>';
        if (hist.some(function(r2) { return r2.ranking; })) h += '<td>' + esc(r.ranking || '') + '</td>';
        h += '<td><span class="' + idxColor + idxBold + '">' + r.utmb_index + '</span></td></tr>';
    });
    h += '</table></div>';
    el.innerHTML = h;
}

function renderHealthFactors(data, athlete) {
    var p = ATHLETES[athlete].prefix;
    var factors = data.health_factors || [];
    var el = document.getElementById(p + 'health-factors-card');
    if (!el) return;
    if (factors.length === 0) { el.innerHTML = ''; return; }
    var h = '<div class="card" style="margin-bottom: 24px; border-left: 3px solid var(--orange);">';
    h += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';
    h += '<h2 style="margin: 0;">Facteurs limitants — Hygiène de vie</h2>';
    if (data.health_perf_impact) h += '<span class="badge badge-orange">' + esc(data.health_perf_impact) + '</span>';
    h += '</div>';
    if (data.health_intro) h += '<p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">' + esc(data.health_intro) + '</p>';
    h += '<table><tr><th>Facteur</th><th>État actuel</th><th>Impact</th><th>Objectif</th></tr>';
    factors.forEach(function(f) {
        h += '<tr><td class="text-bold">' + esc(f.name) + '</td><td class="text-' + f.color + ' text-bold">' + esc(f.current) + '</td>';
        h += '<td class="text-muted">' + esc(f.impact) + '</td><td class="text-green">' + esc(f.target) + '</td></tr>';
    });
    h += '</table>';
    if (data.health_note) h += '<div class="note-box" style="margin-top: 12px;"><strong>Pour le ' + esc(ATHLETES[athlete].injuryKey) + ' :</strong> ' + esc(data.health_note).replace(/^Pour le .+? : /, '') + '</div>';
    h += '</div>';
    el.innerHTML = h;
}

// ===== LOAD ATHLETE DATA (all data for one athlete) =====
function loadAthleteData(athlete) {
    Promise.all([
        fetchCoachLog(athlete),
        fetchWeekPlan(athlete),
        fetchActivities(athlete),
        fetchGarminData(athlete),
        fetchAthleteProfile(athlete)
    ]).then(function(results) {
        var coachLog = results[0];
        var weekData = results[1];
        var activities = results[2];
        var garmin = results[3];
        var profile = results[4];

        // Store data
        _coachLogByAthlete[athlete] = coachLog.daily || [];
        _weekPlanByAthlete[athlete] = weekData.current || weekData;
        _activitiesByAthlete[athlete] = activities;
        _athleteDataByAthlete[athlete] = profile;

        // Render profile + zones FIRST (zones needed for activity matching)
        renderProfile(profile, athlete);
        renderZones(profile, athlete);
        renderInjury(profile, athlete);
        renderCalendar(profile, athlete);
        renderPredictions(profile, athlete);
        renderProgression(profile, athlete);
        renderHealthFactors(profile, athlete);

        // Render week plan (creates DOM elements for days + populates past tab)
        applyWeekPlan(weekData, athlete);

        // Build today card (MOVES element, must be before initManualChecks/initDayMetrics)
        buildTodayCard(athlete);
        markPastDays(athlete);

        // Move past days from current week to "Passés" tab
        movePastDaysToHistory(athlete);

        // Init checks and metrics ONCE (after all DOM elements are in place)
        initManualChecks(athlete);
        initDayMetrics(athlete);

        // Match activities to week plan
        matchWeekActivities(activities, athlete);

        // Apply coach-log data (protocol badges, eval, injury journal/chart)
        applyCoachLog(coachLog, athlete);

        // Render garmin wellness data
        renderGarminWellness(garmin, athlete);

        // Render activities list
        renderActivitiesList(activities, athlete);
    });
}

// ===== REFRESH AFTER AI MODIFICATIONS =====
function refreshAfterModification(athlete, modifications) {
    var needCoachLog = modifications.some(function(m) { return ['daily','longterm','evaluation'].indexOf(m.type) >= 0; });
    var needWeekPlan = modifications.some(function(m) { return m.type === 'week_plan'; });
    var needProfile = modifications.some(function(m) { return m.type === 'athlete_data'; });

    var fetches = [
        needCoachLog ? fetchCoachLog(athlete) : Promise.resolve(null),
        needWeekPlan ? fetchWeekPlan(athlete) : Promise.resolve(null),
        needProfile ? fetchAthleteProfile(athlete) : Promise.resolve(null)
    ];

    Promise.all(fetches).then(function(results) {
        if (results[0]) {
            _coachLogByAthlete[athlete] = results[0].daily || [];
            applyCoachLog(results[0], athlete);
        }
        if (results[1]) {
            _weekPlanByAthlete[athlete] = results[1].current || results[1];
            applyWeekPlan(results[1], athlete);
            buildTodayCard(athlete);
            markPastDays(athlete);
            movePastDaysToHistory(athlete);
        }
        // Re-init metrics if coach-log OR week-plan changed
        if (results[0] || results[1]) {
            initManualChecks(athlete);
            initDayMetrics(athlete);
            if (_activitiesByAthlete[athlete]) matchWeekActivities(_activitiesByAthlete[athlete], athlete);
        }
        if (results[2]) {
            _athleteDataByAthlete[athlete] = results[2];
            renderProfile(results[2], athlete);
            renderZones(results[2], athlete);
            renderInjury(results[2], athlete);
            renderCalendar(results[2], athlete);
            renderPredictions(results[2], athlete);
            renderProgression(results[2], athlete);
            renderHealthFactors(results[2], athlete);
        }
    });
}

// Initial load
updateHeaderDetails();
if (currentAthlete !== 'yohann') {
    // Restore saved athlete: activate correct button, wrapper, and load data
    document.querySelectorAll('.athlete-btn').forEach(function(b) { b.classList.remove('active'); });
    var savedBtn = document.querySelector('.athlete-btn[data-athlete="' + currentAthlete + '"]');
    if (savedBtn) savedBtn.classList.add('active');
    document.querySelectorAll('.athlete-content').forEach(function(c) { c.classList.remove('active'); });
    document.getElementById('athlete-' + currentAthlete).classList.add('active');
}
loadAthleteData(currentAthlete);
_loadedAthletes[currentAthlete] = true;


</script>

<script>
// ===== CHAT COACH IA (tab-integrated, scoped per athlete) =====
(function() {
    var chatLoadedFor = {};
    var chatSending = {};
    var ngrokH = { 'ngrok-skip-browser-warning': '1' };

    var TYPING_MSGS = {
        common: [
            'Analyse en cours...',
            'Je consulte tes donn\u00e9es...',
            'Laisse-moi r\u00e9fl\u00e9chir...',
            'Je regarde ton historique...',
            'Ton coach r\u00e9fl\u00e9chit...',
            'Recherche en cours...',
            'Je v\u00e9rifie dans tes stats...',
            'Un instant, je calcule...',
            'Je fouille dans tes s\u00e9ances...',
            'Hmm, bonne question...',
            'Je check tes donn\u00e9es Garmin...',
            'Patience, \u00e7a vaut le coup...',
            'J\'analyse tout \u00e7a...',
            'Je compile les donn\u00e9es...',
            'Je cherche sur internet...',
            'Consultation du dossier m\u00e9dical...',
            'Acc\u00e8s aux archives UTMB...',
            'D\u00e9cryptage des donn\u00e9es en cours...'
        ],
        yohann: [
            'Ton sol\u00e9aire va bien au moins ?',
            'Encore une question sur l\'OCC ?',
            'Attends je demande \u00e0 Juliette...',
            '57 bornes, 3500 D+... t\'es s\u00fbr de toi ?',
            'Je v\u00e9rifie que t\'as bien mang\u00e9...',
            'UTMB Index 451... on peut faire mieux.',
            'Chamonix nous attend !',
            'Tu fumes plus au moins ?',
            'Ton tapis de course me manque pas.',
            'J\'appelle Kilian pour avoir son avis...',
            'Juliette court plus vite que toi, tu sais...',
            'Allez, un jour tu battras ta femme.',
            'Je regarde si Juliette a des conseils...',
            'Promis je dis rien \u00e0 ton sol\u00e9aire.',
            'Faut que je te parle de ton sommeil...',
            'Le D+ \u00e7a se travaille, patience.'
        ],
        yohann_night: [
            'Encore debout \u00e0 cette heure ?',
            'H\u00e9, pose ton t\u00e9l\u00e9phone et va dormir.',
            'Juliette m\'a dit de te dire de dormir plus.',
            'Je v\u00e9rifie que t\'as bien mang\u00e9 ce soir...',
            'Ton sol\u00e9aire r\u00e9cup\u00e8re pendant que tu dors...'
        ],
        juliette: [
            'Attends j\'appelle Yohann...',
            'Ton mari m\'a dit de te dire qu\'il t\'aime.',
            'Ton mari, il est pas trop fort ?',
            'Yohann m\'a demand\u00e9 si tu pouvais ralentir un peu.',
            '275 bornes en Arizona... c\'est normal \u00e7a ?',
            'Ton g\u00e9nou droit va bien ?',
            'Grand to Grand, rien que le nom fait mal.',
            'UTMB Index 570... tu plaisantes ?',
            'Yohann est jaloux de ton index.',
            'Le d\u00e9sert d\'Arizona \u00e0 40\u00b0C, classique.',
            'Je check si y\'a des serpents en Arizona...',
            'Running Stones 5... bient\u00f4t 6 !',
            'Yohann dit que c\'est lui le plus fort du couple.',
            'Le Marathon des Sables c\'\u00e9tait pas assez ?',
            'J\'appelle Jim Walmsley pour comparer...',
            'Le Grand Canyon \u00e0 pied, quand m\u00eame...'
        ],
        juliette_night: [
            'H\u00e9, repose ce t\u00e9l\u00e9phone et va dormir.',
            'Ton mari veut savoir si tu rentres pour le d\u00eener.',
            'Ton g\u00e9nou te remerciera si tu dors plus...'
        ]
    };

    function randomTypingMsg(athlete) {
        var h = new Date().getHours();
        var isNight = h >= 22 || h < 6;
        var pool = TYPING_MSGS.common.concat(TYPING_MSGS[athlete] || []);
        if (isNight) pool = pool.concat(TYPING_MSGS[athlete + '_night'] || []);
        return pool[Math.floor(Math.random() * pool.length)];
    }

    function showTyping(el, athlete) {
        var textEl = el.typing.querySelector('.chat-typing-text');
        if (textEl) textEl.textContent = randomTypingMsg(athlete);
        el.typing.classList.add('visible');
    }

    function getEls(athlete) {
        var p = ATHLETES[athlete].prefix;
        return {
            messages: document.getElementById(p + 'chat-messages'),
            typing: document.getElementById(p + 'chat-typing'),
            input: document.getElementById(p + 'chat-input'),
            send: document.getElementById(p + 'chat-send'),
            newBtn: document.getElementById(p + 'chat-new')
        };
    }

    function initChat(athlete) {
        var el = getEls(athlete);
        if (!el.send || el.send._chatInit) return;
        el.send._chatInit = true;

        el.send.addEventListener('click', function() { sendMessage(athlete); });
        el.input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(athlete); }
        });
        el.input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 72) + 'px';
        });
        el.newBtn.addEventListener('click', function() {
            if (!confirm('Nouvelle conversation ? L\'historique sera effac\u00e9.')) return;
            fetch(API_BASE + '/api/chat-clear?athlete=' + athlete, { method: 'POST', headers: ngrokH })
                .then(function() {
                    el.messages.innerHTML = '';
                    chatLoadedFor[athlete] = false;
                    addWelcome(athlete);
                }).catch(function() {});
        });
    }

    // Load history for an athlete (called when tab becomes visible)
    function loadChatHistory(athlete) {
        var el = getEls(athlete);
        fetch(API_BASE + '/api/chat-history?athlete=' + athlete, { headers: ngrokH })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                el.messages.innerHTML = '';
                if (!data.messages || data.messages.length === 0) {
                    addWelcome(athlete);
                } else {
                    var lastDate = '';
                    data.messages.forEach(function(m) {
                        var d = m.timestamp ? m.timestamp.slice(0, 10) : '';
                        if (d && d !== lastDate) { addDateSep(el.messages, d); lastDate = d; }
                        appendMsg(el.messages, m.role, m.content, m.timestamp, false);
                    });
                }
                scrollBot(el.messages);
                chatLoadedFor[athlete] = true;
            })
            .catch(function() {
                addWelcome(athlete);
                chatLoadedFor[athlete] = true;
            });
    }

    function addWelcome(athlete) {
        var el = getEls(athlete);
        var name = athlete === 'juliette' ? 'Juliette' : 'Yohann';
        var div = document.createElement('div');
        div.className = 'chat-msg assistant';
        div.innerHTML = 'Salut ' + name + ' ! Je suis ton coach trail. Parle-moi de ta s\u00e9ance, tes sensations, ou demande-moi de construire ton plan de semaine.';
        el.messages.appendChild(div);
    }

    function sendMessage(athlete) {
        var el = getEls(athlete);
        var text = el.input.value.trim();
        if (!text || chatSending[athlete]) return;

        chatSending[athlete] = true;
        el.send.disabled = true;
        el.input.value = '';
        el.input.style.height = 'auto';

        var todayStr = new Date().toISOString().slice(0, 10);
        var lastSep = el.messages.querySelector('.chat-date-sep:last-of-type');
        if (!lastSep || lastSep.dataset.date !== todayStr) addDateSep(el.messages, todayStr);

        appendMsg(el.messages, 'user', text, new Date().toISOString(), true);
        showTyping(el, athlete);
        scrollBot(el.messages);

        fetch(API_BASE + '/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': '1' },
            body: JSON.stringify({ athlete: athlete, message: text })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            el.typing.classList.remove('visible');
            if (data.error) {
                appendMsg(el.messages, 'assistant', 'Erreur : ' + data.error, new Date().toISOString(), true);
            } else {
                appendMsg(el.messages, 'assistant', data.response, new Date().toISOString(), true);
                if (data.modifications && data.modifications.length > 0) {
                    addModNotice(el.messages, data.modifications);
                    // Refresh only affected dashboard sections
                    refreshAfterModification(athlete, data.modifications);
                }
            }
            scrollBot(el.messages);
            chatSending[athlete] = false;
            el.send.disabled = false;
            el.input.focus();
        })
        .catch(function() {
            el.typing.classList.remove('visible');
            appendMsg(el.messages, 'assistant', 'Erreur de connexion. V\u00e9rifie que le serveur tourne sur ton Mac.', new Date().toISOString(), true);
            scrollBot(el.messages);
            chatSending[athlete] = false;
            el.send.disabled = false;
        });
    }

    function appendMsg(container, role, content, ts, animate) {
        var div = document.createElement('div');
        div.className = 'chat-msg ' + role;
        if (!animate) div.style.animation = 'none';
        div.innerHTML = role === 'assistant' ? fmtMd(content) : escHtml(content);
        if (ts) {
            var t = document.createElement('div');
            t.className = 'chat-msg-time';
            try { t.textContent = new Date(ts).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }); } catch(e) {}
            div.appendChild(t);
        }
        container.appendChild(div);
    }

    function addDateSep(container, dateStr) {
        var div = document.createElement('div');
        div.className = 'chat-date-sep';
        div.dataset.date = dateStr;
        var today = new Date().toISOString().slice(0, 10);
        var yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
        var label = dateStr === today ? 'Aujourd\'hui' : dateStr === yesterday ? 'Hier' : '';
        if (!label) try { label = new Date(dateStr + 'T12:00:00').toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' }); } catch(e) { label = dateStr; }
        div.innerHTML = '<span>' + label + '</span>';
        container.appendChild(div);
    }

    function addModNotice(container, mods) {
        var labels = mods.map(function(m) {
            if (m.type === 'daily') return 'Donn\u00e9es du ' + m.date;
            if (m.type === 'longterm') return 'Trajectoire';
            if (m.type === 'week_plan') return 'Plan ' + m.week;
            if (m.type === 'evaluation') return '\u00c9valuation';
            if (m.type === 'reference') return 'Fichier ' + (m.file || '');
            if (m.type === 'athlete_data') return 'Dashboard ' + (m.section || '');
            return m.type;
        });
        var div = document.createElement('div');
        div.className = 'chat-notification';
        div.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>Mis \u00e0 jour : ' + labels.join(', ');
        container.appendChild(div);
    }

    function scrollBot(el) { setTimeout(function() { el.scrollTop = el.scrollHeight; }, 50); }

    function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function fmtMd(text) {
        if (!text) return '';
        var s = escHtml(text);
        // Headers → bold text (strip # markers)
        s = s.replace(/^#{1,6}\s+(.+)$/gm, '<strong>$1</strong>');
        // Horizontal rules → just a spacer
        s = s.replace(/^[\-\*_]{3,}\s*$/gm, '');
        // Bold & italic
        s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
        // Inline code
        s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
        // Tables → simple lines (strip | delimiters, skip separator rows)
        s = s.replace(/^\|[\s\-:]+\|$/gm, ''); // remove separator rows like |---|---|
        s = s.replace(/^\|(.+)\|$/gm, function(_, row) {
            return row.split('|').map(function(c) { return c.trim(); }).filter(Boolean).join(' \u00b7 ');
        });
        // Unordered lists
        s = s.replace(/^[-\u2022] (.+)$/gm, '<li>$1</li>');
        s = s.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
        // Ordered lists
        s = s.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
        // Paragraphs
        s = s.replace(/\n\n/g, '</p><p>');
        s = s.replace(/\n/g, '<br>');
        s = '<p>' + s + '</p>';
        s = s.replace(/<p>\s*<\/p>/g, '');
        s = s.replace(/<p><br>/g, '<p>');
        return s;
    }

    // Hook into tab navigation: load chat when Coach tab is shown
    document.querySelectorAll('.tab-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            if (btn.dataset.tab === 'coach') {
                var athlete = currentAthlete;
                initChat(athlete);
                if (!chatLoadedFor[athlete]) {
                    loadChatHistory(athlete);
                }
                setTimeout(function() { var el = getEls(athlete); if (el.input) el.input.focus(); }, 200);
            }
        });
    });

    // Init both athletes (in case loaded via URL hash)
    ['yohann', 'juliette'].forEach(function(a) { initChat(a); });

})();
</script>

</body>
</html>
