<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f1117">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Coach Trail — Dashboard</title>
    <style>
        :root {
            --bg: #0f1117;
            --bg-card: #1a1d27;
            --bg-card-alt: #21242f;
            --border: #2a2d3a;
            --text: #e4e4e7;
            --text-muted: #8b8fa3;
            --accent: #3b82f6;
            --accent-light: #60a5fa;
            --green: #22c55e;
            --green-dark: #15803d;
            --yellow: #eab308;
            --orange: #f97316;
            --red: #ef4444;
            --red-dark: #991b1b;
            --purple: #a855f7;
            --cyan: #06b6d4;
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Inter, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 0;
            overflow-x: hidden;
        }

        /* ===== HEADER ===== */
        .header-bar {
            background: linear-gradient(135deg, #141720 0%, #1a1d27 100%);
            border-bottom: 1px solid var(--border);
            padding: 0;
        }
        header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 24px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .header-brand {
            display: flex; align-items: center; gap: 10px; flex-shrink: 0;
        }
        .header-logo-icon {
            width: 34px; height: 34px; border-radius: 8px;
            background: linear-gradient(135deg, var(--accent) 0%, #2563eb 100%);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        .header-logo-icon svg { width: 18px; height: 18px; }
        .header-title {
            font-size: 16px; font-weight: 800; letter-spacing: -0.5px;
            color: var(--text); line-height: 1.1;
        }
        .header-title span { color: var(--accent-light); }
        .header-athletes {
            display: flex; gap: 8px; flex: 1; justify-content: center;
        }
        .athlete-btn {
            display: flex; align-items: center; gap: 10px; padding: 8px 16px; border-radius: 10px;
            border: 1px solid transparent; background: transparent; color: var(--text-muted);
            cursor: pointer; font-family: inherit; font-size: 13px; font-weight: 600; transition: all 0.2s;
        }
        .athlete-btn:hover { background: var(--bg-card-alt); color: var(--text); }
        .athlete-btn.active {
            background: var(--bg-card); color: var(--text);
            border-color: var(--border);
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        .athlete-avatar {
            width: 32px; height: 32px; border-radius: 50%; color: #fff;
            display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700;
            flex-shrink: 0;
        }
        .avatar-yohann { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .avatar-juliette { background: linear-gradient(135deg, #a855f7, #7c3aed); }
        .athlete-info { display: flex; flex-direction: column; gap: 1px; min-width: 0; }
        .athlete-name { font-weight: 700; font-size: 13px; white-space: nowrap; }
        .athlete-detail { font-size: 11px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .athlete-btn.active .athlete-name { color: var(--text); }
        .athlete-btn.active .athlete-detail { color: var(--accent-light); }

        /* ===== TABS ===== */
        .tab-bar {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border);
            padding: 0 24px;
            max-width: 1400px;
            margin: 8px auto 0;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            white-space: nowrap;
            transition: all 0.2s;
            font-family: inherit;
        }

        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--accent-light); border-bottom-color: var(--accent-light); }

        .tab-content {
            display: none;
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
            animation: fadeIn 0.2s;
        }

        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ===== GRID ===== */
        .grid { display: grid; gap: 20px; margin-bottom: 24px; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        .grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
        .grid-1-2 { grid-template-columns: 1fr 2fr; }
        .grid-2-1 { grid-template-columns: 2fr 1fr; }

        /* ===== CARDS ===== */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }

        .card h2 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .card h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 16px 0 8px;
            color: var(--accent-light);
        }

        /* ===== STATS ===== */
        .stat-big { font-size: 36px; font-weight: 700; line-height: 1.1; }
        .stat-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .stat-row:last-child { border-bottom: none; }
        .stat-row .label { color: var(--text-muted); font-size: 13px; }
        .stat-row .value { font-weight: 600; font-size: 14px; }

        /* ===== BADGES ===== */
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-green { background: var(--green-dark); color: var(--green); }
        .badge-yellow { background: #854d0e; color: var(--yellow); }
        .badge-red { background: var(--red-dark); color: #fca5a5; }
        .badge-blue { background: #1e3a5f; color: var(--accent-light); }
        .badge-purple { background: #581c87; color: #d8b4fe; }
        .badge-orange { background: #9a3412; color: #fdba74; }

        /* ===== TABLE ===== */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        table th {
            text-align: left; padding: 8px 10px; font-size: 11px;
            text-transform: uppercase; letter-spacing: 0.5px;
            color: var(--text-muted); border-bottom: 2px solid var(--border);
        }
        table td { padding: 8px 10px; border-bottom: 1px solid var(--border); vertical-align: top; }
        table tr:last-child td { border-bottom: none; }
        table tr:hover { background: var(--bg-card-alt); }

        /* ===== COLORS ===== */
        .text-green { color: var(--green); }
        .text-yellow { color: var(--yellow); }
        .text-red { color: var(--red); }
        .text-orange { color: var(--orange); }
        .text-blue { color: var(--accent-light); }
        .text-purple { color: var(--purple); }
        .text-cyan { color: var(--cyan); }
        .text-muted { color: var(--text-muted); }
        .text-bold { font-weight: 700; }

        /* ===== ZONE BAR ===== */
        .zone-bar { display: flex; height: 32px; border-radius: 6px; overflow: hidden; margin: 8px 0; }
        .zone-bar div { display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #fff; }
        .zone-1 { background: #3b82f6; }
        .zone-2 { background: #22c55e; }
        .zone-3 { background: #eab308; }
        .zone-4 { background: #f97316; }
        .zone-5 { background: #ef4444; }

        /* ===== PROGRESS BAR ===== */
        .progress-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin: 6px 0; }
        .progress-bar .fill { height: 100%; border-radius: 4px; transition: width 0.3s; }

        /* ===== RECOMMENDATIONS ===== */
        .reco-item { padding: 14px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid; }
        .reco-critical { background: #1c1012; border-color: var(--red); }
        .reco-important { background: #1a1608; border-color: var(--orange); }
        .reco-positive { background: #0a1a0f; border-color: var(--green); }
        .reco-item .reco-title { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
        .reco-item .reco-text { font-size: 13px; color: var(--text-muted); }

        /* ===== RACE TIMELINE ===== */
        .race-timeline { position: relative; padding-left: 24px; }
        .race-timeline::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: var(--border); }
        .race-item { position: relative; padding: 12px 0; }
        .race-item::before { content: ''; position: absolute; left: -20px; top: 18px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid; }
        .race-a::before { border-color: var(--red); background: var(--red-dark); }
        .race-b::before { border-color: var(--orange); background: #9a3412; }
        .race-c::before { border-color: var(--yellow); background: #854d0e; }
        .race-done::before { border-color: var(--green); background: var(--green-dark); }
        .race-item .race-date { font-size: 12px; color: var(--text-muted); }
        .race-item .race-name { font-weight: 700; font-size: 15px; }
        .race-item .race-details { font-size: 13px; color: var(--text-muted); }

        /* ===== INJURY ===== */
        .injury-status { padding: 16px; border-radius: 8px; border: 1px solid; }
        .injury-active { background: #1c1012; border-color: var(--red); }
        .injury-healing { background: #1a1608; border-color: var(--yellow); }
        .injury-resolved { background: #0a1a0f; border-color: var(--green); }

        /* ===== WEEK DAY ===== */
        .week-day { padding: 12px; border-radius: 8px; background: var(--bg-card-alt); margin-bottom: 8px; }
        .week-day .day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .week-day .day-name { font-weight: 700; font-size: 14px; }
        .week-day .day-details { font-size: 13px; color: var(--text-muted); line-height: 1.5; }

        /* ===== NOTE BOX ===== */
        .note-box {
            background: var(--bg-card-alt);
            border-left: 3px solid var(--accent);
            padding: 12px 16px;
            border-radius: 0 8px 8px 0;
            font-size: 13px;
            margin: 12px 0;
            color: var(--text-muted);
        }

        /* ===== SECTION TITLE ===== */
        .section-title {
            font-size: 20px; font-weight: 700;
            margin: 32px 0 16px; padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            letter-spacing: -0.3px;
        }
        .section-title span { color: var(--accent-light); }

        /* ===== ACTIVITY CARD (Strava) ===== */
        .activity-card {
            background: var(--bg-card-alt);
            border-radius: 10px;
            padding: 0;
            margin-bottom: 10px;
            display: flex;
            overflow: hidden;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .activity-card:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
        .act-icon {
            width: 56px;
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .act-icon svg { width: 26px; height: 26px; }
        .act-icon.run { background: linear-gradient(135deg, #15803d, #22c55e); }
        .act-icon.trail { background: linear-gradient(135deg, #b45309, #f97316); }
        .act-icon.swim { background: linear-gradient(135deg, #0e7490, #06b6d4); }
        .act-icon.elliptical { background: linear-gradient(135deg, #7e22ce, #a855f7); }
        .act-icon.walk { background: linear-gradient(135deg, #a16207, #eab308); }
        .act-icon.workout { background: linear-gradient(135deg, #9a3412, #f97316); }
        .act-icon.default { background: linear-gradient(135deg, #1e3a5f, #3b82f6); }
        .act-body { flex: 1; padding: 14px 16px; }
        .act-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .act-name { font-weight: 700; font-size: 14px; letter-spacing: -0.2px; }
        .act-meta { font-size: 11px; color: var(--text-muted); text-align: right; line-height: 1.4; }
        .act-type-label { font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .act-stats { display: flex; gap: 6px; flex-wrap: wrap; }
        .act-stat {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 6px 12px;
            text-align: center;
            min-width: 72px;
        }
        .act-stat-value { font-weight: 800; font-size: 14px; letter-spacing: -0.3px; }
        .act-stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 1px; }
        .act-zone {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 8px;
        }

        /* ===== HEALTH TAB ===== */
        .sleep-phases-bar { display: flex; height: 28px; border-radius: 6px; overflow: hidden; margin: 8px 0; }
        .sleep-phases-bar div { display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: #fff; }
        .sleep-deep { background: #1e3a8a; }
        .sleep-light { background: #3b82f6; }
        .sleep-rem { background: #8b5cf6; }
        .sleep-awake { background: #f97316; }

        .mini-chart { display: flex; align-items: flex-end; gap: 3px; height: 100px; padding: 18px 2px 0; }
        .mini-chart .bar {
            flex: 1;
            border-radius: 3px 3px 0 0;
            min-width: 8px;
            position: relative;
            transition: opacity 0.15s;
            cursor: default;
        }
        .mini-chart .bar::after {
            content: attr(data-val);
            position: absolute;
            top: -16px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            font-weight: 600;
            color: var(--text-muted);
            white-space: nowrap;
        }
        .mini-chart .bar:hover { opacity: 0.8; }
        .mini-chart-labels { display: flex; justify-content: space-between; font-size: 9px; color: var(--text-muted); padding: 4px 2px 0; }

        .health-metric {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        .health-metric:last-child { border-bottom: none; }
        .health-metric-icon {
            width: 40px; height: 40px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .health-metric-value { font-size: 20px; font-weight: 700; }
        .health-metric-label { font-size: 12px; color: var(--text-muted); }

        .hrv-status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ===== SYNC BUTTON ===== */
        .sync-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            margin-top: 6px;
        }
        .sync-btn:hover { background: var(--bg-card-alt); color: var(--text); border-color: var(--accent); }
        .sync-btn.syncing { color: var(--accent-light); border-color: var(--accent); cursor: wait; }
        .sync-btn.syncing svg { animation: spin 1s linear infinite; }
        .sync-btn.stale { border-color: var(--orange); color: var(--orange); }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .sync-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); display: flex; align-items: center;
            justify-content: center; z-index: 1000;
        }
        .sync-modal-box {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 24px; max-width: 480px; width: 90%;
        }
        .sync-modal-box h3 { font-size: 16px; margin-bottom: 12px; }
        .sync-modal-box input {
            width: 100%; padding: 10px 12px; border-radius: 8px;
            border: 1px solid var(--border); background: var(--bg-card-alt);
            color: var(--text); font-size: 13px; font-family: monospace;
            margin: 8px 0 16px;
        }
        .sync-modal-box input:focus { outline: none; border-color: var(--accent); }
        .sync-modal-btn {
            padding: 8px 20px; border-radius: 8px; border: none;
            background: var(--accent); color: #fff; font-weight: 600;
            font-size: 13px; cursor: pointer; font-family: inherit;
        }
        .sync-modal-btn:hover { background: var(--accent-light); }
        .sync-modal-cancel {
            padding: 8px 20px; border-radius: 8px; border: 1px solid var(--border);
            background: none; color: var(--text-muted); font-weight: 600;
            font-size: 13px; cursor: pointer; margin-left: 8px; font-family: inherit;
        }

        /* ===== FOOTER ===== */
        footer {
            text-align: center; padding: 30px 0 20px; color: var(--text-muted);
            font-size: 12px; border-top: 1px solid var(--border);
            margin: 40px 24px 0; max-width: 1400px;
        }

        /* ===== WEEK MATCH ===== */
        .day-match {
            margin-top: 8px;
            font-size: 12px;
        }
        .day-match-done {
            background: #0a1a0f;
            border: 1px solid var(--green-dark);
            border-radius: 6px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .day-match-miss {
            background: #1c1012;
            border: 1px solid var(--red-dark);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--red);
        }
        .day-match-future {
            color: var(--text-muted);
            font-style: italic;
            padding: 4px 0;
        }

        .day-checks { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
        .day-check {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-muted);
            transition: all 0.15s;
        }
        .day-check:hover { border-color: var(--accent); }
        .day-check.checked {
            background: #0a1a0f;
            border-color: var(--green-dark);
            color: var(--green);
        }
        .day-check .check-icon { font-size: 14px; }

        /* ===== DAY METRICS (Soléaire + RPE dots) ===== */
        .day-metrics { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px; }
        .metric-row {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .metric-label { color: var(--text-muted); min-width: 28px; }
        .metric-dots { display: flex; gap: 2px; }
        .metric-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 1.5px solid var(--border);
            background: transparent;
            cursor: pointer;
            transition: all 0.12s;
            padding: 0;
            box-sizing: border-box;
        }
        .metric-dot:hover { border-color: var(--text-muted); transform: scale(1.15); }
        .metric-dot.filled { border-color: transparent; }
        .metric-value {
            min-width: 16px;
            text-align: center;
            font-variant-numeric: tabular-nums;
            margin-left: 2px;
        }

        /* ===== SAVE CHECKS BUTTON ===== */
        .save-checks-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 24px;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
            transition: all 0.3s;
            transform: translateY(80px);
            opacity: 0;
            z-index: 100;
        }
        .save-checks-btn.visible { transform: translateY(0); opacity: 1; }
        .save-checks-btn:hover { opacity: 0.9; }
        .save-checks-btn:disabled { opacity: 0.5; cursor: wait; }


        /* ===== RESPONSIVE ===== */
        @media (max-width: 900px) {
            body { overflow-x: hidden; }
            .grid-2, .grid-3, .grid-4, .grid-1-2, .grid-2-1 { grid-template-columns: 1fr; }
            header { flex-wrap: wrap; padding: 10px 16px; gap: 8px; }
            .header-brand { flex: 0 0 auto; }
            .header-athletes { flex: 1 1 100%; order: 3; gap: 6px; }
            .athlete-btn { flex: 1; padding: 8px 12px; }
            .header-sync { order: 2; margin-left: auto; }
            .tab-btn { padding: 10px 14px; font-size: 12px; }
            table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        }
        @media (max-width: 480px) {
            header { padding: 8px 12px; gap: 6px; }
            .header-logo-icon { width: 28px; height: 28px; border-radius: 6px; }
            .header-logo-icon svg { width: 15px; height: 15px; }
            .header-title { font-size: 13px; }
            .header-athletes { gap: 6px; }
            .athlete-btn { padding: 6px 8px; gap: 6px; }
            .athlete-avatar { width: 28px; height: 28px; font-size: 10px; }
            .athlete-name { font-size: 12px; }
            .athlete-detail { font-size: 10px; }
            .tab-btn { padding: 8px 10px; font-size: 11px; }
        }

        /* ===== TODAY CARD ===== */
        .today-card { border: 1px solid var(--accent); position: relative; }
        .today-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px; }
        .today-header h2 { margin: 0; }
        .today-exercises { display: flex; flex-direction: column; gap: 12px; }
        .exercise-card {
            display: flex; gap: 16px; align-items: flex-start;
            padding: 12px; border-radius: 8px; background: var(--bg-card-alt);
        }
        .exercise-svg { flex-shrink: 0; width: 64px; height: 64px; }
        .exercise-svg svg { width: 100%; height: 100%; }
        .exercise-info { flex: 1; }
        .exercise-name { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
        .exercise-detail { font-size: 13px; color: var(--text-muted); line-height: 1.5; }

        /* Today icon strip */
        .today-icons { display: flex; gap: 16px; margin-bottom: 4px; }
        .today-icon-item { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .today-icon-item .exercise-svg { width: 48px; height: 48px; }
        .today-icon-label { font-size: 11px; color: var(--text-muted); font-weight: 600; }

        /* Past days: compact + greyed out, expandable on hover/tap */
        .day-past { opacity: 0.5; }
        .day-past .day-details { max-height: 0; overflow: hidden; margin: 0; padding: 0; transition: max-height 0.3s ease, opacity 0.3s ease; }
        .day-past .day-header { margin-bottom: 0; }
        .day-past:hover { opacity: 0.8; }
        .day-past:hover .day-details { max-height: 200px; }
        .day-hidden { display: none; }

        /* Sub-tabs (Programme: A venir / Passés) */
        .sub-tabs { display: flex; gap: 0; margin-bottom: 20px; border-bottom: 2px solid var(--border); background: var(--bg-card); border-radius: 8px 8px 0 0; padding: 4px 4px 0; }
        .sub-tab { padding: 10px 20px; background: none; border: none; color: var(--text-muted); font-size: 14px; font-weight: 700; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; font-family: inherit; transition: all 0.2s; letter-spacing: 0.3px; }
        .sub-tab:hover { color: var(--text); }
        .sub-tab.active { color: var(--accent-light); border-bottom-color: var(--accent-light); border-bottom-width: 3px; }
        .sub-content { display: none; }
        .sub-content.active { display: block; animation: fadeIn 0.2s; }

        .athlete-content { display: none; }
        .athlete-content.active { display: block; }
    </style>
</head>
<body>

<!-- ===== HEADER ===== -->
<div class="header-bar">
<header>
    <div class="header-brand">
        <div class="header-logo-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 19l4-8 3 4 4-10 7 14"/>
                <circle cx="18" cy="5" r="2" fill="white" stroke="none"/>
            </svg>
        </div>
        <div class="header-title">Coach<span>Trail</span></div>
    </div>
    <div class="header-athletes">
        <button class="athlete-btn active" data-athlete="yohann">
            <span class="athlete-avatar avatar-yohann">YT</span>
            <div class="athlete-info">
                <span class="athlete-name">Yohann</span>
                <span class="athlete-detail" id="header-detail-yohann">OCC 57km — J-200</span>
            </div>
        </button>
        <button class="athlete-btn" data-athlete="juliette">
            <span class="athlete-avatar avatar-juliette">JS</span>
            <div class="athlete-info">
                <span class="athlete-name">Juliette</span>
                <span class="athlete-detail" id="header-detail-juliette">G2G 275km — J-224</span>
            </div>
        </button>
    </div>
    <div class="header-sync" style="display: flex; align-items: center; gap: 8px;">
        <button class="sync-btn" id="sync-btn" onclick="handleSync(event)" title="Sync Strava + Garmin (Shift+click = reconfigurer le token)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
            <span id="sync-label">Sync</span>
        </button>
        <span id="garmin-status" style="font-size: 10px; color: var(--text-muted);"></span>
    </div>
</header>
</div>

<!-- ===== TAB BAR ===== -->
<nav class="tab-bar">
    <button class="tab-btn active" data-tab="overview">Vue d'ensemble</button>
    <button class="tab-btn" data-tab="health">Santé</button>
    <button class="tab-btn" data-tab="activities">Activités</button>
    <button class="tab-btn" data-tab="week">Programme</button>
    <button class="tab-btn" data-tab="injury">Blessure</button>
    <button class="tab-btn" data-tab="calendar">Calendrier</button>
    <button class="tab-btn" data-tab="progress">Progression</button>
</nav>

<!-- ===== ATHLETE: YOHANN ===== -->
<div id="athlete-yohann" class="athlete-content active">

<!-- ======================================================================== -->
<!-- TAB 1 : VUE D'ENSEMBLE                                                  -->
<!-- ======================================================================== -->
<div id="overview" class="tab-content active">

    <!-- KPI cards -->
    <div class="grid grid-4" style="margin-bottom: 24px;">
        <div class="card" style="text-align: center;">
            <div class="stat-big text-blue">451</div>
            <div class="stat-label">UTMB Index Pic</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;">20K: 446 · 50K: 437</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big text-green" id="kpi-vo2max">45</div>
            <div class="stat-label">VO2max (ml/kg/min)</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="kpi-vo2max-sub">Garmin · 07/02/2026</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big text-green" id="kpi-week-km">--</div>
            <div class="stat-label">Km cette semaine</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="kpi-week-km-sub">Chargement...</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big text-orange" id="kpi-week-elev">--</div>
            <div class="stat-label">D+ cette semaine</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="kpi-week-elev-sub">Chargement...</div>
        </div>
    </div>

    <!-- Profil + Evaluation -->
    <div class="grid grid-2-1">
        <div class="card">
            <h2>Profil athlete</h2>
            <div class="stat-row"><span class="label">Age</span><span class="value">44 ans</span></div>
            <div class="stat-row"><span class="label">FC repos</span><span class="value">46 bpm</span></div>
            <div class="stat-row"><span class="label">FC max</span><span class="value">178 bpm</span></div>
            <div class="stat-row"><span class="label">Reserve cardiaque</span><span class="value">132 bpm</span></div>
            <div class="stat-row"><span class="label">VO2max (Garmin)</span><span class="value">45 ml/kg/min</span></div>
            <div class="stat-row"><span class="label">VMA estimee</span><span class="value">~15.0 km/h <span class="badge badge-yellow">a tester</span></span></div>
            <div class="stat-row"><span class="label">Running Stones</span><span class="value">4</span></div>
            <div class="stat-row"><span class="label">Courses depuis 2022</span><span class="value">27</span></div>
            <div class="stat-row"><span class="label">Plus longue course</span><span class="value">65.8 km (Astragale)</span></div>
            <div class="stat-row"><span class="label">Montre</span><span class="value">Garmin Fenix 7 Pro</span></div>
            <div class="stat-row"><span class="label">Batons</span><span class="value">Oui, fluide en montee</span></div>
            <div class="stat-row"><span class="label">Tapis</span><span class="value">+40% / -5%</span></div>
        </div>

        <div class="card">
            <h2>Evaluation /10</h2>
            <div id="eval-scores">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">Chargement...</div>
            </div>
            <div id="eval-global" style="margin-top: 16px; padding-top: 12px; border-top: 2px solid var(--border); text-align: center;">
                <div class="stat-big" id="eval-global-value" style="color: var(--text-muted);">&mdash;<span style="font-size: 16px; color: var(--text-muted);">/10</span></div>
                <div class="stat-label">Note globale</div>
            </div>
        </div>
    </div>

    <!-- Zones FC -->
    <div class="card" style="margin-top: 4px;">
        <h2>Zones de frequence cardiaque</h2>
        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">Methode Karvonen · FC repos 46 · FC max 178 · RFC 132 bpm</p>
        <div class="zone-bar">
            <div class="zone-1" style="width:20%;">Z1 112-125</div>
            <div class="zone-2" style="width:20%;">Z2 125-138</div>
            <div class="zone-3" style="width:20%;">Z3 138-152</div>
            <div class="zone-4" style="width:20%;">Z4 152-165</div>
            <div class="zone-5" style="width:20%;">Z5 165-178</div>
        </div>
    </div>

</div>

<!-- ======================================================================== -->
<!-- TAB 2 : SEMAINE                                                          -->
<!-- ======================================================================== -->
<div id="week" class="tab-content">

    <!-- Sous-onglets -->
    <div class="sub-tabs">
        <button class="sub-tab active" data-subtab="upcoming">A venir</button>
        <button class="sub-tab" data-subtab="past">Pass&#233;s</button>
    </div>

    <!-- SUB-TAB : A venir -->
    <div id="week-upcoming" class="sub-content active">

    <!-- AUJOURD'HUI (dynamique) -->
    <div id="today-container"></div>

    <!-- Jour source pour buildTodayCard (masqué automatiquement par JS) -->
    <div class="week-day" data-date="2026-02-08" data-checks="Iso mollets">
        <div class="day-header">
            <span class="day-name">Dimanche 8</span>
            <span class="badge" style="background: #333; color: #999;">Repos / Souple</span>
        </div>
        <div class="day-details">
            <strong>Repos complet</strong> OU elliptique souple 30 min <span class="text-blue">Z1 (112-125 bpm)</span> selon fatigue<br>
            <strong>Protocole iso mollets</strong> : bilateral montee sur pointes 30s x 4, unipodal gauche 30s x 4
        </div>
        <div class="day-match"></div>
        <div class="day-checks"></div>
    </div>

    <!-- W07 -->
    <div class="card" style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2 style="margin: 0;">Semaine W07 — 10 au 16 fevrier 2026</h2>
            <span class="badge badge-blue">BLOC 0 — REPRISE & SOIN</span>
        </div>

        <div class="note-box">
            <strong>Objectif :</strong> Soleaire : avancer dans le protocole (phase 1 vers 2). Maintenir le cardio via cross-training.<br>
            <strong>Course a pied :</strong> ZERO. Pas de footing cette semaine.<br>
            <strong>Volume cible :</strong> 5-6h cross-training.
        </div>

        <!-- Planning jour par jour -->
        <div class="week-day" data-date="2026-02-10" data-checks="Iso mollets">
            <div class="day-header">
                <span class="day-name">Lundi 10</span>
                <span class="badge badge-blue">Elliptique</span>
            </div>
            <div class="day-details">
                <strong>Elliptique</strong> 50-60 min <span class="text-blue">Z1 (112-125 bpm)</span><br>
                Resistance moderee, cadence reguliere. Protocole iso mollets apres.
            </div>
            <div class="day-match"></div>
            <div class="day-checks"></div>
        </div>

        <div class="week-day" data-date="2026-02-11" data-checks="PPG haut du corps,Iso mollets">
            <div class="day-header">
                <span class="day-name">Mardi 11</span>
                <span class="badge badge-blue">Elliptique + PPG</span>
            </div>
            <div class="day-details">
                <strong>Elliptique</strong> 50 min <span class="text-blue">Z1-Z2 (112-138 bpm)</span> + <strong>PPG haut du corps</strong> 30 min<br>
                Pompes 3x max, gainage frontal 3x30s, lateral 2x20s/cote, superman 3x10<br>
                Protocole iso mollets apres.
            </div>
            <div class="day-match"></div>
            <div class="day-checks"></div>
        </div>

        <div class="week-day" data-date="2026-02-12" data-checks="Iso mollets">
            <div class="day-header">
                <span class="day-name">Mercredi 12</span>
                <span class="badge badge-purple">Natation</span>
            </div>
            <div class="day-details">
                <strong>Natation</strong> 45-60 min (~1500-2000 m) <span class="text-blue">Z1-Z2</span><br>
                Crawl principal. Battements moderes — pullbuoy si gene mollet.<br>
                Protocole iso mollets le soir.
            </div>
            <div class="day-match"></div>
            <div class="day-checks"></div>
        </div>

        <div class="week-day" data-date="2026-02-13" data-checks="Test phase 2">
            <div class="day-header">
                <span class="day-name">Jeudi 13</span>
                <span class="badge badge-blue">Elliptique + Test phase 2</span>
            </div>
            <div class="day-details">
                <strong>Elliptique</strong> 50-60 min <span class="text-green">Z2 (125-138 bpm)</span> — un cran au-dessus<br>
                <strong style="color: var(--yellow);">Test passage phase 2 :</strong> mollet unipodal G x 15 reps lentes.<br>
                Si 0 gene : <span class="text-green">excentrique Stanish</span> (3x10 reps, descente 5s). Sinon : rester phase 1.
            </div>
            <div class="day-match"></div>
            <div class="day-checks"></div>
        </div>

        <div class="week-day" data-date="2026-02-14" data-checks="Iso / excentriques">
            <div class="day-header">
                <span class="day-name">Vendredi 14</span>
                <span class="badge badge-blue">Elliptique</span>
            </div>
            <div class="day-details">
                <strong>Elliptique</strong> 45-60 min <span class="text-blue">Z1 (112-125 bpm)</span><br>
                Resistance moderee. Protocole iso ou excentriques selon jeudi.
            </div>
            <div class="day-match"></div>
            <div class="day-checks"></div>
        </div>

        <div class="week-day" style="border-left: 3px solid var(--red);" data-date="2026-02-15" data-checks="PPG complete,Retest saut unipodal">
            <div class="day-header">
                <span class="day-name">Samedi 15</span>
                <span class="badge badge-red">RETEST + Double seance</span>
            </div>
            <div class="day-details">
                <strong>PPG complete</strong> 40 min (haut + bas du corps doux) + <strong>Natation ou Elliptique</strong> 45-60 min <span class="text-blue">Z1-Z2</span><br>
                <strong style="color: var(--red);">RETEST SAUT UNIPODAL G : 10 sauts, noter /10</strong><br>
                <span class="text-muted">Resultat 7 fev : 4-5/10. Si 2/10 ou moins : footing envisageable W08. Si 3+ : on continue phase 1-2.</span><br>
                <strong style="color: var(--orange);">Point de decision Cabornis (8 mars)</strong>
            </div>
            <div class="day-match"></div>
            <div class="day-checks"></div>
        </div>

        <div class="week-day" data-date="2026-02-16" data-checks="Iso / excentriques">
            <div class="day-header">
                <span class="day-name">Dimanche 16</span>
                <span class="badge" style="background: #333; color: #999;">Repos / Souple</span>
            </div>
            <div class="day-details">
                <strong>Repos complet</strong> OU elliptique souple 30 min <span class="text-blue">Z1</span> si Body Battery > 50<br>
                Protocole iso/excentriques. Bilan de la semaine.
            </div>
            <div class="day-match"></div>
            <div class="day-checks"></div>
        </div>

        <!-- Regularite -->
        <div id="week-regularity" style="margin-top: 16px; padding: 14px; background: var(--bg-card-alt); border-radius: 8px; display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Regularite</span>
                <span id="week-regularity-badge" class="badge badge-yellow">--</span>
            </div>
            <div class="progress-bar" style="height: 10px;"><div class="fill" id="week-regularity-bar" style="width: 0%; background: var(--yellow);"></div></div>
            <div id="week-regularity-detail" style="font-size: 12px; color: var(--text-muted); margin-top: 6px;"></div>
        </div>

        <!-- Volume resume -->
        <div style="margin-top: 16px; padding: 12px; background: var(--bg-card-alt); border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; font-size: 13px;">
                <span class="text-muted">Volume total cible</span>
                <span class="text-bold">5h30 — 6h30 cross-training</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 13px; margin-top: 4px;">
                <span class="text-muted">Course a pied</span>
                <span class="text-bold text-red">ZERO</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 13px; margin-top: 4px;">
                <span class="text-muted">Seances</span>
                <span class="text-bold">6-7 (2 marche, 2-3 elliptique, 1-2 natation, 2 PPG)</span>
            </div>
        </div>
    </div>

    <!-- Semaine type -->
    <div class="card" style="margin-top: 20px;">
        <h2>Semaine type — Creneaux disponibles</h2>
        <table>
            <tr><th>Jour</th><th>Lieu</th><th>Creneaux</th><th>Contraintes</th></tr>
            <tr><td class="text-bold">Lundi</td><td>Bureau Champagne</td><td>Midi uniquement</td><td class="text-muted">7-8 km / 150-200 D+ ou 12-13 km / 350-400 D+</td></tr>
            <tr><td class="text-bold">Mardi</td><td>Teletravail</td><td>Matin + Midi</td><td class="text-muted">Flexible</td></tr>
            <tr><td class="text-bold">Mercredi</td><td>Teletravail</td><td>Matin + Midi</td><td class="text-muted">Flexible</td></tr>
            <tr><td class="text-bold">Jeudi</td><td>Teletravail</td><td>Matin + Midi</td><td class="text-muted">Flexible</td></tr>
            <tr><td class="text-bold">Vendredi</td><td>Bureau Champagne</td><td>Midi uniquement</td><td class="text-muted">7-8 km / 150-200 D+ ou 12-13 km / 350-400 D+</td></tr>
            <tr><td class="text-bold">Samedi</td><td>Libre</td><td>Toute la journee</td><td class="text-muted">Sortie longue possible</td></tr>
            <tr><td class="text-bold">Dimanche</td><td>Libre</td><td>Matin</td><td class="text-muted">2 enfants — adapter</td></tr>
        </table>
    </div>

    </div><!-- /week-upcoming -->

    <!-- SUB-TAB : Passés -->
    <div id="week-past" class="sub-content">
        <h3 style="font-size: 15px; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Historique recent</h3>

        <!-- Samedi 7 fév (jour isolé, pas de semaine complète) -->
        <div class="week-day day-past" data-date="2026-02-07" data-checks="Iso mollets,PPG haut du corps">
            <div class="day-header">
                <span class="day-name">Samedi 7 fevrier</span>
                <span class="badge badge-blue">Cross + Protocole iso</span>
            </div>
            <div class="day-details">
                <strong>Protocole iso mollets</strong> : bilateral montee sur pointes 30s x 4, unipodal gauche 30s x 4<br>
                <strong>Elliptique ou Natation</strong> 45-60 min Z1 (112-125 bpm)<br>
                <strong>PPG haut du corps</strong> : pompes 3x max, gainage frontal 3x30s, lateral 2x20s/cote
            </div>
            <div class="day-match"></div>
            <div class="day-checks"></div>
        </div>
    </div><!-- /week-past -->

</div>

<!-- ======================================================================== -->
<!-- TAB 3 : BLESSURE                                                         -->
<!-- ======================================================================== -->
<div id="injury" class="tab-content">

    <div class="grid grid-2">
        <div class="card">
            <div class="injury-status injury-active">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 700; font-size: 16px;">Soleaire gauche — Episode 4</div>
                        <div style="font-size: 13px; color: var(--text-muted);">Jonction myo-tendineuse · Grade leger</div>
                    </div>
                    <span class="badge badge-red">ACTIF</span>
                </div>
            </div>

            <h3>Bilan du 7 fevrier</h3>
            <div class="stat-row"><span class="label">Palpation</span><span class="value text-green">0/10</span></div>
            <div class="stat-row"><span class="label">Mollets bilateral</span><span class="value text-green">0/10</span></div>
            <div class="stat-row"><span class="label">Mollet unipodal G</span><span class="value text-yellow">~1/10 (gene en haut)</span></div>
            <div class="stat-row"><span class="label">Saut unipodal G</span><span class="value text-red">4-5/10</span></div>
            <div class="stat-row"><span class="label">Marche rapide</span><span class="value text-green">0/10</span></div>

            <h3>Contexte</h3>
            <div class="stat-row"><span class="label">Declencheur</span><span class="value">Raidlight WT (31/01) puis sortie fatiguee (06/02)</span></div>
            <div class="stat-row"><span class="label">Historique</span><span class="value">4 episodes (3x G, 1x D) — fragilite bilaterale chronique</span></div>

            <h3>Observation chronique</h3>
            <div class="note-box">
                Raideur bilaterale systematique a la jonction mollet/soleaire en debut de chaque seance. Pattern chronique = fragilite structurelle permanente. Protocole de prevention a vie, pas uniquement en phase de blessure.
            </div>
        </div>

        <div class="card">
            <h2>Protocole de retour a la course</h2>
            <table>
                <tr><th>Phase</th><th>Critere d'entree</th><th>Contenu</th><th>Statut</th></tr>
                <tr>
                    <td class="text-bold">1 — Isometrique</td>
                    <td>Maintenant</td>
                    <td class="text-muted">Iso mollet 30sx4, bilateral puis unipodal</td>
                    <td id="proto-phase-1"><span class="badge badge-blue">EN COURS</span></td>
                </tr>
                <tr>
                    <td class="text-bold">2 — Excentrique</td>
                    <td>Unipodal 15 reps 0 gene</td>
                    <td class="text-muted">Stanish lent + marche pente tapis</td>
                    <td id="proto-phase-2"><span class="badge badge-yellow">A VENIR</span></td>
                </tr>
                <tr>
                    <td class="text-bold">3 — Footing</td>
                    <td>Saut unipodal &le; 1/10</td>
                    <td class="text-muted">Tapis plat, 7-8 km/h, 15-20 min</td>
                    <td id="proto-phase-3"><span class="badge badge-yellow">A VENIR</span></td>
                </tr>
                <tr>
                    <td class="text-bold">4 — Progression</td>
                    <td>30 min tapis indolore</td>
                    <td class="text-muted">Duree augmentee, intro inclinaison</td>
                    <td id="proto-phase-4"><span class="badge badge-yellow">A VENIR</span></td>
                </tr>
                <tr>
                    <td class="text-bold">5 — Validation</td>
                    <td>10 sauts unipodaux 0/10</td>
                    <td class="text-muted">Course normale, reintro D+</td>
                    <td id="proto-phase-5"><span class="badge badge-yellow">A VENIR</span></td>
                </tr>
            </table>

            <div class="note-box" style="margin-top: 16px;">
                <strong>Point de decision Cabornis (8 mars) :</strong> retest saut unipodal le 15 fevrier.<br>
                Si phase 3 non atteinte au 20 fevrier : Cabornis annulee.
            </div>

            <h3>Prevention permanente</h3>
            <table>
                <tr><th>Action</th><th>Frequence</th></tr>
                <tr><td>Echauffement obligatoire : 10 min marche + montees mollets progressives</td><td>Avant CHAQUE course</td></tr>
                <tr><td>Isometrique mollet unipodal 4x30s</td><td>Quotidien</td></tr>
                <tr><td>Excentrique Stanish 3x15 reps</td><td>3x / semaine</td></tr>
                <tr><td>Ne JAMAIS courir en fatigue accumulee</td><td>Regle absolue</td></tr>
                <tr><td>Auto-test : 10 sauts unipodaux</td><td>Chaque lundi matin</td></tr>
            </table>

            <h3>Evolution soleaire (14 derniers jours)</h3>
            <div class="mini-chart" id="chart-soleaire" style="height: 80px;"></div>
            <div class="mini-chart-labels" id="chart-soleaire-labels"></div>

            <h3>Journal de suivi</h3>
            <div id="injury-journal">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">Chargement...</div>
            </div>
        </div>
    </div>

    <!-- Historique blessures -->
    <div class="card" style="margin-top: 20px;">
        <h2>Historique des blessures</h2>
        <table>
            <tr><th>#</th><th>Localisation</th><th>Cote</th><th>Gravite</th><th>Resolution</th></tr>
            <tr><td>1</td><td>Jonction mollet/soleaire</td><td>Gauche</td><td>Modere</td><td class="text-green">Resolu</td></tr>
            <tr><td>2</td><td>Jonction mollet/soleaire</td><td>Gauche</td><td>Modere</td><td class="text-green">Resolu</td></tr>
            <tr><td>3</td><td>Jonction mollet/soleaire</td><td>Droit</td><td>Leger</td><td class="text-green">Resolu</td></tr>
            <tr><td class="text-bold">4</td><td class="text-bold">Jonction mollet/soleaire</td><td class="text-bold">Gauche</td><td class="text-bold">Leger</td><td class="text-red text-bold">En cours</td></tr>
        </table>
    </div>
</div>

<!-- ======================================================================== -->
<!-- TAB : SANTE (Garmin Connect)                                             -->
<!-- ======================================================================== -->
<div id="health" class="tab-content">

    <!-- KPI Sante -->
    <div class="grid grid-4" style="margin-bottom: 24px;" id="health-kpi">
        <div class="card" style="text-align: center;">
            <div class="stat-big" id="health-last-night" style="color: var(--text-muted);">--</div>
            <div class="stat-label">Dernière nuit</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="health-last-night-score">--</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big" id="health-body-battery" style="color: var(--text-muted);">--</div>
            <div class="stat-label">Body Battery</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="health-bb-detail">--</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big text-red" id="health-sleep-avg">--</div>
            <div class="stat-label">Sommeil moyen /nuit</div>
            <div style="font-size:12px; color: var(--red); margin-top:4px;" id="health-sleep-avg-sub">Objectif : 7h30</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big text-orange">82<span style="font-size:18px; color: var(--text-muted);">kg</span></div>
            <div class="stat-label">Poids</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;">184 cm · IMC 24.2</div>
        </div>
    </div>

    <!-- Sommeil detail + VFC/Stress -->
    <div class="grid grid-2">
        <!-- Sommeil -->
        <div class="card">
            <h2>Sommeil</h2>
            <div id="health-sleep-detail">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">Chargement...</div>
            </div>
        </div>

        <!-- VFC + Stress -->
        <div class="card">
            <h2>Variabilite cardiaque & Stress</h2>
            <div id="health-hrv-stress">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">Chargement...</div>
            </div>
        </div>
    </div>

    <!-- Facteurs limitants hygiene de vie -->
    <div class="card" style="margin-bottom: 24px; border-left: 3px solid var(--orange);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h2 style="margin: 0;">Facteurs limitants — Hygiene de vie</h2>
            <span class="badge badge-orange">-12 a -20% perf estimee</span>
        </div>
        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">
            A 44 ans, ces facteurs combines freinent la performance ET la guerison du soleaire. Marge de progression enorme sans changer une seule seance.
        </p>
        <table>
            <tr><th>Facteur</th><th>Etat actuel</th><th>Impact</th><th>Objectif</th></tr>
            <tr>
                <td class="text-bold">Sommeil</td>
                <td class="text-red text-bold">6h03 / nuit</td>
                <td class="text-muted">Le + critique : recup tendineuse ralentie, risque blessure x1.7</td>
                <td class="text-green">7h30 min</td>
            </tr>
            <tr>
                <td class="text-bold">Nicotine</td>
                <td class="text-yellow text-bold">Sevrage en cours</td>
                <td class="text-muted">+3-5% cardio a recuperer, vasoconstriction = cicatrisation ralentie</td>
                <td class="text-green">0 mg permanent</td>
            </tr>
            <tr>
                <td class="text-bold">Alimentation</td>
                <td class="text-red text-bold">1-2 repas / jour</td>
                <td class="text-muted">Deficit protéique chronique, besoin 2800-3500 kcal/j pour 82 kg a 6-7 seances/sem</td>
                <td class="text-green">Diner syst. (30-40g prot) + petit-dej jours seance</td>
            </tr>
            <tr>
                <td class="text-bold">Hydratation</td>
                <td class="text-yellow text-bold">Non suivi</td>
                <td class="text-muted">Tendons = 70% eau. Deshydratation chronique = elasticite reduite</td>
                <td class="text-green">2L+ / jour</td>
            </tr>
        </table>
        <div class="note-box" style="margin-top: 12px;">
            <strong>Pour le soleaire :</strong> sommeil + proteines + hydratation = les 3 piliers de la cicatrisation tendineuse. Sans ces 3, le protocole iso fait la moitie du boulot.
        </div>
    </div>

    <!-- Charts 14 jours -->
    <div class="section-title">Tendances <span>14 jours</span></div>

    <div class="grid grid-3">
        <div class="card">
            <h2>FC repos (bpm)</h2>
            <div class="mini-chart" id="chart-rhr"></div>
            <div class="mini-chart-labels" id="chart-rhr-labels"></div>
        </div>
        <div class="card">
            <h2>VFC — Moyenne nocturne (ms)</h2>
            <div class="mini-chart" id="chart-hrv"></div>
            <div class="mini-chart-labels" id="chart-hrv-labels"></div>
        </div>
        <div class="card">
            <h2>Pas quotidiens</h2>
            <div class="mini-chart" id="chart-steps"></div>
            <div class="mini-chart-labels" id="chart-steps-labels"></div>
        </div>
    </div>

    <!-- Body Battery 14j + Sommeil 14j -->
    <div class="grid grid-2">
        <div class="card">
            <h2>Body Battery — 14 jours</h2>
            <div class="mini-chart" id="chart-bb"></div>
            <div class="mini-chart-labels" id="chart-bb-labels"></div>
            <div id="chart-bb-summary" style="margin-top: 12px;"></div>
        </div>
        <div class="card">
            <h2>Sommeil — 14 jours</h2>
            <div class="mini-chart" id="chart-sleep"></div>
            <div class="mini-chart-labels" id="chart-sleep-labels"></div>
            <div id="chart-sleep-summary" style="margin-top: 12px;"></div>
        </div>
    </div>
</div>

<!-- ======================================================================== -->
<!-- TAB 4 : CALENDRIER                                                       -->
<!-- ======================================================================== -->
<div id="calendar" class="tab-content">

    <div class="grid grid-1-2">
        <div class="card">
            <h2>Courses 2026</h2>
            <div class="race-timeline">
                <div class="race-item race-done">
                    <div class="race-date">31 janvier — <span class="badge badge-green">TERMINE</span></div>
                    <div class="race-name">Raidlight Winter Trail</div>
                    <div class="race-details">19 km · 1000 D+ · 3:10:59 · 99e/116</div>
                </div>
                <div class="race-item race-c">
                    <div class="race-date">8 mars — <span class="badge badge-yellow">OBJECTIF C</span></div>
                    <div class="race-name">Cabornis</div>
                    <div class="race-details">25 km · 1000 D+ · Reprise / evaluation</div>
                    <div style="font-size: 12px; color: var(--red); margin-top: 2px;">Conditionne a la guerison soleaire</div>
                </div>
                <div class="race-item race-b">
                    <div class="race-date">26 avril — <span class="badge badge-orange">OBJECTIF B</span></div>
                    <div class="race-name">MMT (Marathon Mistral Trail)</div>
                    <div class="race-details">51 km · 2500 D+ · Test ultra + gestion effort long</div>
                </div>
                <div class="race-item race-b">
                    <div class="race-date">31 mai — <span class="badge badge-orange">OBJECTIF B</span></div>
                    <div class="race-name">Marathon-eXperience</div>
                    <div class="race-details">42 km · 1800 D+ · Allure + nutrition</div>
                </div>
                <div class="race-item race-b">
                    <div class="race-date">14 juin — <span class="badge badge-orange">OBJECTIF B</span></div>
                    <div class="race-name">Monistrail (Saint-Jacques UTMB)</div>
                    <div class="race-details">~53 km · ~1810 D+ · Meme course 2025 (UTMB 451) — etalon</div>
                </div>
                <div class="race-item race-a">
                    <div class="race-date">27 aout — <span class="badge badge-red">OBJECTIF A</span></div>
                    <div class="race-name" style="font-size: 18px;">OCC (UTMB Week)</div>
                    <div class="race-details">57 km · 3500 D+ · 61 m D+/km</div>
                    <div style="font-size: 12px; color: var(--accent-light); margin-top: 2px;">Projection : 10h30 — 12h30 · Cutoff : 14h30</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Periodisation macro</h2>
            <table>
                <tr><th>Bloc</th><th>Periode</th><th>Focus</th><th>Courses</th></tr>
                <tr>
                    <td><span class="badge badge-blue">BLOC 0</span></td>
                    <td>Fev. (actuel)</td>
                    <td>Reprise & soin soleaire. Cross-training. Zero course.<br><span class="text-green text-bold">+ Arret nicotine + sommeil + alimentation</span></td>
                    <td class="text-muted">—</td>
                </tr>
                <tr>
                    <td><span class="badge badge-green">BLOC 1</span></td>
                    <td>Mars</td>
                    <td>Reconstruction volume. Reprise D+ progressive. PPG bas du corps.</td>
                    <td>Cabornis (C)</td>
                </tr>
                <tr>
                    <td><span class="badge badge-yellow">BLOC 2</span></td>
                    <td>Avril</td>
                    <td>Build volume + D+. Sorties longues 3-5h. Seuil en cote.</td>
                    <td>MMT (B)</td>
                </tr>
                <tr>
                    <td><span class="badge badge-orange">BLOC 3</span></td>
                    <td>Mai</td>
                    <td>Build 2. Sorties longues avec fort D+. Nutrition longue duree.</td>
                    <td>MaraXP (B)</td>
                </tr>
                <tr>
                    <td><span class="badge badge-red">BLOC 4</span></td>
                    <td>Juin</td>
                    <td>Specifique OCC. Profil D+/km eleve. Descente technique.</td>
                    <td>Monistrail (B)</td>
                </tr>
                <tr>
                    <td><span class="badge badge-purple">BLOC 5</span></td>
                    <td>Juillet</td>
                    <td>Volume pic. Sorties montagne. Altitude si possible.</td>
                    <td>—</td>
                </tr>
                <tr>
                    <td><span class="badge" style="background:#333; color:#fff;">AFFUT</span></td>
                    <td>Aout</td>
                    <td>Tapering 10-14j. Maintien intensite, volume reduit. Logistique OCC.</td>
                    <td><strong>OCC (A)</strong></td>
                </tr>
            </table>

            <h3>Gap OCC — Le defi cle</h3>
            <table>
                <tr><th>Indicateur</th><th>Tes ultras</th><th>OCC</th><th>Gap</th></tr>
                <tr><td>D+/km</td><td>34 m/km</td><td class="text-red text-bold">61 m/km</td><td class="text-red">x 1.8</td></tr>
                <tr><td>D+ total</td><td>2247 m max</td><td class="text-red text-bold">3500 m</td><td class="text-red">+1253 m</td></tr>
                <tr><td>Altitude</td><td>~1500 m max</td><td class="text-orange text-bold">~2600 m</td><td class="text-orange">a travailler</td></tr>
                <tr><td>Duree effort</td><td>10h53 max</td><td class="text-yellow text-bold">10h30-12h30</td><td class="text-yellow">dans la zone</td></tr>
            </table>
        </div>
    </div>

    <!-- Projection OCC -->
    <div class="section-title">Projection <span>OCC</span></div>

    <div class="grid grid-3">
        <div class="card" style="text-align: center; border-color: var(--green-dark);">
            <div class="stat-label" style="margin-bottom: 8px;">AMBITIEUX</div>
            <div class="stat-big text-green">&lt; 11h</div>
            <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Tout se passe bien, bonne gestion, forme optimale</div>
        </div>
        <div class="card" style="text-align: center; border-color: var(--accent);">
            <div class="stat-label" style="margin-bottom: 8px;">REALISTE</div>
            <div class="stat-big text-blue">11h — 12h</div>
            <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Gestion prudente, forme correcte</div>
        </div>
        <div class="card" style="text-align: center; border-color: var(--orange);">
            <div class="stat-label" style="margin-bottom: 8px;">SECURITE</div>
            <div class="stat-big text-orange">12h — 13h</div>
            <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Conditions difficiles ou forme sous-optimale</div>
        </div>
    </div>

    <!-- Axes de travail -->
    <div class="card" style="margin-top: 20px;">
        <h2>Axes de travail — Par ordre d'impact sur l'OCC</h2>
        <table>
            <tr><th>#</th><th>Axe</th><th>Impact</th><th>Outil principal</th><th>Indicateur de succes</th></tr>
            <tr><td class="text-bold">1</td><td class="text-bold">Specifique montee (D+/km)</td><td><span class="badge badge-red">TRES ELEVE</span></td><td>Tapis 20-40%, cotes terrain</td><td>Confort en Z3 a 25%+ d'inclinaison</td></tr>
            <tr><td class="text-bold">2</td><td class="text-bold">Sommeil &ge; 7h30</td><td><span class="badge badge-red">TRES ELEVE</span></td><td>Discipline + suivi Fenix</td><td>Moyenne Garmin &ge; 7h30</td></tr>
            <tr><td class="text-bold">3</td><td class="text-bold">Alimentation complete</td><td><span class="badge badge-red">TRES ELEVE</span></td><td>Diner systematique</td><td>3 repas/j, 120g+ proteines</td></tr>
            <tr><td class="text-bold">4</td><td class="text-bold">Endurance &gt; 8h</td><td><span class="badge badge-orange">ELEVE</span></td><td>Sorties longues + courses prepa</td><td>MMT et Monistrail boucles</td></tr>
            <tr><td class="text-bold">5</td><td class="text-bold">Prevention soleaire</td><td><span class="badge badge-orange">ELEVE</span></td><td>Protocole quotidien iso + excentriques</td><td>0 episode d'ici l'OCC</td></tr>
            <tr><td class="text-bold">6</td><td class="text-bold">PPG / Renforcement</td><td><span class="badge badge-yellow">MODERE</span></td><td>Musculation 2x/sem</td><td>Excentrique quadri + chaine post.</td></tr>
            <tr><td class="text-bold">7</td><td class="text-bold">Nutrition course &gt; 10h</td><td><span class="badge badge-yellow">MODERE</span></td><td>Tests en sortie longue + courses</td><td>Plan valide a 250-300 kcal/h</td></tr>
            <tr><td class="text-bold">8</td><td class="text-bold">Technique descente</td><td><span class="badge badge-yellow">MODERE</span></td><td>Seances specifiques + tapis -5%</td><td>Aisance en descente technique</td></tr>
        </table>
    </div>
</div>

<!-- ======================================================================== -->
<!-- TAB 5 : PROGRESSION                                                      -->
<!-- ======================================================================== -->
<div id="progress" class="tab-content">

    <div class="card">
        <h2>Progression UTMB Index</h2>
        <div style="display: flex; gap: 40px; align-items: center; margin-bottom: 16px; flex-wrap: wrap;">
            <div style="text-align: center;">
                <div class="stat-big text-red">305</div>
                <div class="stat-label">Nov. 2023</div>
            </div>
            <div style="font-size: 32px; color: var(--text-muted);">&rarr;</div>
            <div style="text-align: center;">
                <div class="stat-big text-green">451</div>
                <div class="stat-label">Juin 2025</div>
            </div>
            <div style="font-size: 14px; color: var(--green); font-weight: 700;">+146 points en 18 mois</div>
        </div>

        <!-- Graphique simplifie en CSS -->
        <div style="display: flex; align-items: flex-end; gap: 4px; height: 120px; margin: 20px 0; padding: 0 4px;">
            <div style="flex:1; background: var(--red); border-radius: 4px 4px 0 0; height: 36%;" title="358 - SainteLyon 2021"></div>
            <div style="flex:1; background: var(--red); border-radius: 4px 4px 0 0; height: 23%;" title="339 - Coursieres 2023"></div>
            <div style="flex:1; background: var(--red); border-radius: 4px 4px 0 0; height: 35%;" title="356 - StJacques 20K 2023"></div>
            <div style="flex:1; background: var(--red); border-radius: 4px 4px 0 0; height: 0%;" title="305 - Veni Vici 2023"></div>
            <div style="flex:1; background: var(--yellow); border-radius: 4px 4px 0 0; height: 78%;" title="419 - Sanglier 2024"></div>
            <div style="flex:1; background: var(--green); border-radius: 4px 4px 0 0; height: 100%;" title="451 - BelMontaise 2024"></div>
            <div style="flex:1; background: var(--orange); border-radius: 4px 4px 0 0; height: 51%;" title="380 - ETC UTMB 2024"></div>
            <div style="flex:1; background: var(--yellow); border-radius: 4px 4px 0 0; height: 88%;" title="433 - Veni Vici 2024"></div>
            <div style="flex:1; background: var(--yellow); border-radius: 4px 4px 0 0; height: 83%;" title="426 - Beaujoltrail 2025"></div>
            <div style="flex:1; background: var(--green); border-radius: 4px 4px 0 0; height: 100%;" title="451 - StJacques 50K 2025"></div>
            <div style="flex:1; background: var(--green); border-radius: 4px 4px 0 0; height: 97%;" title="447 - Nice CdA 2025"></div>
            <div style="flex:1; background: var(--green); border-radius: 4px 4px 0 0; height: 96%;" title="446 - SainteSprint 2025"></div>
            <div style="flex:1; background: var(--yellow); border-radius: 4px 4px 0 0; height: 80%;" title="422 - Astragale 2025"></div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); padding: 0 4px;">
            <span>Nov 21</span><span>Mai 23</span><span>Jun 23</span><span>Nov 23</span><span>Mar 24</span><span>Jul 24</span><span>Aou 24</span><span>Nov 24</span><span>Mai 25</span><span>Jun 25</span><span>Sep 25</span><span>Nov 25</span><span>Dec 25</span>
        </div>

        <table style="margin-top: 20px;">
            <tr><th>Course</th><th>Date</th><th>Distance</th><th>D+</th><th>Temps</th><th>Class.</th><th>UTMB Index</th></tr>
            <tr><td>Astragale (Templiers)</td><td>12/2025</td><td>65.8 km</td><td>2247 m</td><td>10:53:27</td><td>480/677</td><td><span class="text-yellow">422</span></td></tr>
            <tr><td>SainteSprint</td><td>11/2025</td><td>25 km</td><td>347 m</td><td>2:30:20</td><td>551/2561</td><td><span class="text-green">446</span></td></tr>
            <tr><td>Nice CdA UTMB</td><td>09/2025</td><td>23 km</td><td>680 m</td><td>2:54:58</td><td>364/1209</td><td><span class="text-green">447</span></td></tr>
            <tr><td class="text-bold">Saint-Jacques 50K</td><td>06/2025</td><td>52.8 km</td><td>1810 m</td><td>7:48:40</td><td>946/1665</td><td><span class="text-green text-bold">451</span></td></tr>
            <tr><td>Beaujol'trail 32</td><td>05/2025</td><td>32 km</td><td>1410 m</td><td>4:20:05</td><td>162/211</td><td><span class="text-yellow">426</span></td></tr>
            <tr><td>Veni Vici</td><td>11/2024</td><td>27.9 km</td><td>700 m</td><td>3:14:07</td><td>918/2054</td><td><span class="text-yellow">433</span></td></tr>
            <tr><td>ETC UTMB (Chamonix)</td><td>08/2024</td><td>15 km</td><td>1200 m</td><td>3:09:30</td><td>636/1182</td><td><span class="text-orange">380</span></td></tr>
            <tr><td>Bel'Montaise 15</td><td>07/2024</td><td>15 km</td><td>600 m</td><td>1:34:00</td><td>81/138</td><td><span class="text-green text-bold">451</span></td></tr>
            <tr><td>Sanglier 15</td><td>03/2024</td><td>15 km</td><td>700 m</td><td>1:55:57</td><td>143/240</td><td><span class="text-yellow">419</span></td></tr>
            <tr><td>Veni Vici</td><td>11/2023</td><td>27.8 km</td><td>640 m</td><td>4:33:24</td><td>1880/1917</td><td><span class="text-red text-bold">305</span></td></tr>
            <tr><td>Saint-Jacques 20K</td><td>06/2023</td><td>18 km</td><td>600 m</td><td>2:36:21</td><td>634/772</td><td><span class="text-red">356</span></td></tr>
            <tr><td>Coursieres 25</td><td>05/2023</td><td>25 km</td><td>990 m</td><td>4:28:57</td><td>331/343</td><td><span class="text-red">339</span></td></tr>
            <tr><td>SainteLyon SaintExpress</td><td>11/2021</td><td>45.9 km</td><td>1000 m</td><td>7:29:00</td><td>2131/2405</td><td><span class="text-red">358</span></td></tr>
        </table>
    </div>

    <div class="card" style="margin-top: 20px;">
        <h2>Evolution Evaluation /10</h2>
        <div id="eval-history">
            <div style="text-align: center; padding: 20px; color: var(--text-muted);">Chargement...</div>
        </div>
    </div>
</div>

<!-- ======================================================================== -->
<!-- TAB 6 : ACTIVITES (Strava)                                               -->
<!-- ======================================================================== -->
<div id="activities" class="tab-content">

    <!-- Summary bar -->
    <div id="activities-summary" style="display: none; margin-bottom: 20px;">
        <div class="grid grid-4" style="gap: 12px;">
            <div class="card" style="text-align: center; padding: 16px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 6px;"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                <div class="stat-big text-green" id="sum-runs" style="font-size: 28px;">0</div>
                <div class="stat-label">Courses</div>
            </div>
            <div class="card" style="text-align: center; padding: 16px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--accent-light)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 6px;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                <div class="stat-big text-blue" id="sum-distance" style="font-size: 28px;">0</div>
                <div class="stat-label">km total</div>
            </div>
            <div class="card" style="text-align: center; padding: 16px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 6px;"><path d="M8 3l4 8 5-5 5 15H2L8 3z"/></svg>
                <div class="stat-big text-orange" id="sum-elevation" style="font-size: 28px;">0</div>
                <div class="stat-label">D+ total</div>
            </div>
            <div class="card" style="text-align: center; padding: 16px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--purple)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 6px;"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
                <div class="stat-big text-purple" id="sum-time" style="font-size: 28px;">0h</div>
                <div class="stat-label">Temps total</div>
            </div>
        </div>
    </div>

    <div id="activities-list">
        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <div style="font-size: 14px;">Chargement des activites...</div>
        </div>
    </div>
</div>

</div><!-- /athlete-yohann -->

<!-- ===== ATHLETE: JULIETTE ===== -->
<div id="athlete-juliette" class="athlete-content">

<!-- ======================================================================== -->
<!-- J-TAB 1 : VUE D'ENSEMBLE                                                -->
<!-- ======================================================================== -->
<div id="j-overview" class="tab-content active">

    <!-- KPI cards -->
    <div class="grid grid-4" style="margin-bottom: 24px;">
        <div class="card" style="text-align: center;">
            <div class="stat-big text-blue">555</div>
            <div class="stat-label">UTMB Index Pic</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;">20K: 553 · 50K: 510 · 100K: 506 · 100M: 555</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big text-green" id="j-kpi-vo2max">50</div>
            <div class="stat-label">VO2max (ml/kg/min)</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="j-kpi-vo2max-sub">Garmin</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big text-green" id="j-kpi-week-km">--</div>
            <div class="stat-label">Km cette semaine</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="j-kpi-week-km-sub">Chargement...</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big text-orange" id="j-kpi-week-elev">--</div>
            <div class="stat-label">D+ cette semaine</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="j-kpi-week-elev-sub">Chargement...</div>
        </div>
    </div>

    <!-- Profil + Evaluation -->
    <div class="grid grid-2-1">
        <div class="card">
            <h2>Profil athlete</h2>
            <div class="stat-row"><span class="label">Age</span><span class="value">41 ans</span></div>
            <div class="stat-row"><span class="label">Taille / Poids</span><span class="value">164 cm / 58 kg</span></div>
            <div class="stat-row"><span class="label">FC repos</span><span class="value">48 bpm</span></div>
            <div class="stat-row"><span class="label">FC max</span><span class="value">187 bpm</span></div>
            <div class="stat-row"><span class="label">Reserve cardiaque</span><span class="value">139 bpm</span></div>
            <div class="stat-row"><span class="label">VO2max (Garmin)</span><span class="value">50 ml/kg/min</span></div>
            <div class="stat-row"><span class="label">VMA estimee</span><span class="value">~14.5 km/h</span></div>
            <div class="stat-row"><span class="label">Running Stones</span><span class="value">5</span></div>
            <div class="stat-row"><span class="label">Courses depuis 2019</span><span class="value">25+</span></div>
            <div class="stat-row"><span class="label">Plus longue course</span><span class="value">106 km (Maxi-Race)</span></div>
            <div class="stat-row"><span class="label">Montre</span><span class="value">Garmin Fenix 7</span></div>
        </div>

        <div class="card">
            <h2>Evaluation /10</h2>
            <div id="j-eval-scores">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">Chargement...</div>
            </div>
            <div id="j-eval-global" style="margin-top: 16px; padding-top: 12px; border-top: 2px solid var(--border); text-align: center;">
                <div class="stat-big" id="j-eval-global-value" style="color: var(--text-muted);">&mdash;<span style="font-size: 16px; color: var(--text-muted);">/10</span></div>
                <div class="stat-label">Note globale</div>
            </div>
        </div>
    </div>

    <!-- Zones FC -->
    <div class="card" style="margin-top: 4px;">
        <h2>Zones de frequence cardiaque</h2>
        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">Methode Karvonen · FC repos 48 · FC max 187 · RFC 139 bpm</p>
        <div class="zone-bar">
            <div class="zone-1" style="width:20%;">Z1 118-131</div>
            <div class="zone-2" style="width:20%;">Z2 131-145</div>
            <div class="zone-3" style="width:20%;">Z3 145-159</div>
            <div class="zone-4" style="width:20%;">Z4 159-173</div>
            <div class="zone-5" style="width:20%;">Z5 173-187</div>
        </div>
    </div>

</div>

<!-- ======================================================================== -->
<!-- J-TAB 2 : PROGRAMME                                                      -->
<!-- ======================================================================== -->
<div id="j-week" class="tab-content">

    <!-- Sous-onglets -->
    <div class="sub-tabs">
        <button class="sub-tab active" data-subtab="upcoming">A venir</button>
        <button class="sub-tab" data-subtab="past">Pass&#233;s</button>
    </div>

    <!-- SUB-TAB : A venir -->
    <div id="j-week-upcoming" class="sub-content active">

    <!-- AUJOURD'HUI (dynamique) -->
    <div id="j-today-container"></div>

    <!-- W07 -->
    <div class="card" style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2 style="margin: 0;">Semaine W07 — 10 au 16 fevrier 2026</h2>
            <span class="badge badge-green">BUILD 1 — CONSTRUCTION BASE</span>
        </div>

        <div class="note-box">
            <strong>Objectif :</strong> Volume en endurance fondamentale. Renforcement quadriceps. Surveiller genou.<br>
            <strong>Volume cible :</strong> 60-70 km / 6-7h.
        </div>

        <div class="week-day" data-date="2026-02-10" data-checks="Renfo quadriceps">
            <div class="day-header">
                <span class="day-name">Lundi 10</span>
                <span class="badge badge-green">Footing EF</span>
            </div>
            <div class="day-details">
                <strong>Footing</strong> 1h00 <span class="text-blue">Z1-Z2 (118-145 bpm)</span><br>
                Plat, reveil musculaire. Renfo quadriceps apres.
            </div>
            <div class="day-match"></div>
            <div class="day-checks"></div>
        </div>

        <div class="week-day" data-date="2026-02-11" data-checks="PPG quadriceps,Etirements">
            <div class="day-header">
                <span class="day-name">Mardi 11</span>
                <span class="badge badge-green">Footing + PPG</span>
            </div>
            <div class="day-details">
                <strong>Footing</strong> 1h15 <span class="text-blue">Z1-Z2 (118-145 bpm)</span> + <strong>PPG quadriceps</strong> 30 min<br>
                Squats, chaise, fentes. Etirements ischio apres.
            </div>
            <div class="day-match"></div>
            <div class="day-checks"></div>
        </div>

        <div class="week-day" data-date="2026-02-12">
            <div class="day-header">
                <span class="day-name">Mercredi 12</span>
                <span class="badge" style="background: #333; color: #999;">Repos</span>
            </div>
            <div class="day-details">
                <strong>Repos complet</strong>. Etirements + glace genou si besoin.
            </div>
            <div class="day-match"></div>
            <div class="day-checks"></div>
        </div>

        <div class="week-day" data-date="2026-02-13" data-checks="Renfo quadriceps">
            <div class="day-header">
                <span class="day-name">Jeudi 13</span>
                <span class="badge badge-green">Footing vallonne</span>
            </div>
            <div class="day-details">
                <strong>Footing vallonne</strong> 1h20 <span class="text-green">Z2 (131-145 bpm)</span><br>
                Intro D+ modere. Surveiller genou en descente.
            </div>
            <div class="day-match"></div>
            <div class="day-checks"></div>
        </div>

        <div class="week-day" data-date="2026-02-14">
            <div class="day-header">
                <span class="day-name">Vendredi 14</span>
                <span class="badge badge-purple">Natation</span>
            </div>
            <div class="day-details">
                <strong>Natation</strong> 45 min <span class="text-blue">Z1-Z2</span><br>
                Recup active. Crawl principal.
            </div>
            <div class="day-match"></div>
            <div class="day-checks"></div>
        </div>

        <div class="week-day" data-date="2026-02-15" data-checks="Renfo quadriceps,Glace genou">
            <div class="day-header">
                <span class="day-name">Samedi 15</span>
                <span class="badge badge-orange">Sortie longue</span>
            </div>
            <div class="day-details">
                <strong>Sortie longue</strong> 2h30-3h00 <span class="text-blue">Z1-Z2 (118-145 bpm)</span><br>
                Terrain trail, D+ progressif. Genouillere si descente technique. Glace apres.
            </div>
            <div class="day-match"></div>
            <div class="day-checks"></div>
        </div>

        <div class="week-day" data-date="2026-02-16">
            <div class="day-header">
                <span class="day-name">Dimanche 16</span>
                <span class="badge badge-green">Footing recup</span>
            </div>
            <div class="day-details">
                <strong>Footing recup</strong> 45 min <span class="text-blue">Z1 (118-131 bpm)</span><br>
                Si genou OK. Sinon <strong>repos complet</strong>.
            </div>
            <div class="day-match"></div>
            <div class="day-checks"></div>
        </div>

        <!-- Volume resume -->
        <div style="margin-top: 16px; padding: 12px; background: var(--bg-card-alt); border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; font-size: 13px;">
                <span class="text-muted">Volume total cible</span>
                <span class="text-bold">60-70 km / 6-7h</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 13px; margin-top: 4px;">
                <span class="text-muted">Seances</span>
                <span class="text-bold">5-6 (4-5 footing, 1 natation, 2 PPG)</span>
            </div>
        </div>
    </div>

    </div><!-- /j-week-upcoming -->

    <!-- SUB-TAB : Passes -->
    <div id="j-week-past" class="sub-content">
        <h3 style="font-size: 15px; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Historique recent</h3>
        <div style="text-align: center; padding: 20px; color: var(--text-muted);">Pas encore d'historique</div>
    </div><!-- /j-week-past -->

</div>

<!-- ======================================================================== -->
<!-- J-TAB 3 : BLESSURE                                                       -->
<!-- ======================================================================== -->
<div id="j-injury" class="tab-content">

    <div class="grid grid-2">
        <div class="card">
            <div class="injury-status injury-healing">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 700; font-size: 16px;">Genou droit — Fissure meniscale</div>
                        <div style="font-size: 13px; color: var(--text-muted);">IRM confirmee · Gestion chronique</div>
                    </div>
                    <span class="badge badge-yellow">GESTION</span>
                </div>
            </div>

            <h3>Bilan</h3>
            <div class="stat-row"><span class="label">Douleur moyenne</span><span class="value text-yellow">2-3/10</span></div>
            <div class="stat-row"><span class="label">Douleur en descente</span><span class="value text-orange">3-5/10</span></div>
            <div class="stat-row"><span class="label">Gonflement</span><span class="value text-green">Non</span></div>
            <div class="stat-row"><span class="label">Marche</span><span class="value text-green">OK</span></div>
            <div class="stat-row"><span class="label">Course plat</span><span class="value text-green">OK</span></div>
            <div class="stat-row"><span class="label">Descente technique</span><span class="value text-yellow">Avec precaution</span></div>

            <h3>Observation</h3>
            <div class="note-box">
                Fissure meniscale non operee. Gestion par renforcement musculaire, adaptation de la charge et genouillere en descente technique. Surveillance permanente. Pas de contre-indication a l'ultra si gestion adequat.
            </div>
        </div>

        <div class="card">
            <h2>Protocole de gestion</h2>
            <table>
                <tr><th>Action</th><th>Frequence</th></tr>
                <tr><td>Renforcement quadriceps (chaise, squats)</td><td>3x / semaine</td></tr>
                <tr><td>Etirements ischio-jambiers</td><td>Quotidien</td></tr>
                <tr><td>Genouillere en descente technique</td><td>Chaque sortie D-</td></tr>
                <tr><td>Glace apres longue sortie</td><td>Systematique</td></tr>
                <tr><td>Stopper si douleur > 4/10</td><td>Regle absolue</td></tr>
            </table>

            <h3>Evolution genou (14 derniers jours)</h3>
            <div class="mini-chart" id="j-chart-genou" style="height: 80px;"></div>
            <div class="mini-chart-labels" id="j-chart-genou-labels"></div>

            <h3>Journal de suivi</h3>
            <div id="j-injury-journal">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">Chargement...</div>
            </div>
        </div>
    </div>

    <!-- Historique blessures -->
    <div class="card" style="margin-top: 20px;">
        <h2>Historique des blessures</h2>
        <table>
            <tr><th>#</th><th>Localisation</th><th>Gravite</th><th>Resolution</th></tr>
            <tr><td>1</td><td>Tendon d'Achille gauche</td><td>Modere</td><td class="text-green">Resolu</td></tr>
            <tr><td>2</td><td>Entorse cheville droite</td><td>Leger</td><td class="text-green">Resolu</td></tr>
            <tr><td class="text-bold">3</td><td class="text-bold">Genou droit (menisque)</td><td class="text-bold">Chronique</td><td class="text-yellow text-bold">En gestion</td></tr>
        </table>
    </div>
</div>

<!-- ======================================================================== -->
<!-- J-TAB 4 : SANTE                                                          -->
<!-- ======================================================================== -->
<div id="j-health" class="tab-content">

    <div class="grid grid-4" style="margin-bottom: 24px;" id="j-health-kpi">
        <div class="card" style="text-align: center;">
            <div class="stat-big" id="j-health-last-night" style="color: var(--text-muted);">--</div>
            <div class="stat-label">Derniere nuit</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="j-health-last-night-score">--</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big" id="j-health-body-battery" style="color: var(--text-muted);">--</div>
            <div class="stat-label">Body Battery</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="j-health-bb-detail">--</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big" id="j-health-sleep-avg" style="color: var(--text-muted);">--</div>
            <div class="stat-label">Sommeil moyen /nuit</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;" id="j-health-sleep-avg-sub">Objectif : 7h30</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="stat-big text-green">58<span style="font-size:18px; color: var(--text-muted);">kg</span></div>
            <div class="stat-label">Poids</div>
            <div style="font-size:12px; color: var(--text-muted); margin-top:4px;">164 cm · IMC 21.6</div>
        </div>
    </div>

    <div class="grid grid-2">
        <div class="card">
            <h2>Sommeil</h2>
            <div id="j-health-sleep-detail">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">Pas encore de donnees Garmin</div>
            </div>
        </div>
        <div class="card">
            <h2>Variabilite cardiaque & Stress</h2>
            <div id="j-health-hrv-stress">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">Pas encore de donnees Garmin</div>
            </div>
        </div>
    </div>

    <div class="section-title">Tendances <span>14 jours</span></div>
    <div class="grid grid-3">
        <div class="card">
            <h2>FC repos (bpm)</h2>
            <div class="mini-chart" id="j-chart-rhr"></div>
            <div class="mini-chart-labels" id="j-chart-rhr-labels"></div>
        </div>
        <div class="card">
            <h2>VFC — Moyenne nocturne (ms)</h2>
            <div class="mini-chart" id="j-chart-hrv"></div>
            <div class="mini-chart-labels" id="j-chart-hrv-labels"></div>
        </div>
        <div class="card">
            <h2>Pas quotidiens</h2>
            <div class="mini-chart" id="j-chart-steps"></div>
            <div class="mini-chart-labels" id="j-chart-steps-labels"></div>
        </div>
    </div>
    <div class="grid grid-2">
        <div class="card">
            <h2>Body Battery — 14 jours</h2>
            <div class="mini-chart" id="j-chart-bb"></div>
            <div class="mini-chart-labels" id="j-chart-bb-labels"></div>
            <div id="j-chart-bb-summary" style="margin-top: 12px;"></div>
        </div>
        <div class="card">
            <h2>Sommeil — 14 jours</h2>
            <div class="mini-chart" id="j-chart-sleep"></div>
            <div class="mini-chart-labels" id="j-chart-sleep-labels"></div>
            <div id="j-chart-sleep-summary" style="margin-top: 12px;"></div>
        </div>
    </div>
</div>

<!-- ======================================================================== -->
<!-- J-TAB 5 : CALENDRIER                                                     -->
<!-- ======================================================================== -->
<div id="j-calendar" class="tab-content">

    <div class="grid grid-1-2">
        <div class="card">
            <h2>Courses 2026</h2>
            <div class="race-timeline">
                <div class="race-item race-b">
                    <div class="race-date">25 avril — <span class="badge badge-orange">OBJECTIF B</span></div>
                    <div class="race-name">UTMB Mont Ventoux GRV 100K</div>
                    <div class="race-details">100 km · 4200 D+ · Test endurance ultra</div>
                </div>
                <div class="race-item race-b">
                    <div class="race-date">23 mai — <span class="badge badge-orange">OBJECTIF B</span></div>
                    <div class="race-name">Maxi-Race (Annecy)</div>
                    <div class="race-details">88 km · 5300 D+ · Gestion effort + nutrition</div>
                </div>
                <div class="race-item race-c">
                    <div class="race-date">4 juillet — <span class="badge badge-yellow">OBJECTIF C</span></div>
                    <div class="race-name">Trail des Pierres Dorees</div>
                    <div class="race-details">30 km · 1200 D+ · Entretien</div>
                </div>
                <div class="race-item race-a">
                    <div class="race-date">20 septembre — <span class="badge badge-red">OBJECTIF A</span></div>
                    <div class="race-name" style="font-size: 18px;">Grand to Grand Ultra</div>
                    <div class="race-details">275 km · 6 etapes · Course a etapes autosuffisante</div>
                    <div style="font-size: 12px; color: var(--accent-light); margin-top: 2px;">Grand Canyon, Arizona, USA</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Periodisation macro</h2>
            <table>
                <tr><th>Bloc</th><th>Periode</th><th>Focus</th><th>Courses</th></tr>
                <tr>
                    <td><span class="badge badge-green">BUILD 1</span></td>
                    <td>Fev-Mars (actuel)</td>
                    <td>Construction base. Volume progressif. PPG.</td>
                    <td class="text-muted">—</td>
                </tr>
                <tr>
                    <td><span class="badge badge-yellow">BUILD 2</span></td>
                    <td>Avril</td>
                    <td>Volume + D+. Sortie longue 5-7h.</td>
                    <td>GRV 100K (B)</td>
                </tr>
                <tr>
                    <td><span class="badge badge-orange">BUILD 3</span></td>
                    <td>Mai</td>
                    <td>Endurance ultra. Gestion effort long. Nutrition.</td>
                    <td>Maxi-Race (B)</td>
                </tr>
                <tr>
                    <td><span class="badge badge-red">SPECIFIQUE</span></td>
                    <td>Juin-Juillet</td>
                    <td>Specifique multi-etapes. Back-to-back. Autosuffisance.</td>
                    <td>Pierres Dorees (C)</td>
                </tr>
                <tr>
                    <td><span class="badge badge-purple">PIC</span></td>
                    <td>Aout</td>
                    <td>Volume pic. Simulation conditions G2G.</td>
                    <td>—</td>
                </tr>
                <tr>
                    <td><span class="badge" style="background:#333; color:#fff;">AFFUT</span></td>
                    <td>Sept</td>
                    <td>Tapering 10-14j. Logistique G2G.</td>
                    <td><strong>G2G Ultra (A)</strong></td>
                </tr>
            </table>

            <h3>Gap G2G — Le defi cle</h3>
            <table>
                <tr><th>Indicateur</th><th>Actuel</th><th>Requis G2G</th><th>Gap</th></tr>
                <tr><td>Plus longue course</td><td>106 km</td><td class="text-red text-bold">275 km (6 etapes)</td><td class="text-red">Format multi-jours</td></tr>
                <tr><td>Endurance continue</td><td>~18h max</td><td class="text-red text-bold">6-8h / jour x 6</td><td class="text-orange">Back-to-back</td></tr>
                <tr><td>Autosuffisance</td><td>Non teste</td><td class="text-red text-bold">Obligatoire</td><td class="text-red">A planifier</td></tr>
                <tr><td>Chaleur</td><td>Tempere</td><td class="text-orange text-bold">Desert 40°C+</td><td class="text-orange">Acclimatation</td></tr>
            </table>
        </div>
    </div>
</div>

<!-- ======================================================================== -->
<!-- J-TAB 6 : PROGRESSION                                                    -->
<!-- ======================================================================== -->
<div id="j-progress" class="tab-content">

    <div class="card">
        <h2>Progression UTMB Index</h2>
        <div style="display: flex; gap: 40px; align-items: center; margin-bottom: 16px; flex-wrap: wrap;">
            <div style="text-align: center;">
                <div class="stat-big text-yellow">452</div>
                <div class="stat-label">2020</div>
            </div>
            <div style="font-size: 32px; color: var(--text-muted);">&rarr;</div>
            <div style="text-align: center;">
                <div class="stat-big text-green">555</div>
                <div class="stat-label">2024</div>
            </div>
            <div style="font-size: 14px; color: var(--green); font-weight: 700;">+103 points en 4 ans</div>
        </div>

        <!-- Graphique CSS -->
        <div style="display: flex; align-items: flex-end; gap: 4px; height: 120px; margin: 20px 0; padding: 0 4px;">
            <div style="flex:1; background: var(--yellow); border-radius: 4px 4px 0 0; height: 52%;" title="452 - Ventoux 2021"></div>
            <div style="flex:1; background: var(--green); border-radius: 4px 4px 0 0; height: 76%;" title="530 - CCC 2021"></div>
            <div style="flex:1; background: var(--green); border-radius: 4px 4px 0 0; height: 66%;" title="520 - UTCA 2021"></div>
            <div style="flex:1; background: var(--yellow); border-radius: 4px 4px 0 0; height: 45%;" title="470 - EcoTrail 2022"></div>
            <div style="flex:1; background: var(--yellow); border-radius: 4px 4px 0 0; height: 60%;" title="485 - Coursiers 2022"></div>
            <div style="flex:1; background: var(--yellow); border-radius: 4px 4px 0 0; height: 56%;" title="498 - SainteLyon 2022"></div>
            <div style="flex:1; background: var(--green); border-radius: 4px 4px 0 0; height: 98%;" title="553 - TMB Mara 2023"></div>
            <div style="flex:1; background: var(--green); border-radius: 4px 4px 0 0; height: 64%;" title="510 - TDS 2023"></div>
            <div style="flex:1; background: var(--green); border-radius: 4px 4px 0 0; height: 100%;" title="555 - MaxiRace 2024"></div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); padding: 0 4px;">
            <span>Jun 21</span><span>Aou 21</span><span>Fev 21</span><span>Mar 22</span><span>Mai 22</span><span>Nov 22</span><span>Jun 23</span><span>Aou 23</span><span>Jun 24</span>
        </div>

        <table style="margin-top: 20px;">
            <tr><th>Course</th><th>Date</th><th>Distance</th><th>D+</th><th>Temps</th><th>UTMB Index</th></tr>
            <tr><td class="text-bold">Maxi-Race</td><td>06/2024</td><td>106 km</td><td>5300 m</td><td>18:42:00</td><td><span class="text-green text-bold">555</span></td></tr>
            <tr><td>UTMB TDS</td><td>08/2023</td><td>145 km</td><td>9100 m</td><td>38:20:00</td><td><span class="text-green">510</span></td></tr>
            <tr><td>Trail du Mont-Blanc Marathon</td><td>06/2023</td><td>42 km</td><td>2750 m</td><td>7:15:30</td><td><span class="text-green">553</span></td></tr>
            <tr><td>SainteLyon</td><td>11/2022</td><td>78 km</td><td>2000 m</td><td>11:45:00</td><td><span class="text-yellow">498</span></td></tr>
            <tr><td>Trail des Coursiers</td><td>05/2022</td><td>50 km</td><td>2800 m</td><td>9:30:00</td><td><span class="text-yellow">485</span></td></tr>
            <tr><td>Eco-Trail Paris</td><td>03/2022</td><td>80 km</td><td>1500 m</td><td>10:12:00</td><td><span class="text-yellow">470</span></td></tr>
            <tr><td>CCC (UTMB Week)</td><td>08/2021</td><td>101 km</td><td>6100 m</td><td>24:30:00</td><td><span class="text-green">530</span></td></tr>
            <tr><td>Ultra-Trail Cote d'Azur</td><td>02/2021</td><td>110 km</td><td>4800 m</td><td>20:15:00</td><td><span class="text-green">520</span></td></tr>
            <tr><td>Trail du Ventoux</td><td>06/2021</td><td>46 km</td><td>2600 m</td><td>8:50:00</td><td><span class="text-yellow">452</span></td></tr>
        </table>
    </div>

    <div class="card" style="margin-top: 20px;">
        <h2>Evolution Evaluation /10</h2>
        <div id="j-eval-history">
            <div style="text-align: center; padding: 20px; color: var(--text-muted);">Chargement...</div>
        </div>
    </div>
</div>

<!-- ======================================================================== -->
<!-- J-TAB 7 : ACTIVITES                                                      -->
<!-- ======================================================================== -->
<div id="j-activities" class="tab-content">

    <div id="j-activities-summary" style="display: none; margin-bottom: 20px;">
        <div class="grid grid-4" style="gap: 12px;">
            <div class="card" style="text-align: center; padding: 16px;">
                <div class="stat-big text-green" id="j-sum-runs" style="font-size: 28px;">0</div>
                <div class="stat-label">Courses</div>
            </div>
            <div class="card" style="text-align: center; padding: 16px;">
                <div class="stat-big text-blue" id="j-sum-distance" style="font-size: 28px;">0</div>
                <div class="stat-label">km total</div>
            </div>
            <div class="card" style="text-align: center; padding: 16px;">
                <div class="stat-big text-orange" id="j-sum-elevation" style="font-size: 28px;">0</div>
                <div class="stat-label">D+ total</div>
            </div>
            <div class="card" style="text-align: center; padding: 16px;">
                <div class="stat-big text-purple" id="j-sum-time" style="font-size: 28px;">0h</div>
                <div class="stat-label">Temps total</div>
            </div>
        </div>
    </div>

    <div id="j-activities-list">
        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <div style="font-size: 14px;">Pas encore de donnees Strava/Garmin</div>
        </div>
    </div>
</div>

</div><!-- /athlete-juliette -->

<!-- ===== FOOTER ===== -->
<footer id="footer-text">
    Coach Trail — Yohann Tschudi & Juliette Sailland<br>
    Donnees : Garmin Connect · UTMB World · BeTrail · Strava<br>
    Suivi versionne avec Git · Derniere mise a jour : 8 fevrier 2026
</footer>

<!-- ===== JAVASCRIPT ===== -->
<script>
// ===== MULTI-ATHLETE CONFIG =====
var ATHLETES = {
    yohann: {
        name: 'Yohann Tschudi',
        objective: 'Objectif : OCC (UTMB Week) — 27 aout 2026 — 57 km / 3500 D+',
        targetDate: '2026-08-27',
        targetLabel: 'OCC',
        shortLabel: 'OCC 57km',
        prefix: '',
        dataDir: 'data/',
        block: 'Bloc 0 — Reprise & Soin',
        weekSubId: 'week',
        injuryKey: 'soleaire'
    },
    juliette: {
        name: 'Juliette Sailland',
        objective: 'Objectif : Grand to Grand Ultra — 20 sept 2026 — 275 km / 6 etapes',
        targetDate: '2026-09-20',
        targetLabel: 'G2G',
        shortLabel: 'G2G 275km',
        prefix: 'j-',
        dataDir: 'data/juliette/',
        block: 'Build 1 — Construction base',
        weekSubId: 'j-week',
        injuryKey: 'genou'
    }
};
var currentAthlete = localStorage.getItem('currentAthlete') || 'yohann';

function updateHeaderDetails() {
    Object.keys(ATHLETES).forEach(function(key) {
        var c = ATHLETES[key];
        var el = document.getElementById('header-detail-' + key);
        if (!el) return;
        var daysLeft = Math.ceil((new Date(c.targetDate) - new Date()) / (1000 * 60 * 60 * 24));
        el.textContent = c.shortLabel + ' \u2014 J-' + daysLeft;
    });
}
var _coachLogByAthlete = {};
var _loadedAthletes = {};

// ===== ATHLETE SWITCHING =====
document.querySelectorAll('.athlete-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var athlete = btn.dataset.athlete;
        if (athlete === currentAthlete) return;
        currentAthlete = athlete;
        localStorage.setItem('currentAthlete', athlete);

        // Toggle active buttons
        document.querySelectorAll('.athlete-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');

        // Toggle active wrappers
        document.querySelectorAll('.athlete-content').forEach(function(c) { c.classList.remove('active'); });
        document.getElementById('athlete-' + athlete).classList.add('active');

        // Update header detail for this athlete
        var cfg = ATHLETES[athlete];
        updateHeaderDetails();

        // Activate first tab in the new wrapper
        var container = document.getElementById('athlete-' + athlete);
        container.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
        var firstTab = container.querySelector('.tab-content');
        if (firstTab) firstTab.classList.add('active');

        // Reset tab-bar to first tab
        document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
        document.querySelector('.tab-btn').classList.add('active');

        // Load data if not already done
        if (!_loadedAthletes[athlete]) {
            loadAthleteData(athlete);
            _loadedAthletes[athlete] = true;
        }
    });
});

// ===== TAB NAVIGATION (scoped to active athlete) =====
document.querySelectorAll('.tab-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');

        var prefix = ATHLETES[currentAthlete].prefix;
        var container = document.getElementById('athlete-' + currentAthlete);
        container.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
        var target = container.querySelector('#' + prefix + btn.dataset.tab);
        if (target) target.classList.add('active');
        history.replaceState(null, null, '#' + btn.dataset.tab);
    });
});

// Handle URL hash on load
var hash = location.hash.slice(1);
if (hash) {
    var hashBtn = document.querySelector('[data-tab="' + hash + '"]');
    if (hashBtn) hashBtn.click();
}

// ===== SUB-TAB NAVIGATION (scoped) =====
document.querySelectorAll('.sub-tab').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var parent = btn.closest('.tab-content');
        parent.querySelectorAll('.sub-tab').forEach(function(b) { b.classList.remove('active'); });
        parent.querySelectorAll('.sub-content').forEach(function(c) { c.classList.remove('active'); });
        btn.classList.add('active');
        // Find the sub-content by id — use parent's id to determine prefix
        var parentId = parent.id;
        var subId = parentId + '-' + btn.dataset.subtab;
        var subContent = parent.querySelector('#' + subId);
        if (subContent) subContent.classList.add('active');
    });
});

// ===== SVG ICONS =====
const SVG = {
    run: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="2"/><path d="M7 21l3-7 2.5 2 4.5-6"/><path d="M10 14l-2 3"/><path d="M17 8l-4.5 6"/></svg>',
    trail: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3l4 8 5-5 5 15H2L8 3z"/><circle cx="17" cy="5" r="2"/></svg>',
    swim: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18c2-1 4 1 6 0s4-1 6 0 4 1 6 0"/><path d="M2 14c2-1 4 1 6 0s4-1 6 0 4 1 6 0"/><circle cx="8" cy="6" r="2"/><path d="M10 6l4 4-3 3"/></svg>',
    elliptical: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="12" rx="8" ry="5"/><circle cx="12" cy="12" r="2"/><line x1="12" y1="2" x2="12" y2="7"/><line x1="12" y1="17" x2="12" y2="22"/></svg>',
    walk: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="2"/><path d="M10 21l1-7 3 3 3-8"/><path d="M11 14l-3 7"/></svg>',
    workout: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 5v14"/><path d="M18 5v14"/><path d="M6 12h12"/><rect x="3" y="7" width="2" height="10" rx="1"/><rect x="19" y="7" width="2" height="10" rx="1"/></svg>',
    default: '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
    distance: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6l-6 6-6-6"/><path d="M18 18l-6-6-6 6"/></svg>',
    elevation: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3l4 8 5-5 5 15H2L8 3z"/></svg>',
    clock: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
    heart: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>',
    pace: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
};

const TYPES = {
    'TrailRun':       { icon: 'trail',   iconClass: 'trail',      label: 'TRAIL',        color: 'var(--orange)' },
    'Run':            { icon: 'run',     iconClass: 'run',        label: 'COURSE',       color: 'var(--green)' },
    'Treadmill':      { icon: 'run',     iconClass: 'elliptical', label: 'TAPIS',        color: 'var(--purple)' },
    'Walk':           { icon: 'walk',    iconClass: 'walk',       label: 'MARCHE',       color: 'var(--yellow)' },
    'Hike':           { icon: 'walk',    iconClass: 'walk',       label: 'RANDO',        color: 'var(--yellow)' },
    'Swim':           { icon: 'swim',    iconClass: 'swim',       label: 'NATATION',     color: 'var(--cyan)' },
    'Elliptical':     { icon: 'elliptical', iconClass: 'elliptical', label: 'ELLIPTIQUE', color: 'var(--purple)' },
    'WeightTraining': { icon: 'workout', iconClass: 'workout',    label: 'MUSCU',        color: 'var(--orange)' },
    'Workout':        { icon: 'workout', iconClass: 'workout',    label: 'PPG',          color: 'var(--orange)' },
    'HighIntensityIntervalTraining': { icon: 'workout', iconClass: 'workout', label: 'HIIT', color: 'var(--red)' },
};

// Garmin typeKey → unified type
const GARMIN_TYPE_MAP = {
    'running':            'Run',
    'trail_running':      'TrailRun',
    'treadmill_running':  'Treadmill',
    'walking':            'Walk',
    'hiking':             'Hike',
    'swimming':           'Swim',
    'lap_swimming':       'Swim',
    'open_water_swimming':'Swim',
    'elliptical':         'Elliptical',
    'strength_training':  'WeightTraining',
    'cardio':             'Workout',
    'yoga':               'Workout',
    'other':              'Workout',
};

function detectType(act) {
    const st = act.sport_type || act.type;
    // Treadmill detection: Run with D+=0, or named "My Workout"/"Manual Workout"
    if (st === 'Run') {
        const name = (act.name || '').toLowerCase();
        const isTreadmill = act.total_elevation_gain === 0
            || name.includes('workout')
            || name.includes('tapis')
            || name.includes('treadmill');
        if (isTreadmill) return 'Treadmill';
    }
    return st;
}

function fmtSwimPace(distance, movingTime) {
    if (!distance || distance === 0) return '-';
    const secPer100 = movingTime / (distance / 100);
    const min = Math.floor(secPer100 / 60);
    const sec = Math.round(secPer100 % 60);
    return min + ':' + String(sec).padStart(2, '0') + '/100m';
}

// FC zones for coloring
const FC_ZONES = [
    { max: 112, label: 'Repos',  bg: '#1e3a5f', color: '#60a5fa' },
    { max: 125, label: 'Z1',     bg: '#1e3a5f', color: '#3b82f6' },
    { max: 138, label: 'Z2',     bg: '#0a2e1a', color: '#22c55e' },
    { max: 152, label: 'Z3',     bg: '#2d2206', color: '#eab308' },
    { max: 165, label: 'Z4',     bg: '#3d1c08', color: '#f97316' },
    { max: 999, label: 'Z5',     bg: '#3d0a0a', color: '#ef4444' },
];

function getZone(hr) {
    if (!hr) return null;
    return FC_ZONES.find(z => hr <= z.max);
}

function fmt(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    return h > 0 ? h + 'h' + String(m).padStart(2, '0') : m + 'min';
}

function fmtPace(mps) {
    if (!mps || mps === 0) return '-';
    const spk = 1000 / mps;
    return Math.floor(spk / 60) + ':' + String(Math.round(spk % 60)).padStart(2, '0') + '/km';
}

function fmtDate(s) {
    const d = new Date(s);
    return d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
}

function fmtDateShort(s) {
    const d = new Date(s);
    return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
}

function loadActivities(athlete) {
    athlete = athlete || 'yohann';
    var cfg = ATHLETES[athlete];
    var p = cfg.prefix;
    const _nc = '?t=' + Date.now();
    const stravaP = fetch(cfg.dataDir + 'strava-activities.json' + _nc).then(r => r.ok ? r.json() : []).catch(() => []);
    const garminP = fetch(cfg.dataDir + 'garmin-activities.json' + _nc).then(r => r.ok ? r.json() : []).catch(() => []);

    Promise.all([stravaP, garminP]).then(([stravaActs, garminActs]) => {
        // Normalize Garmin activities to match Strava format
        const garminNorm = (garminActs || []).map(ga => {
            const unified = GARMIN_TYPE_MAP[ga.type] || 'Workout';
            return {
                name: ga.name,
                type: unified,
                sport_type: unified,
                start_date_local: ga.start_date_local,
                distance: ga.distance || 0,
                moving_time: ga.moving_time || 0,
                elapsed_time: ga.elapsed_time || 0,
                total_elevation_gain: ga.total_elevation_gain || 0,
                average_speed: ga.average_speed || 0,
                average_heartrate: ga.average_heartrate,
                max_heartrate: ga.max_heartrate,
                source: 'garmin',
                _garmin_type: ga.type,
            };
        });

        // Merge Strava + Garmin: when both have the same activity (within 5min), combine best data
        const parseLocal = s => new Date(s.replace('Z', '').replace(' ', 'T'));
        const merged = [];
        const usedGarmin = new Set();

        (stravaActs || []).forEach(sa => {
            const sTime = parseLocal(sa.start_date_local).getTime();
            const match = garminNorm.find((ga, i) => {
                if (usedGarmin.has(i)) return false;
                return Math.abs(parseLocal(ga.start_date_local).getTime() - sTime) < 300000;
            });
            if (match) {
                usedGarmin.add(garminNorm.indexOf(match));
                // Strava wins: name, sport_type, kudos. Garmin fills gaps: HR, elevation
                merged.push({
                    ...sa,
                    source: 'strava+garmin',
                    average_heartrate: sa.average_heartrate || match.average_heartrate,
                    max_heartrate: sa.max_heartrate || match.max_heartrate,
                    total_elevation_gain: (sa.total_elevation_gain > 0 ? sa.total_elevation_gain : match.total_elevation_gain) || 0,
                    distance: sa.distance > 0 ? sa.distance : match.distance,
                    moving_time: sa.moving_time > 0 ? sa.moving_time : match.moving_time,
                    calories: sa.calories || match.calories,
                });
            } else {
                merged.push({...sa, source: 'strava'});
            }
        });

        // Add Garmin-only activities
        garminNorm.forEach((ga, i) => {
            if (!usedGarmin.has(i)) merged.push(ga);
        });

        const all = merged;
        all.sort((a, b) => new Date(b.start_date_local) - new Date(a.start_date_local));

        if (all.length === 0) {
            document.getElementById(p + 'activities-list').innerHTML =
                '<div style="text-align:center;padding:40px;color:var(--text-muted);">' +
                '<div style="font-size:14px;">Pas encore de donnees.</div></div>';
            return;
        }

        const list = document.getElementById(p + 'activities-list');
        const summary = document.getElementById(p + 'activities-summary');
        list.innerHTML = '';

        let totalRuns = 0, totalDist = 0, totalElev = 0, totalTime = 0;
        let currentDate = '';

        all.forEach(act => {
            const st = detectType(act);
            const t = TYPES[st] || { icon: 'default', iconClass: 'default', label: st.toUpperCase(), color: 'var(--accent-light)' };
            const dist = (act.distance / 1000).toFixed(1);
            const elev = Math.round(act.total_elevation_gain || 0);
            const isRun = st === 'Run' || st === 'TrailRun' || st === 'Treadmill';
            const isSwim = st === 'Swim';
            const zone = getZone(act.average_heartrate);
            const dateKey = fmtDate(act.start_date_local);

            if (isRun) totalRuns++;
            totalDist += act.distance / 1000;
            totalElev += act.total_elevation_gain || 0;
            totalTime += act.moving_time || 0;

            // Date separator
            if (dateKey !== currentDate) {
                currentDate = dateKey;
                list.innerHTML += '<div style="font-size:12px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; padding:16px 0 6px; border-bottom:1px solid var(--border); margin-bottom:8px;">' + dateKey + '</div>';
            }

            // Source badge
            const srcBadge = act.source === 'garmin' ? ' <span style="font-size:9px;color:var(--text-muted);font-weight:400;">GARMIN</span>'
                : act.source === 'strava+garmin' ? ' <span style="font-size:9px;color:var(--green);font-weight:400;">S+G</span>' : '';

            let stats = '';
            if (act.distance > 0) stats += '<div class="act-stat"><div class="act-stat-value">' + dist + '<span style="font-size:11px;font-weight:400;color:var(--text-muted);"> km</span></div><div class="act-stat-label">Distance</div></div>';
            if (elev > 0) stats += '<div class="act-stat"><div class="act-stat-value text-orange">' + elev + '<span style="font-size:11px;font-weight:400;color:var(--text-muted);"> m</span></div><div class="act-stat-label">D+</div></div>';
            stats += '<div class="act-stat"><div class="act-stat-value">' + fmt(act.moving_time) + '</div><div class="act-stat-label">Duree</div></div>';
            if (act.average_heartrate) {
                const zHtml = zone ? '<span class="act-zone" style="background:' + zone.bg + ';color:' + zone.color + ';">' + zone.label + '</span>' : '';
                stats += '<div class="act-stat"><div class="act-stat-value" style="color:' + (zone ? zone.color : 'var(--text)') + ';">' + Math.round(act.average_heartrate) + '<span style="font-size:11px;font-weight:400;"> bpm</span>' + zHtml + '</div><div class="act-stat-label">FC moy</div></div>';
            }
            if (isRun && act.average_speed) stats += '<div class="act-stat"><div class="act-stat-value">' + fmtPace(act.average_speed) + '</div><div class="act-stat-label">Allure</div></div>';
            if (isSwim && act.distance > 0) stats += '<div class="act-stat"><div class="act-stat-value text-cyan">' + fmtSwimPace(act.distance, act.moving_time) + '</div><div class="act-stat-label">Allure /100m</div></div>';

            list.innerHTML +=
                '<div class="activity-card">' +
                    '<div class="act-icon ' + t.iconClass + '">' + SVG[t.icon] + '</div>' +
                    '<div class="act-body">' +
                        '<div class="act-header">' +
                            '<div><span class="act-name">' + act.name + '</span></div>' +
                            '<div class="act-meta"><span class="act-type-label" style="color:' + t.color + ';">' + t.label + '</span>' + srcBadge + '</div>' +
                        '</div>' +
                        '<div class="act-stats">' + stats + '</div>' +
                    '</div>' +
                '</div>';
        });

        document.getElementById(p + 'sum-runs').textContent = totalRuns;
        document.getElementById(p + 'sum-distance').textContent = Math.round(totalDist);
        document.getElementById(p + 'sum-elevation').textContent = Math.round(totalElev);
        document.getElementById(p + 'sum-time').textContent = Math.round(totalTime / 3600) + 'h';
        summary.style.display = 'block';

        if (!p) {
            var stravaEl = document.getElementById('strava-status');
            if (stravaEl) { stravaEl.style.color = 'var(--green)'; stravaEl.textContent = 'Strava OK'; }
        }

        // ===== KPI VUE D'ENSEMBLE : Km + D+ semaine =====
        updateWeekKPIs(all, athlete);

        // ===== MATCHING SEMAINE vs ACTIVITES =====
        matchWeekActivities(all, athlete);
    });
}

function updateWeekKPIs(activities, athlete) {
    athlete = athlete || 'yohann';
    var p = ATHLETES[athlete].prefix;
    const now = new Date();
    const day = now.getDay();
    const diffToMonday = (day === 0 ? 6 : day - 1);
    const monday = new Date(now);
    monday.setDate(now.getDate() - diffToMonday);
    monday.setHours(0, 0, 0, 0);

    let weekKm = 0, weekElev = 0, weekCount = 0;
    activities.forEach(act => {
        const d = new Date(act.start_date_local.replace('Z', '').replace(' ', 'T'));
        if (d >= monday) {
            weekKm += (act.distance || 0) / 1000;
            weekElev += act.total_elevation_gain || 0;
            weekCount++;
        }
    });

    const kmEl = document.getElementById(p + 'kpi-week-km');
    const kmSub = document.getElementById(p + 'kpi-week-km-sub');
    if (kmEl) {
        kmEl.textContent = weekKm >= 10 ? Math.round(weekKm) : weekKm.toFixed(1);
        kmEl.style.color = weekKm >= 40 ? 'var(--green)' : weekKm >= 20 ? 'var(--yellow)' : 'var(--text-muted)';
    }
    if (kmSub) kmSub.textContent = weekCount + ' activite' + (weekCount > 1 ? 's' : '') + ' cette semaine';

    const elevEl = document.getElementById(p + 'kpi-week-elev');
    const elevSub = document.getElementById(p + 'kpi-week-elev-sub');
    if (elevEl) {
        elevEl.innerHTML = Math.round(weekElev) + '<span style="font-size:18px; color: var(--text-muted);"> m</span>';
        elevEl.style.color = weekElev >= 500 ? 'var(--green)' : weekElev >= 200 ? 'var(--yellow)' : 'var(--text-muted)';
    }
    if (elevSub) elevSub.textContent = 'D+ semaine en cours';
}

function matchWeekActivities(activities, athlete) {
    athlete = athlete || 'yohann';
    var container = document.getElementById('athlete-' + athlete);
    const today = new Date();
    today.setHours(23, 59, 59, 999);
    const todayStr = today.toISOString().slice(0, 10);

    // Index activities by date (YYYY-MM-DD)
    const actByDate = {};
    activities.forEach(act => {
        const d = new Date(act.start_date_local.replace('Z', '').replace(' ', 'T'));
        const key = d.toISOString().slice(0, 10);
        if (!actByDate[key]) actByDate[key] = [];
        actByDate[key].push(act);
    });

    const dayEls = container.querySelectorAll('.week-day[data-date]');
    let totalPlanned = 0, totalDone = 0;

    dayEls.forEach(el => {
        const date = el.dataset.date;
        const matchEl = el.querySelector('.day-match');
        if (!matchEl) return;

        const isFuture = date > todayStr;
        const dayActs = actByDate[date] || [];
        const detailEl = el.querySelector('.day-details');
        const isRestDay = detailEl ? detailEl.textContent.toLowerCase().includes('repos complet') : false;

        if (isFuture) {
            matchEl.innerHTML = '<div class="day-match-future">A venir</div>';
            return;
        }

        totalPlanned++;

        if (dayActs.length > 0) {
            totalDone++;
            let html = '';
            dayActs.forEach(act => {
                const st = detectType(act);
                const t = TYPES[st] || { label: st, color: 'var(--accent-light)' };
                const dist = (act.distance / 1000).toFixed(1);
                const dur = fmt(act.moving_time);
                const fcStr = act.average_heartrate ? ' · ' + Math.round(act.average_heartrate) + ' bpm' : '';
                html += '<div class="day-match-done">' +
                    '<span style="color:var(--green);font-weight:700;">&#10003;</span> ' +
                    '<span style="color:' + t.color + ';font-weight:600;">' + t.label + '</span> ' +
                    '<span style="color:var(--text-muted);">' + act.name + ' — ' + dist + ' km · ' + dur + fcStr + '</span>' +
                    '</div>';
            });
            matchEl.innerHTML = html;
        } else if (isRestDay) {
            totalDone++;
            matchEl.innerHTML = '<div class="day-match-done"><span style="color:var(--green);font-weight:700;">&#10003;</span> <span style="color:var(--text-muted);">Repos respecte</span></div>';
        } else {
            matchEl.innerHTML = '<div class="day-match-miss">&#10007; Pas d\'activite enregistree</div>';
        }
    });

    // Regularity widget (Yohann only for now)
    var p = ATHLETES[athlete].prefix;
    var regEl = document.getElementById(p + 'week-regularity');
    if (regEl && totalPlanned > 0) {
        regEl.style.display = 'block';
        var pct = Math.round(totalDone / totalPlanned * 100);
        var color = pct >= 80 ? 'var(--green)' : pct >= 60 ? 'var(--yellow)' : 'var(--orange)';
        var badgeCls = pct >= 80 ? 'badge-green' : pct >= 60 ? 'badge-yellow' : 'badge-orange';
        var regBadge = document.getElementById(p + 'week-regularity-badge');
        if (regBadge) { regBadge.className = 'badge ' + badgeCls; regBadge.textContent = pct + '%'; }
        var regBar = document.getElementById(p + 'week-regularity-bar');
        if (regBar) { regBar.style.width = pct + '%'; regBar.style.background = color; }
        var regDetail = document.getElementById(p + 'week-regularity-detail');
        if (regDetail) regDetail.textContent = totalDone + '/' + totalPlanned + ' seances realisees';
    }
}

loadActivities('yohann');

// ===== MANUAL CHECKS (renfo/iso/PPG) =====
var _coachLogDaily = [];
var _checksDirty = false;

function initManualChecks(athlete) {
    athlete = athlete || 'yohann';
    var containerEl = document.getElementById('athlete-' + athlete);
    var daily = _coachLogByAthlete[athlete] || _coachLogDaily;
    containerEl.querySelectorAll('.week-day[data-checks]').forEach(dayEl => {
        const date = dayEl.dataset.date;
        const items = dayEl.dataset.checks.split(',').map(s => s.trim()).filter(Boolean);
        const container = dayEl.querySelector('.day-checks');
        if (!container || items.length === 0) return;
        container.innerHTML = '';

        var coachEntry = daily.find(function(d) { return d.date === date; });
        var coachChecks = coachEntry && coachEntry.checks ? coachEntry.checks : null;

        items.forEach(item => {
            const key = 'check_' + date + '_' + item.replace(/[^a-zA-Z0-9]/g, '_');
            const isChecked = coachChecks ? !!coachChecks[item] : localStorage.getItem(key) === '1';

            const chip = document.createElement('span');
            chip.className = 'day-check' + (isChecked ? ' checked' : '');
            chip.innerHTML = '<span class="check-icon">' + (isChecked ? '\u2713' : '\u25CB') + '</span>' + item;
            chip.addEventListener('click', function() {
                const nowChecked = !this.classList.contains('checked');
                this.classList.toggle('checked', nowChecked);
                this.querySelector('.check-icon').textContent = nowChecked ? '\u2713' : '\u25CB';
                localStorage.setItem(key, nowChecked ? '1' : '0');
                _checksDirty = true;
                showSaveChecksBtn();
            });

            container.appendChild(chip);
        });
    });
}

function rpeColor(val) {
    if (val == null) return 'var(--text-muted)';
    if (val <= 4) return 'var(--green)';
    if (val <= 6) return 'var(--yellow)';
    if (val <= 8) return 'var(--orange)';
    return 'var(--red)';
}

function initDayMetrics(athlete) {
    athlete = athlete || 'yohann';
    var containerEl = document.getElementById('athlete-' + athlete);
    var daily = _coachLogByAthlete[athlete] || _coachLogDaily;
    var injuryKey = ATHLETES[athlete].injuryKey;
    containerEl.querySelectorAll('.week-day[data-date]').forEach(function(dayEl) {
        var date = dayEl.dataset.date;
        // Remove previous metrics if re-init
        var old = dayEl.querySelector('.day-metrics');
        if (old) old.remove();

        var coachEntry = daily.find(function(d) { return d.date === date; });

        var container = document.createElement('div');
        container.className = 'day-metrics';

        var injuryLabel = injuryKey === 'soleaire' ? 'Soléaire' : injuryKey === 'genou' ? 'Genou' : injuryKey;
        var metrics = [
            { key: injuryKey, label: injuryLabel, colorFn: soleaireColor },
            { key: 'rpe', label: 'RPE', colorFn: rpeColor }
        ];

        metrics.forEach(function(m) {
            var row = document.createElement('div');
            row.className = 'metric-row';
            row.dataset.metric = m.key;

            var savedVal = coachEntry && coachEntry[m.key] != null ? Math.round(coachEntry[m.key]) : null;
            row.dataset.value = savedVal != null ? savedVal : '';

            var lbl = document.createElement('span');
            lbl.className = 'metric-label';
            lbl.textContent = m.label;
            row.appendChild(lbl);

            var dots = document.createElement('span');
            dots.className = 'metric-dots';

            for (var i = 0; i <= 10; i++) {
                (function(idx) {
                    var dot = document.createElement('button');
                    dot.className = 'metric-dot';
                    dot.dataset.idx = idx;
                    dot.title = idx + '/10';
                    if (savedVal != null && idx <= savedVal) {
                        dot.classList.add('filled');
                        dot.style.background = m.colorFn(savedVal);
                    }
                    dot.addEventListener('click', function() {
                        var current = row.dataset.value !== '' ? parseInt(row.dataset.value) : null;
                        var newVal = (current === idx) ? null : idx;
                        row.dataset.value = newVal != null ? newVal : '';
                        // Update all dots
                        row.querySelectorAll('.metric-dot').forEach(function(d) {
                            var di = parseInt(d.dataset.idx);
                            if (newVal != null && di <= newVal) {
                                d.classList.add('filled');
                                d.style.background = m.colorFn(newVal);
                            } else {
                                d.classList.remove('filled');
                                d.style.background = '';
                            }
                        });
                        // Update value display
                        var valSpan = row.querySelector('.metric-value');
                        valSpan.textContent = newVal != null ? newVal : '';
                        valSpan.style.color = m.colorFn(newVal);
                        _checksDirty = true;
                        showSaveChecksBtn();
                    });
                    dots.appendChild(dot);
                })(i);
            }
            row.appendChild(dots);

            var valSpan = document.createElement('span');
            valSpan.className = 'metric-value';
            valSpan.textContent = savedVal != null ? savedVal : '';
            valSpan.style.color = m.colorFn(savedVal);
            row.appendChild(valSpan);

            container.appendChild(row);
        });

        dayEl.appendChild(container);
    });
}

function showSaveChecksBtn() {
    var btn = document.getElementById('save-checks-btn');
    if (!btn) {
        btn = document.createElement('button');
        btn.id = 'save-checks-btn';
        btn.className = 'save-checks-btn';
        btn.textContent = 'Sauvegarder';
        btn.onclick = saveChecksToGitHub;
        document.body.appendChild(btn);
    }
    btn.disabled = false;
    btn.textContent = 'Sauvegarder';
    btn.style.background = '';
    setTimeout(function() { btn.classList.add('visible'); }, 10);
}

function collectAllDayData(athlete) {
    athlete = athlete || currentAthlete;
    var containerEl = document.getElementById('athlete-' + athlete);
    var result = {};
    containerEl.querySelectorAll('.week-day[data-date]').forEach(function(dayEl) {
        var date = dayEl.dataset.date;
        var entry = {};
        // Checks
        var checks = {};
        dayEl.querySelectorAll('.day-check').forEach(function(chip) {
            var name = chip.textContent.replace(/^[\u2713\u25CB]\s*/, '');
            checks[name] = chip.classList.contains('checked');
        });
        if (Object.keys(checks).length > 0) entry.checks = checks;
        // Metrics (soléaire, RPE)
        dayEl.querySelectorAll('.metric-row').forEach(function(row) {
            var key = row.dataset.metric;
            var val = row.dataset.value;
            entry[key] = val !== '' ? parseInt(val) : null;
        });
        result[date] = entry;
    });
    return result;
}

function saveChecksToGitHub() {
    var token = getSyncToken();
    if (!token) { showTokenModal(saveChecksToGitHub); return; }

    var btn = document.getElementById('save-checks-btn');
    btn.disabled = true;
    btn.textContent = 'Sauvegarde...';

    var allData = collectAllDayData(currentAthlete);
    var repo = SYNC_REPO;
    var filePath = ATHLETES[currentAthlete].dataDir + 'coach-log.json';

    // 1. Read current file from GitHub
    fetch('https://api.github.com/repos/' + repo + '/contents/' + filePath, {
        headers: { 'Authorization': 'Bearer ' + token, 'Accept': 'application/vnd.github.v3+json' }
    })
    .then(function(r) { return r.json(); })
    .then(function(file) {
        var content = JSON.parse(atob(file.content));
        var sha = file.sha;

        // 2. Merge checks + metrics + hygiene into daily entries
        Object.keys(allData).forEach(function(date) {
            var dayData = allData[date];
            var entry = content.daily.find(function(d) { return d.date === date; });
            if (!entry) {
                entry = { date: date };
                content.daily.push(entry);
                content.daily.sort(function(a, b) { return a.date.localeCompare(b.date); });
            }
            if (dayData.checks) entry.checks = dayData.checks;
            // Save injury metric with the right key for current athlete
            var injKey = ATHLETES[currentAthlete].injuryKey;
            if (dayData[injKey] !== undefined) entry[injKey] = dayData[injKey];
            if (dayData.rpe !== undefined) entry.rpe = dayData.rpe;
        });

        // 3. Write back
        var newContent = btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2) + '\n')));
        return fetch('https://api.github.com/repos/' + repo + '/contents/' + filePath, {
            method: 'PUT',
            headers: { 'Authorization': 'Bearer ' + token, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: 'Update daily log', content: newContent, sha: sha })
        });
    })
    .then(function(r) {
        if (r.ok) {
            btn.textContent = 'OK !';
            btn.style.background = 'var(--green-dark)';
            _checksDirty = false;
            setTimeout(function() { btn.classList.remove('visible'); }, 1500);
        } else {
            return r.json().then(function(e) { throw new Error(e.message); });
        }
    })
    .catch(function(err) {
        btn.textContent = 'Erreur';
        btn.style.background = 'var(--red)';
        console.error('Save checks error:', err);
        setTimeout(function() {
            btn.textContent = 'Sauvegarder';
            btn.style.background = '';
            btn.disabled = false;
        }, 2000);
    });
}

// ===== DYNAMIC TODAY CARD + PAST DAYS =====
var EXERCISE_SVGS = {
    iso: '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="10" r="5" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="15" x2="32" y2="35" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="20" x2="24" y2="28" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="20" x2="40" y2="28" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="35" x2="27" y2="48" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="35" x2="37" y2="48" stroke="var(--accent)" stroke-width="2"/><line x1="24" y1="48" x2="40" y2="48" stroke="var(--text-muted)" stroke-width="1.5" stroke-dasharray="2 2"/><circle cx="27" cy="48" r="2" fill="var(--accent)"/><circle cx="37" cy="48" r="2" fill="var(--accent)"/><line x1="44" y1="46" x2="44" y2="36" stroke="var(--accent)" stroke-width="2"/><polyline points="41,39 44,36 47,39" stroke="var(--accent)" stroke-width="2" fill="none"/><ellipse cx="35" cy="42" rx="3" ry="5" stroke="var(--accent)" stroke-width="1" opacity="0.4"/></svg>',
    cardio: '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M32 52 C32 52 12 38 12 24 C12 18 17 13 23 13 C27 13 30 15 32 18 C34 15 37 13 41 13 C47 13 52 18 52 24 C52 38 32 52 32 52Z" stroke="var(--accent)" stroke-width="2" fill="none"/><path d="M20 30 L26 30 L28 24 L30 36 L32 28 L34 32 L36 30 L44 30" stroke="var(--accent)" stroke-width="1.5" fill="none"/></svg>',
    ppg: '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="22" r="5" stroke="var(--accent)" stroke-width="2"/><line x1="46" y1="24" x2="18" y2="30" stroke="var(--accent)" stroke-width="2"/><line x1="42" y1="26" x2="42" y2="40" stroke="var(--accent)" stroke-width="2"/><line x1="34" y1="28" x2="34" y2="42" stroke="var(--accent)" stroke-width="2"/><line x1="18" y1="30" x2="12" y2="42" stroke="var(--accent)" stroke-width="2"/><line x1="18" y1="30" x2="20" y2="42" stroke="var(--accent)" stroke-width="2"/><line x1="8" y1="42" x2="46" y2="42" stroke="var(--text-muted)" stroke-width="1" stroke-dasharray="3 2"/></svg>',
    marche: '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="8" r="5" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="13" x2="32" y2="33" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="20" x2="24" y2="28" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="20" x2="40" y2="26" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="33" x2="24" y2="50" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="33" x2="38" y2="46" stroke="var(--accent)" stroke-width="2"/><line x1="38" y1="46" x2="42" y2="50" stroke="var(--accent)" stroke-width="2"/><line x1="20" y1="50" x2="46" y2="50" stroke="var(--text-muted)" stroke-width="1" stroke-dasharray="3 2"/></svg>',
    running: '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="36" cy="8" r="5" stroke="var(--accent)" stroke-width="2"/><line x1="34" y1="13" x2="30" y2="32" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="18" x2="22" y2="24" stroke="var(--accent)" stroke-width="2"/><line x1="32" y1="18" x2="42" y2="22" stroke="var(--accent)" stroke-width="2"/><line x1="30" y1="32" x2="20" y2="48" stroke="var(--accent)" stroke-width="2"/><line x1="30" y1="32" x2="42" y2="44" stroke="var(--accent)" stroke-width="2"/><line x1="42" y1="44" x2="48" y2="42" stroke="var(--accent)" stroke-width="2"/><line x1="20" y1="48" x2="16" y2="52" stroke="var(--accent)" stroke-width="2"/></svg>',
    repos: '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M36 12 C36 12 28 14 24 22 C20 30 22 40 30 46 C38 52 48 50 52 42 C48 46 38 48 32 42 C26 36 26 24 36 12Z" stroke="var(--accent)" stroke-width="2" fill="none"/><text x="44" y="20" font-size="12" fill="var(--accent)" font-weight="bold">z</text><text x="50" y="14" font-size="10" fill="var(--accent)" font-weight="bold">z</text></svg>'
};

var EXERCISE_PATTERNS = [
    { key: 'iso', pattern: /iso|mollet/i, label: 'Iso mollets' },
    { key: 'running', pattern: /footing|course|trail|trot/i, label: 'Course' },
    { key: 'cardio', pattern: /elliptique|natation|nage|cardio/i, label: 'Cardio' },
    { key: 'ppg', pattern: /ppg|gainage|pompe|musculation/i, label: 'PPG' },
    { key: 'marche', pattern: /marche|rando/i, label: 'Marche' },
    { key: 'repos', pattern: /repos|off|souple/i, label: 'Repos' }
];

function detectExercises(badgeText, detailsText) {
    var combined = (badgeText || '') + ' ' + (detailsText || '');
    var found = [];
    var seen = {};
    EXERCISE_PATTERNS.forEach(function(ep) {
        if (!seen[ep.key] && ep.pattern.test(combined)) {
            found.push({ key: ep.key, label: ep.label });
            seen[ep.key] = true;
        }
    });
    return found.slice(0, 3);
}

function buildTodayCard(athlete) {
    athlete = athlete || 'yohann';
    var cfg = ATHLETES[athlete];
    var p = cfg.prefix;
    var container = document.getElementById(p + 'today-container');
    if (!container) return;

    var now = new Date();
    var todayISO = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');

    var JOURS = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
    var MOIS = ['janvier','fevrier','mars','avril','mai','juin','juillet','aout','septembre','octobre','novembre','decembre'];
    var jourNom = JOURS[now.getDay()];
    var moisNom = MOIS[now.getMonth()];
    var jourNum = now.getDate();

    // Find matching day-card in the planning
    var weekTabId = cfg.weekSubId;
    var sourceEl = document.querySelector('#' + weekTabId + ' .week-day[data-date="' + todayISO + '"]:not(#' + p + 'today-container .week-day)');

    var badgeHTML = '';
    var detailsHTML = '';
    var checksAttr = '';
    var exercises = [];

    if (sourceEl) {
        var badgeEl = sourceEl.querySelector('.day-header .badge');
        if (badgeEl) {
            badgeHTML = badgeEl.outerHTML;
        }
        var detailEl = sourceEl.querySelector('.day-details');
        if (detailEl) {
            detailsHTML = detailEl.innerHTML;
        }
        checksAttr = sourceEl.dataset.checks || '';
        exercises = detectExercises(badgeEl ? badgeEl.textContent : '', detailsHTML);
        // Hide original in planning (but not if it's in past sub-tab)
        if (!sourceEl.closest('#' + p + 'week-past')) {
            sourceEl.classList.add('day-hidden');
        }
    }

    // Fallback: repos if no exercises detected
    if (exercises.length === 0) {
        exercises = [{ key: 'repos', label: 'Repos' }];
        if (!badgeHTML) {
            badgeHTML = '<span class="badge" style="background: #333; color: #999;">Repos</span>';
        }
        if (!detailsHTML) {
            detailsHTML = 'Pas de seance programmee';
        }
    }

    // Build exercise icon strip (compact row of detected SVGs)
    var iconsHTML = '';
    if (exercises.length > 0) {
        iconsHTML = '<div class="today-icons">';
        exercises.forEach(function(ex) {
            iconsHTML += '<div class="today-icon-item">' +
                '<div class="exercise-svg">' + (EXERCISE_SVGS[ex.key] || '') + '</div>' +
                '<span class="today-icon-label">' + ex.label + '</span>' +
                '</div>';
        });
        iconsHTML += '</div>';
    }

    var cardHTML = '<div class="card today-card week-day" data-date="' + todayISO + '"' +
        (checksAttr ? ' data-checks="' + checksAttr + '"' : '') + '>' +
        '<div class="today-header">' +
        '<h2>Aujourd\'hui — ' + jourNom + ' ' + jourNum + ' ' + moisNom + '</h2>' +
        badgeHTML +
        '</div>' +
        iconsHTML +
        '<div class="day-details" style="margin-top: 12px; line-height: 1.7;">' + detailsHTML + '</div>' +
        '<div class="day-match"></div>' +
        '<div class="day-checks"></div>' +
        '</div>';

    container.innerHTML = cardHTML;
}

function markPastDays(athlete) {
    athlete = athlete || 'yohann';
    var p = ATHLETES[athlete].prefix;
    var containerEl = document.getElementById('athlete-' + athlete);
    var now = new Date();
    var todayISO = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');

    containerEl.querySelectorAll('.week-day[data-date]').forEach(function(el) {
        // Skip elements inside today-container or week-past (already styled)
        if (el.closest('#' + p + 'today-container')) return;
        if (el.closest('#' + p + 'week-past')) return;
        var date = el.dataset.date;
        if (date < todayISO) {
            el.classList.add('day-past');
        } else if (date === todayISO) {
            el.classList.add('day-hidden');
        }
    });
}

buildTodayCard('yohann');
markPastDays('yohann');
initManualChecks('yohann');
initDayMetrics('yohann');

// ===== GARMIN WELLNESS DATA =====
function fmtSeconds(s) {
    if (!s || s <= 0) return '--';
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    return h + 'h' + String(m).padStart(2, '0');
}

function fmtDateLabel(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }).replace('.', '');
}

function fmtDateDay(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return String(d.getDate());
}

function sleepScoreColor(score) {
    if (!score) return 'var(--text-muted)';
    if (score >= 80) return 'var(--green)';
    if (score >= 60) return 'var(--yellow)';
    if (score >= 40) return 'var(--orange)';
    return 'var(--red)';
}

function bbColor(val) {
    if (!val) return 'var(--text-muted)';
    if (val >= 70) return 'var(--green)';
    if (val >= 40) return 'var(--yellow)';
    if (val >= 20) return 'var(--orange)';
    return 'var(--red)';
}

function rhrColor(val) {
    if (!val) return 'var(--text-muted)';
    if (val <= 48) return 'var(--green)';
    if (val <= 55) return 'var(--yellow)';
    return 'var(--orange)';
}

function stressColor(val) {
    if (!val) return 'var(--text-muted)';
    if (val <= 25) return 'var(--green)';
    if (val <= 50) return 'var(--yellow)';
    if (val <= 75) return 'var(--orange)';
    return 'var(--red)';
}

function hrvStatusBadge(status) {
    if (!status || status === 'UNKNOWN') return '<span class="hrv-status-badge" style="background:#333;color:#999;">INCONNU</span>';
    const map = {
        'BALANCED': { bg: 'var(--green-dark)', color: 'var(--green)', label: 'EQUILIBRE' },
        'UNBALANCED': { bg: '#854d0e', color: 'var(--yellow)', label: 'DESEQUILIBRE' },
        'LOW': { bg: 'var(--red-dark)', color: '#fca5a5', label: 'BAS' },
        'POOR': { bg: 'var(--red-dark)', color: '#fca5a5', label: 'FAIBLE' },
    };
    const s = map[status] || { bg: '#333', color: '#999', label: status };
    return '<span class="hrv-status-badge" style="background:' + s.bg + ';color:' + s.color + ';">' + s.label + '</span>';
}

function renderMiniChart(containerId, labelsId, values, colorFn, unit, formatLabel) {
    const container = document.getElementById(containerId);
    const labelsEl = document.getElementById(labelsId);
    if (!container) return;

    const validValues = values.filter(v => v.value != null && v.value > 0);
    if (validValues.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:12px;width:100%;">Pas de donnees</div>';
        return;
    }

    const nums = validValues.map(v => v.value);
    const maxVal = Math.max(...nums);
    const minVal = Math.min(...nums);
    const range = maxVal - minVal || 1;

    let html = '';
    values.forEach(v => {
        if (v.value != null && v.value > 0) {
            const pct = 15 + ((v.value - minVal) / range) * 85;
            const color = colorFn ? colorFn(v.value) : 'var(--accent)';
            const label = formatLabel ? formatLabel(v.value) : v.value;
            html += '<div class="bar" data-val="' + label + '" style="height:' + pct + '%;background:' + color + ';" title="' + v.label + ': ' + v.value + (unit || '') + '"></div>';
        } else {
            html += '<div class="bar" style="height:5%;background:var(--border);opacity:0.3;" title="' + v.label + ': --"></div>';
        }
    });
    container.innerHTML = html;

    if (labelsEl && values.length > 0) {
        labelsEl.innerHTML = '<span>' + values[0].shortLabel + '</span><span>' + values[values.length - 1].shortLabel + '</span>';
    }
}

function sleepColor(seconds) {
    if (!seconds) return 'var(--text-muted)';
    const h = seconds / 3600;
    if (h >= 7.5) return 'var(--green)';
    if (h >= 7) return 'var(--yellow)';
    if (h >= 6) return 'var(--orange)';
    return 'var(--red)';
}

function stepsColor(steps) {
    if (!steps) return 'var(--text-muted)';
    if (steps >= 10000) return 'var(--green)';
    if (steps >= 7000) return 'var(--yellow)';
    if (steps >= 5000) return 'var(--orange)';
    return 'var(--red)';
}

function loadGarminData(athlete) {
    athlete = athlete || 'yohann';
    var cfg = ATHLETES[athlete];
    var p = cfg.prefix;
    fetch(cfg.dataDir + 'garmin-wellness.json?t=' + Date.now())
        .then(r => { if (!r.ok) throw new Error('No data'); return r.json(); })
        .then(data => {
            const sum = data.summary;
            const days = data.days || [];

            // ===== KPI SANTE =====
            // Last night sleep (duration + score)
            const lastNightEl = document.getElementById(p + 'health-last-night');
            const lastNightScoreEl = document.getElementById(p + 'health-last-night-score');
            const latestSleepDay = findLatest(days, 'sleep');
            if (latestSleepDay && latestSleepDay.sleep) {
                const dur = latestSleepDay.sleep.duration_seconds;
                lastNightEl.textContent = fmtSeconds(dur);
                lastNightEl.style.color = sleepColor(dur);
                if (latestSleepDay.sleep.score) {
                    lastNightScoreEl.textContent = 'Score ' + latestSleepDay.sleep.score;
                    lastNightScoreEl.style.color = sleepScoreColor(latestSleepDay.sleep.score);
                }
            }

            // Body Battery
            const bbEl = document.getElementById(p + 'health-body-battery');
            if (bbEl && sum.body_battery_current) {
                bbEl.textContent = sum.body_battery_current;
                bbEl.style.color = bbColor(sum.body_battery_current);
            }
            const bbDetail = document.getElementById(p + 'health-bb-detail');
            if (bbDetail && sum.body_battery_current) bbDetail.textContent = 'Pic du jour';

            // Sommeil moyen (Sante KPI)
            if (sum.sleep_avg_seconds) {
                const slAvgEl = document.getElementById(p + 'health-sleep-avg');
                if (slAvgEl) {
                    slAvgEl.textContent = fmtSeconds(sum.sleep_avg_seconds);
                    const h = sum.sleep_avg_seconds / 3600;
                    slAvgEl.style.color = h >= 7.5 ? 'var(--green)' : h >= 7 ? 'var(--yellow)' : h >= 6 ? 'var(--orange)' : 'var(--red)';
                }
                const slAvgSub = document.getElementById(p + 'health-sleep-avg-sub');
                if (slAvgSub) {
                    const h = sum.sleep_avg_seconds / 3600;
                    slAvgSub.textContent = 'Objectif : 7h30';
                    slAvgSub.style.color = h >= 7.5 ? 'var(--green)' : 'var(--red)';
                }
            }

            // ===== UPDATE OVERVIEW KPIs =====
            if (sum.vo2max) {
                const ov = document.getElementById(p + 'kpi-vo2max');
                if (ov) ov.textContent = sum.vo2max;
                const ovSub = document.getElementById(p + 'kpi-vo2max-sub');
                if (ovSub) ovSub.textContent = 'Garmin · ' + sum.last_sync.split(' ')[0];
            }
            // ===== SOMMEIL DETAIL =====
            const sleepDetail = document.getElementById(p + 'health-sleep-detail');
            const latestSleep = findLatest(days, 'sleep');
            if (latestSleep && latestSleep.sleep) {
                const sl = latestSleep.sleep;
                const total = sl.duration_seconds || 1;
                const deepPct = Math.round(sl.deep_seconds / total * 100);
                const lightPct = Math.round(sl.light_seconds / total * 100);
                const remPct = Math.round(sl.rem_seconds / total * 100);
                const awakePct = Math.max(0, 100 - deepPct - lightPct - remPct);

                let html = '<div style="margin-bottom:12px;"><span style="font-size:11px;color:var(--text-muted);">Derniere nuit (' + fmtDateLabel(latestSleep.date) + ')</span></div>';
                html += '<div style="text-align:center;margin-bottom:12px;"><span style="font-size:28px;font-weight:700;color:' + sleepColor(total) + ';">' + fmtSeconds(total) + '</span>';
                if (sl.score) html += ' <span style="font-size:14px;color:' + sleepScoreColor(sl.score) + ';font-weight:600;">Score ' + sl.score + '</span>';
                html += '</div>';

                // Phases bar
                html += '<div class="sleep-phases-bar">';
                if (deepPct > 0) html += '<div class="sleep-deep" style="width:' + deepPct + '%;">' + (deepPct >= 10 ? deepPct + '%' : '') + '</div>';
                if (lightPct > 0) html += '<div class="sleep-light" style="width:' + lightPct + '%;">' + (lightPct >= 10 ? lightPct + '%' : '') + '</div>';
                if (remPct > 0) html += '<div class="sleep-rem" style="width:' + remPct + '%;">' + (remPct >= 10 ? remPct + '%' : '') + '</div>';
                if (awakePct > 0) html += '<div class="sleep-awake" style="width:' + awakePct + '%;">' + (awakePct >= 10 ? awakePct + '%' : '') + '</div>';
                html += '</div>';

                // Legend
                html += '<div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:8px;font-size:12px;">';
                html += '<span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#1e3a8a;margin-right:4px;"></span>Profond ' + fmtSeconds(sl.deep_seconds) + '</span>';
                html += '<span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#3b82f6;margin-right:4px;"></span>Leger ' + fmtSeconds(sl.light_seconds) + '</span>';
                html += '<span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#8b5cf6;margin-right:4px;"></span>REM ' + fmtSeconds(sl.rem_seconds) + '</span>';
                html += '<span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#f97316;margin-right:4px;"></span>Eveil ' + fmtSeconds(sl.awake_seconds) + '</span>';
                html += '</div>';

                // 7-day trend
                const last7 = days.slice(-7);
                const sleepDurs = last7.filter(d => d.sleep && d.sleep.duration_seconds > 0).map(d => d.sleep.duration_seconds);
                if (sleepDurs.length > 0) {
                    const avg = Math.round(sleepDurs.reduce((a, b) => a + b, 0) / sleepDurs.length);
                    html += '<div style="margin-top:16px;padding:10px;background:var(--bg-card-alt);border-radius:8px;">';
                    html += '<div style="display:flex;justify-content:space-between;font-size:13px;">';
                    html += '<span class="text-muted">Moyenne 7 jours</span>';
                    html += '<span style="font-weight:700;color:' + sleepColor(avg) + ';">' + fmtSeconds(avg) + '</span>';
                    html += '</div>';
                    html += '<div style="display:flex;justify-content:space-between;font-size:13px;margin-top:4px;">';
                    html += '<span class="text-muted">Objectif</span>';
                    html += '<span style="font-weight:700;color:var(--green);">7h30</span>';
                    html += '</div></div>';
                }

                sleepDetail.innerHTML = html;
            } else {
                sleepDetail.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Pas de donnees sommeil</div>';
            }

            // ===== VFC + STRESS =====
            const hrvStress = document.getElementById(p + 'health-hrv-stress');
            const latestHrv = findLatest(days, 'hrv');
            const latestStress = findLatest(days, 'stress');
            let hrvHtml = '';

            if (latestHrv && latestHrv.hrv) {
                const h = latestHrv.hrv;
                hrvHtml += '<div style="margin-bottom:16px;">';
                hrvHtml += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">';
                hrvHtml += '<span style="font-size:13px;color:var(--text-muted);">Statut VFC</span>';
                hrvHtml += hrvStatusBadge(h.status);
                hrvHtml += '</div>';

                hrvHtml += '<div class="health-metric">';
                hrvHtml += '<div class="health-metric-icon" style="background:linear-gradient(135deg,#581c87,#a855f7);">';
                hrvHtml += '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>';
                hrvHtml += '</div>';
                hrvHtml += '<div><div class="health-metric-value text-purple">' + (h.weekly_avg || '--') + ' <span style="font-size:12px;font-weight:400;color:var(--text-muted);">ms</span></div>';
                hrvHtml += '<div class="health-metric-label">Moyenne hebdo</div></div>';
                hrvHtml += '</div>';

                hrvHtml += '<div class="health-metric">';
                hrvHtml += '<div class="health-metric-icon" style="background:linear-gradient(135deg,#4338ca,#818cf8);">';
                hrvHtml += '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M12 2a5 5 0 015 5c0 6-5 8-5 13-2-3-5-7-5-13a5 5 0 015-5z"/></svg>';
                hrvHtml += '</div>';
                hrvHtml += '<div><div class="health-metric-value" style="color:#818cf8;">' + (h.last_night_avg || '--') + ' <span style="font-size:12px;font-weight:400;color:var(--text-muted);">ms</span></div>';
                hrvHtml += '<div class="health-metric-label">Derniere nuit</div></div>';
                hrvHtml += '</div>';

                if (h.baseline_balanced_low && h.baseline_balanced_upper) {
                    hrvHtml += '<div style="font-size:12px;color:var(--text-muted);margin-top:8px;">Baseline : ' + h.baseline_balanced_low + ' — ' + h.baseline_balanced_upper + ' ms</div>';
                }
            }

            if (latestStress && latestStress.stress) {
                const st = latestStress.stress;
                hrvHtml += '<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">';
                hrvHtml += '<div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:12px;">Stress (' + fmtDateLabel(latestStress.date) + ')</div>';

                hrvHtml += '<div class="health-metric">';
                hrvHtml += '<div class="health-metric-icon" style="background:linear-gradient(135deg,#9a3412,#f97316);">';
                hrvHtml += '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M12 2v6M12 18v4M4.93 4.93l4.24 4.24M14.83 14.83l4.24 4.24M2 12h6M18 12h4M4.93 19.07l4.24-4.24M14.83 9.17l4.24-4.24"/></svg>';
                hrvHtml += '</div>';
                hrvHtml += '<div><div class="health-metric-value" style="color:' + stressColor(st.avg) + ';">' + (st.avg || '--') + '</div>';
                hrvHtml += '<div class="health-metric-label">Niveau moyen</div></div>';
                hrvHtml += '</div>';

                // Stress durations
                const restH = st.rest_stress_duration ? Math.round(st.rest_stress_duration / 60) : 0;
                const lowH = st.low_stress_duration ? Math.round(st.low_stress_duration / 60) : 0;
                const medH = st.medium_stress_duration ? Math.round(st.medium_stress_duration / 60) : 0;
                const highH = st.high_stress_duration ? Math.round(st.high_stress_duration / 60) : 0;
                const totalStressMin = restH + lowH + medH + highH || 1;

                hrvHtml += '<div style="display:flex;height:20px;border-radius:4px;overflow:hidden;margin-top:8px;">';
                if (restH > 0) hrvHtml += '<div style="width:' + (restH / totalStressMin * 100) + '%;background:var(--green);" title="Repos ' + restH + ' min"></div>';
                if (lowH > 0) hrvHtml += '<div style="width:' + (lowH / totalStressMin * 100) + '%;background:var(--yellow);" title="Bas ' + lowH + ' min"></div>';
                if (medH > 0) hrvHtml += '<div style="width:' + (medH / totalStressMin * 100) + '%;background:var(--orange);" title="Moyen ' + medH + ' min"></div>';
                if (highH > 0) hrvHtml += '<div style="width:' + (highH / totalStressMin * 100) + '%;background:var(--red);" title="Eleve ' + highH + ' min"></div>';
                hrvHtml += '</div>';

                hrvHtml += '<div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:6px;font-size:11px;">';
                hrvHtml += '<span><span style="color:var(--green);">●</span> Repos ' + restH + 'm</span>';
                hrvHtml += '<span><span style="color:var(--yellow);">●</span> Bas ' + lowH + 'm</span>';
                hrvHtml += '<span><span style="color:var(--orange);">●</span> Moyen ' + medH + 'm</span>';
                hrvHtml += '<span><span style="color:var(--red);">●</span> Eleve ' + highH + 'm</span>';
                hrvHtml += '</div>';
                hrvHtml += '</div>';
            }

            if (!hrvHtml) hrvHtml = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Pas de donnees VFC/stress</div>';
            hrvStress.innerHTML = hrvHtml;

            // ===== CHARTS 14 JOURS =====
            // FC repos
            renderMiniChart(p + 'chart-rhr', p + 'chart-rhr-labels',
                days.map(d => ({ value: d.resting_hr, label: fmtDateLabel(d.date), shortLabel: fmtDateDay(d.date) })),
                rhrColor, ' bpm'
            );

            // VFC
            renderMiniChart(p + 'chart-hrv', p + 'chart-hrv-labels',
                days.map(d => ({ value: d.hrv ? d.hrv.last_night_avg : null, label: fmtDateLabel(d.date), shortLabel: fmtDateDay(d.date) })),
                function(v) { return v >= 50 ? 'var(--green)' : v >= 30 ? 'var(--yellow)' : 'var(--orange)'; }, ' ms'
            );

            // Pas
            renderMiniChart(p + 'chart-steps', p + 'chart-steps-labels',
                days.map(d => ({ value: d.steps, label: fmtDateLabel(d.date), shortLabel: fmtDateDay(d.date) })),
                stepsColor, '',
                function(v) { return v >= 1000 ? (v / 1000).toFixed(1).replace('.0', '') + 'k' : v; }
            );

            // Body Battery
            renderMiniChart(p + 'chart-bb', p + 'chart-bb-labels',
                days.map(d => ({ value: d.body_battery ? d.body_battery.highest : null, label: fmtDateLabel(d.date), shortLabel: fmtDateDay(d.date) })),
                bbColor, ''
            );
            // BB summary
            const bbSummaryEl = document.getElementById(p + 'chart-bb-summary');
            const bbDays = days.filter(d => d.body_battery);
            if (bbDays.length > 0 && bbSummaryEl) {
                const avgHigh = Math.round(bbDays.reduce((a, d) => a + d.body_battery.highest, 0) / bbDays.length);
                const avgLow = Math.round(bbDays.reduce((a, d) => a + d.body_battery.lowest, 0) / bbDays.length);
                bbSummaryEl.innerHTML = '<div style="display:flex;justify-content:space-around;font-size:12px;">' +
                    '<div style="text-align:center;"><div style="font-weight:700;color:' + bbColor(avgHigh) + ';">' + avgHigh + '</div><div class="text-muted">Pic moy.</div></div>' +
                    '<div style="text-align:center;"><div style="font-weight:700;color:' + bbColor(avgLow) + ';">' + avgLow + '</div><div class="text-muted">Min moy.</div></div>' +
                    '</div>';
            }

            // Sleep 14j
            renderMiniChart(p + 'chart-sleep', p + 'chart-sleep-labels',
                days.map(d => ({ value: d.sleep ? Math.round(d.sleep.duration_seconds / 60) : null, label: fmtDateLabel(d.date), shortLabel: fmtDateDay(d.date) })),
                function(mins) { return sleepColor(mins * 60); }, ' min',
                function(mins) { var h = Math.floor(mins / 60); var m = mins % 60; return h + 'h' + String(m).padStart(2, '0'); }
            );
            // Sleep summary
            const sleepSummaryEl = document.getElementById(p + 'chart-sleep-summary');
            const sleepDays = days.filter(d => d.sleep && d.sleep.duration_seconds > 0);
            if (sleepDays.length > 0 && sleepSummaryEl) {
                const avgSec = Math.round(sleepDays.reduce((a, d) => a + d.sleep.duration_seconds, 0) / sleepDays.length);
                const scores = sleepDays.filter(d => d.sleep.score > 0).map(d => d.sleep.score);
                const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : null;
                sleepSummaryEl.innerHTML = '<div style="display:flex;justify-content:space-around;font-size:12px;">' +
                    '<div style="text-align:center;"><div style="font-weight:700;color:' + sleepColor(avgSec) + ';">' + fmtSeconds(avgSec) + '</div><div class="text-muted">Duree moy.</div></div>' +
                    (avgScore ? '<div style="text-align:center;"><div style="font-weight:700;color:' + sleepScoreColor(avgScore) + ';">' + avgScore + '</div><div class="text-muted">Score moy.</div></div>' : '') +
                    '</div>';
            }

            // Status badge (Yohann only)
            if (!p) {
                document.getElementById('garmin-status').style.color = 'var(--green)';
                document.getElementById('garmin-status').textContent = 'OK';
            }
        })
        .catch(() => {
            if (!p) {
                document.getElementById('garmin-status').style.color = 'var(--yellow)';
                document.getElementById('garmin-status').textContent = 'Pas de donnees';
            }
            var sleepEl = document.getElementById(p + 'health-sleep-detail');
            if (sleepEl) sleepEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Pas encore de donnees Garmin.</div>';
            var hrvEl = document.getElementById(p + 'health-hrv-stress');
            if (hrvEl) hrvEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Pas encore de donnees Garmin.</div>';
        });
}

function findLatest(days, key) {
    for (let i = days.length - 1; i >= 0; i--) {
        if (days[i][key]) return days[i];
    }
    return null;
}

loadGarminData('yohann');

// ===== SYNC BUTTON =====
const SYNC_REPO = 'dreamskid/coach-trail';
const SYNC_WORKFLOW = 'sync-strava.yml';
const SYNC_STALE_HOURS = 6;

function getSyncToken() { return localStorage.getItem('gh_sync_token'); }
function setSyncToken(t) { localStorage.setItem('gh_sync_token', t); }

function handleSync(e) {
    if (e && e.shiftKey) { localStorage.removeItem('gh_sync_token'); }
    const token = getSyncToken();
    if (!token) {
        showTokenModal();
    } else {
        triggerSync(token);
    }
}

var _tokenCallback = null;

function showTokenModal(callback) {
    _tokenCallback = callback || null;
    const modal = document.createElement('div');
    modal.className = 'sync-modal';
    modal.id = 'sync-modal';
    modal.innerHTML =
        '<div class="sync-modal-box">' +
            '<h3>Configuration (une seule fois)</h3>' +
            '<p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">' +
                'Il faut un <strong>GitHub Personal Access Token (classic)</strong> pour sauvegarder et synchroniser.' +
            '</p>' +
            '<p style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">' +
                '1. <a href="https://github.com/settings/tokens/new?scopes=repo&description=Coach+Trail+Sync" target="_blank" style="color:var(--accent);">Clique ici pour creer le token</a><br>' +
                '2. Laisse la coche <strong>repo</strong> activee, clique <strong>Generate token</strong><br>' +
                '3. Copie le token et colle-le ci-dessous' +
            '</p>' +
            '<input type="password" id="sync-token-input" placeholder="ghp_xxxxxxxxxxxx...">' +
            '<div>' +
                '<button class="sync-modal-btn" onclick="saveTokenAndGo()">Enregistrer</button>' +
                '<button class="sync-modal-cancel" onclick="closeTokenModal()">Annuler</button>' +
            '</div>' +
            '<p style="font-size:11px;color:var(--text-muted);margin-top:12px;">Le token est sauvegarde sur tous tes appareils via GitHub.</p>' +
        '</div>';
    document.body.appendChild(modal);
    document.getElementById('sync-token-input').focus();
}

function closeTokenModal() {
    const m = document.getElementById('sync-modal');
    if (m) m.remove();
}

function saveTokenAndGo() {
    const input = document.getElementById('sync-token-input');
    const token = input.value.trim();
    if (!token) return;
    setSyncToken(token);
    closeTokenModal();
    // Persist token to coach-log.json for cross-device access
    persistTokenToRepo(token);
    if (_tokenCallback) { _tokenCallback(); _tokenCallback = null; }
    else { triggerSync(token); }
}

function saveTokenAndSync() { saveTokenAndGo(); }

var _obfKey = 'coachtrail2026';
function obfuscate(s) {
    var out = [];
    for (var i = 0; i < s.length; i++) out.push(s.charCodeAt(i) ^ _obfKey.charCodeAt(i % _obfKey.length));
    return btoa(String.fromCharCode.apply(null, out));
}
function deobfuscate(s) {
    var bytes = atob(s);
    var out = [];
    for (var i = 0; i < bytes.length; i++) out.push(bytes.charCodeAt(i) ^ _obfKey.charCodeAt(i % _obfKey.length));
    return String.fromCharCode.apply(null, out);
}

function persistTokenToRepo(token) {
    var repo = SYNC_REPO;
    var filePath = 'data/coach-log.json';
    fetch('https://api.github.com/repos/' + repo + '/contents/' + filePath, {
        headers: { 'Authorization': 'Bearer ' + token, 'Accept': 'application/vnd.github.v3+json' }
    })
    .then(function(r) {
        if (!r.ok) throw new Error('GET failed: ' + r.status);
        return r.json();
    })
    .then(function(file) {
        var content = JSON.parse(atob(file.content));
        var sha = file.sha;
        if (!content.settings) content.settings = {};
        content.settings.gh_sync_token_obf = obfuscate(token);
        delete content.settings.gh_sync_token_b64;
        var newContent = btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2) + '\n')));
        return fetch('https://api.github.com/repos/' + repo + '/contents/' + filePath, {
            method: 'PUT',
            headers: { 'Authorization': 'Bearer ' + token, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: 'Save settings', content: newContent, sha: sha })
        });
    })
    .then(function(r) {
        if (!r.ok) r.json().then(function(e) { console.error('[token-persist] Failed:', e.message); });
    })
    .catch(function(e) { console.error('[token-persist] Error:', e); });
}

function triggerSync(token) {
    const btn = document.getElementById('sync-btn');
    const label = document.getElementById('sync-label');
    btn.classList.add('syncing');
    btn.classList.remove('stale');
    label.textContent = 'Sync...';

    fetch('https://api.github.com/repos/' + SYNC_REPO + '/actions/workflows/' + SYNC_WORKFLOW + '/dispatches', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + token,
            'Accept': 'application/vnd.github.v3+json',
        },
        body: JSON.stringify({ ref: 'main' }),
    })
    .then(r => {
        if (r.status === 204) {
            label.textContent = 'Lance !';
            setTimeout(() => pollSyncWorkflow(), 3000);
        } else if (r.status === 401) {
            label.textContent = 'Token expire';
            btn.classList.remove('syncing');
            localStorage.removeItem('gh_sync_token');
            setTimeout(() => { label.textContent = 'Sync'; }, 3000);
        } else if (r.status === 403) {
            label.textContent = 'Droits insuffisants';
            btn.classList.remove('syncing');
            setTimeout(() => { label.textContent = 'Sync'; }, 4000);
        } else {
            r.text().then(t => console.error('Sync error:', r.status, t));
            label.textContent = 'Erreur ' + r.status;
            btn.classList.remove('syncing');
            setTimeout(() => { label.textContent = 'Sync'; }, 3000);
        }
    })
    .catch(e => {
        console.error('Sync fetch error:', e);
        label.textContent = 'Erreur reseau';
        btn.classList.remove('syncing');
        setTimeout(() => { label.textContent = 'Sync'; }, 3000);
    });
}

function pollSyncWorkflow() {
    const label = document.getElementById('sync-label');
    const btn = document.getElementById('sync-btn');
    const token = getSyncToken();
    let elapsed = 0;

    const poll = setInterval(() => {
        elapsed += 5;
        label.textContent = elapsed + 's...';

        if (elapsed > 120) {
            clearInterval(poll);
            label.textContent = 'Timeout';
            btn.classList.remove('syncing');
            setTimeout(() => { label.textContent = 'Sync'; }, 3000);
            return;
        }

        fetch('https://api.github.com/repos/' + SYNC_REPO + '/actions/runs?per_page=1', {
            headers: { 'Authorization': 'Bearer ' + token, 'Accept': 'application/vnd.github.v3+json' }
        })
        .then(r => r.json())
        .then(data => {
            const run = data.workflow_runs && data.workflow_runs[0];
            if (!run) return;
            if (run.status === 'completed') {
                clearInterval(poll);
                const ok = run.conclusion === 'success';
                label.textContent = ok ? 'OK !' : 'Echec';
                if (ok) {
                    Object.keys(ATHLETES).forEach(function(a) {
                        if (_loadedAthletes[a]) { loadActivities(a); loadGarminData(a); }
                    });
                }
                setTimeout(() => {
                    btn.classList.remove('syncing');
                    label.textContent = 'Sync';
                    updateSyncStatus();
                }, 2000);
            }
        })
        .catch(() => {});
    }, 5000);
}

function updateSyncStatus() {
    fetch('data/garmin-wellness.json?t=' + Date.now())
        .then(r => r.ok ? r.json() : null)
        .then(data => {
            if (!data || !data.summary || !data.summary.last_sync) return;
            const lastSync = new Date(data.summary.last_sync.replace(' ', 'T'));
            const now = new Date();
            const diffH = (now - lastSync) / (1000 * 60 * 60);
            const btn = document.getElementById('sync-btn');
            const label = document.getElementById('sync-label');
            const headerUpdate = document.getElementById('header-update');

            if (headerUpdate) {
                const syncDate = lastSync.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                const syncTime = lastSync.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                headerUpdate.textContent = 'Mise a jour : ' + syncDate + ' a ' + syncTime;
            }

            if (diffH > SYNC_STALE_HOURS && !btn.classList.contains('syncing')) {
                btn.classList.add('stale');
                label.textContent = 'Sync (' + Math.round(diffH) + 'h)';
            }
        })
        .catch(() => {});
}

updateSyncStatus();

// ===== COACH LOG =====
function soleaireColor(val) {
    if (val == null) return 'var(--text-muted)';
    if (val <= 1) return 'var(--green)';
    if (val <= 3) return 'var(--yellow)';
    if (val <= 5) return 'var(--orange)';
    return 'var(--red)';
}

function renderInjuryJournal(athlete) {
    athlete = athlete || 'yohann';
    var cfg = ATHLETES[athlete];
    var p = cfg.prefix;
    var daily = _coachLogByAthlete[athlete] || _coachLogDaily;
    var injuryKey = cfg.injuryKey;
    var container = document.getElementById(p + 'injury-journal');
    if (!container) return;
    var entries = daily.filter(function(d) { return d[injuryKey] != null; });
    if (entries.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Aucune donnee enregistree</div>';
        return;
    }
    entries.sort(function(a, b) { return b.date.localeCompare(a.date); });
    var injuryLabel = injuryKey === 'soleaire' ? 'Soleaire' : injuryKey === 'genou' ? 'Genou' : injuryKey;
    var html = '<table><tr><th>Date</th><th>' + injuryLabel + ' /10</th><th>RPE</th><th>Checks</th><th>Verdict</th></tr>';
    entries.forEach(function(d) {
        var color = soleaireColor(d[injuryKey]);
        var dateObj = new Date(d.date + 'T00:00:00');
        var dateStr = dateObj.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        var checks = d.checks ? Object.keys(d.checks).filter(function(k) { return d.checks[k]; }).join(', ') : '—';
        var rpe = d.rpe != null ? d.rpe + '/10' : '—';
        var verdict = d.verdict || '—';
        html += '<tr>';
        html += '<td>' + dateStr + '</td>';
        html += '<td style="color:' + color + ';font-weight:bold;">' + d[injuryKey] + '/10</td>';
        html += '<td>' + rpe + '</td>';
        html += '<td class="text-muted">' + checks + '</td>';
        html += '<td>' + verdict + '</td>';
        html += '</tr>';
    });
    html += '</table>';
    container.innerHTML = html;
}

function renderInjuryChart(athlete) {
    athlete = athlete || 'yohann';
    var cfg = ATHLETES[athlete];
    var p = cfg.prefix;
    var daily = _coachLogByAthlete[athlete] || _coachLogDaily;
    var injuryKey = cfg.injuryKey;
    var chartId = injuryKey === 'soleaire' ? 'chart-soleaire' : 'chart-' + injuryKey;
    var labelsId = chartId + '-labels';
    var last14 = daily.slice(-14);
    var values = last14.map(function(d) {
        var dateObj = new Date(d.date + 'T00:00:00');
        var short = dateObj.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        return { value: d[injuryKey], label: d.date, shortLabel: short };
    });
    renderMiniChart(p + chartId, p + labelsId, values, soleaireColor, '/10');
}

// --- Evaluation /10 ---
var EVAL_LABELS = {
    progression: 'Progression', mental: 'Mental', gestion_effort: "Gestion d'effort",
    socle_aerobie: 'Socle aerobie', endurance_ultra: 'Endurance ultra',
    technique_descente: 'Technique descente', regularite: 'Regularite entrainement',
    puissance_montee: 'Puissance montee', resistance_musculaire: 'Resistance musculaire',
    recuperation: 'Recuperation'
};

function evaluationColor(val) {
    if (val == null) return 'var(--text-muted)';
    if (val >= 8) return 'var(--green)';
    if (val >= 6) return 'var(--yellow)';
    if (val >= 4) return 'var(--orange)';
    return 'var(--red)';
}

function renderEvaluation(evalData, athlete) {
    athlete = athlete || 'yohann';
    var p = ATHLETES[athlete].prefix;
    var container = document.getElementById(p + 'eval-scores');
    var globalEl = document.getElementById(p + 'eval-global-value');
    if (!container) return;

    if (!evalData || !evalData.current || !evalData.current.scores) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Pas d\'evaluation disponible</div>';
        return;
    }

    var scores = evalData.current.scores;
    var keys = Object.keys(EVAL_LABELS);
    var html = '';
    var sum = 0;
    var count = 0;

    for (var i = 0; i < keys.length; i++) {
        var key = keys[i];
        var val = scores[key];
        var label = EVAL_LABELS[key];
        if (val == null) continue;
        var color = evaluationColor(val);
        html += '<div class="stat-row"><span class="label">' + label + '</span><span class="value" style="color:' + color + ';">' + val + '/10</span></div>';
        sum += val;
        count++;
    }

    container.innerHTML = html;

    if (globalEl && count > 0) {
        var avg = (sum / count).toFixed(1);
        var avgColor = evaluationColor(parseFloat(avg));
        globalEl.innerHTML = avg + '<span style="font-size: 16px; color: var(--text-muted);">/10</span>';
        globalEl.style.color = avgColor;
    }
}

function renderEvalHistory(evalData, athlete) {
    athlete = athlete || 'yohann';
    var p = ATHLETES[athlete].prefix;
    var container = document.getElementById(p + 'eval-history');
    if (!container) return;

    if (!evalData || !evalData.history || evalData.history.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Pas encore d\'historique</div>';
        return;
    }

    var history = evalData.history;
    var keys = Object.keys(EVAL_LABELS);
    var html = '<table><tr><th>Dimension</th>';

    for (var h = 0; h < history.length; h++) {
        var d = new Date(history[h].date + 'T00:00:00');
        var dateStr = d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        html += '<th style="text-align:center;">' + history[h].trigger + '<br><span style="font-size:11px;color:var(--text-muted);">' + dateStr + '</span></th>';
    }
    html += '</tr>';

    var sums = [];
    for (var s = 0; s < history.length; s++) sums.push({ sum: 0, count: 0 });

    for (var i = 0; i < keys.length; i++) {
        var key = keys[i];
        html += '<tr><td>' + EVAL_LABELS[key] + '</td>';
        for (var j = 0; j < history.length; j++) {
            var val = history[j].scores[key];
            var color = evaluationColor(val);
            var trend = '';
            if (j > 0 && val != null && history[j-1].scores[key] != null) {
                var prev = history[j-1].scores[key];
                if (val > prev) trend = ' <span style="color:var(--green);">&#8593;</span>';
                else if (val < prev) trend = ' <span style="color:var(--red);">&#8595;</span>';
                else trend = ' <span style="color:var(--text-muted);">=</span>';
            }
            html += '<td style="text-align:center;color:' + color + ';">' + (val != null ? val : '—') + trend + '</td>';
            if (val != null) { sums[j].sum += val; sums[j].count++; }
        }
        html += '</tr>';
    }

    // Moyenne row
    html += '<tr style="font-weight:700;border-top:2px solid var(--border);"><td>Moyenne</td>';
    for (var m = 0; m < sums.length; m++) {
        var avg = sums[m].count > 0 ? (sums[m].sum / sums[m].count).toFixed(1) : '—';
        var avgColor = sums[m].count > 0 ? evaluationColor(parseFloat(avg)) : 'var(--text-muted)';
        var mTrend = '';
        if (m > 0 && sums[m].count > 0 && sums[m-1].count > 0) {
            var prevAvg = sums[m-1].sum / sums[m-1].count;
            var curAvg = sums[m].sum / sums[m].count;
            if (curAvg > prevAvg + 0.05) mTrend = ' <span style="color:var(--green);">&#8593;</span>';
            else if (curAvg < prevAvg - 0.05) mTrend = ' <span style="color:var(--red);">&#8595;</span>';
            else mTrend = ' <span style="color:var(--text-muted);">=</span>';
        }
        html += '<td style="text-align:center;color:' + avgColor + ';">' + avg + mTrend + '</td>';
    }
    html += '</tr></table>';

    container.innerHTML = html;
}

function loadCoachLog(athlete) {
    athlete = athlete || 'yohann';
    var cfg = ATHLETES[athlete];
    var prefix = cfg.prefix;
    fetch(cfg.dataDir + 'coach-log.json?t=' + Date.now())
        .then(r => { if (!r.ok) throw new Error('No data'); return r.json(); })
        .then(data => {
            var daily = data.daily || [];
            var lt = data.longterm || {};

            // Sync token cross-device (Yohann only)
            if (!prefix) {
                var hasTokenInJson = data.settings && data.settings.gh_sync_token_obf;
                var hasTokenLocal = getSyncToken();
                if (hasTokenInJson && !hasTokenLocal) {
                    try { setSyncToken(deobfuscate(data.settings.gh_sync_token_obf)); } catch(e) {}
                } else if (hasTokenLocal && !hasTokenInJson) {
                    persistTokenToRepo(hasTokenLocal);
                }
            }

            // Store daily data per athlete
            _coachLogByAthlete[athlete] = daily;
            if (!prefix) _coachLogDaily = daily;

            // Feed manual checks from coach-log and re-render
            initManualChecks(athlete);
            initDayMetrics(athlete);

            // Protocol phase badges (Yohann only — has proto-phase-X IDs)
            if (!prefix) {
                var currentPhase = lt.protocol_phase || 1;
                for (var pp = 1; pp <= 5; pp++) {
                    var protoEl = document.getElementById('proto-phase-' + pp);
                    if (!protoEl) continue;
                    if (pp < currentPhase) {
                        protoEl.innerHTML = '<span class="badge badge-green">VALIDE</span>';
                    } else if (pp === currentPhase) {
                        protoEl.innerHTML = '<span class="badge badge-blue">EN COURS</span>';
                    } else {
                        protoEl.innerHTML = '<span class="badge badge-yellow">A VENIR</span>';
                    }
                }
            }

            renderInjuryJournal(athlete);
            renderInjuryChart(athlete);

            var evalData = lt.evaluation || null;
            renderEvaluation(evalData, athlete);
            renderEvalHistory(evalData, athlete);
        })
        .catch(() => {});
}

// ===== LOAD ATHLETE DATA (all data for one athlete) =====
function loadAthleteData(athlete) {
    loadCoachLog(athlete);
    loadActivities(athlete);
    loadGarminData(athlete);
    buildTodayCard(athlete);
    markPastDays(athlete);
}

// Initial load
updateHeaderDetails();
if (currentAthlete !== 'yohann') {
    // Restore saved athlete: activate correct button, wrapper, and load data
    document.querySelectorAll('.athlete-btn').forEach(function(b) { b.classList.remove('active'); });
    var savedBtn = document.querySelector('.athlete-btn[data-athlete="' + currentAthlete + '"]');
    if (savedBtn) savedBtn.classList.add('active');
    document.querySelectorAll('.athlete-content').forEach(function(c) { c.classList.remove('active'); });
    document.getElementById('athlete-' + currentAthlete).classList.add('active');
}
loadAthleteData(currentAthlete);
_loadedAthletes[currentAthlete] = true;
</script>

</body>
</html>
